
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ms3.transformations &#8212; ms3 1.2.4.post0.dev2+gf30d960 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../../_static/styles/bootstrap.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=796348d33e8b1d947c94" rel="stylesheet">
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/thebelab.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94">
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/thebelab-helper.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/ms3/transformations';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>

  
  <input type="checkbox" class="sidebar-toggle" name="__primary" id="__primary">
  <label class="overlay overlay-primary" for="__primary"></label>

  
  <input type="checkbox" class="sidebar-toggle" name="__secondary" id="__secondary">
  <label class="overlay overlay-secondary" for="__secondary"></label>

  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
      
<form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  </div>

  
  <nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
      <span class="fa-solid fa-bars"></span>
  </label>
  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../../index.html">

  
  
  
  
  
  
  

  
  
    <p class="title logo__title">ms3 1.2.4.post0.dev2+gf30d960 documentation</p>
  
</a>
    
  </div>

  
  <div class="col-lg-9 navbar-header-items">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../install.html">
                        Installation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../quick.html">
                        Quick Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../manual/index.html">
                        Manual
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../reference.html">
                        Developers' Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../license.html">
                        License
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../authors.html">
                        Authors
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../changelog.html">
                        Changelog
                      </a>
                    </li>
                
                </div>
            </div>
            
    </ul>
</nav>
      </div>
      
    </div>

    <div id="navbar-end">
      
        <div class="navbar-end-item navbar-persistent--container">
          
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
        </div>
      
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>


  
  
    <div class="navbar-persistent--mobile">
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
    </div>
  

  
  <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
  </label>
  

</div>
  </nav>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        
  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../install.html">
                        Installation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../quick.html">
                        Quick Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../manual/index.html">
                        Manual
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../reference.html">
                        Developers' Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../license.html">
                        License
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../authors.html">
                        Authors
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../changelog.html">
                        Changelog
                      </a>
                    </li>
                
                </div>
            </div>
            
    </ul>
</nav>
      </div>
      
      </div>
    

    
    
    <div class="sidebar-header-items__end">
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
    
  </div>

  
  <div class="sidebar-start-items sidebar-primary__section">
    <div class="sidebar-start-items__item">
<h3><a href="../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quick.html">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../manual/index.html">Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference.html">Developers' Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
</ul>

    </div>
    <div class="sidebar-start-items__item">
    </div>
    <div class="sidebar-start-items__item">
    </div>
    <div class="sidebar-start-items__item">
<div id="searchbox"></div>
    </div>
  </div>
  

  
  <div class="sidebar-end-items sidebar-primary__section">
    <div class="sidebar-end-items__item">
    </div>
  </div>

  
  <div id="rtd-footer-container"></div>

      </div>
      <main id="main-content" class="bd-main">
        
        
        <div class="bd-content">
          <div class="bd-article-container">
            
            <div class="bd-header-article">
                
            </div>
            
            
            <article class="bd-article" role="main">
              
  <h1>Source code for ms3.transformations</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Functions for transforming DataFrames as output by ms3.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">fractions</span> <span class="kn">import</span> <span class="n">Fraction</span> <span class="k">as</span> <span class="n">frac</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">.logger</span> <span class="kn">import</span> <span class="n">function_logger</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">adjacency_groups</span><span class="p">,</span> <span class="n">features2tpcs</span><span class="p">,</span> <span class="n">fifths2name</span><span class="p">,</span> <span class="n">fifths2iv</span><span class="p">,</span> <span class="n">fifths2pc</span><span class="p">,</span> <span class="n">fifths2rn</span><span class="p">,</span> <span class="n">fifths2sd</span><span class="p">,</span> <span class="n">make_interval_index_from_breaks</span><span class="p">,</span> \
    <span class="n">make_continuous_offset_series</span><span class="p">,</span> <span class="n">make_interval_index_from_durations</span><span class="p">,</span> <span class="n">make_playthrough_info</span><span class="p">,</span> <span class="n">midi2octave</span><span class="p">,</span> <span class="n">name2fifths</span><span class="p">,</span> <span class="n">nan_eq</span><span class="p">,</span> <span class="n">rel2abs_key</span><span class="p">,</span> \
    <span class="n">replace_index_by_intervals</span><span class="p">,</span> <span class="n">resolve_relative_keys</span><span class="p">,</span> <span class="n">roman_numeral2fifths</span><span class="p">,</span> \
    <span class="n">roman_numeral2semitones</span><span class="p">,</span> <span class="n">series_is_minor</span><span class="p">,</span> <span class="n">reduce_dataframe_duration_to_first_row</span><span class="p">,</span> <span class="n">tpc2name</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">transpose</span><span class="p">,</span> <span class="n">transpose_changes</span><span class="p">,</span> <span class="n">unfold_repeats</span><span class="p">,</span> <span class="n">overlapping_chunk_per_interval</span>


<span class="k">def</span> <span class="nf">add_localkey_change_column</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">key_column</span><span class="o">=</span><span class="s1">&#39;localkey&#39;</span><span class="p">):</span>
    <span class="n">key_segment</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">adjacency_groups</span><span class="p">(</span><span class="n">at</span><span class="p">[</span><span class="n">key_column</span><span class="p">],</span> <span class="n">na_values</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">at</span><span class="p">,</span> <span class="n">key_segment</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;key_segment&#39;</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="make_note_name_and_octave_columns"><a class="viewcode-back" href="../../reference.html#ms3.transformations.make_note_name_and_octave_columns">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">make_note_name_and_octave_columns</span><span class="p">(</span><span class="n">notes</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                                      <span class="n">staff2drums</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Takes a notelist and maybe a {staff -&gt; {midi_pitch -&gt; &#39;instrument_name&#39;}} mapping and returns two columns named &#39;name&#39; and &#39;octave&#39;.&quot;&quot;&quot;</span>
    <span class="n">octaves</span> <span class="o">=</span> <span class="n">midi2octave</span><span class="p">(</span><span class="n">notes</span><span class="o">.</span><span class="n">midi</span><span class="p">,</span> <span class="n">notes</span><span class="o">.</span><span class="n">tpc</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;octave&#39;</span><span class="p">)</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">(</span><span class="n">tpc2name</span><span class="p">(</span><span class="n">notes</span><span class="o">.</span><span class="n">tpc</span><span class="p">)</span> <span class="o">+</span> <span class="n">octaves</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">staff2drums</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">staff2drums</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">names</span><span class="p">,</span> <span class="n">octaves</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">notes</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">staff</span><span class="p">,</span> <span class="n">drum_map</span> <span class="ow">in</span> <span class="n">staff2drums</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">drum_map</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">drum_map</span> <span class="o">=</span> <span class="n">drum_map</span><span class="o">.</span><span class="n">name</span>
        <span class="n">drum_notes</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">staff</span> <span class="o">==</span> <span class="n">staff</span>
        <span class="n">result</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">drum_notes</span><span class="p">]</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">midi</span><span class="p">[</span><span class="n">drum_notes</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">drum_map</span><span class="p">)</span>
    <span class="n">not_drum</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">not_drum</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">not_drum</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">is_drum</span> <span class="o">=</span> <span class="o">~</span><span class="n">not_drum</span>
        <span class="n">octaves</span> <span class="o">=</span> <span class="n">octaves</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;Int64&#39;</span><span class="p">)</span>
        <span class="n">octaves</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">is_drum</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">octaves</span></div>

<div class="viewcode-block" id="add_quarterbeats_col"><a class="viewcode-back" href="../../reference.html#ms3.transformations.add_quarterbeats_col">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">add_quarterbeats_col</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                         <span class="n">offset_dict</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="nb">dict</span><span class="p">],</span>
                         <span class="n">interval_index</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Insert a column measuring the distance of events from MC 1 in quarter notes. If no &#39;mc_onset&#39; column is present,</span>
<span class="sd">        the column corresponds to the values given in the offset_dict..</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        DataFrame with an ``mc_playthrough`` and an ``mc_onset`` column.</span>
<span class="sd">    offset_dict : :obj:`pandas.Series` or :obj:`dict`, optional</span>
<span class="sd">        | If unfolded: {mc_playthrough -&gt; offset}</span>
<span class="sd">        | Otherwise: {mc -&gt; offset}</span>
<span class="sd">        | You can create the dict using the function :py:meth:`Parse.get_continuous_offsets()&lt;ms3.parse.Parse.get_continuous_offsets&gt;`</span>
<span class="sd">        | It is not required if the column &#39;quarterbeats&#39; exists already.</span>
<span class="sd">    interval_index : :obj:`bool`, optional</span>
<span class="sd">        Defaults to False. Pass True to replace the index with an :obj:`pandas.IntervalIndex` (depends on the successful</span>
<span class="sd">        creation of the column ``duration_qb``).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="n">has_quarterbeats</span> <span class="o">=</span> <span class="s1">&#39;quarterbeats&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">has_duration_qb</span> <span class="o">=</span> <span class="s1">&#39;duration_qb&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">has_duration</span> <span class="o">=</span> <span class="s1">&#39;duration&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">if</span> <span class="nb">sum</span><span class="p">((</span><span class="n">has_quarterbeats</span><span class="p">,</span> <span class="n">has_duration_qb</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">interval_index</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;quarterbeats&#39; and &#39;duration_qb&#39; already present, only creating IntervalIndex&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">replace_index_by_intervals</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;quarterbeats&#39; and &#39;duration_qb&#39; already present, nothing to do.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>
    <span class="k">if</span> <span class="n">offset_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_quarterbeats</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No offset_dict was passed: Not adding quarterbeats.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_duration</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not create &#39;duration_qb&#39; because no offset_dict was passed and no &#39;duration&#39; column is present.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_duration</span> <span class="ow">and</span> <span class="s1">&#39;end&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">offset_dict</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not create &#39;duration_qb&#39; because offset_dict does not contain the key &#39;end&#39;.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="n">new_cols</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">has_quarterbeats</span><span class="p">:</span>
        <span class="n">new_cols</span><span class="p">[</span><span class="s1">&#39;quarterbeats&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">quarterbeats</span>
    <span class="k">if</span> <span class="n">has_duration_qb</span><span class="p">:</span>
        <span class="n">new_cols</span><span class="p">[</span><span class="s1">&#39;duration_qb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">duration_qb</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">new_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_quarterbeats</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;mc_playthrough&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">mc_col</span> <span class="o">=</span> <span class="s1">&#39;mc_playthrough&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;mc&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">mc_col</span> <span class="o">=</span> <span class="s1">&#39;mc&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Expected to have at least one column called &#39;mc&#39; or &#39;mc_playthrough&#39;.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="n">quarterbeats</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">mc_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">offset_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;mc_onset&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">quarterbeats</span> <span class="o">+=</span> <span class="n">df</span><span class="o">.</span><span class="n">mc_onset</span> <span class="o">*</span> <span class="mi">4</span>
        <span class="n">new_cols</span><span class="p">[</span><span class="s1">&#39;quarterbeats&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">quarterbeats</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;quarterbeats&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_quarterbeats</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">has_duration_qb</span><span class="p">:</span>
        <span class="c1"># recreate duration_qb also when quarterbeats had been missing</span>
        <span class="k">if</span> <span class="s1">&#39;duration&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">new_cols</span><span class="p">[</span><span class="s1">&#39;duration_qb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">duration</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;duration_qb&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">quarterbeats</span> <span class="o">=</span> <span class="n">new_cols</span><span class="p">[</span><span class="s1">&#39;quarterbeats&#39;</span><span class="p">]</span>
            <span class="n">present_qb</span> <span class="o">=</span> <span class="n">quarterbeats</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
            <span class="n">selected_qb</span> <span class="o">=</span> <span class="n">quarterbeats</span><span class="p">[</span><span class="n">present_qb</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">qb_are_sorted</span> <span class="o">=</span> <span class="p">(</span><span class="n">selected_qb</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">selected_qb</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">qb_are_sorted</span><span class="p">:</span>
                <span class="n">unordered_index_pairs</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ix_a</span><span class="p">,</span> <span class="n">ix_b</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">ix_a</span><span class="p">,</span> <span class="n">a</span><span class="p">),</span> <span class="p">(</span><span class="n">ix_b</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">selected_qb</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">selected_qb</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="k">if</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="n">a</span><span class="p">]</span>
                <span class="n">n_problems</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unordered_index_pairs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n_problems</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">fails_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">fail</span><span class="p">]</span> <span class="k">for</span> <span class="n">fail</span> <span class="ow">in</span> <span class="n">unordered_index_pairs</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">n_problems</span><span class="p">),</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;problem&#39;</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">])</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;In the following instances the second event occurs before the first one: </span><span class="se">\n</span><span class="si">{</span><span class="n">fails_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,:</span><span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                                   <span class="sa">f</span><span class="s2">&quot;Each second row will not have a &#39;duration_qb&#39; value.&quot;</span><span class="p">,</span>
                                   <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;message_id&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">28</span><span class="p">,)})</span>
                    <span class="n">present_and_in_the_right_order</span> <span class="o">=</span> <span class="n">present_qb</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">selected_qb</span> <span class="o">&gt;</span> <span class="n">selected_qb</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">selected_qb</span> <span class="o">=</span> <span class="n">quarterbeats</span><span class="p">[</span><span class="n">present_and_in_the_right_order</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># the index changed when sorting values but only because some quarterbeats were identical</span>
                    <span class="n">qb_are_sorted</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ivs</span> <span class="o">=</span> <span class="n">make_interval_index_from_breaks</span><span class="p">(</span><span class="n">selected_qb</span><span class="p">,</span>
                                                      <span class="n">end_value</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">offset_dict</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]),</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
                <span class="n">duration_qb</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;duration_qb&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">qb_are_sorted</span><span class="p">:</span>
                    <span class="n">duration_qb</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">present_qb</span><span class="p">]</span> <span class="o">=</span> <span class="n">ivs</span><span class="o">.</span><span class="n">length</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">duration_qb</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">present_and_in_the_right_order</span><span class="p">]</span> <span class="o">=</span> <span class="n">ivs</span><span class="o">.</span><span class="n">length</span>
                <span class="n">new_cols</span><span class="p">[</span><span class="s1">&#39;duration_qb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">duration_qb</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error while creating durations from quarterbeats column. Error:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">insert_after</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;mn_playthrough&#39;</span><span class="p">,</span> <span class="s1">&#39;mc_playthrough&#39;</span><span class="p">,</span> <span class="s1">&#39;mn&#39;</span><span class="p">,</span> <span class="s1">&#39;mc&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inserting </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">new_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2"> after &#39;</span><span class="si">{</span><span class="n">insert_after</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="n">insert_position</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">insert_after</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">insert_position</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">insert_position</span><span class="p">:]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">left</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_cols</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> <span class="p">[</span><span class="n">right</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Inserted the columns </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">new_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No columns were added.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">interval_index</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;quarterbeats&#39;</span><span class="p">,</span> <span class="s1">&#39;duration_qb&#39;</span><span class="p">)):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">replace_index_by_intervals</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="add_weighted_grace_durations"><a class="viewcode-back" href="../../reference.html#ms3.transformations.add_weighted_grace_durations">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">add_weighted_grace_durations</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; For a given notes table, change the &#39;duration&#39; value of all grace notes, weighting it by ``weight``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    notes : :obj:`pandas.DataFrame`</span>
<span class="sd">        Notes table containing the columns &#39;duration&#39;, &#39;nominal_duration&#39;, &#39;scalar&#39;</span>
<span class="sd">    weight : :obj:`Fraction` or :obj:`float`</span>
<span class="sd">        Value by which to weight duration of all grace notes. Defaults to a half.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.DataFrame`</span>
<span class="sd">        Copy of ``notes`` with altered duration values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;gracenote&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">notes</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">notes</span>
    <span class="n">grace</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">gracenote</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">grace</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">notes</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">notes</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="s1">&#39;nominal_duration&#39;</span><span class="p">,</span> <span class="s1">&#39;scalar&#39;</span><span class="p">)),</span>\
        <span class="s2">&quot;Needs to contain columns &#39;duration&#39;, &#39;nominal_duration&#39;, &#39;scalar&#39;&quot;</span>
    <span class="n">gracenotes</span> <span class="o">=</span> <span class="n">notes</span><span class="p">[</span><span class="n">grace</span><span class="p">]</span>
    <span class="n">new_durations</span> <span class="o">=</span> <span class="n">gracenotes</span><span class="o">.</span><span class="n">scalar</span> <span class="o">*</span> <span class="n">gracenotes</span><span class="o">.</span><span class="n">nominal_duration</span> <span class="o">*</span> <span class="n">frac</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
    <span class="n">notes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">grace</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_durations</span>
    <span class="k">if</span> <span class="s1">&#39;duration_qb&#39;</span> <span class="ow">in</span> <span class="n">notes</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">notes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">grace</span><span class="p">,</span> <span class="s1">&#39;duration_qb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_durations</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">index</span>
        <span class="k">if</span> <span class="n">idx</span><span class="o">.</span><span class="n">nlevels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">IntervalIndex</span><span class="p">):</span>
                <span class="n">notes</span> <span class="o">=</span> <span class="n">replace_index_by_intervals</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated existing interval index.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No interval index present to be updated.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;interval&#39;</span> <span class="ow">in</span> <span class="n">idx</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="n">interval_idx_levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idx</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;interval&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">interval_idx_levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idx</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">IntervalDtype</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">interval_idx_levels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No interval index present to be updated.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">interval_idx_levels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">interval_idx_level</span> <span class="o">=</span> <span class="n">interval_idx_levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updating the IntervalIndex at level </span><span class="si">{</span><span class="n">interval_idx_level</span><span class="si">}</span><span class="s2"> (&#39;</span><span class="si">{</span><span class="n">idx</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">interval_idx_level</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;).&quot;</span><span class="p">)</span>
                <span class="n">new_iv_idx</span> <span class="o">=</span> <span class="n">make_interval_index_from_durations</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
                <span class="n">idx_df</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
                <span class="n">idx_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">interval_idx_level</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_iv_idx</span>
                <span class="n">notes</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_frame</span><span class="p">(</span><span class="n">idx_df</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">idx</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found several IntervalIndex levels, none of which is called &#39;interval&#39;.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">notes</span></div>


<div class="viewcode-block" id="compute_chord_tones"><a class="viewcode-back" href="../../reference.html#ms3.transformations.compute_chord_tones">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">compute_chord_tones</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">bass_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the chord tones for DCML harmony labels. They are returned as lists</span>
<span class="sd">    of tonal pitch classes in close position, starting with the bass note. The</span>
<span class="sd">    tonal pitch classes represent intervals relative to the local tonic:</span>

<span class="sd">    -2: Second below tonic</span>
<span class="sd">    -1: fifth below tonic</span>
<span class="sd">    0: tonic</span>
<span class="sd">    1: fifth above tonic</span>
<span class="sd">    2: second above tonic, etc.</span>

<span class="sd">    The labels need to have undergone :py:func:`split_labels` and :py:func:`propagate_keys`.</span>
<span class="sd">    Pedal points are not taken into account.</span>

<span class="sd">    Uses: :py:func:`features2tpcs`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        Dataframe containing DCML chord labels that have been split by split_labels()</span>
<span class="sd">        and where the keys have been propagated using propagate_keys(add_bool=True).</span>
<span class="sd">    bass_only : :obj:`bool`, optional</span>
<span class="sd">        Pass True if you need only the bass note.</span>
<span class="sd">    expand : :obj:`bool`, optional</span>
<span class="sd">        Pass True if you need chord tones and added tones in separate columns.</span>
<span class="sd">    cols : :obj:`dict`, optional</span>
<span class="sd">        In case the column names for ``[&#39;mc&#39;, &#39;numeral&#39;, &#39;form&#39;, &#39;figbass&#39;, &#39;changes&#39;, &#39;relativeroot&#39;, &#39;localkey&#39;, &#39;globalkey&#39;]`` deviate, pass a dict, such as</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            {&#39;mc&#39;:              &#39;mc&#39;,</span>
<span class="sd">             &#39;numeral&#39;:         &#39;numeral_col_name&#39;,</span>
<span class="sd">             &#39;form&#39;:            &#39;form_col_name&#39;,</span>
<span class="sd">             &#39;figbass&#39;:         &#39;figbass_col_name&#39;,</span>
<span class="sd">             &#39;changes&#39;:         &#39;changes_col_name&#39;,</span>
<span class="sd">             &#39;relativeroot&#39;:    &#39;relativeroot_col_name&#39;,</span>
<span class="sd">             &#39;localkey&#39;:        &#39;localkey_col_name&#39;,</span>
<span class="sd">             &#39;globalkey&#39;:       &#39;globalkey_col_name&#39;}</span>

<span class="sd">        You may also deactivate columns by setting them to None, e.g. {&#39;changes&#39;: None}</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.Series` or :obj:`pandas.DataFrame`</span>
<span class="sd">        For every row of `df` one tuple with chord tones, expressed as tonal pitch classes.</span>
<span class="sd">        If `expand` is True, the function returns a DataFrame with four columns:</span>
<span class="sd">        Two with tuples for chord tones and added tones, one with the chord root,</span>
<span class="sd">        and one with the bass note.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1">### If the index is not unique, it has to be temporarily replaced</span>
    <span class="n">tmp_index</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_unique</span>
    <span class="k">if</span> <span class="n">tmp_index</span><span class="p">:</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
        <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;numeral&#39;</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="s1">&#39;figbass&#39;</span><span class="p">,</span> <span class="s1">&#39;changes&#39;</span><span class="p">,</span> <span class="s1">&#39;relativeroot&#39;</span><span class="p">,</span> <span class="s1">&#39;localkey&#39;</span><span class="p">,</span> <span class="s1">&#39;globalkey&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span>
    <span class="n">local_minor</span><span class="p">,</span> <span class="n">global_minor</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;localkey&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_is_minor&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;globalkey&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_is_minor&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">local_minor</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">local_minor</span><span class="p">]</span> <span class="o">=</span> <span class="n">series_is_minor</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;localkey&#39;</span><span class="p">]],</span> <span class="n">is_name</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Boolean column &#39;</span><span class="si">{</span><span class="n">local_minor</span><span class="si">}</span><span class="s2">&#39; created.&#39;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">global_minor</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">global_minor</span><span class="p">]</span> <span class="o">=</span> <span class="n">series_is_minor</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;globalkey&#39;</span><span class="p">]],</span> <span class="n">is_name</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Boolean column &#39;</span><span class="si">{</span><span class="n">global_minor</span><span class="si">}</span><span class="s2">&#39; created.&#39;&quot;</span><span class="p">)</span>

    <span class="n">param_cols</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;numeral&#39;</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="s1">&#39;figbass&#39;</span><span class="p">,</span> <span class="s1">&#39;changes&#39;</span><span class="p">,</span> <span class="s1">&#39;relativeroot&#39;</span><span class="p">,</span> <span class="s1">&#39;mc&#39;</span><span class="p">]</span> <span class="k">if</span>
                  <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span> <span class="ow">and</span> <span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
    <span class="n">param_cols</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_minor</span>
    <span class="n">param_tuples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">param_cols</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
    <span class="c1"># result_dict = {t: features2tpcs(**{a:b for a, b in zip(param_cols.keys(), t)}, bass_only=bass_only, merge_tones=not expand, logger=logger) for t in set(param_tuples)}</span>
    <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">bass_only</span><span class="p">:</span>
        <span class="n">default</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">expand</span><span class="p">:</span>
        <span class="n">default</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">default</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;chord_tones&#39;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(),</span>
            <span class="s1">&#39;added_tones&#39;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(),</span>
            <span class="s1">&#39;root&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">param_tuples</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result_dict</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">features2tpcs</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">param_cols</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">t</span><span class="p">)},</span> <span class="n">bass_only</span><span class="o">=</span><span class="n">bass_only</span><span class="p">,</span> <span class="n">merge_tones</span><span class="o">=</span><span class="ow">not</span> <span class="n">expand</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">result_dict</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">default</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">expand</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">result_dict</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">param_tuples</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;bass_note&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">chord_tones</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">res</span><span class="p">[[</span><span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="s1">&#39;bass_note&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[[</span><span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="s1">&#39;bass_note&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;Int64&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">result_dict</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">param_tuples</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tmp_index</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ix</span>

    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="dfs2quarterbeats"><a class="viewcode-back" href="../../reference.html#ms3.transformations.dfs2quarterbeats">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">dfs2quarterbeats</span><span class="p">(</span><span class="n">dfs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]],</span>
                     <span class="n">measures</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">unfold</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">quarterbeats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interval_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Pass one or several DataFrames and one measures table to unfold repeats and/or add quarterbeats columns and/or index.</span>

<span class="sd">    Args:</span>
<span class="sd">      dfs: DataFrame(s) that are to be unfolded and/or receive quarterbeats.</span>
<span class="sd">      measures:</span>
<span class="sd">      unfold:</span>
<span class="sd">      quarterbeats:</span>
<span class="sd">      interval_index:</span>

<span class="sd">    Returns:</span>
<span class="sd">      Altered copies of `dfs`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">sum</span><span class="p">((</span><span class="n">unfold</span><span class="p">,</span> <span class="n">quarterbeats</span><span class="p">,</span> <span class="n">interval_index</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;At least one of the &#39;unfold&#39;, &#39;quarterbeats&#39;, and &#39;interval_index&#39; arguments needs to be True.&quot;</span>
    <span class="k">assert</span> <span class="n">measures</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;measures cannot be None&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">dfs</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">interval_index</span><span class="p">:</span>
        <span class="n">quarterbeats</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">unfold</span><span class="p">:</span>
        <span class="n">playthrough_info</span> <span class="o">=</span> <span class="n">make_playthrough_info</span><span class="p">(</span><span class="n">measures</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">playthrough_info</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">playthrough_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unfolding not possible because of incorrect repeat structure.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">unfold</span><span class="p">:</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">unfold_repeats</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">playthrough_info</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span> <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">df</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">quarterbeats</span><span class="p">:</span>
            <span class="n">unfolded_measures</span> <span class="o">=</span> <span class="n">unfold_repeats</span><span class="p">(</span><span class="n">measures</span><span class="p">,</span> <span class="n">playthrough_info</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
            <span class="n">continuous_offset</span> <span class="o">=</span> <span class="n">make_continuous_offset_series</span><span class="p">(</span><span class="n">unfolded_measures</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
            <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">add_quarterbeats_col</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">continuous_offset</span><span class="p">,</span> <span class="n">interval_index</span><span class="o">=</span><span class="n">interval_index</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
                   <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">df</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">quarterbeats</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;volta&#39;</span> <span class="ow">in</span> <span class="n">measures</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No quarterbeats are assigned to first endings. Pass unfold=True to &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;compute quarterbeats for a full playthrough.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">3</span> <span class="ow">in</span> <span class="n">measures</span><span class="o">.</span><span class="n">volta</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Piece contains third endings, note that only second endings are taken into account.&quot;</span><span class="p">)</span>
            <span class="n">measures</span> <span class="o">=</span> <span class="n">measures</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">measures</span><span class="p">[</span><span class="n">measures</span><span class="o">.</span><span class="n">volta</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;volta&#39;</span><span class="p">)</span>
        <span class="n">continuous_offset</span> <span class="o">=</span> <span class="n">make_continuous_offset_series</span><span class="p">(</span><span class="n">measures</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">dfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">add_quarterbeats_col</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">continuous_offset</span><span class="p">,</span> <span class="n">interval_index</span><span class="o">=</span><span class="n">interval_index</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
               <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">df</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">dfs</span></div>


<div class="viewcode-block" id="get_chord_sequences"><a class="viewcode-back" href="../../reference.html#ms3.transformations.get_chord_sequences">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">get_chord_sequences</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">major_minor</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;chord&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Transforms an annotation table into lists of chord symbols for n-gram analysis. If your table represents</span>
<span class="sd">    several pieces, make sure to pass the groupby parameter ``level`` to avoid including inexistent transitions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    at : :obj:`pandas.DataFrame`</span>
<span class="sd">        Annotation table.</span>
<span class="sd">    major_minor : :obj:`bool`, optional</span>
<span class="sd">        | Defaults to True: the length of the chord sequences corresponds to localkey segments. The result comes as dict of dicts.</span>
<span class="sd">        | If you pass False, chord sequences are returned as they are, potentially including incorrect transitions, e.g., when</span>
<span class="sd">          the localkey changes. The result comes as list of lists, where the sublists result from the groupby if you specified ``level``.</span>
<span class="sd">    level : :obj:`int` or :obj:`list`</span>
<span class="sd">        Argument passed to :py:meth:`pandas.DataFrame.groupby`. Defaults to -1, resulting in a GroupBy by all levels</span>
<span class="sd">        except the last. Conversely, you can pass, for instance, 2 to group by the first two levels.</span>
<span class="sd">    column : :obj:`str`</span>
<span class="sd">        Name of the column containing the chord symbols that compose the sequences.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`dict` of :obj:`dict` or :obj:`list` of :obj:`list`</span>
<span class="sd">        | If ``major_minor`` is True, the sequences are returned as {:obj:`int` -&gt; {&#39;localkey&#39; -&gt; :obj:`str`, &#39;localkey_is_minor&#39; -&gt; :obj:`bool`, &#39;sequence&#39; -&gt; :obj:`list`} }</span>
<span class="sd">        | If False, the sequences are returned as a list of lists</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">major_minor</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;key_segment&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The DataFrame does not include the column &#39;key_segment&#39; which is used for processing localkey segments. &quot;</span>
                        <span class="s2">&quot;If you need to access the regions, add the column using transform_multiple(df, &#39;key_segment&#39;)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">at</span> <span class="o">=</span> <span class="n">transform_multiple</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="s1">&#39;key_segment&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">at</span> <span class="o">=</span> <span class="n">add_localkey_change_column</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;key_segment&#39;</span><span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sequence</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;localkey&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">localkey</span><span class="p">,</span>
                <span class="s1">&#39;localkey_is_minor&#39;</span><span class="p">:</span> <span class="n">row</span><span class="o">.</span><span class="n">localkey_is_minor</span><span class="p">,</span>
                <span class="s1">&#39;sequence&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
            <span class="p">}</span>
            <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sequence</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">levels</span> <span class="o">=</span> <span class="n">_treat_level_parameter</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">at</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">nlevels</span><span class="p">)</span>
            <span class="n">sequences</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">levels</span><span class="p">)[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sequences</span> <span class="o">=</span> <span class="p">[</span><span class="n">at</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">sequences</span></div>


<div class="viewcode-block" id="group_annotations_by_features"><a class="viewcode-back" href="../../reference.html#ms3.transformations.group_annotations_by_features">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">group_annotations_by_features</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="s1">&#39;numeral&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Drop exact repetitions of one or several feature columns when occurring under the same localkey (and pedal point).</span>
<span class="sd">    For example, pass ``features = [&#39;numeral&#39;, &#39;form&#39;, &#39;figbass&#39;]`` to drop rows where all three features are identical</span>
<span class="sd">    with the previous row _and_ the localkey stays the same. If the column ``duration_qb`` is present, it is updated</span>
<span class="sd">    with the new durations, as would be the IntervalIndex if there is one.</span>
<span class="sd">    Uses: nan_eq()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    at : :obj:`pandas.DataFrame`</span>
<span class="sd">        Annotation table</span>
<span class="sd">    features : :obj:`str` or :obj:`list`</span>
<span class="sd">        Feature or feature combination for which to remove immediate repetitions</span>
<span class="sd">    dropna : :obj:`bool`</span>
<span class="sd">        Also subsumes rows for which all ``features`` are NaN, rather than treating them as a new value.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.DataFrame`</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>

<span class="sd">    &gt;&gt;&gt; df</span>
<span class="sd">    +--------------+--------------+-------------+----------+---------------+---------+------+---------+---------+--------------+</span>
<span class="sd">    |              | quarterbeats | duration_qb | localkey | chord         | numeral | form | figbass | changes | relativeroot |</span>
<span class="sd">    +==============+==============+=============+==========+===============+=========+======+=========+=========+==============+</span>
<span class="sd">    | [37.5, 38.5) | 75/2         | 1.0         | I        | viio65(6b3)/V | vii     | o    | 65      | 6b3     | V            |</span>
<span class="sd">    +--------------+--------------+-------------+----------+---------------+---------+------+---------+---------+--------------+</span>
<span class="sd">    | [38.5, 40.5) | 77/2         | 2.0         | I        | Ger           | vii     | o    | 65      | b3      | V            |</span>
<span class="sd">    +--------------+--------------+-------------+----------+---------------+---------+------+---------+---------+--------------+</span>
<span class="sd">    | [40.5, 41.5) | 81/2         | 1.0         | I        | V(7v4)        | V       |      |         | 7v4     |              |</span>
<span class="sd">    +--------------+--------------+-------------+----------+---------------+---------+------+---------+---------+--------------+</span>
<span class="sd">    | [41.5, 43.5) | 83/2         | 2.0         | I        | V(64)         | V       |      |         | 64      |              |</span>
<span class="sd">    +--------------+--------------+-------------+----------+---------------+---------+------+---------+---------+--------------+</span>
<span class="sd">    | [43.5, 44.5) | 87/2         | 1.0         | I        | V7(9)         | V       |      | 7       | 9       |              |</span>
<span class="sd">    +--------------+--------------+-------------+----------+---------------+---------+------+---------+---------+--------------+</span>
<span class="sd">    | [44.5, 46.5) | 89/2         | 2.0         | I        | V7            | V       |      | 7       |         |              |</span>
<span class="sd">    +--------------+--------------+-------------+----------+---------------+---------+------+---------+---------+--------------+</span>
<span class="sd">    | [46.5, 48.0) | 93/2         | 1.5         | I        | I             | I       |      |         |         |              |</span>
<span class="sd">    +--------------+--------------+-------------+----------+---------------+---------+------+---------+---------+--------------+</span>

<span class="sd">    &gt;&gt;&gt; group_annotations_by_features(df)</span>
<span class="sd">    +--------------+--------------+-------------+----------+--------------+---------+-------+</span>
<span class="sd">    |              | quarterbeats | duration_qb | localkey | relativeroot | numeral | chord |</span>
<span class="sd">    +==============+==============+=============+==========+==============+=========+=======+</span>
<span class="sd">    | [37.5, 40.5) | 75/2         | 3.0         | I        | V            | vii     | vii/V |</span>
<span class="sd">    +--------------+--------------+-------------+----------+--------------+---------+-------+</span>
<span class="sd">    | [40.5, 46.5) | 81/2         | 6.0         | I        | NaN          | V       | V     |</span>
<span class="sd">    +--------------+--------------+-------------+----------+--------------+---------+-------+</span>
<span class="sd">    | [46.5, 48.0) | 93/2         | 1.5         | I        | NaN          | I       | I     |</span>
<span class="sd">    +--------------+--------------+-------------+----------+--------------+---------+-------+</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">features</span><span class="p">]</span>
    <span class="n">qb_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;quarterbeats&#39;</span><span class="p">,</span> <span class="s1">&#39;duration_qb&#39;</span><span class="p">]</span>
    <span class="n">safety_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;globalkey&#39;</span><span class="p">,</span> <span class="s1">&#39;localkey&#39;</span><span class="p">,</span> <span class="s1">&#39;pedal&#39;</span><span class="p">]</span> <span class="c1"># if present, these prevent grouping because they change meaning</span>
    <span class="n">keep_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;mn&#39;</span><span class="p">,</span> <span class="s1">&#39;mc_onset&#39;</span><span class="p">,</span> <span class="s1">&#39;mn_onset&#39;</span><span class="p">,</span> <span class="s1">&#39;timesig&#39;</span><span class="p">,</span> <span class="s1">&#39;staff&#39;</span><span class="p">,</span> <span class="s1">&#39;voice&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;volta&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;globalkey&#39;</span><span class="p">,</span> <span class="s1">&#39;localkey&#39;</span><span class="p">,</span> <span class="s1">&#39;globalkey_is_minor&#39;</span><span class="p">,</span> <span class="s1">&#39;localkey_is_minor&#39;</span><span class="p">,</span> <span class="s1">&#39;special&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;pedal&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;numeral&#39;</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
        <span class="n">safety_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;relativeroot&#39;</span><span class="p">)</span>
        <span class="n">keep_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;relativeroot&#39;</span><span class="p">)</span>
    <span class="n">safety</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">safety_cols</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">features</span> <span class="ow">and</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features</span> <span class="o">+</span> <span class="n">safety</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DataFrame has no column called </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features</span> <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">at</span>


    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">qb_cols</span><span class="p">):</span>
        <span class="n">na_values</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ffill&#39;</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;numeral&#39;</span> <span class="k">else</span> <span class="s1">&#39;group&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grouping with the following na_values settings: </span><span class="si">{</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span><span class="w"> </span><span class="n">na_values</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">segment_by_adjacency_groups</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">na_values</span><span class="o">=</span><span class="n">na_values</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">keep_cols</span> <span class="o">=</span> <span class="n">qb_cols</span> <span class="o">+</span> <span class="n">keep_cols</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">column_shift_mask</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Sets those values of Series a to True where a value in the Series b is different from its predecessor.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">a</span> <span class="o">|</span> <span class="o">~</span><span class="n">nan_eq</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span>
        <span class="c1"># The change mask is True for every row where either of the feature or safety columns is different from its previous value.</span>
        <span class="n">change_mask</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">column_shift_mask</span><span class="p">,</span>
                             <span class="p">(</span><span class="n">col</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">at</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
                             <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">at</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">at</span><span class="p">[</span><span class="n">change_mask</span><span class="p">]</span>
    <span class="n">keep_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">keep_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">+</span> <span class="n">features</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">keep_cols</span><span class="p">]</span>
    <span class="n">chord_components</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span>
                        <span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="s1">&#39;bass_note&#39;</span><span class="p">,</span> <span class="s1">&#39;root_name&#39;</span><span class="p">,</span> <span class="s1">&#39;bass_note_name&#39;</span><span class="p">,</span> <span class="s1">&#39;numeral&#39;</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="s1">&#39;chord_type&#39;</span><span class="p">,</span> <span class="s1">&#39;figbass&#39;</span><span class="p">,</span> <span class="s1">&#39;changes&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;numeral&#39;</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">chord_components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;relativeroot&#39;</span><span class="p">)</span>
    <span class="n">chord_col</span> <span class="o">=</span> <span class="n">make_chord_col</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">chord_components</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">res</span><span class="p">,</span> <span class="n">chord_col</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;numeral&#39;</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">res</span><span class="p">,</span> <span class="n">compute_chord_tones</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="labels2global_tonic"><a class="viewcode-back" href="../../reference.html#ms3.transformations.labels2global_tonic">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">labels2global_tonic</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="p">{},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transposes all numerals to their position in the global major or minor scale.</span>
<span class="sd">    This eliminates localkeys and relativeroots. The resulting chords are defined</span>
<span class="sd">    by [`numeral`, `figbass`, `changes`, `globalkey_is_minor`] (and `pedal`).</span>

<span class="sd">    Uses: :py:func:`transform`, :py:func:`rel2abs_key^, :py:func:`resolve_relative_keys` -&gt; :py:func:`str_is_minor()`</span>
<span class="sd">    :py:func:`transpose_changes`, :py:func:`series_is_minor`,</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        Dataframe containing DCML chord labels that have been split by split_labels()</span>
<span class="sd">        and where the keys have been propagated using propagate_keys(add_bool=True).</span>
<span class="sd">    cols : :obj:`dict`, optional</span>
<span class="sd">        In case the column names for ``[&#39;numeral&#39;, &#39;form&#39;, &#39;figbass&#39;, &#39;changes&#39;, &#39;relativeroot&#39;, &#39;localkey&#39;, &#39;globalkey&#39;]`` deviate, pass a dict, such as</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            {&#39;chord&#39;:           &#39;chord_col_name&#39;</span>
<span class="sd">             &#39;pedal&#39;:           &#39;pedal_col_name&#39;,</span>
<span class="sd">             &#39;numeral&#39;:         &#39;numeral_col_name&#39;,</span>
<span class="sd">             &#39;form&#39;:            &#39;form_col_name&#39;,</span>
<span class="sd">             &#39;figbass&#39;:         &#39;figbass_col_name&#39;,</span>
<span class="sd">             &#39;changes&#39;:         &#39;changes_col_name&#39;,</span>
<span class="sd">             &#39;relativeroot&#39;:    &#39;relativeroot_col_name&#39;,</span>
<span class="sd">             &#39;localkey&#39;:        &#39;localkey_col_name&#39;,</span>
<span class="sd">             &#39;globalkey&#39;:       &#39;globalkey_col_name&#39;}}</span>

<span class="sd">    inplace : :obj:`bool`, optional</span>
<span class="sd">        Pass True if you want to mutate the input.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.DataFrame`</span>
<span class="sd">        If `inplace=False`, the relevant features of the transposed chords are returned.</span>
<span class="sd">        Otherwise, the original DataFrame is mutated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1">### If the index is not unique, it has to be temporarily replaced</span>
    <span class="n">tmp_index</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_unique</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">interval</span><span class="o">.</span><span class="n">IntervalIndex</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tmp_index</span><span class="p">:</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
        <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chord&#39;</span><span class="p">,</span> <span class="s1">&#39;pedal&#39;</span><span class="p">,</span> <span class="s1">&#39;numeral&#39;</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="s1">&#39;figbass&#39;</span><span class="p">,</span> <span class="s1">&#39;changes&#39;</span><span class="p">,</span> <span class="s1">&#39;relativeroot&#39;</span><span class="p">,</span> <span class="s1">&#39;localkey&#39;</span><span class="p">,</span> <span class="s1">&#39;globalkey&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span>
    <span class="n">local_minor</span><span class="p">,</span> <span class="n">global_minor</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;localkey&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_is_minor&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;globalkey&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_is_minor&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">local_minor</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">local_minor</span><span class="p">]</span> <span class="o">=</span> <span class="n">series_is_minor</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;localkey&#39;</span><span class="p">]],</span> <span class="n">is_name</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Boolean column &#39;</span><span class="si">{</span><span class="n">local_minor</span><span class="si">}</span><span class="s2"> created.&#39;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">global_minor</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">global_minor</span><span class="p">]</span> <span class="o">=</span> <span class="n">series_is_minor</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;globalkey&#39;</span><span class="p">]],</span> <span class="n">is_name</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Boolean column &#39;</span><span class="si">{</span><span class="n">global_minor</span><span class="si">}</span><span class="s2"> created.&#39;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;localkey&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cols</span><span class="p">[</span><span class="s1">&#39;localkey&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">resolve_relative_keys</span><span class="p">,</span> <span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;localkey&#39;</span><span class="p">],</span> <span class="n">global_minor</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;pedal&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cols</span><span class="p">[</span><span class="s1">&#39;pedal&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">resolve_relative_keys</span><span class="p">,</span> <span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;pedal&#39;</span><span class="p">],</span> <span class="n">local_minor</span><span class="p">])</span>

    <span class="c1"># Express pedals in relation to the global tonic</span>
    <span class="n">param_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pedal&#39;</span><span class="p">,</span> <span class="s1">&#39;localkey&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">global_minor</span><span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cols</span><span class="p">[</span><span class="s1">&#39;pedal&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">rel2abs_key</span><span class="p">,</span> <span class="n">param_cols</span><span class="p">)</span>

    <span class="c1"># Make relativeroots to local keys</span>
    <span class="n">param_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;relativeroot&#39;</span><span class="p">,</span> <span class="s1">&#39;localkey&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">local_minor</span><span class="p">,</span> <span class="n">global_minor</span><span class="p">]</span>
    <span class="n">relativeroots</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;relativeroot&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">notna</span><span class="p">(),</span> <span class="n">param_cols</span><span class="p">]</span>
    <span class="n">rr_tuples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">relativeroots</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
    <span class="n">transposed_rr</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">localkey</span><span class="p">,</span> <span class="n">local_minor</span><span class="p">,</span> <span class="n">global_minor</span><span class="p">):</span> <span class="n">rel2abs_key</span><span class="p">(</span><span class="n">resolve_relative_keys</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">local_minor</span><span class="p">),</span> <span class="n">localkey</span><span class="p">,</span>
                                                               <span class="n">global_minor</span><span class="p">)</span> <span class="k">for</span>
        <span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">localkey</span><span class="p">,</span> <span class="n">local_minor</span><span class="p">,</span> <span class="n">global_minor</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">rr_tuples</span><span class="p">)}</span>
    <span class="n">transposed_rr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">((</span><span class="n">transposed_rr</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">rr_tuples</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">relativeroots</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">relativeroots</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cols</span><span class="p">[</span><span class="s1">&#39;localkey&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">transposed_rr</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">relativeroots</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">local_minor</span><span class="p">]</span> <span class="o">=</span> <span class="n">series_is_minor</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">relativeroots</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cols</span><span class="p">[</span><span class="s1">&#39;localkey&#39;</span><span class="p">]])</span>

    <span class="c1"># Express numerals in relation to the global tonic</span>
    <span class="n">param_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;numeral&#39;</span><span class="p">,</span> <span class="s1">&#39;localkey&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">global_minor</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;abs_numeral&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">rel2abs_key</span><span class="p">,</span> <span class="n">param_cols</span><span class="p">)</span>

    <span class="c1"># Transpose changes to be valid with the new numeral</span>
    <span class="n">param_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;changes&#39;</span><span class="p">,</span> <span class="s1">&#39;numeral&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;abs_numeral&#39;</span><span class="p">,</span> <span class="n">local_minor</span><span class="p">,</span> <span class="n">global_minor</span><span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cols</span><span class="p">[</span><span class="s1">&#39;changes&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">transpose_changes</span><span class="p">,</span> <span class="n">param_cols</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>

    <span class="c1"># Combine the new chord features</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cols</span><span class="p">[</span><span class="s1">&#39;chord&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">abs_numeral</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">figbass</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span>
                <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">changes</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1"># + (&#39;/&#39; + df.relativeroot).fillna(&#39;&#39;)</span>

    <span class="k">if</span> <span class="n">tmp_index</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ix</span>

    <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;numeral&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">abs_numeral</span>
        <span class="n">drop_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;localkey&#39;</span><span class="p">,</span> <span class="s1">&#39;relativeroot&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;abs_numeral&#39;</span><span class="p">,</span> <span class="n">local_minor</span><span class="p">]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">drop_cols</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;abs_numeral&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="s1">&#39;figbass&#39;</span><span class="p">,</span> <span class="s1">&#39;changes&#39;</span><span class="p">,</span> <span class="s1">&#39;globalkey&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">global_minor</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">res_cols</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;abs_numeral&#39;</span><span class="p">:</span> <span class="n">cols</span><span class="p">[</span><span class="s1">&#39;numeral&#39;</span><span class="p">]})</span>
        <span class="k">return</span> <span class="n">res</span></div>


<span class="k">def</span> <span class="nf">make_chord_col</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;numeral&#39;</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="s1">&#39;figbass&#39;</span><span class="p">,</span> <span class="s1">&#39;changes&#39;</span><span class="p">,</span> <span class="s1">&#39;relativeroot&#39;</span><span class="p">]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">summing_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;changes&#39;</span><span class="p">,</span> <span class="s1">&#39;relativeroot&#39;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">summing_cols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">chord_col</span> <span class="o">=</span> <span class="n">at</span><span class="p">[</span><span class="n">summing_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chord_col</span> <span class="o">=</span> <span class="n">at</span><span class="p">[</span><span class="n">summing_cols</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;changes&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">chord_col</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">at</span><span class="o">.</span><span class="n">changes</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;relativeroot&#39;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">chord_col</span> <span class="o">+=</span> <span class="p">(</span><span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">at</span><span class="o">.</span><span class="n">relativeroot</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chord_col</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;chord&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="make_gantt_data"><a class="viewcode-back" href="../../reference.html#ms3.transformations.make_gantt_data">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">make_gantt_data</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">last_mn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">relativeroots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode_agnostic_adjacency</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Takes an expanded DCML annotation table and returns a DataFrame with timings of the included key segments,</span>
<span class="sd">    based on the column ``localkey``. The column names are suited for the plotly library.</span>
<span class="sd">    Uses: rel2abs_key, resolve_relative_keys, roman_numeral2fifths roman_numerals2semitones, labels2global_tonic</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    at : :obj:`pandas.DataFrame`</span>
<span class="sd">        Expanded DCML annotation table.</span>
<span class="sd">    last_mn : :obj:`int`, optional</span>
<span class="sd">        By default, the column ``quarterbeats`` is used for computing Start and Finish unless the column is not present,</span>
<span class="sd">        in which case a continuous version of measure numbers (MN) is used. In the latter case you should pass the last</span>
<span class="sd">        measure number of the piece in order to calculate the correct duration of the last key segment; otherwise it</span>
<span class="sd">        will go until the end of the last label&#39;s MN. As soon as you pass a value, the column ``quarterbeats`` is ignored</span>
<span class="sd">        even if present. If you want to ignore it but don&#39;t know the last MN, pass -1.</span>
<span class="sd">    relativeroots : :obj:`bool`, optional</span>
<span class="sd">        By default, additional rows are added based on the column ``relativeroot``. Pass False to prevent that.</span>
<span class="sd">    mode_agnostic_adjacency : :obj:`bool`, optional</span>
<span class="sd">        By default (if ``relativeroots`` is True), additional rows are added for labels adjacent to temporarily tonicized</span>
<span class="sd">        roots, no matter if the mode is identical or not. For example, before and after a V/V, all V _and_ v labels will</span>
<span class="sd">        be grouped as adjacent segments. Pass False to group only labels with the same mode (only V labels in the example),</span>
<span class="sd">        or None to include no adjacency at all.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">at</span> <span class="o">=</span> <span class="n">at</span><span class="p">[</span><span class="n">at</span><span class="o">.</span><span class="n">numeral</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">numeral</span> <span class="o">!=</span> <span class="s1">&#39;@none&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">last_mn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="s1">&#39;quarterbeats&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">position_col</span> <span class="o">=</span> <span class="s1">&#39;mn_fraction&#39;</span>
        <span class="k">if</span> <span class="n">last_mn</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">last_mn</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">last_mn</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">mn</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">last_val</span> <span class="o">=</span> <span class="n">last_mn</span> <span class="o">+</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="s1">&#39;mn_fraction&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">mn_fraction</span> <span class="o">=</span> <span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">mn</span> <span class="o">+</span> <span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">mn_onset</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="n">at</span><span class="o">.</span><span class="n">timesig</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">frac</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;mn&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;mn_fraction&#39;</span><span class="p">,</span> <span class="n">mn_fraction</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">position_col</span> <span class="o">=</span> <span class="s1">&#39;quarterbeats&#39;</span>
        <span class="n">at</span> <span class="o">=</span> <span class="n">at</span><span class="p">[</span><span class="n">at</span><span class="o">.</span><span class="n">quarterbeats</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">at</span><span class="o">.</span><span class="n">quarterbeats</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">quarterbeats</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">last_label</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">last_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">last_label</span><span class="o">.</span><span class="n">quarterbeats</span><span class="p">)</span> <span class="o">+</span> <span class="n">last_label</span><span class="o">.</span><span class="n">duration_qb</span>

    <span class="n">check_columns</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;localkey&#39;</span><span class="p">,</span> <span class="s1">&#39;globalkey_is_minor&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">check_columns</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Annotation table is missing the columns </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">check_columns</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">at</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">. Cannot make Gantt data&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="n">at</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">position_col</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">at</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">make_interval_index_from_breaks</span><span class="p">(</span><span class="n">at</span><span class="p">[</span><span class="n">position_col</span><span class="p">],</span> <span class="n">end_value</span><span class="o">=</span><span class="n">last_val</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>

    <span class="n">at</span><span class="p">[</span><span class="s1">&#39;localkey_resolved&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">resolve_relative_keys</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;localkey&#39;</span><span class="p">,</span> <span class="s1">&#39;globalkey_is_minor&#39;</span><span class="p">])</span>

    <span class="n">key_groups</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">at</span><span class="o">.</span><span class="n">localkey</span> <span class="o">!=</span> <span class="n">at</span><span class="o">.</span><span class="n">localkey</span><span class="o">.</span><span class="n">shift</span><span class="p">(),</span> <span class="p">[</span><span class="n">position_col</span><span class="p">,</span> <span class="s1">&#39;localkey&#39;</span><span class="p">,</span> <span class="s1">&#39;localkey_resolved&#39;</span><span class="p">,</span> <span class="s1">&#39;globalkey&#39;</span><span class="p">,</span>
                                                             <span class="s1">&#39;globalkey_is_minor&#39;</span><span class="p">]]</span> \
        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">position_col</span><span class="p">:</span> <span class="s1">&#39;Start&#39;</span><span class="p">})</span>
    <span class="n">iix</span> <span class="o">=</span> <span class="n">make_interval_index_from_breaks</span><span class="p">(</span><span class="n">key_groups</span><span class="o">.</span><span class="n">Start</span><span class="p">,</span> <span class="n">end_value</span><span class="o">=</span><span class="n">last_val</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">key_groups</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">iix</span>
    <span class="n">fifths</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">key_groups</span><span class="p">,</span> <span class="n">roman_numeral2fifths</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;localkey_resolved&#39;</span><span class="p">,</span> <span class="s1">&#39;globalkey_is_minor&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;fifths&#39;</span><span class="p">)</span>
    <span class="n">semitones</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">key_groups</span><span class="p">,</span> <span class="n">roman_numeral2semitones</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;localkey_resolved&#39;</span><span class="p">,</span> <span class="s1">&#39;globalkey_is_minor&#39;</span><span class="p">],</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="s1">&#39;semitones&#39;</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;Duration: &#39;</span> <span class="o">+</span> <span class="n">iix</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> \
                  <span class="s1">&#39;&lt;br&gt;Tonicized global scale degree: &#39;</span> <span class="o">+</span> <span class="n">key_groups</span><span class="o">.</span><span class="n">localkey_resolved</span> <span class="o">+</span> \
                  <span class="s1">&#39;&lt;br&gt;Local tonic: &#39;</span> <span class="o">+</span> <span class="n">key_groups</span><span class="o">.</span><span class="n">localkey</span>

    <span class="n">key_groups</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Start&#39;</span><span class="p">:</span> <span class="n">key_groups</span><span class="o">.</span><span class="n">Start</span><span class="p">,</span>
        <span class="s1">&#39;Finish&#39;</span><span class="p">:</span> <span class="n">iix</span><span class="o">.</span><span class="n">right</span><span class="p">,</span>
        <span class="s1">&#39;Duration&#39;</span><span class="p">:</span> <span class="n">iix</span><span class="o">.</span><span class="n">length</span><span class="p">,</span>
        <span class="s1">&#39;Resource&#39;</span><span class="p">:</span> <span class="s1">&#39;local&#39;</span><span class="p">,</span>
        <span class="s1">&#39;abs_numeral&#39;</span><span class="p">:</span> <span class="n">key_groups</span><span class="o">.</span><span class="n">localkey_resolved</span><span class="p">,</span>
        <span class="s1">&#39;fifths&#39;</span><span class="p">:</span> <span class="n">fifths</span><span class="p">,</span>
        <span class="s1">&#39;semitones&#39;</span><span class="p">:</span> <span class="n">semitones</span><span class="p">,</span>
        <span class="s1">&#39;localkey&#39;</span><span class="p">:</span> <span class="n">key_groups</span><span class="o">.</span><span class="n">localkey</span><span class="p">,</span>
        <span class="s1">&#39;globalkey&#39;</span><span class="p">:</span> <span class="n">key_groups</span><span class="o">.</span><span class="n">globalkey</span><span class="p">,</span>
        <span class="s1">&#39;Description&#39;</span><span class="p">:</span> <span class="n">description</span>
    <span class="p">})</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">relativeroots</span> <span class="ow">or</span> <span class="n">at</span><span class="o">.</span><span class="n">relativeroot</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">key_groups</span>

    <span class="n">levels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">nlevels</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">select_groups</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">levels</span>
        <span class="n">has_applied</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">has_applied</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">df</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;tonic of adjacent applied chord(s)&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># relativeroot gets filled in with numeral because it is needed for the Description. However, if mode_agnostic_adjacency=True,</span>
            <span class="c1"># only the numeral of the first row of each subgroup will be displayed.</span>
            <span class="n">df</span><span class="o">.</span><span class="n">relativeroot</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">relativeroot</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">has_applied</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">numeral</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;subgroup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">Resource</span> <span class="o">!=</span> <span class="n">df</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">levels</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">gantt_data</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
        <span class="n">frst</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">finish</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">right</span>
        <span class="n">frst</span><span class="p">[</span><span class="s1">&#39;Start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span>
        <span class="n">frst</span><span class="p">[</span><span class="s1">&#39;Finish&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">finish</span>
        <span class="n">frst</span><span class="p">[</span><span class="s1">&#39;Duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">finish</span> <span class="o">-</span> <span class="n">start</span>
        <span class="n">frst</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">IntervalIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">([(</span><span class="n">start</span><span class="p">,</span> <span class="n">finish</span><span class="p">)],</span> <span class="n">closed</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">frst</span>

    <span class="n">global_numerals</span> <span class="o">=</span> <span class="n">labels2global_tonic</span><span class="p">(</span><span class="n">at</span><span class="p">)</span><span class="o">.</span><span class="n">numeral</span>
    <span class="n">at</span><span class="p">[</span><span class="s1">&#39;Resource&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span>
    <span class="n">at</span><span class="o">.</span><span class="n">Resource</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">relativeroot</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span> <span class="s1">&#39;applied&#39;</span><span class="p">)</span>
    <span class="n">at</span><span class="p">[</span><span class="s1">&#39;relativeroot_resolved&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">resolve_relative_keys</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;relativeroot&#39;</span><span class="p">,</span> <span class="s1">&#39;localkey_is_minor&#39;</span><span class="p">])</span>
    <span class="n">at</span><span class="p">[</span><span class="s1">&#39;abs_numeral&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">rel2abs_key</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;relativeroot_resolved&#39;</span><span class="p">,</span> <span class="s1">&#39;localkey_resolved&#39;</span><span class="p">,</span> <span class="s1">&#39;globalkey_is_minor&#39;</span><span class="p">])</span>
    <span class="n">at</span><span class="o">.</span><span class="n">abs_numeral</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">global_numerals</span><span class="p">,</span>
                          <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># = at.abs_numeral.where(at.abs_numeral.notna(), global_numerals)</span>
    <span class="n">at</span><span class="p">[</span><span class="s1">&#39;fifths&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">roman_numeral2fifths</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;abs_numeral&#39;</span><span class="p">,</span> <span class="s1">&#39;globalkey_is_minor&#39;</span><span class="p">])</span>
    <span class="n">at</span><span class="p">[</span><span class="s1">&#39;semitones&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">roman_numeral2semitones</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;abs_numeral&#39;</span><span class="p">,</span> <span class="s1">&#39;globalkey_is_minor&#39;</span><span class="p">],</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode_agnostic_adjacency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">adjacent_groups</span> <span class="o">=</span> <span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">semitones</span> <span class="o">!=</span> <span class="n">at</span><span class="o">.</span><span class="n">semitones</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span> <span class="k">if</span> <span class="n">mode_agnostic_adjacency</span> <span class="k">else</span> <span class="p">(</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">abs_numeral</span> <span class="o">!=</span> <span class="n">at</span><span class="o">.</span><span class="n">abs_numeral</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">at</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">adjacent_groups</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">select_groups</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;semitones&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;fifths&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">adjacent_groups</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">select_groups</span><span class="p">))</span>
            <span class="k">raise</span>
        <span class="n">at</span><span class="o">.</span><span class="n">subgroup</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">subgroup</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="n">at</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;subgroup&#39;</span><span class="p">,</span> <span class="s1">&#39;localkey&#39;</span><span class="p">],</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">gantt_data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subgroups</span> <span class="o">=</span> <span class="p">((</span><span class="n">at</span><span class="o">.</span><span class="n">relativeroot</span> <span class="o">!=</span> <span class="n">at</span><span class="o">.</span><span class="n">relativeroot</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span> <span class="o">|</span> <span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">localkey</span> <span class="o">!=</span> <span class="n">at</span><span class="o">.</span><span class="n">localkey</span><span class="o">.</span><span class="n">shift</span><span class="p">()))</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="n">at</span> <span class="o">=</span> <span class="n">at</span><span class="p">[</span><span class="n">at</span><span class="o">.</span><span class="n">relativeroot</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">subgroups</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">gantt_data</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">key_groups</span><span class="p">,</span> <span class="n">at</span><span class="p">])[</span>
        <span class="p">[</span><span class="s1">&#39;Start&#39;</span><span class="p">,</span> <span class="s1">&#39;Finish&#39;</span><span class="p">,</span> <span class="s1">&#39;Duration&#39;</span><span class="p">,</span> <span class="s1">&#39;Resource&#39;</span><span class="p">,</span> <span class="s1">&#39;abs_numeral&#39;</span><span class="p">,</span> <span class="s1">&#39;fifths&#39;</span><span class="p">,</span> <span class="s1">&#39;semitones&#39;</span><span class="p">,</span> <span class="s1">&#39;localkey&#39;</span><span class="p">,</span> <span class="s1">&#39;globalkey&#39;</span><span class="p">,</span>
         <span class="s1">&#39;relativeroot&#39;</span><span class="p">]]</span>
    <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">&#39;Start&#39;</span><span class="p">,</span> <span class="s1">&#39;Finish&#39;</span><span class="p">,</span> <span class="s1">&#39;Duration&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[[</span><span class="s1">&#39;Start&#39;</span><span class="p">,</span> <span class="s1">&#39;Finish&#39;</span><span class="p">,</span> <span class="s1">&#39;Duration&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="s1">&#39;Description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Duration: &#39;</span> <span class="o">+</span> <span class="n">res</span><span class="o">.</span><span class="n">Duration</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> \
                         <span class="s1">&#39;&lt;br&gt;Tonicized global scale degree: &#39;</span> <span class="o">+</span> <span class="n">res</span><span class="o">.</span><span class="n">abs_numeral</span> <span class="o">+</span> \
                         <span class="s1">&#39;&lt;br&gt;Local tonic: &#39;</span> <span class="o">+</span> <span class="n">res</span><span class="o">.</span><span class="n">localkey</span> <span class="o">+</span> \
                         <span class="p">(</span><span class="s1">&#39;&lt;br&gt;Tonicized local scale degree: &#39;</span> <span class="o">+</span> <span class="n">res</span><span class="o">.</span><span class="n">relativeroot</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="notes2pcvs"><a class="viewcode-back" href="../../reference.html#ms3.transformations.notes2pcvs">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">notes2pcvs</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span>
               <span class="n">pitch_class_format</span><span class="o">=</span><span class="s1">&#39;tpc&#39;</span><span class="p">,</span>
               <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">long</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">fillna</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">additional_group_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">ensure_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    notes : :obj:`pandas.DataFrame`</span>
<span class="sd">        Note table to be transformed into a wide or long table of Pitch Class Vectors by grouping via the first (or only)</span>
<span class="sd">        index level. The DataFrame needs containing at least the columns &#39;duration_qb&#39; and &#39;tpc&#39; or &#39;midi&#39;, depending</span>
<span class="sd">        on ``pitch_class_format``.</span>
<span class="sd">    pitch_class_format : :obj:`str`, optional</span>
<span class="sd">        | Defines the type of pitch classes to use for the vectors.</span>
<span class="sd">        | &#39;tpc&#39; (default): tonal pitch class, such that -1=F, 0=C, 1=G etc.</span>
<span class="sd">        | &#39;name&#39;: tonal pitch class as spelled pitch, e.g. &#39;C&#39;, &#39;F#&#39;, &#39;Abb&#39; etc.</span>
<span class="sd">        | &#39;pc&#39;: chromatic pitch classes where 0=C, 1=C#/Db, ... 11=B/Cb.</span>
<span class="sd">        | &#39;midi&#39;: original MIDI numbers; the result are pitch vectors, not pitch class vectors.</span>
<span class="sd">    normalize : :obj:`bool`, optional</span>
<span class="sd">        By default, the PCVs contain absolute durations in quarter notes. Pass True to normalize</span>
<span class="sd">        the PCV for each group.</span>
<span class="sd">    long : :obj:`bool`, optional</span>
<span class="sd">        By default, the resulting DataFrames have wide format, i.e. each row contains the PCV</span>
<span class="sd">        for one slice. Pass True if you need long format instead, i.e. with a non-unique</span>
<span class="sd">        :obj:`pandas.IntervalIndex` and two columns, ``[(&#39;tpc&#39;|&#39;midi&#39;), &#39;duration_qb&#39;]``</span>
<span class="sd">        where the first column&#39;s name depends on ``pitch_class_format``.</span>
<span class="sd">    fillna : :obj:`bool`, optional</span>
<span class="sd">        By default, if a Pitch class does not appear in a PCV, its value will be 0. Pass False if</span>
<span class="sd">        you want NA instead.</span>
<span class="sd">    additional_group_cols : (:obj:`list` of) :obj:`str`</span>
<span class="sd">        If you would like to maintain some information from other columns of ``notes`` in additional index levels,</span>
<span class="sd">        pass their names.</span>
<span class="sd">    ensure_columns : :obj:`Iterable`, optional</span>
<span class="sd">        By default, pitch classes that don&#39;t appear don&#39;t get a column. Pass a value if you want to</span>
<span class="sd">        ensure the presence of particular columns, even if empty. For example, if ``pitch_class_format=&#39;pc&#39;``</span>
<span class="sd">        you could pass ``ensure_columns=range(12)``.</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pitch_class_format</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;tpc&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">):</span>
        <span class="n">pitch_class_grouper</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">tpc</span><span class="o">.</span><span class="n">values</span>
    <span class="k">elif</span> <span class="n">pitch_class_format</span> <span class="o">==</span> <span class="s2">&quot;pc&quot;</span><span class="p">:</span>
        <span class="n">pitch_class_grouper</span> <span class="o">=</span> <span class="p">(</span><span class="n">notes</span><span class="o">.</span><span class="n">midi</span> <span class="o">%</span> <span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="k">elif</span> <span class="n">pitch_class_format</span> <span class="o">==</span> <span class="s2">&quot;midi&quot;</span><span class="p">:</span>
        <span class="n">pitch_class_grouper</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">midi</span><span class="o">.</span><span class="n">values</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;pitch_class_format needs to be one of &#39;tpc&#39;, &#39;name&#39;, &#39;pc&#39;, &#39;midi&#39;, not &quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pitch_class_format</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">index</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">grouper</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">group_levels</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">additional_group_cols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">additional_group_cols</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">additional_group_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">additional_group_cols</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">additional_group_cols</span><span class="p">:</span>
            <span class="n">grouper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">notes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">group_levels</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">grouper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pitch_class_grouper</span><span class="p">)</span>
    <span class="n">pcvs</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">grouper</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">duration_qb</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="c1"># if long:</span>
    <span class="c1">#     if normalize:</span>
    <span class="c1">#         pcvs = pcvs.groupby(level=list(range(group_levels))).apply(lambda S: S / S.sum())</span>
    <span class="c1">#     pcvs = pcvs.reset_index(level=-1)</span>
    <span class="c1">#     if pitch_class_format == &quot;name&quot;:</span>
    <span class="c1">#         pcvs.loc[:, &quot;tpc&quot;] = transform(pcvs.tpc, fifths2name)</span>
    <span class="c1"># else:</span>
    <span class="n">pcvs</span> <span class="o">=</span> <span class="n">pcvs</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">pitch_class_format</span> <span class="o">==</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span>
        <span class="n">pcvs</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">fifths2name</span><span class="p">(</span><span class="n">pcvs</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">pcvs</span> <span class="o">=</span> <span class="n">pcvs</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">pcvs</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ensure_columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ensure_columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pcvs</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">new_cols</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">pcvs</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">missing</span><span class="p">)</span>
            <span class="n">pcvs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pcvs</span><span class="p">,</span> <span class="n">new_cols</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">long</span><span class="p">:</span>
        <span class="n">pcvs</span> <span class="o">=</span> <span class="n">pcvs</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">fillna</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pcvs</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pcvs</span></div>


<div class="viewcode-block" id="resolve_all_relative_numerals"><a class="viewcode-back" href="../../reference.html#ms3.transformations.resolve_all_relative_numerals">[docs]</a><span class="k">def</span> <span class="nf">resolve_all_relative_numerals</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">additional_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Resolves Roman numerals that include slash notation such as &#39;#vii/ii&#39; =&gt; &#39;#i&#39; or &#39;V/V/V&#39; =&gt; &#39;VI&#39; in a major and</span>
<span class="sd">    &#39;#VI&#39; in a minor key. The function expects the columns [&#39;globalkey_is_minor&#39;, &#39;localkey_is_minor&#39;] to be present.</span>
<span class="sd">    The former is necessary only if the column &#39;localkey&#39; is present and needs resolving. Execution will be slightly</span>
<span class="sd">    faster if performed on the entire DataFrame rather than using :py:meth:`transform_multiple`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    at : :obj:`pandas.DataFrame`</span>
<span class="sd">        Annotation table.</span>
<span class="sd">    additional_columns : :obj:`str` or :obj:`list`</span>
<span class="sd">        By default, the function resolves, if present, the columns [&#39;relativeroot&#39;, &#39;pedal&#39;] but here you can name</span>
<span class="sd">        other columns, too. They will be resolved based on the localkey&#39;s mode.</span>
<span class="sd">    inplace : :obj:`bool`, optional</span>
<span class="sd">        By default, a manipulated copy of ``at`` is returned. Pass True to mutate instead.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="n">at</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;localkey&#39;</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">at</span><span class="o">.</span><span class="n">localkey</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">at</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;localkey&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">resolve_relative_keys</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;localkey&#39;</span><span class="p">,</span> <span class="s1">&#39;globalkey_is_minor&#39;</span><span class="p">])</span>
    <span class="n">roman_numeral_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;relativeroot&#39;</span><span class="p">,</span> <span class="s1">&#39;pedal&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">additional_columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">additional_columns</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">additional_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">additional_columns</span><span class="p">]</span>
        <span class="n">roman_numeral_cols</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">additional_columns</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">roman_numeral_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">resolved</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">at</span><span class="p">[</span><span class="n">cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;localkey_is_minor&#39;</span><span class="p">]],</span> <span class="n">resolve_relative_keys</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;localkey_is_minor&#39;</span><span class="p">],</span>
                             <span class="n">column_wise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolved</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;numeral&#39;</span><span class="p">,</span> <span class="s1">&#39;relativeroot&#39;</span><span class="p">)):</span>
        <span class="n">at</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;numeral&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">rel2abs_key</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;numeral&#39;</span><span class="p">,</span> <span class="s1">&#39;relativeroot&#39;</span><span class="p">,</span> <span class="s1">&#39;localkey_is_minor&#39;</span><span class="p">])</span>
        <span class="n">at</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;relativeroot&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">at</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;chord&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_chord_col</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">at</span></div>


<div class="viewcode-block" id="segment_by_adjacency_groups"><a class="viewcode-back" href="../../reference.html#ms3.transformations.segment_by_adjacency_groups">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">segment_by_adjacency_groups</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">na_values</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Drop exact adjacent repetitions within one or a combination of several feature columns and adapt the</span>
<span class="sd">    IntervalIndex and the column &#39;duration_qb&#39; accordingly.</span>
<span class="sd">    Uses: :func:`adjacency_groups`, :func:`reduce_dataframe_duration_to_first_row`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        DataFrame to be reduced, expected to contain the column ``duration_qb``. In order to use the result as a</span>
<span class="sd">        segmentation, it should have a :obj:`pandas.IntervalIndex`.</span>
<span class="sd">    cols : :obj:`list`</span>
<span class="sd">        Feature columns which exact, adjacent repetitions should be grouped to a segment, keeping only the first row.</span>
<span class="sd">    na_values : (:obj:`list` of) :obj:`str` or :obj:`Any`, optional</span>
<span class="sd">        | Either pass a list of equal length as ``cols`` or a single value that is passed to :py:func:`adjacency_groups`</span>
<span class="sd">        | for each. Not dealing with NA values will lead to wrongly grouped segments. The default option is the safest.</span>
<span class="sd">        | &#39;group&#39; creates individual groups for NA values</span>
<span class="sd">        | &#39;backfill&#39; or &#39;bfill&#39; groups NA values with the subsequent group</span>
<span class="sd">        | &#39;pad&#39;, &#39;ffill&#39; groups NA values with the preceding group</span>
<span class="sd">        | Any other value works like &#39;group&#39;, with the difference that the created groups will be named with this value.</span>
<span class="sd">    group_keys : :obj:`bool`, optional</span>
<span class="sd">        By default, the grouped values will be returned as an appended MultiIndex, differentiation groups via ascending</span>
<span class="sd">        integers. If you want to duplicate the columns&#39; value, e.g. to account for a custom filling value for</span>
<span class="sd">        ``na_values``, pass True. Beware that this most often results in non-unique index levels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.DataFrame`</span>
<span class="sd">        Reduced DataFrame with updated &#39;duration_qb&#39; column and :obj:`pandas.IntervalIndex` on the first level</span>
<span class="sd">        (if present).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;duration_qb&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;DataFrame is missing the column &#39;duration_qb&#39;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">cols</span><span class="p">]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>  <span class="c1"># number of columns of which subsequent equal value combinations are grouped</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">na_values</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">na_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">na_values</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">na_values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">:</span>
            <span class="n">na_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)</span>
    <span class="n">groups</span><span class="p">,</span> <span class="n">names</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="o">*</span><span class="p">(</span><span class="n">adjacency_groups</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">na_values</span><span class="o">=</span><span class="n">na</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="n">na</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">na_values</span><span class="p">)))</span>

    <span class="n">grouped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">groups</span><span class="p">),</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">reduce_dataframe_duration_to_first_row</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">gr</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">for</span> <span class="n">gr</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;na_values=</span><span class="si">{</span><span class="n">na_values</span><span class="si">}</span><span class="s2"> did not take care of all NA values in </span><span class="si">{</span><span class="n">cols</span><span class="si">}</span><span class="s2">. This very probably leads to wrongly grouped rows. If in doubt, use &#39;group&#39;.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">grouped</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
        <span class="n">grouped</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">reorder_levels</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Groupby-apply did not generate MultiIndex.&quot;</span><span class="p">)</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">groups</span><span class="p">),</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">group_keys</span><span class="p">:</span>
        <span class="n">no_tuples</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">coll</span><span class="p">:</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">coll</span><span class="p">)</span>
        <span class="n">new_levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">index_level</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">if</span> <span class="n">no_tuples</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">else</span> <span class="n">index_level</span> <span class="k">for</span>
                      <span class="n">index_level</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grouped</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">names</span><span class="p">)]</span>
        <span class="n">grouped</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">set_levels</span><span class="p">(</span><span class="n">new_levels</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
                                                 <span class="n">verify_integrity</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">grouped</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;segment&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">grouped</span></div>

<div class="viewcode-block" id="segment_by_criterion"><a class="viewcode-back" href="../../reference.html#ms3.transformations.segment_by_criterion">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">segment_by_criterion</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">boolean_mask</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">],</span> <span class="n">warn_na</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Drop all rows where the boolean mask does not match and adapt the IntervalIndex and the column &#39;duration_qb&#39; accordingly.</span>

<span class="sd">    Args:</span>
<span class="sd">      df: DataFrame to be reduced, expected to come with the column ``duration_qb`` and an :obj:`pandas.IntervalIndex`.</span>
<span class="sd">      boolean_mask: Boolean mask where every True value starts a new segment.</span>
<span class="sd">      warn_na: If the boolean mask starts with any number of False, this first group will be missing from the result.</span>
<span class="sd">          Set warn_na to True if you want the logger to throw a warning in this case.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Reduced DataFrame with updated &#39;duration_qb&#39; column and :obj:`pandas.IntervalIndex` on the first level.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;quarterbeats&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;DataFrame is missing the column &#39;quarterbeats&#39;&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">offset_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">end</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DataFrame index does not consist of one level that is an IntervalIndex:</span><span class="se">\n</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">boolean_mask</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;duration_qb&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;duration_qb&#39;</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">add_quarterbeats_col</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">offset_dict</span><span class="p">,</span> <span class="n">interval_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">warn_na</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">boolean_mask</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Boolean mask started with False, meaning that a part of the DataFrame is excluded from the segmentation.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="segment_by_interval_index"><a class="viewcode-back" href="../../reference.html#ms3.transformations.segment_by_interval_index">[docs]</a><span class="k">def</span> <span class="nf">segment_by_interval_index</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Segment a DataFrame into chunks based on a given IntervalIndex.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        DataFrame that has a :obj:`pandas.IntervalIndex` to allow for its segmentation.</span>
<span class="sd">    idx : :obj:`pandas.IntervalIndex` or :obj:`pandas.MultiIndex`</span>
<span class="sd">        Intervals by which to segment ``df``. The index will be prepended to differentiate between segments. If ``idx``</span>
<span class="sd">        is a :obj:`pandas.MultiIndex`, the first level is expected to be a :obj:`pandas.IntervalIndex`.</span>
<span class="sd">    truncate : :obj:`bool`, optional</span>
<span class="sd">        By default, the intervals of the segmented DataFrame will be cut off at segment boundaries and the event&#39;s</span>
<span class="sd">        &#39;duration_qb&#39; will be adapted accordingly. Pass False to prevent that and duplicate overlapping events without</span>
<span class="sd">        adapting their Intervals and &#39;duration_qb&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.DataFrame`</span>
<span class="sd">        A copy of ``df`` where the index levels ``idx`` have been prepended and only rows of ``df`` with overlapping</span>
<span class="sd">        intervals are included.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">iv_idx</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iv_idx</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
        <span class="n">iv_idx</span> <span class="o">=</span> <span class="n">iv_idx</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">iv_idx</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">IntervalIndex</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;idx needs to IntervalIndex, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">iv_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="n">overlapping_chunk_per_interval</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">iv_idx</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="n">truncate</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">chunks</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">keys</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">idx</span><span class="o">.</span><span class="n">levels</span><span class="p">)</span></div>


<div class="viewcode-block" id="slice_df"><a class="viewcode-back" href="../../reference.html#ms3.transformations.slice_df">[docs]</a><span class="k">def</span> <span class="nf">slice_df</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
             <span class="n">quarters_per_slice</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Interval</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Returns a sliced version of the DataFrame. Slices appear in the IntervalIndex and the contained event&#39;s</span>
<span class="sd">    durations within the slice are shown in the column &#39;duration_qb&#39;.</span>
<span class="sd">    Uses:</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        The DataFrame is expected to come with an IntervalIndex and contain the columns &#39;quarterbeats&#39; and &#39;duration_qb&#39;.</span>
<span class="sd">        Those can be obtained through ``Parse.get_lists(interval_index=True)`` or</span>
<span class="sd">        ``Parse.iter_transformed(interval_index=True)``.</span>
<span class="sd">    quarters_per_slice : :obj:`float`, optional</span>
<span class="sd">        By default, the slices have variable size, from onset to onset. If you pass a value, the slices will</span>
<span class="sd">        have that constant size, measured in quarter notes. For example, pass 1.0 for all slices to have size 1 quarter.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.DataFrame`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">IntervalIndex</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;DataFrame is expected to have an IntervalIndex, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="n">end</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">quarters_per_slice</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lefts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">left</span><span class="p">))</span>
        <span class="n">rights</span> <span class="o">=</span> <span class="n">lefts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="n">end</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
        <span class="n">lefts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">quarters_per_slice</span><span class="p">)</span>
        <span class="n">rights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">quarters_per_slice</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="n">quarters_per_slice</span><span class="p">,</span> <span class="n">quarters_per_slice</span><span class="p">)</span>
    <span class="n">intervals</span> <span class="o">=</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Interval</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lefts</span><span class="p">,</span> <span class="n">rights</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">overlapping_chunk_per_interval</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">intervals</span><span class="p">)</span></div>


<div class="viewcode-block" id="transform_multiple"><a class="viewcode-back" href="../../reference.html#ms3.transformations.transform_multiple">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">transform_multiple</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">level</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Applying transformation(s) separately to concatenated pieces that can be differentiated by index level(s).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        Concatenated tables with :obj:`pandas.MultiIndex`.</span>
<span class="sd">    func : :obj:`~collections.abc.Callable` or :obj:`str`</span>
<span class="sd">        Function to be applied to the individual tables. For convenience, you can pass strings to call the standard</span>
<span class="sd">        transformers for a particular table type. For example, pass &#39;annotations&#39; to call ``transform_annotations``.</span>
<span class="sd">    level : :obj:`int` or :obj:`list`</span>
<span class="sd">        Argument passed to :py:meth:`pandas.DataFrame.groupby`. Defaults to -1, resulting in a GroupBy by all levels</span>
<span class="sd">        except the last. Conversely, you can pass, for instance, 2 to group by the first two levels.</span>
<span class="sd">    kwargs :</span>
<span class="sd">        Keyword arguments passed to ``func``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.DataFrame`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">kw2func</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;annotations&#39;</span><span class="p">:</span> <span class="n">transform_annotations</span><span class="p">,</span>
            <span class="s1">&#39;key_segment&#39;</span><span class="p">:</span> <span class="n">add_localkey_change_column</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">kw2func</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">kw2func</span><span class="p">[</span><span class="n">func</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2">&#39; is not a valid keyword. Either pass a callable (function), or one of the keywords </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kw2func</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">levels</span> <span class="o">=</span> <span class="n">_treat_level_parameter</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">nlevels</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">levels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="n">levels</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error when trying to group the index levels </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">)</span><span class="si">}</span><span class="s2"> using level=</span><span class="si">{</span><span class="n">levels</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index had too few levels (</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">)</span><span class="si">}</span><span class="s2">) to group by parameter level=</span><span class="si">{</span><span class="n">levels</span><span class="si">}</span><span class="s2">. Applied&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2"> to the entire DataFrame instead.&quot;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="transform_annotations"><a class="viewcode-back" href="../../reference.html#ms3.transformations.transform_annotations">[docs]</a><span class="k">def</span> <span class="nf">transform_annotations</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">groupby_features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resolve_relative</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Wrapper for applying several transformations to an annotation table.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    at : :obj:`pandas.DataFrame`</span>
<span class="sd">        Annotation table corresponding to a single piece.</span>
<span class="sd">    groupby_features : :obj:`str` or :obj:`list`</span>
<span class="sd">        Argument ``features`` passed to :py:meth:`group_annotations_by_features`.</span>
<span class="sd">    resolve_relative : :obj:`bool`</span>
<span class="sd">        Resolves slash notation (e.g. &#39;vii/V&#39;) from Roman numerals in the columns [&#39;localkey&#39;, &#39;relativeroot&#39;, &#39;pedal&#39;].</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.DataFrame`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">groupby_features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">at</span> <span class="o">=</span> <span class="n">group_annotations_by_features</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">groupby_features</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resolve_relative</span><span class="p">:</span>
        <span class="n">at</span> <span class="o">=</span> <span class="n">resolve_all_relative_numerals</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">at</span></div>


<div class="viewcode-block" id="transpose_notes_to_localkey"><a class="viewcode-back" href="../../reference.html#ms3.transformations.transpose_notes_to_localkey">[docs]</a><span class="k">def</span> <span class="nf">transpose_notes_to_localkey</span><span class="p">(</span><span class="n">notes</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Transpose the columns &#39;tpc&#39; and &#39;midi&#39; such that they reflect the local key as if it was C major/minor. This</span>
<span class="sd">    operation is typically required for creating pitch class profiles.</span>
<span class="sd">    Uses: :py:func:`transform`, :py:func:`name2fifths`, :py:func:`roman_numeral2fifths`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    notes : :obj:`pandas.DataFrame`</span>
<span class="sd">        DataFrame that has at least the columns [&#39;globalkey&#39;, &#39;localkey&#39;, &#39;tpc&#39;, &#39;midi&#39;].</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.DataFrame`</span>
<span class="sd">         A copy of ``notes`` where the columns &#39;tpc&#39; and &#39;midi&#39; are shifted in such a way that tpc=0 and midi=60</span>
<span class="sd">         match the local tonic (e.g. for the local key A major/minor, each pitch A will have tpc=0 and midi % 12 = 0).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">new_cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s1">&#39;globalkey_is_minor&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">notes</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">gkim</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">globalkey</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;globalkey_is_minor&#39;</span><span class="p">)</span>
        <span class="n">new_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gkim</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;localkey_is_minor&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">notes</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">lkim</span> <span class="o">=</span> <span class="n">notes</span><span class="o">.</span><span class="n">localkey</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;localkey_is_minor&#39;</span><span class="p">)</span>
        <span class="n">new_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lkim</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_cols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">notes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">notes</span><span class="p">]</span> <span class="o">+</span> <span class="n">new_cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">transpose_by</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">notes</span><span class="o">.</span><span class="n">globalkey</span><span class="p">,</span> <span class="n">name2fifths</span><span class="p">)</span> <span class="o">+</span> <span class="n">transform</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">roman_numeral2fifths</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;localkey&#39;</span><span class="p">,</span> <span class="s1">&#39;globalkey_is_minor&#39;</span><span class="p">])</span>
    <span class="n">notes</span><span class="o">.</span><span class="n">tpc</span> <span class="o">-=</span> <span class="n">transpose_by</span>
    <span class="n">midi_transposition</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">transpose_by</span><span class="p">,</span> <span class="n">fifths2pc</span><span class="p">)</span>
    <span class="c1"># For transpositions up to a diminished fifth, move pitches up,</span>
    <span class="c1"># for larger intervals, move pitches down.</span>
    <span class="n">midi_transposition</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">midi_transposition</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">midi_transposition</span> <span class="o">%</span> <span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">notes</span><span class="o">.</span><span class="n">midi</span> <span class="o">-=</span> <span class="n">midi_transposition</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">notes</span><span class="p">,</span> <span class="n">transpose_by</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;local_tonic&#39;</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">notes</span><span class="o">.</span><span class="n">local_tonic</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">notes</span><span class="p">,</span> <span class="n">fifths2name</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fifths</span><span class="o">=</span><span class="s1">&#39;local_tonic&#39;</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="s1">&#39;localkey_is_minor&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">notes</span></div>

<span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">_treat_level_parameter</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">nlevels</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Given a number of index levels, turn an int such as -1 into a list of all levels except the last.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    level : :obj:`int`</span>
<span class="sd">        Integer to transform into a list. If negative, all but the last ``level`` levels are chosen. If positive,</span>
<span class="sd">        the first ``level`` ones.</span>
<span class="sd">    nlevels : :obj:`int`</span>
<span class="sd">        Number of present index levels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">level</span>
    <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">nlevels</span>
    <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">level</span> <span class="o">+=</span> <span class="n">nlevels</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot group by the </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2"> first levels. nlevels=</span><span class="si">{</span><span class="n">nlevels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
    <span class="k">elif</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="n">nlevels</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Supposed to group by </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2"> first levels but nlevels=</span><span class="si">{</span><span class="n">nlevels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">levels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">level</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">levels</span>


<div class="viewcode-block" id="transform_columns"><a class="viewcode-back" href="../../reference.html#ms3.transformations.transform_columns">[docs]</a><span class="k">def</span> <span class="nf">transform_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">param2col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Wrapper function to use transform() on df[columns], leaving the other columns untouched.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        DataFrame where columns (or column combinations) work as function arguments.</span>
<span class="sd">    func : :obj:`callable`</span>
<span class="sd">        Function you want to apply to all elements in `columns`.</span>
<span class="sd">    columns : :obj:`list`</span>
<span class="sd">        Columns to which you want to apply `func`.</span>
<span class="sd">    param2col : :obj:`dict` or :obj:`list`, optional</span>
<span class="sd">        Mapping from parameter names of `func` to column names.</span>
<span class="sd">        If you pass a list of column names, the columns&#39; values are passed as positional arguments.</span>
<span class="sd">        Pass None if you want to use all columns as positional arguments.</span>
<span class="sd">    inplace : :obj:`bool`, optional</span>
<span class="sd">        Pass True if you want to mutate `df` rather than getting an altered copy.</span>
<span class="sd">    **kwargs: keyword arguments for transform()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">param_cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="k">elif</span> <span class="n">param2col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">param2col</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">param_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">param2col</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">param_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">param2col</span><span class="p">)</span>

    <span class="n">tmp_index</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_unique</span>
    <span class="k">if</span> <span class="n">tmp_index</span><span class="p">:</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
        <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">columns</span> <span class="o">+</span> <span class="n">param_cols</span><span class="p">],</span> <span class="n">func</span><span class="p">,</span> <span class="n">param2col</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tmp_index</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ix</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="transform_note_columns"><a class="viewcode-back" href="../../reference.html#ms3.transformations.transform_note_columns">[docs]</a><span class="k">def</span> <span class="nf">transform_note_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">note_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chord_tones&#39;</span><span class="p">,</span> <span class="s1">&#39;added_tones&#39;</span><span class="p">,</span> <span class="s1">&#39;bass_note&#39;</span><span class="p">,</span> <span class="s1">&#39;root&#39;</span><span class="p">],</span> <span class="n">minor_col</span><span class="o">=</span><span class="s1">&#39;localkey_is_minor&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Turns columns with line-of-fifth tonal pitch classes into another representation.</span>

<span class="sd">    Uses: transform_columns()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        DataFrame where columns (or column combinations) work as function arguments.</span>
<span class="sd">    to : {&#39;name&#39;, &#39;iv&#39;, &#39;pc&#39;, &#39;sd&#39;, &#39;rn&#39;}</span>
<span class="sd">        The tone representation that you want to get from the `note_cols`.</span>

<span class="sd">        * &#39;name&#39;: Note names. Should only be used if the stacked fifths actually represent</span>
<span class="sd">                absolute tonal pitch classes rather than intervals over the local tonic.</span>
<span class="sd">                In other words, make sure to use &#39;name&#39; only if 0 means C rather than I.</span>
<span class="sd">        * &#39;iv&#39;:   Intervals such that 0 = &#39;P1&#39;, 1 = &#39;P5&#39;, 4 = &#39;M3&#39;, -3 = &#39;m3&#39;, 6 = &#39;A4&#39;,</span>
<span class="sd">                -6 = &#39;D5&#39; etc.</span>
<span class="sd">        * &#39;pc&#39;:   (Relative) chromatic pitch class, or distance from tonic in semitones.</span>
<span class="sd">        * &#39;sd&#39;:   Scale degrees such that 0 = &#39;1&#39;, -1 = &#39;4&#39;, -2 = &#39;b7&#39; in major, &#39;7&#39; in minor etc.</span>
<span class="sd">                This representation requires a boolean column `minor_col` which is</span>
<span class="sd">                True in those rows where the stacks of fifths occur in a local minor</span>
<span class="sd">                context and False for the others. Alternatively, if all pitches are</span>
<span class="sd">                in the same mode or you simply want to express them as degrees of</span>
<span class="sd">                particular mode, you can pass the boolean keyword argument `minor`.</span>
<span class="sd">        * &#39;rn&#39;:   Roman numerals such that 0 = &#39;I&#39;, -2 = &#39;bVII&#39; in major, &#39;VII&#39; in minor etc.</span>
<span class="sd">                Requires boolean &#39;minor&#39; values, see &#39;sd&#39;.</span>

<span class="sd">    note_cols : :obj:`list`, optional</span>
<span class="sd">        List of columns that hold integers or collections of integers that represent</span>
<span class="sd">        stacks of fifth (0 = tonal center, 1 = fifth above, -1 = fourth above, etc).</span>
<span class="sd">    minor_col : :obj:`str`, optional</span>
<span class="sd">        If `to` is &#39;sd&#39; or &#39;rn&#39;, specify a boolean column where the value is</span>
<span class="sd">        True in those rows where the stacks of fifths occur in a local minor</span>
<span class="sd">        context and False for the others.</span>
<span class="sd">    **kwargs: keyword arguments for transform()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">transformations</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">fifths2name</span><span class="p">,</span>
        <span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="n">fifths2name</span><span class="p">,</span>
        <span class="s1">&#39;iv&#39;</span><span class="p">:</span> <span class="n">fifths2iv</span><span class="p">,</span>
        <span class="s1">&#39;pc&#39;</span><span class="p">:</span> <span class="n">fifths2pc</span><span class="p">,</span>
        <span class="s1">&#39;sd&#39;</span><span class="p">:</span> <span class="n">fifths2sd</span><span class="p">,</span>
        <span class="s1">&#39;rn&#39;</span><span class="p">:</span> <span class="n">fifths2rn</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">assert</span> <span class="n">to</span> <span class="ow">in</span> <span class="n">transformations</span><span class="p">,</span> <span class="s2">&quot;Parameter to needs to be one of {&#39;name&#39;, &#39;iv&#39;, &#39;pc&#39;, &#39;sd&#39;, &#39;rn&#39;}&quot;</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">note_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">note_cols</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Columns </span><span class="si">{</span><span class="p">[[</span><span class="n">col</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">note_cols</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">param2col</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">to</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sd&#39;</span><span class="p">,</span> <span class="s1">&#39;rn&#39;</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="n">minor_col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">or</span> <span class="s1">&#39;minor&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">to</span><span class="si">}</span><span class="s2"> representation requires a boolean column for the &#39;minor&#39; argument, e.g. &#39;globalkey_is_minor&#39;.&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;minor&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">param2col</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;minor&#39;</span><span class="p">:</span> <span class="n">minor_col</span><span class="p">}</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">transformations</span><span class="p">[</span><span class="n">to</span><span class="p">]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">transform_columns</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">note_cols</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="n">inplace</span><span class="p">,</span> <span class="n">param2col</span><span class="o">=</span><span class="n">param2col</span><span class="p">,</span> <span class="n">column_wise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="transpose_chord_tones_by_localkey"><a class="viewcode-back" href="../../reference.html#ms3.transformations.transpose_chord_tones_by_localkey">[docs]</a><span class="k">def</span> <span class="nf">transpose_chord_tones_by_localkey</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">by_global</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Returns a copy of the expanded table where the scale degrees in the chord tone columns</span>
<span class="sd">        have been transposed by localkey (i.e. they express all chord tones as scale degrees of</span>
<span class="sd">        the globalkey) or, if ``by_global`` is set to True, additionally by globalkey (i.e., chord</span>
<span class="sd">        tones as tonal pitch classes TPC).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        Expanded labels with chord tone columns.</span>
<span class="sd">    by_global : :obj:`bool`</span>
<span class="sd">        By default, the transformed chord tone columns express chord tones as scale degrees (or</span>
<span class="sd">        intervals) of the global tonic. If set to True, they correspond to tonal pitch classes</span>
<span class="sd">        and can be further transformed to note names using transform_note_columns().</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.DataFrame`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">ct_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chord_tones&#39;</span><span class="p">,</span> <span class="s1">&#39;added_tones&#39;</span><span class="p">,</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="s1">&#39;bass_note&#39;</span><span class="p">]</span>
    <span class="n">ct</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">ct_cols</span><span class="p">]</span>
    <span class="n">transpose_by</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">roman_numeral2fifths</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;localkey&#39;</span><span class="p">,</span> <span class="s1">&#39;globalkey_is_minor&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">by_global</span><span class="p">:</span>
        <span class="n">transpose_by</span> <span class="o">+=</span> <span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">name2fifths</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;globalkey&#39;</span><span class="p">])</span>
    <span class="n">transposed_row_tuples</span> <span class="o">=</span> <span class="p">[</span><span class="n">transpose</span><span class="p">(</span><span class="n">tpcs</span><span class="p">,</span> <span class="n">fifths</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">tpcs</span><span class="p">,</span> <span class="n">fifths</span> <span class="ow">in</span>
                             <span class="nb">zip</span><span class="p">(</span><span class="n">ct</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                                 <span class="n">transpose_by</span><span class="o">.</span><span class="n">values</span><span class="p">)]</span>
    <span class="n">ct</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">transposed_row_tuples</span><span class="p">,</span>
                      <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                      <span class="n">columns</span><span class="o">=</span><span class="n">ct_cols</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="c1"># Setting values in-place is fine, ignore the warning in Pandas &gt;= 1.5.0</span>
        <span class="c1"># This can be removed, if Pandas 1.5.0 does not need to be supported any longer.</span>
        <span class="c1"># See also: https://stackoverflow.com/q/74057367/859591</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
            <span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;.*will attempt to set the values inplace instead of always setting a new array. &quot;</span>
                <span class="s2">&quot;To retain the old behavior, use either.*&quot;</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">ct_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct</span>
    <span class="k">return</span> <span class="n">df</span></div>
</pre></div>

            </article>
            
            
            
            <footer class="bd-footer-article">
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
            
          </div>
          
          
          
            <div class="bd-sidebar-secondary bd-toc">
              
<div class="toc-item">
  
<div id="searchbox"></div>
</div>

<div class="toc-item">
  
</div>

<div class="toc-item">
  
</div>

            </div>
          
          
        </div>
        <footer class="bd-footer-content">
          <div class="bd-footer-content__inner">
            
          </div>
        </footer>
        
      </main>
    </div>
  </div>

  
    
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94"></script>

  <footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    
<p class="copyright">

    &copy; Copyright 2020, johentsch.<br>

</p>

  </div>
  
  <div class="footer-item">
    <p class="theme-version">
    Built with the
    <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">
        PyData Sphinx Theme
    </a>
    0.12.0.
</p>
  </div>
  
  <div class="footer-item">
    
<p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.3.0.<br>
</p>

  </div>
  
</div>
  </footer>
  </body>
</html>