
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ms3.utils &#8212; ms3 1.2.4.post0.dev2+gf30d960 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../../_static/styles/bootstrap.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=796348d33e8b1d947c94" rel="stylesheet">
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/thebelab.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94">
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/thebelab-helper.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/ms3/utils';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>

  
  <input type="checkbox" class="sidebar-toggle" name="__primary" id="__primary">
  <label class="overlay overlay-primary" for="__primary"></label>

  
  <input type="checkbox" class="sidebar-toggle" name="__secondary" id="__secondary">
  <label class="overlay overlay-secondary" for="__secondary"></label>

  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
      
<form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  </div>

  
  <nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
      <span class="fa-solid fa-bars"></span>
  </label>
  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../../index.html">

  
  
  
  
  
  
  

  
  
    <p class="title logo__title">ms3 1.2.4.post0.dev2+gf30d960 documentation</p>
  
</a>
    
  </div>

  
  <div class="col-lg-9 navbar-header-items">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../install.html">
                        Installation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../quick.html">
                        Quick Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../manual/index.html">
                        Manual
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../reference.html">
                        Developers' Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../license.html">
                        License
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../authors.html">
                        Authors
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../changelog.html">
                        Changelog
                      </a>
                    </li>
                
                </div>
            </div>
            
    </ul>
</nav>
      </div>
      
    </div>

    <div id="navbar-end">
      
        <div class="navbar-end-item navbar-persistent--container">
          
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
        </div>
      
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>


  
  
    <div class="navbar-persistent--mobile">
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
    </div>
  

  
  <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
  </label>
  

</div>
  </nav>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        
  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../install.html">
                        Installation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../quick.html">
                        Quick Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../manual/index.html">
                        Manual
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../reference.html">
                        Developers' Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../license.html">
                        License
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../authors.html">
                        Authors
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../changelog.html">
                        Changelog
                      </a>
                    </li>
                
                </div>
            </div>
            
    </ul>
</nav>
      </div>
      
      </div>
    

    
    
    <div class="sidebar-header-items__end">
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
    
  </div>

  
  <div class="sidebar-start-items sidebar-primary__section">
    <div class="sidebar-start-items__item">
<h3><a href="../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quick.html">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../manual/index.html">Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference.html">Developers' Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
</ul>

    </div>
    <div class="sidebar-start-items__item">
    </div>
    <div class="sidebar-start-items__item">
    </div>
    <div class="sidebar-start-items__item">
<div id="searchbox"></div>
    </div>
  </div>
  

  
  <div class="sidebar-end-items sidebar-primary__section">
    <div class="sidebar-end-items__item">
    </div>
  </div>

  
  <div id="rtd-footer-container"></div>

      </div>
      <main id="main-content" class="bd-main">
        
        
        <div class="bd-content">
          <div class="bd-article-container">
            
            <div class="bd-header-article">
                
            </div>
            
            
            <article class="bd-article" role="main">
              
  <h1>Source code for ms3.utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">dataclasses</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">sys</span><span class="o">,</span> <span class="nn">platform</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">namedtuple</span><span class="p">,</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">fractions</span> <span class="kn">import</span> <span class="n">Fraction</span> <span class="k">as</span> <span class="n">frac</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span><span class="p">,</span> <span class="n">lru_cache</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">getfullargspec</span><span class="p">,</span> <span class="n">stack</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">repeat</span><span class="p">,</span> <span class="n">takewhile</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">which</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">NamedTemporaryFile</span> <span class="k">as</span> <span class="n">Temp</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">overload</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Iterator</span>
<span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span> <span class="k">as</span> <span class="n">Zip</span>

<span class="kn">import</span> <span class="nn">git</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">webcolors</span>
<span class="kn">from</span> <span class="nn">gitdb.exc</span> <span class="kn">import</span> <span class="n">BadName</span>
<span class="kn">from</span> <span class="nn">numpy.typing</span> <span class="kn">import</span> <span class="n">NDArray</span>
<span class="kn">from</span> <span class="nn">pandas._typing</span> <span class="kn">import</span> <span class="n">Dtype</span>
<span class="kn">from</span> <span class="nn">pandas.errors</span> <span class="kn">import</span> <span class="n">EmptyDataError</span>
<span class="kn">from</span> <span class="nn">pathos</span> <span class="kn">import</span> <span class="n">multiprocessing</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">pytablewriter</span> <span class="kn">import</span> <span class="n">MarkdownTableWriter</span>

<span class="kn">from</span> <span class="nn">.logger</span> <span class="kn">import</span> <span class="n">function_logger</span><span class="p">,</span> <span class="n">update_cfg</span><span class="p">,</span> <span class="n">LogCapturer</span>
<span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">FileDict</span><span class="p">,</span> <span class="n">Facet</span><span class="p">,</span> <span class="n">ViewDict</span><span class="p">,</span> <span class="n">FileDataframeTupleMaybe</span>

<span class="n">MS3_VERSION</span> <span class="o">=</span> <span class="s1">&#39;1.2.4&#39;</span>
<span class="n">LATEST_MUSESCORE_VERSION</span> <span class="o">=</span> <span class="s1">&#39;3.6.2&#39;</span>
<span class="n">COMPUTED_METADATA_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;TimeSig&#39;</span><span class="p">,</span> <span class="s1">&#39;KeySig&#39;</span><span class="p">,</span> <span class="s1">&#39;last_mc&#39;</span><span class="p">,</span> <span class="s1">&#39;last_mn&#39;</span><span class="p">,</span> <span class="s1">&#39;length_qb&#39;</span><span class="p">,</span> <span class="s1">&#39;last_mc_unfolded&#39;</span><span class="p">,</span> <span class="s1">&#39;last_mn_unfolded&#39;</span><span class="p">,</span> <span class="s1">&#39;length_qb_unfolded&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;volta_mcs&#39;</span><span class="p">,</span> <span class="s1">&#39;all_notes_qb&#39;</span><span class="p">,</span> <span class="s1">&#39;n_onsets&#39;</span><span class="p">,</span> <span class="s1">&#39;n_onset_positions&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;guitar_chord_count&#39;</span><span class="p">,</span> <span class="s1">&#39;form_label_count&#39;</span><span class="p">,</span> <span class="s1">&#39;label_count&#39;</span><span class="p">,</span> <span class="s1">&#39;annotated_key&#39;</span><span class="p">,</span> <span class="p">]</span>
<span class="sd">&quot;&quot;&quot;Automatically computed columns&quot;&quot;&quot;</span>

<span class="n">DCML_METADATA_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;harmony_version&#39;</span><span class="p">,</span> <span class="s1">&#39;annotators&#39;</span><span class="p">,</span> <span class="s1">&#39;reviewers&#39;</span><span class="p">,</span> <span class="s1">&#39;score_integrity&#39;</span><span class="p">,</span> <span class="s1">&#39;composed_start&#39;</span><span class="p">,</span> <span class="s1">&#39;composed_end&#39;</span><span class="p">,</span> <span class="s1">&#39;composed_source&#39;</span><span class="p">]</span>
<span class="sd">&quot;&quot;&quot;Arbitrary column names used in the DCML corpus initiative&quot;&quot;&quot;</span>


<span class="n">MUSESCORE_METADATA_FIELDS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;composer&#39;</span><span class="p">,</span> <span class="s1">&#39;workTitle&#39;</span><span class="p">,</span> <span class="s1">&#39;movementNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;movementTitle&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;workNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;poet&#39;</span><span class="p">,</span> <span class="s1">&#39;lyricist&#39;</span><span class="p">,</span> <span class="s1">&#39;arranger&#39;</span><span class="p">,</span> <span class="s1">&#39;copyright&#39;</span><span class="p">,</span> <span class="s1">&#39;creationDate&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;mscVersion&#39;</span><span class="p">,</span> <span class="s1">&#39;platform&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;translator&#39;</span><span class="p">,]</span>
<span class="sd">&quot;&quot;&quot;Default fields available in the File -&gt; Score Properties... menu.&quot;&quot;&quot;</span>

<span class="n">VERSION_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;musescore&#39;</span><span class="p">,</span> <span class="s1">&#39;ms3_version&#39;</span><span class="p">,]</span>
<span class="sd">&quot;&quot;&quot;Software versions&quot;&quot;&quot;</span>

<span class="n">INSTRUMENT_RELATED_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;has_drumset&#39;</span><span class="p">,</span> <span class="s1">&#39;ambitus&#39;</span><span class="p">]</span>

<span class="n">MUSESCORE_HEADER_FIELDS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;title_text&#39;</span><span class="p">,</span> <span class="s1">&#39;subtitle_text&#39;</span><span class="p">,</span> <span class="s1">&#39;lyricist_text&#39;</span><span class="p">,</span> <span class="s1">&#39;composer_text&#39;</span><span class="p">,</span> <span class="s1">&#39;part_name_text&#39;</span><span class="p">,]</span>
<span class="sd">&quot;&quot;&quot;Default text fields in MuseScore&quot;&quot;&quot;</span>

<span class="n">OTHER_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;subdirectory&#39;</span><span class="p">,</span> <span class="s1">&#39;rel_path&#39;</span><span class="p">,]</span>

<span class="n">LEGACY_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fnames&#39;</span><span class="p">,</span> <span class="s1">&#39;rel_paths&#39;</span><span class="p">,</span> <span class="s1">&#39;md5&#39;</span><span class="p">,]</span>

<span class="n">AUTOMATIC_COLUMNS</span> <span class="o">=</span> <span class="n">COMPUTED_METADATA_COLUMNS</span> <span class="o">+</span> <span class="n">VERSION_COLUMNS</span> <span class="o">+</span> <span class="n">INSTRUMENT_RELATED_COLUMNS</span> <span class="o">+</span> <span class="n">OTHER_COLUMNS</span>
<span class="sd">&quot;&quot;&quot;This combination of column names is excluded when updating metadata fields in MuseScore files via ms3 metadata.&quot;&quot;&quot;</span>

<span class="n">METADATA_COLUMN_ORDER</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">COMPUTED_METADATA_COLUMNS</span> <span class="o">+</span> <span class="n">DCML_METADATA_COLUMNS</span> <span class="o">+</span> <span class="n">MUSESCORE_METADATA_FIELDS</span> <span class="o">+</span> <span class="n">MUSESCORE_HEADER_FIELDS</span> <span class="o">+</span> <span class="n">VERSION_COLUMNS</span> <span class="o">+</span> <span class="n">OTHER_COLUMNS</span> <span class="o">+</span> <span class="n">INSTRUMENT_RELATED_COLUMNS</span>
<span class="sd">&quot;&quot;&quot;The default order in which columns of metadata.tsv files are to be sorted.&quot;&quot;&quot;</span>

<span class="n">SCORE_EXTENSIONS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;.mscx&#39;</span><span class="p">,</span> <span class="s1">&#39;.mscz&#39;</span><span class="p">,</span> <span class="s1">&#39;.cap&#39;</span><span class="p">,</span> <span class="s1">&#39;.capx&#39;</span><span class="p">,</span> <span class="s1">&#39;.midi&#39;</span><span class="p">,</span> <span class="s1">&#39;.mid&#39;</span><span class="p">,</span> <span class="s1">&#39;.musicxml&#39;</span><span class="p">,</span> <span class="s1">&#39;.mxl&#39;</span><span class="p">,</span> <span class="s1">&#39;.xml&#39;</span><span class="p">)</span>

<span class="n">STANDARD_COLUMN_ORDER</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;mc_playthrough&#39;</span><span class="p">,</span> <span class="s1">&#39;mn&#39;</span><span class="p">,</span> <span class="s1">&#39;mn_playthrough&#39;</span><span class="p">,</span> <span class="s1">&#39;quarterbeats&#39;</span><span class="p">,</span> <span class="s1">&#39;mc_onset&#39;</span><span class="p">,</span> <span class="s1">&#39;mn_onset&#39;</span><span class="p">,</span> <span class="s1">&#39;beat&#39;</span><span class="p">,</span>
    <span class="s1">&#39;event&#39;</span><span class="p">,</span> <span class="s1">&#39;timesig&#39;</span><span class="p">,</span> <span class="s1">&#39;staff&#39;</span><span class="p">,</span> <span class="s1">&#39;voice&#39;</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="s1">&#39;tied&#39;</span><span class="p">,</span>
    <span class="s1">&#39;gracenote&#39;</span><span class="p">,</span> <span class="s1">&#39;nominal_duration&#39;</span><span class="p">,</span> <span class="s1">&#39;scalar&#39;</span><span class="p">,</span> <span class="s1">&#39;tpc&#39;</span><span class="p">,</span> <span class="s1">&#39;midi&#39;</span><span class="p">,</span> <span class="s1">&#39;volta&#39;</span><span class="p">,</span> <span class="s1">&#39;chord_id&#39;</span><span class="p">]</span>

<span class="n">STANDARD_NAMES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;notes_and_rests&#39;</span><span class="p">,</span> <span class="s1">&#39;rests&#39;</span><span class="p">,</span> <span class="s1">&#39;notes&#39;</span><span class="p">,</span> <span class="s1">&#39;measures&#39;</span><span class="p">,</span> <span class="s1">&#39;events&#39;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">,</span> <span class="s1">&#39;chords&#39;</span><span class="p">,</span> <span class="s1">&#39;expanded&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;harmonies&#39;</span><span class="p">,</span> <span class="s1">&#39;cadences&#39;</span><span class="p">,</span> <span class="s1">&#39;form_labels&#39;</span><span class="p">,</span> <span class="s1">&#39;MS3&#39;</span><span class="p">,</span> <span class="s1">&#39;scores&#39;</span><span class="p">]</span>
<span class="sd">&quot;&quot;&quot;:obj:`list`</span>
<span class="sd">Indicators for corpora: If a folder contains any file or folder beginning or ending on any of these names, it is </span>
<span class="sd">considered to be a corpus by the function :py:func:`iterate_corpora`.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">STANDARD_NAMES_OR_GIT</span> <span class="o">=</span> <span class="n">STANDARD_NAMES</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;.git&quot;</span><span class="p">]</span>


<span class="n">DCML_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">^(\.?</span>
<span class="s2">    ((?P&lt;globalkey&gt;[a-gA-G](b*|\#*))\.)?</span>
<span class="s2">    ((?P&lt;localkey&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)+)\.)?</span>
<span class="s2">    ((?P&lt;pedal&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)+)\[)?</span>
<span class="s2">    (?P&lt;chord&gt;</span>
<span class="s2">        (?P&lt;numeral&gt;(b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i|Ger|It|Fr|@none))</span>
<span class="s2">        (?P&lt;form&gt;(%|o|\+|M|\+M))?</span>
<span class="s2">        (?P&lt;figbass&gt;(7|65|43|42|2|64|6))?</span>
<span class="s2">        (\((?P&lt;changes&gt;((\+|-|\^|v)?(b*|\#*)\d)+)\))?</span>
<span class="s2">        (/(?P&lt;relativeroot&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)*))?</span>
<span class="s2">    )</span>
<span class="s2">    (?P&lt;pedalend&gt;\])?</span>
<span class="s2">)?</span>
<span class="s2">(\|(?P&lt;cadence&gt;((HC|PAC|IAC|DC|EC|PC)(\..+?)?)))?</span>
<span class="s2">(?P&lt;phraseend&gt;(\\\\|\}\{|\{|\}))?$</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;:obj:`str`</span>
<span class="sd">Constant with a regular expression that recognizes labels conforming to the DCML harmony annotation standard excluding those</span>
<span class="sd">consisting of two alternatives.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">DCML_DOUBLE_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                                ^(?P&lt;first&gt;</span>
<span class="s2">                                  (\.?</span>
<span class="s2">                                    ((?P&lt;globalkey&gt;[a-gA-G](b*|\#*))\.)?</span>
<span class="s2">                                    ((?P&lt;localkey&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)+)\.)?</span>
<span class="s2">                                    ((?P&lt;pedal&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)+)\[)?</span>
<span class="s2">                                    (?P&lt;chord&gt;</span>
<span class="s2">                                        (?P&lt;numeral&gt;(b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i|Ger|It|Fr|@none))</span>
<span class="s2">                                        (?P&lt;form&gt;(%|o|\+|M|\+M))?</span>
<span class="s2">                                        (?P&lt;figbass&gt;(7|65|43|42|2|64|6))?</span>
<span class="s2">                                        (\((?P&lt;changes&gt;((\+|-|\^|v)?(b*|\#*)\d)+)\))?</span>
<span class="s2">                                        (/(?P&lt;relativeroot&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)*))?</span>
<span class="s2">                                    )</span>
<span class="s2">                                    (?P&lt;pedalend&gt;\])?</span>
<span class="s2">                                  )?</span>
<span class="s2">                                  (\|(?P&lt;cadence&gt;((HC|PAC|IAC|DC|EC|PC)(\..+?)?)))?</span>
<span class="s2">                                  (?P&lt;phraseend&gt;(\\\\|\}\{|\{|\})</span>
<span class="s2">                                  )?</span>
<span class="s2">                                 )</span>
<span class="s2">                                 (-</span>
<span class="s2">                                  (?P&lt;second&gt;</span>
<span class="s2">                                    ((?P&lt;globalkey2&gt;[a-gA-G](b*|\#*))\.)?</span>
<span class="s2">                                    ((?P&lt;localkey2&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)+)\.)?</span>
<span class="s2">                                    ((?P&lt;pedal2&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)+)\[)?</span>
<span class="s2">                                    (?P&lt;chord2&gt;</span>
<span class="s2">                                        (?P&lt;numeral2&gt;(b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i|Ger|It|Fr|@none))</span>
<span class="s2">                                        (?P&lt;form2&gt;(%|o|\+|M|\+M))?</span>
<span class="s2">                                        (?P&lt;figbass2&gt;(7|65|43|42|2|64|6))?</span>
<span class="s2">                                        (\((?P&lt;changes2&gt;((\+|-|\^|v)?(b*|\#*)\d)+)\))?</span>
<span class="s2">                                        (/(?P&lt;relativeroot2&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)*))?</span>
<span class="s2">                                    )</span>
<span class="s2">                                    (?P&lt;pedalend2&gt;\])?</span>
<span class="s2">                                  )?</span>
<span class="s2">                                  (\|(?P&lt;cadence2&gt;((HC|PAC|IAC|DC|EC|PC)(\..+?)?)))?</span>
<span class="s2">                                  (?P&lt;phraseend2&gt;(\\\\|\}\{|\{|\})</span>
<span class="s2">                                  )?</span>
<span class="s2">                                 )?</span>
<span class="s2">                                $</span>
<span class="s2">                                &quot;&quot;&quot;</span><span class="p">,</span>
                        <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;:obj:`str`</span>
<span class="sd">Constant with a regular expression that recognizes complete labels conforming to the DCML harmony annotation standard </span>
<span class="sd">including those consisting of two alternatives, without having to split them. It is simply a doubled version of DCML_REGEX.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">FORM_DETECTION_REGEX</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^\d{1,2}.*?:&quot;</span>
<span class="sd">&quot;&quot;&quot;:obj:`str`</span>
<span class="sd">Following Gotham &amp; Ireland (@ISMIR 20 (2019): &quot;Taking Form: A Representation Standard, Conversion Code, and Example Corpus for Recording, Visualizing, and Studying Analyses of Musical Form&quot;),</span>
<span class="sd">detects form labels as those strings that start with indicating a hierarchical level (one or two digits) followed by a colon.</span>
<span class="sd">By extension (Llorens et al., forthcoming), allows one or more &#39;i&#39; characters or any other alphabet character to further specify the level.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">FORM_LEVEL_REGEX</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^(?P&lt;level&gt;\d{1,2})?(?P&lt;form_tree&gt;[a-h])?(?P&lt;reading&gt;[ivx]+)?:?$&quot;</span> <span class="c1"># (?P&lt;token&gt;(?:\D|\d+(?!(?:$|i+|\w)?[\&amp;=:]))+)&quot;</span>
<span class="n">FORM_LEVEL_FORMAT</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\d{1,2}[a-h]?[ivx]*(?:\&amp;\d{0,2}[a-h]?[ivx]*)*&quot;</span>
<span class="n">FORM_LEVEL_SPLIT_REGEX</span> <span class="o">=</span> <span class="n">FORM_LEVEL_FORMAT</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span>
<span class="n">FORM_LEVEL_CAPTURE_REGEX</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(?P&lt;levels&gt;</span><span class="si">{</span><span class="n">FORM_LEVEL_FORMAT</span><span class="si">}</span><span class="s2">):&quot;</span>
<span class="n">FORM_TOKEN_ABBREVIATIONS</span> <span class="o">=</span> <span class="p">{</span>
 <span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="s1">&#39;satz&#39;</span><span class="p">,</span>
 <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="s1">&#39;unit&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ah&#39;</span><span class="p">:</span> <span class="s1">&#39;anhang&#39;</span><span class="p">,</span>
 <span class="s1">&#39;bi&#39;</span><span class="p">:</span> <span class="s1">&#39;basic idea&#39;</span><span class="p">,</span>
 <span class="s1">&#39;br&#39;</span><span class="p">:</span> <span class="s1">&#39;bridge&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ci&#39;</span><span class="p">:</span> <span class="s1">&#39;contrasting idea&#39;</span><span class="p">,</span>
 <span class="s1">&#39;cr&#39;</span><span class="p">:</span> <span class="s1">&#39;crux&#39;</span><span class="p">,</span>
 <span class="s1">&#39;eg&#39;</span><span class="p">:</span> <span class="s1">&#39;eingang&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hp&#39;</span><span class="p">:</span> <span class="s1">&#39;hauptperiode&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hs&#39;</span><span class="p">:</span> <span class="s1">&#39;hauptsatz&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ip&#39;</span><span class="p">:</span> <span class="s1">&#39;interpolation&#39;</span><span class="p">,</span>
 <span class="s1">&#39;li&#39;</span><span class="p">:</span> <span class="s1">&#39;lead-in&#39;</span><span class="p">,</span>
 <span class="s1">&#39;pc&#39;</span><span class="p">:</span> <span class="s1">&#39;pre-core&#39;</span><span class="p">,</span>
 <span class="s1">&#39;pd&#39;</span><span class="p">:</span> <span class="s1">&#39;period&#39;</span><span class="p">,</span>
 <span class="s1">&#39;si&#39;</span><span class="p">:</span> <span class="s1">&#39;secondary idea&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ti&#39;</span><span class="p">:</span> <span class="s1">&#39;thematic introduction&#39;</span><span class="p">,</span>
 <span class="s1">&#39;tr&#39;</span><span class="p">:</span> <span class="s1">&#39;transition&#39;</span><span class="p">,</span>
 <span class="s1">&#39;1st&#39;</span><span class="p">:</span> <span class="s1">&#39;first theme&#39;</span><span class="p">,</span>
 <span class="s1">&#39;2nd&#39;</span><span class="p">:</span> <span class="s1">&#39;second theme&#39;</span><span class="p">,</span>
 <span class="s1">&#39;3rd&#39;</span><span class="p">:</span> <span class="s1">&#39;third theme&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ans&#39;</span><span class="p">:</span> <span class="s1">&#39;answer&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ant&#39;</span><span class="p">:</span> <span class="s1">&#39;antecedent&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ate&#39;</span><span class="p">:</span> <span class="s1">&#39;after-the-end&#39;</span><span class="p">,</span>
 <span class="s1">&#39;beg&#39;</span><span class="p">:</span> <span class="s1">&#39;beginning&#39;</span><span class="p">,</span>
 <span class="s1">&#39;btb&#39;</span><span class="p">:</span> <span class="s1">&#39;before-the-beginning&#39;</span><span class="p">,</span>
 <span class="s1">&#39;cad&#39;</span><span class="p">:</span> <span class="s1">&#39;cadential idea&#39;</span><span class="p">,</span>
 <span class="s1">&#39;cbi&#39;</span><span class="p">:</span> <span class="s1">&#39;compound basic idea&#39;</span><span class="p">,</span>
 <span class="s1">&#39;chr&#39;</span><span class="p">:</span> <span class="s1">&#39;chorus&#39;</span><span class="p">,</span>
 <span class="s1">&#39;cls&#39;</span><span class="p">:</span> <span class="s1">&#39;closing theme&#39;</span><span class="p">,</span>
 <span class="s1">&#39;dev&#39;</span><span class="p">:</span> <span class="s1">&#39;development section&#39;</span><span class="p">,</span>
 <span class="s1">&#39;epi&#39;</span><span class="p">:</span> <span class="s1">&#39;episode&#39;</span><span class="p">,</span>
 <span class="s1">&#39;exp&#39;</span><span class="p">:</span> <span class="s1">&#39;exposition&#39;</span><span class="p">,</span>
 <span class="s1">&#39;liq&#39;</span><span class="p">:</span> <span class="s1">&#39;liquidation&#39;</span><span class="p">,</span>
 <span class="s1">&#39;mid&#39;</span><span class="p">:</span> <span class="s1">&#39;middle&#39;</span><span class="p">,</span>
 <span class="s1">&#39;mod&#39;</span><span class="p">:</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span>
 <span class="s1">&#39;mvt&#39;</span><span class="p">:</span> <span class="s1">&#39;movement&#39;</span><span class="p">,</span>
 <span class="s1">&#39;rec&#39;</span><span class="p">:</span> <span class="s1">&#39;recapitulation&#39;</span><span class="p">,</span>
 <span class="s1">&#39;rep&#39;</span><span class="p">:</span> <span class="s1">&#39;repetition&#39;</span><span class="p">,</span>
 <span class="s1">&#39;rit&#39;</span><span class="p">:</span> <span class="s1">&#39;ritornello&#39;</span><span class="p">,</span>
 <span class="s1">&#39;rtr&#39;</span><span class="p">:</span> <span class="s1">&#39;retransition&#39;</span><span class="p">,</span>
 <span class="s1">&#39;seq&#39;</span><span class="p">:</span> <span class="s1">&#39;sequence&#39;</span><span class="p">,</span>
 <span class="s1">&#39;sub&#39;</span><span class="p">:</span> <span class="s1">&#39;subject&#39;</span><span class="p">,</span>
 <span class="s1">&#39;th0&#39;</span><span class="p">:</span> <span class="s1">&#39;theme0&#39;</span><span class="p">,</span>
 <span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="s1">&#39;variation&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ver&#39;</span><span class="p">:</span> <span class="s1">&#39;verse&#39;</span><span class="p">,</span>
 <span class="s1">&#39;cdza&#39;</span><span class="p">:</span> <span class="s1">&#39;cadenza&#39;</span><span class="p">,</span>
 <span class="s1">&#39;coda&#39;</span><span class="p">:</span> <span class="s1">&#39;coda&#39;</span><span class="p">,</span>
 <span class="s1">&#39;cons&#39;</span><span class="p">:</span> <span class="s1">&#39;consequent&#39;</span><span class="p">,</span>
 <span class="s1">&#39;cont&#39;</span><span class="p">:</span> <span class="s1">&#39;continuation&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ctta&#39;</span><span class="p">:</span> <span class="s1">&#39;codetta&#39;</span><span class="p">,</span>
 <span class="s1">&#39;depi&#39;</span><span class="p">:</span> <span class="s1">&#39;display episode&#39;</span><span class="p">,</span>
 <span class="s1">&#39;diss&#39;</span><span class="p">:</span> <span class="s1">&#39;dissolution&#39;</span><span class="p">,</span>
 <span class="s1">&#39;expa&#39;</span><span class="p">:</span> <span class="s1">&#39;expansion&#39;</span><span class="p">,</span>
 <span class="s1">&#39;frag&#39;</span><span class="p">:</span> <span class="s1">&#39;fragmentation&#39;</span><span class="p">,</span>
 <span class="s1">&#39;pcad&#39;</span><span class="p">:</span> <span class="s1">&#39;postcadential&#39;</span><span class="p">,</span>
 <span class="s1">&#39;pres&#39;</span><span class="p">:</span> <span class="s1">&#39;presentation&#39;</span><span class="p">,</span>
 <span class="s1">&#39;schl&#39;</span><span class="p">:</span> <span class="s1">&#39;schlusssatz&#39;</span><span class="p">,</span>
 <span class="s1">&#39;sent&#39;</span><span class="p">:</span> <span class="s1">&#39;sentence&#39;</span><span class="p">,</span>
 <span class="s1">&#39;intro&#39;</span><span class="p">:</span> <span class="s1">&#39;introduction&#39;</span><span class="p">,</span>
 <span class="s1">&#39;prchr&#39;</span><span class="p">:</span> <span class="s1">&#39;pre-chorus&#39;</span><span class="p">,</span>
 <span class="s1">&#39;ptchr&#39;</span><span class="p">:</span> <span class="s1">&#39;post-chorus&#39;</span>
<span class="p">}</span>


<span class="n">MS3_HTML</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;#005500&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkgreen&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aa0000&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkred&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aa5500&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_sienna&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#00aa00&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_green&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aaaa00&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkgoldenrod&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aaff00&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_chartreuse&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#00007f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_navy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aa007f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkmagenta&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#00557f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_teal&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aa557f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_indianred&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#00aa7f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkcyan&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aaaa7f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkgray&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aaff7f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_palegreen&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aa00ff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkviolet&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#0055ff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_dodgerblue&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aa55ff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_mediumorchid&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#00aaff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_deepskyblue&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aaaaff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_lightsteelblue&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aaffff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_paleturquoise&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#550000&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_maroon&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#555500&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkolivegreen&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#ff5500&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_orangered&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#55aa00&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_olive&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#ffaa00&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_orange&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#55ff00&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_lawngreen&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#55007f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_indigo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#ff007f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_deeppink&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#55557f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkslateblue&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#ff557f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_lightcoral&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#55aa7f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_mediumseagreen&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#ffaa7f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_lightsalmon&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#55ff7f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_lightgreen&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#ffff7f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_khaki&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#5500ff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_blue&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#5555ff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_royalblue&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#ff55ff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_violet&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#55aaff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_cornflowerblue&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#ffaaff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_lightpink&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#55ffff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_aquamarine&#39;</span><span class="p">}</span>

<span class="n">MS3_RGB</span> <span class="o">=</span> <span class="p">{(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_darkgreen&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_darkred&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_sienna&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_green&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_darkgoldenrod&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_chartreuse&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_navy&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_darkmagenta&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_teal&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_indianred&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_darkcyan&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_darkgray&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_palegreen&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_darkviolet&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_dodgerblue&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_mediumorchid&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_deepskyblue&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_lightsteelblue&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_paleturquoise&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_maroon&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_darkolivegreen&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_orangered&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_olive&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_orange&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_lawngreen&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_indigo&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_deeppink&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_darkslateblue&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_lightcoral&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_mediumseagreen&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_lightsalmon&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_lightgreen&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_khaki&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_blue&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_royalblue&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_violet&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_cornflowerblue&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_lightpink&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_aquamarine&#39;</span><span class="p">}</span>

<span class="n">MS3_COLORS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">MS3_HTML</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="n">CSS2MS3</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">:]:</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">MS3_COLORS</span><span class="p">}</span>
<span class="n">CSS_COLORS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">webcolors</span><span class="o">.</span><span class="n">CSS3_NAMES_TO_HEX</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">COLORS</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([[</span><span class="n">c</span><span class="p">,</span> <span class="n">CSS2MS3</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CSS2MS3</span> <span class="k">else</span> <span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CSS_COLORS</span><span class="p">],</span> <span class="p">[])</span>
<span class="n">rgba</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;RGBA&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">])</span>


<div class="viewcode-block" id="map_dict"><a class="viewcode-back" href="../../reference.html#ms3.utils.map_dict">[docs]</a><span class="k">class</span> <span class="nc">map_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Such a dictionary can be mapped to a Series to replace its values but leaving the values absent from the dict keys intact.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__missing__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span></div>


<div class="viewcode-block" id="assert_all_lines_equal"><a class="viewcode-back" href="../../reference.html#ms3.utils.assert_all_lines_equal">[docs]</a><span class="k">def</span> <span class="nf">assert_all_lines_equal</span><span class="p">(</span><span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="n">original</span><span class="p">,</span> <span class="n">tmp_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Compares two multiline strings to test equality.&quot;&quot;&quot;</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">bef</span><span class="p">,</span> <span class="n">aft</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">bef</span><span class="p">,</span> <span class="n">aft</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">before</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(),</span> <span class="n">after</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()),</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">bef</span> <span class="o">!=</span> <span class="n">aft</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">line_n</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">diff</span><span class="p">)</span>
        <span class="n">ln</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">line_n</span><span class="p">)))</span> <span class="c1"># length of the longest line number</span>
        <span class="n">left_col</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">left</span><span class="p">)</span> <span class="c1"># length of the longest line</span>
        <span class="n">folder</span><span class="p">,</span> <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
        <span class="n">tmp_persist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">tmp_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tmp_persist</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">original</span><span class="p">,</span> <span class="n">tmp_persist</span><span class="p">)]</span> <span class="o">+</span> <span class="n">diff</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">a</span><span class="si">:{</span><span class="n">ln</span><span class="si">}}</span><span class="s2">  </span><span class="si">{</span><span class="n">b</span><span class="si">:{</span><span class="n">left_col</span><span class="si">}}</span><span class="s2">    </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">)</span></div>


<div class="viewcode-block" id="assert_dfs_equal"><a class="viewcode-back" href="../../reference.html#ms3.utils.assert_dfs_equal">[docs]</a><span class="k">def</span> <span class="nf">assert_dfs_equal</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Compares the common columns of two DataFrames to test equality. Uses: nan_eq()&quot;&quot;&quot;</span>
    <span class="n">old_l</span><span class="p">,</span> <span class="n">new_l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">old</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
    <span class="n">greater_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">old_l</span><span class="p">,</span> <span class="n">new_l</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">old_l</span> <span class="o">!=</span> <span class="n">new_l</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Old length: </span><span class="si">{</span><span class="n">old_l</span><span class="si">}</span><span class="s2">, new length: </span><span class="si">{</span><span class="n">new_l</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">old_is_shorter</span> <span class="o">=</span> <span class="n">new_l</span> <span class="o">==</span> <span class="n">greater_length</span>
        <span class="n">shorter</span> <span class="o">=</span> <span class="n">old</span> <span class="k">if</span> <span class="n">old_is_shorter</span> <span class="k">else</span> <span class="n">new</span>
        <span class="n">missing_rows</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">old_l</span> <span class="o">-</span> <span class="n">new_l</span><span class="p">)</span>
        <span class="n">shorter_cols</span> <span class="o">=</span> <span class="n">shorter</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">patch</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="s1">&#39;missing row&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">shorter_cols</span><span class="p">)]</span> <span class="o">*</span> <span class="n">missing_rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">shorter_cols</span><span class="p">)</span>
        <span class="n">shorter</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">shorter</span><span class="p">,</span> <span class="n">patch</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">old_is_shorter</span><span class="p">:</span>
            <span class="n">old</span> <span class="o">=</span> <span class="n">shorter</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">shorter</span>
    <span class="c1"># old.index.rename(&#39;old_ix&#39;, inplace=True)</span>
    <span class="c1"># new.index.rename(&#39;new_ix&#39;, inplace=True)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">old</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">new</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">]</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="o">~</span><span class="n">nan_eq</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="k">for</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">o</span><span class="p">),</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">(),</span> <span class="n">new</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">())]</span>
    <span class="n">old_bool</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="n">ix</span><span class="p">:</span> <span class="n">bool_series</span> <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">bool_series</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">},</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
    <span class="n">new_bool</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="n">ix</span><span class="p">:</span> <span class="n">bool_series</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">bool_series</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">},</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
    <span class="n">diffs_per_col</span> <span class="o">=</span> <span class="n">old_bool</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_diff</span><span class="p">():</span>
        <span class="n">comp_str</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;mc&#39;</span> <span class="ow">in</span> <span class="n">old</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">position_col</span> <span class="o">=</span> <span class="s1">&#39;mc&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;last_mc&#39;</span> <span class="ow">in</span> <span class="n">old</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">position_col</span> <span class="o">=</span> <span class="s1">&#39;last_mc&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">position_col</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">n_diffs</span> <span class="ow">in</span> <span class="n">diffs_per_col</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">n_diffs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">position_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">columns</span> <span class="o">=</span> <span class="n">col</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">position_col</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
                <span class="n">comparison</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">old</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">old_bool</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">20</span><span class="p">],</span>
                                        <span class="n">new</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_bool</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span>
                                       <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                       <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;old&#39;</span><span class="p">,</span> <span class="s1">&#39;new&#39;</span><span class="p">])</span>
                <span class="n">comp_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n_diffs</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">greater_length</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">n_diffs</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">greater_length</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> %) rows are different for </span><span class="si">{</span><span class="n">col</span><span class="si">}{</span><span class="s1">&#39; (showing first 20)&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">n_diffs</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="n">comparison</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">comp_str</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">diffs_per_col</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">show_diff</span><span class="p">()</span></div>



<div class="viewcode-block" id="ambitus2oneliner"><a class="viewcode-back" href="../../reference.html#ms3.utils.ambitus2oneliner">[docs]</a><span class="k">def</span> <span class="nf">ambitus2oneliner</span><span class="p">(</span><span class="n">ambitus</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Turns a ``metadata[&#39;parts&#39;][staff_id]`` dictionary into a string.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;min_midi&#39;</span> <span class="ow">in</span> <span class="n">ambitus</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ambitus</span><span class="p">[</span><span class="s1">&#39;min_midi&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">ambitus</span><span class="p">[</span><span class="s1">&#39;max_midi&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">ambitus</span><span class="p">[</span><span class="s1">&#39;min_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">ambitus</span><span class="p">[</span><span class="s1">&#39;max_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;max_midi&#39;</span> <span class="ow">in</span> <span class="n">ambitus</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ambitus</span><span class="p">[</span><span class="s1">&#39;max_midi&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">ambitus</span><span class="p">[</span><span class="s1">&#39;max_midi&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">ambitus</span><span class="p">[</span><span class="s1">&#39;max_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">ambitus</span><span class="p">[</span><span class="s1">&#39;max_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span></div>



<div class="viewcode-block" id="changes2list"><a class="viewcode-back" href="../../reference.html#ms3.utils.changes2list">[docs]</a><span class="k">def</span> <span class="nf">changes2list</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Splits a string of changes into a list of 4-tuples.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; changes2list(&#39;+#7b5&#39;)</span>
<span class="sd">    [(&#39;+#7&#39;, &#39;+&#39;, &#39;#&#39;, &#39;7&#39;),</span>
<span class="sd">     (&#39;b5&#39;,  &#39;&#39;,  &#39;b&#39;, &#39;5&#39;)]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;((\+|-|\^|v)?(#+|b+)?(1\d|\d))&quot;</span><span class="p">,</span> <span class="n">changes</span><span class="p">)]</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">sort</span> <span class="k">else</span> <span class="n">res</span></div>



<div class="viewcode-block" id="changes2tpc"><a class="viewcode-back" href="../../reference.html#ms3.utils.changes2tpc">[docs]</a><span class="k">def</span> <span class="nf">changes2tpc</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">numeral</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">root_alterations</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a numeral and changes, computes the intervals that the changes represent.</span>
<span class="sd">    Changes do not express absolute intervals but instead depend on the numeral and the mode.</span>

<span class="sd">    Uses: split_scale_degree(), changes2list()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    changes : :obj:`str`</span>
<span class="sd">        A string of changes following the DCML harmony standard.</span>
<span class="sd">    numeral : :obj:`str`</span>
<span class="sd">        Roman numeral. If it is preceded by accidentals, it depends on the parameter</span>
<span class="sd">        `root_alterations` whether these are taken into account.</span>
<span class="sd">    minor : :obj:`bool`, optional</span>
<span class="sd">        Set to true if the `numeral` occurs in a minor context.</span>
<span class="sd">    root_alterations : :obj:`bool`, optional</span>
<span class="sd">        Set to True if accidentals of the root should change the result.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">root_alteration</span><span class="p">,</span> <span class="n">num_degree</span> <span class="o">=</span> <span class="n">split_scale_degree</span><span class="p">(</span><span class="n">numeral</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="c1"># build 2-octave diatonic scale on C major/minor</span>
    <span class="n">root</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">num_degree</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="n">tpcs</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)]</span> <span class="k">if</span> <span class="n">minor</span> <span class="k">else</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)]</span>
    <span class="n">tpcs</span> <span class="o">=</span> <span class="n">tpcs</span><span class="p">[</span><span class="n">root</span><span class="p">:]</span> <span class="o">+</span> <span class="n">tpcs</span><span class="p">[:</span><span class="n">root</span><span class="p">]</span>  <span class="c1"># starting the scale from chord root</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">tpcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">root_alterations</span><span class="p">:</span>
        <span class="n">root</span> <span class="o">+=</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">root_alteration</span>
        <span class="n">tpcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">root</span>

    <span class="n">alts</span> <span class="o">=</span> <span class="n">changes2list</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">acc2tpc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">accidentals</span><span class="p">:</span> <span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="n">accidentals</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">accidentals</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">[(</span><span class="n">full</span><span class="p">,</span> <span class="n">added</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">chord_interval</span><span class="p">,</span>
             <span class="p">(</span><span class="n">tpcs</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">chord_interval</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">acc2tpc</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span> <span class="o">-</span> <span class="n">root</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">chord_interval</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span>
            <span class="n">full</span><span class="p">,</span> <span class="n">added</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">chord_interval</span> <span class="ow">in</span> <span class="n">alts</span><span class="p">]</span></div>



<div class="viewcode-block" id="check_labels"><a class="viewcode-back" href="../../reference.html#ms3.utils.check_labels">[docs]</a><span class="k">def</span> <span class="nf">check_labels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="n">split_regex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;mc_onset&#39;</span><span class="p">,</span> <span class="s1">&#39;staff&#39;</span><span class="p">,</span> <span class="s1">&#39;voice&#39;</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;  Checks the labels in ``column`` against ``regex`` and returns those that don&#39;t match.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        DataFrame containing a column with labels.</span>
<span class="sd">    regex : :obj:`str`</span>
<span class="sd">        Regular expression that incorrect labels don&#39;t match.</span>
<span class="sd">    column : :obj:`str`, optional</span>
<span class="sd">        Column name where the labels are. Defaults to &#39;label&#39;</span>
<span class="sd">    split_regex : :obj:`str`, optional</span>
<span class="sd">        If you pass a regular expression (or simple string), it will be used to split the labels before checking the</span>
<span class="sd">        resulting column separately. Instead, pass True to use the default (a &#39;-&#39; that does not precede a scale degree).</span>
<span class="sd">    return_cols : :obj:`list`, optional</span>
<span class="sd">        Pass a list of the DataFrame columns that you want to be displayed for the wrong labels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        DataFrame with wrong labels.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">split_regex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">split_regex</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">check_this</span> <span class="o">=</span> <span class="n">split_alternatives</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">column</span><span class="p">,</span> <span class="n">alternatives_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">check_this</span> <span class="o">=</span> <span class="n">split_alternatives</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">column</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="n">split_regex</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">alternatives_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">check_this</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">column</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">regex</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">!=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="vm">__class__</span><span class="p">:</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
    <span class="n">not_matched</span> <span class="o">=</span> <span class="n">check_this</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="o">~</span><span class="n">c</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">return_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">select_wrong</span> <span class="o">=</span> <span class="n">not_matched</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">check_this</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">not_matched</span><span class="p">,</span> <span class="n">other</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="n">select_wrong</span><span class="p">]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;^/$&#39;</span><span class="p">,</span> <span class="s1">&#39;empty_harmony&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_wrong</span><span class="p">,</span> <span class="n">cols</span><span class="p">],</span> <span class="n">res</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>





<div class="viewcode-block" id="color2rgba"><a class="viewcode-back" href="../../reference.html#ms3.utils.color2rgba">[docs]</a><span class="k">def</span> <span class="nf">color2rgba</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Pass a RGB or RGBA tuple, HTML color or name to convert it to RGBA &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rgba</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rgba</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="p">(</span><span class="mi">255</span><span class="p">,)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rgba</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">html_color2rgba</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">color_name2rgba</span><span class="p">(</span><span class="n">c</span><span class="p">)</span></div>



<div class="viewcode-block" id="color_name2format"><a class="viewcode-back" href="../../reference.html#ms3.utils.color_name2format">[docs]</a><span class="k">def</span> <span class="nf">color_name2format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;rgb&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Converts a single CSS3 name into one of &#39;HTML&#39;, &#39;rgb&#39;, or &#39;rgba&#39;&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">n</span>
    <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">CSS3_NAMES_TO_HEX</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">name_to_hex</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">MS3_HTML</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">html</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">MS3_HTML</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">n</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">n</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">html</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;rgb&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">hex_to_rgb</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;rgba&#39;</span><span class="p">:</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">hex_to_rgb</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rgba</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">rgb</span> <span class="o">+</span> <span class="p">(</span><span class="mi">255</span><span class="p">,)))</span>
    <span class="k">return</span> <span class="n">html</span></div>


<div class="viewcode-block" id="color_name2html"><a class="viewcode-back" href="../../reference.html#ms3.utils.color_name2html">[docs]</a><span class="k">def</span> <span class="nf">color_name2html</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Converts a single CSS3 name into HTML&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">color_name2format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="color_name2rgb"><a class="viewcode-back" href="../../reference.html#ms3.utils.color_name2rgb">[docs]</a><span class="k">def</span> <span class="nf">color_name2rgb</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Converts a single CSS3 name into RGB&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">color_name2format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;rgb&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="color_name2rgba"><a class="viewcode-back" href="../../reference.html#ms3.utils.color_name2rgba">[docs]</a><span class="k">def</span> <span class="nf">color_name2rgba</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Converts a single CSS3 name into RGBA&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">color_name2format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;rgba&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="color_params2rgba"><a class="viewcode-back" href="../../reference.html#ms3.utils.color_params2rgba">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">color_params2rgba</span><span class="p">(</span><span class="n">color_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_html</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_g</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_b</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_a</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; For functions where the color can be specified in four different ways (HTML string, CSS name,</span>
<span class="sd">    RGB, or RGBA), convert the given parameters to RGBA.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    color_name : :obj:`str`, optional</span>
<span class="sd">        As a name you can use CSS colors or MuseScore colors (see :py:attr:`.MS3_COLORS`).</span>
<span class="sd">    color_html : :obj:`str`, optional</span>
<span class="sd">        An HTML color needs to be string of length 6.</span>
<span class="sd">    color_r : :obj:`int`, optional</span>
<span class="sd">        If you specify the color as RGB(A), you also need to specify color_g and color_b.</span>
<span class="sd">    color_g : :obj:`int`, optional</span>
<span class="sd">        If you specify the color as RGB(A), you also need to specify color_r and color_b.</span>
<span class="sd">    color_b : :obj:`int`, optional</span>
<span class="sd">        If you specify the color as RGB(A), you also need to specify color_r and color_g.</span>
<span class="sd">    color_a : :obj:`int`, optional</span>
<span class="sd">        If you have specified an RGB color, the alpha value defaults to 255 unless specified otherwise.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`rgba`</span>
<span class="sd">        :obj:`namedtuple` with four integers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">[</span><span class="n">color_name</span><span class="p">,</span> <span class="n">color_html</span><span class="p">,</span> <span class="n">color_r</span><span class="p">,</span> <span class="n">color_g</span><span class="p">,</span> <span class="n">color_b</span><span class="p">,</span> <span class="n">color_a</span><span class="p">]):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;None of the parameters have been specified. Returning None.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">color_r</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">color_a</span><span class="p">):</span>
            <span class="n">color_a</span> <span class="o">=</span> <span class="mi">255</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">color_g</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">color_b</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">color_name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">color_html</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not a valid RGB color: </span><span class="si">{</span><span class="p">(</span><span class="n">color_r</span><span class="p">,</span><span class="w"> </span><span class="n">color_g</span><span class="p">,</span><span class="w"> </span><span class="n">color_b</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">color_r</span><span class="p">,</span> <span class="n">color_g</span><span class="p">,</span> <span class="n">color_b</span><span class="p">,</span> <span class="n">color_a</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">color_html</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">color2rgba</span><span class="p">(</span><span class="n">color_html</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">color_name</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">color2rgba</span><span class="p">(</span><span class="n">color_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rgba</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">allnamesequal</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

<div class="viewcode-block" id="commonprefix"><a class="viewcode-back" href="../../reference.html#ms3.utils.commonprefix">[docs]</a><span class="k">def</span> <span class="nf">commonprefix</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Returns common prefix of a list of paths.</span>
<span class="sd">    Uses: allnamesequal(), itertools.takewhile()&quot;&quot;&quot;</span>
    <span class="n">bydirectorylevels</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">takewhile</span><span class="p">(</span><span class="n">allnamesequal</span><span class="p">,</span> <span class="n">bydirectorylevels</span><span class="p">))</span></div>


<div class="viewcode-block" id="compute_mn"><a class="viewcode-back" href="../../reference.html#ms3.utils.compute_mn">[docs]</a><span class="k">def</span> <span class="nf">compute_mn</span><span class="p">(</span><span class="n">measures</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Compute measure number integers from a measures table.</span>


<span class="sd">    Args:</span>
<span class="sd">      measures: Measures table with columns [&#39;mc&#39;, &#39;dont_count&#39;, &#39;numbering_offset&#39;].</span>

<span class="sd">    Returns:</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">excluded</span> <span class="o">=</span> <span class="n">measures</span><span class="p">[</span><span class="s1">&#39;dont_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">measures</span><span class="p">[</span><span class="s1">&#39;numbering_offset&#39;</span><span class="p">]</span>
    <span class="n">mn</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">excluded</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">offset</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="n">mn</span> <span class="o">+=</span> <span class="n">offset</span>
    <span class="k">return</span> <span class="n">mn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;mn&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="compute_mn_playthrough"><a class="viewcode-back" href="../../reference.html#ms3.utils.compute_mn_playthrough">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">compute_mn_playthrough</span><span class="p">(</span><span class="n">measures</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Compute measure number strings from an unfolded measures table, such that the first occurrence of a measure</span>
<span class="sd">    number ends on &#39;a&#39;, the second one on &#39;b&#39; etc.</span>

<span class="sd">    The function requires the column &#39;dont_count&#39; in order to correctly number the return of a completing MC after an</span>
<span class="sd">    incomplete MC with &quot;endrepeat&quot; sign. For example, if a repeated section begins with an upbeat that at first</span>
<span class="sd">    completes MN 16 it will have mn_playthrough &#39;16a&#39; the first time and &#39;32a&#39; the second time (assuming it completes</span>
<span class="sd">    the incomplete MN 32).</span>

<span class="sd">    Args:</span>
<span class="sd">      measures: Measures table with columns [&#39;mc&#39;, &#39;mn&#39;, &#39;dont_count&#39;]</span>

<span class="sd">    Returns:</span>
<span class="sd">      &#39;mn_playthrough&#39; Series of disambiguated measure number strings. If no measure repeats, the result will be</span>
<span class="sd">      equivalent to converting column &#39;mn&#39; to strings and appending &#39;a&#39; to all of them.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">previous_occurrences</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_mn_playthrough</span><span class="p">(</span><span class="n">mn</span><span class="p">):</span>
        <span class="n">repeat_char</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">previous_occurrences</span><span class="p">[</span><span class="n">mn</span><span class="p">]</span> <span class="o">+</span> <span class="mi">96</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mn</span><span class="si">}{</span><span class="n">repeat_char</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">mn_playthrough_column</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">previous_mc</span><span class="p">,</span> <span class="n">previous_mn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">mc</span><span class="p">,</span> <span class="n">mn</span><span class="p">,</span> <span class="n">dont_count</span> <span class="ow">in</span> <span class="n">measures</span><span class="p">[[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;mn&#39;</span><span class="p">,</span> <span class="s1">&#39;dont_count&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mn</span> <span class="o">!=</span> <span class="n">previous_mn</span><span class="p">:</span>
            <span class="n">previous_occurrences</span><span class="p">[</span><span class="n">mn</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">mc</span> <span class="o">&lt;</span> <span class="n">previous_mc</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">dont_count</span><span class="p">):</span>
            <span class="c1"># an earlier MC completes a later one after a repeat</span>
            <span class="n">mn_playthrough</span> <span class="o">=</span> <span class="n">get_mn_playthrough</span><span class="p">(</span><span class="n">previous_mn</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MN </span><span class="si">{</span><span class="n">mn</span><span class="si">}</span><span class="s2"> &lt; previous MN </span><span class="si">{</span><span class="n">previous_mn</span><span class="si">}</span><span class="s2">; but since MC </span><span class="si">{</span><span class="n">mc</span><span class="si">}</span><span class="s2"> is excluded from barcount, &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;the repetition has mn_playthrough </span><span class="si">{</span><span class="n">mn_playthrough</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mn_playthrough</span> <span class="o">=</span> <span class="n">get_mn_playthrough</span><span class="p">(</span><span class="n">mn</span><span class="p">)</span>
        <span class="n">mn_playthrough_column</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mn_playthrough</span><span class="p">)</span>
        <span class="n">previous_mn</span> <span class="o">=</span> <span class="n">mn</span>
        <span class="n">previous_mc</span> <span class="o">=</span> <span class="n">mc</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">mn_playthrough_column</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">measures</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mn_playthrough&#39;</span><span class="p">)</span></div>

<span class="nd">@lru_cache</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">get_major_version_of_musescore_executable</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">ms</span><span class="p">,</span> <span class="s2">&quot;-v&quot;</span><span class="p">],</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span>
        <span class="k">if</span> <span class="n">version</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;MuseScore&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">version</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
        <span class="k">return</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span>


<span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">MS</span><span class="o">=</span><span class="s1">&#39;mscore&#39;</span><span class="p">):</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">get_major_version_of_musescore_executable</span><span class="p">(</span><span class="n">MS</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">convert_to_ms4</span><span class="p">(</span><span class="n">old</span><span class="o">=</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">new</span><span class="p">,</span> <span class="n">MS</span><span class="o">=</span><span class="n">MS</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">process</span> <span class="o">=</span> <span class="p">[</span><span class="n">MS</span><span class="p">,</span> <span class="s2">&quot;-fo&quot;</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span><span class="p">]</span> <span class="c1">#[MS, &#39;--appimage-extract-and-run&#39;, &quot;-fo&quot;, new, old] if MS.endswith(&#39;.AppImage&#39;) else [MS, &quot;-fo&quot;, new, old]</span>
    <span class="k">if</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converted </span><span class="si">{</span><span class="n">old</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">new</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Error while converting &quot;</span> <span class="o">+</span> <span class="n">old</span><span class="p">)</span>

<span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">convert_to_ms4</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">MS</span><span class="o">=</span><span class="s1">&#39;mscore&#39;</span><span class="p">):</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">get_major_version_of_musescore_executable</span><span class="p">(</span><span class="n">MS</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">version</span> <span class="o">==</span> <span class="mi">4</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MS</span><span class="si">}</span><span class="s2"> is not MuseScore 4.x.x.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MS</span><span class="si">}</span><span class="s2"> is MuseScore </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s2">, not 4. Try convert().&quot;</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">old_path</span><span class="p">,</span> <span class="n">old_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">old</span><span class="p">)</span>
    <span class="n">old_fname</span><span class="p">,</span> <span class="n">old_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">old_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">old_ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SCORE_EXTENSIONS</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Source file &#39;</span><span class="si">{</span><span class="n">old</span><span class="si">}</span><span class="s2">&#39; doesn&#39;t have one of the following extensions and is skipped: </span><span class="si">{</span><span class="n">SCORE_EXTENSIONS</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">new</span><span class="p">):</span>
        <span class="n">target_folder</span> <span class="o">=</span> <span class="n">new</span>
        <span class="n">target_file</span> <span class="o">=</span> <span class="n">old_file</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">target_folder</span><span class="p">,</span> <span class="n">target_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
    <span class="n">target_fname</span><span class="p">,</span> <span class="n">target_ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">target_file</span><span class="p">)</span>
    <span class="n">tmp_needed</span> <span class="o">=</span> <span class="n">target_ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;.mscx&#39;</span><span class="p">,</span> <span class="s1">&#39;.mscz&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tmp_needed</span><span class="p">:</span>
        <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_folder</span><span class="p">,</span> <span class="s1">&#39;.ms3_tmp_&#39;</span> <span class="o">+</span> <span class="n">old_file</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The temporary directory </span><span class="si">{</span><span class="n">tmp_dir</span><span class="si">}</span><span class="s2"> exists already and would be overwritten. Delete it first.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">tmp_mscx</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">target_fname</span> <span class="o">+</span> <span class="s1">&#39;.mscx&#39;</span><span class="p">)</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">tmp_mscx</span>
    <span class="n">process</span> <span class="o">=</span> <span class="p">[</span><span class="n">MS</span><span class="p">,</span> <span class="s2">&quot;-fo&quot;</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tmp_needed</span><span class="p">:</span>
            <span class="n">target_path_without_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_folder</span><span class="p">,</span> <span class="n">target_fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Temporary directory &#39;</span><span class="si">{</span><span class="n">tmp_dir</span><span class="si">}</span><span class="s2">&#39; did not exist after conversion.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">tmp_mscx</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Conversion of &#39;</span><span class="si">{</span><span class="n">old</span><span class="si">}</span><span class="s2">&#39; did not yield a complete uncompressed MuseScore folder, an .mscx file was missing.&quot;</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">target_ext</span> <span class="o">==</span> <span class="s1">&#39;.mscz&#39;</span><span class="p">:</span>
                <span class="n">zip_file_path</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">make_archive</span><span class="p">(</span><span class="n">target_path_without_extension</span><span class="p">,</span> <span class="s1">&#39;zip&#39;</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">)</span>
                <span class="n">new</span> <span class="o">=</span> <span class="n">target_path_without_extension</span> <span class="o">+</span> <span class="s1">&#39;.mscz&#39;</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">zip_file_path</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new</span> <span class="o">=</span> <span class="n">target_path_without_extension</span> <span class="o">+</span> <span class="s1">&#39;.mscx&#39;</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">tmp_mscx</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully converted </span><span class="si">{</span><span class="n">old</span><span class="si">}</span><span class="s2"> =&gt; </span><span class="si">{</span><span class="n">new</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Conversion to MuseScore 4 failed:</span><span class="se">\n</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tmp_needed</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">)</span>







<span class="k">def</span> <span class="nf">_convert_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Auxiliary function allowing to use Pool.starmap() with keyword arguments (needed in order to</span>
<span class="sd">    pass the logger argument which is not part of the signature of convert() ).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">convert</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="convert_folder"><a class="viewcode-back" href="../../reference.html#ms3.utils.convert_folder">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">convert_folder</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="p">[],</span> <span class="n">target_extension</span><span class="o">=</span><span class="s1">&#39;mscx&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="s1">&#39;.*&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">ms</span><span class="o">=</span><span class="s1">&#39;mscore&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Convert all files in `dir` that have one of the `extensions` to .mscx format using the executable `MS`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    directory : :obj:`str`</span>
<span class="sd">        Directory in which to look for files to convert.</span>
<span class="sd">    file_paths : :obj:`list` of `dir`</span>
<span class="sd">        List of file paths to convert. These are not filtered by any means.</span>
<span class="sd">    target_dir : :obj:`str`</span>
<span class="sd">        Directory where to store converted files. Defaults to ``directory``</span>
<span class="sd">    extensions : list, optional</span>
<span class="sd">        If you want to convert only certain formats, give those, e.g. [&#39;mscz&#39;, &#39;xml&#39;]</span>
<span class="sd">    recursive : bool, optional</span>
<span class="sd">        Subdirectories as well.</span>
<span class="sd">    MS : str, optional</span>
<span class="sd">        Give the path to the MuseScore executable on your system. Need only if</span>
<span class="sd">        the command &#39;mscore&#39; does not execute MuseScore on your system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">MS</span> <span class="o">=</span> <span class="n">get_musescore</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">MS</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;MuseScore not found: </span><span class="si">{</span><span class="n">ms</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">file_paths</span><span class="p">)),</span> <span class="s2">&quot;Pass at least a directory or one path.&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_paths</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">file_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">file_paths</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">target_extension</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
        <span class="n">target_extension</span> <span class="o">=</span> <span class="n">target_extension</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">conversion_params</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#logger.info(f&quot;Traversing {dir} {&#39;&#39; if recursive else &#39;non-&#39;}recursively...&quot;)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">exclude_re</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;^(?:(?!(</span><span class="si">{</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span><span class="si">}</span><span class="s2">)).)*$&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">exclude_re</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">target_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">target_dir</span> <span class="o">=</span> <span class="n">directory</span>
    <span class="n">new_dirs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">subdir_file_tuples</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">([])</span>
    <span class="k">if</span> <span class="n">directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subdir_file_tuples</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="n">subdir_file_tuples</span><span class="p">,</span>
                                   <span class="n">scan_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">file_re</span><span class="o">=</span><span class="n">regex</span><span class="p">,</span> <span class="n">exclude_re</span><span class="o">=</span><span class="n">exclude_re</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span>
                                                  <span class="n">subdirs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exclude_files_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">file_paths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subdir_file_tuples</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="n">subdir_file_tuples</span><span class="p">,</span>
                                   <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">resolve_dir</span><span class="p">(</span><span class="n">path</span><span class="p">))</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">subdir</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">subdir_file_tuples</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="n">new_dirs</span><span class="p">:</span>
            <span class="n">new_subdir</span> <span class="o">=</span> <span class="n">new_dirs</span><span class="p">[</span><span class="n">subdir</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_subdir</span> <span class="o">=</span> <span class="n">subdir</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">old_subdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>
                <span class="n">new_subdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="n">old_subdir</span><span class="p">)</span> <span class="k">if</span> <span class="n">old_subdir</span> <span class="o">!=</span> <span class="s1">&#39;.&#39;</span> <span class="k">else</span> <span class="n">target_dir</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">new_subdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">new_dirs</span><span class="p">[</span><span class="n">subdir</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_subdir</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">target_extension</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">target_extension</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">old</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_subdir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">new</span><span class="p">):</span>
            <span class="n">conversion_params</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">dict</span><span class="p">(</span><span class="n">old</span><span class="o">=</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">new</span><span class="p">,</span> <span class="n">MS</span><span class="o">=</span><span class="n">MS</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="s1">&#39;exists already. Pass -o to overwrite.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conversion_params</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No files to convert.&quot;</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">_convert_kwargs</span><span class="p">,</span> <span class="n">conversion_params</span><span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">MS</span> <span class="ow">in</span> <span class="n">conversion_params</span><span class="p">:</span>
            <span class="n">convert</span><span class="p">(</span><span class="n">old</span><span class="o">=</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">new</span><span class="p">,</span> <span class="n">MS</span><span class="o">=</span><span class="n">MS</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span></div>


<div class="viewcode-block" id="decode_harmonies"><a class="viewcode-back" href="../../reference.html#ms3.utils.decode_harmonies">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">decode_harmonies</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">label_col</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="n">keep_layer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_series</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alt_cols</span><span class="o">=</span><span class="s1">&#39;alt_label&#39;</span><span class="p">,</span> <span class="n">alt_separator</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;MuseScore stores types 2 (Nashville) and 3 (absolute chords) in several columns. This function returns a copy of</span>
<span class="sd">    the DataFrame ``Annotations.df`` where the label column contains the strings corresponding to these columns.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        DataFrame with encoded harmony labels as stored in an :obj:`Annotations` object.</span>
<span class="sd">    label_col : :obj:`str`, optional</span>
<span class="sd">        Column name where the main components (&lt;name&gt; tag) are stored, defaults to &#39;label&#39;</span>
<span class="sd">    keep_layer : :obj:`bool`, optional</span>
<span class="sd">        Defaults to True, retaining the &#39;harmony_layer&#39; column with original layers.</span>
<span class="sd">    return_series : :obj:`bool`, optional</span>
<span class="sd">        If set to True, only the decoded labels column is returned as a Series rather than a copy of ``df``.</span>
<span class="sd">    alt_cols : :obj:`str` or :obj:`list`, optional</span>
<span class="sd">        Column(s) with alternative labels that are joined with the label columns using ``alt_separator``. Defaults to</span>
<span class="sd">        &#39;alt_label&#39;. Suppress by passing None.</span>
<span class="sd">    alt_separator: :obj:`str`, optional</span>
<span class="sd">        Separator for joining ``alt_cols``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.DataFrame` or :obj:`pandas.Series`</span>
<span class="sd">        Decoded harmony labels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">drop_cols</span><span class="p">,</span> <span class="n">compose_label</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s1">&#39;nashville&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">nashville</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sel</span><span class="p">,</span> <span class="n">label_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sel</span><span class="p">,</span> <span class="s1">&#39;nashville&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sel</span><span class="p">,</span> <span class="n">label_col</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">drop_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;nashville&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;leftParen&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">leftParen</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">compose_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;leftParen&#39;</span><span class="p">)</span>
        <span class="n">drop_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;leftParen&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;absolute_root&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">df</span><span class="o">.</span><span class="n">absolute_root</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">absolute_root</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
        <span class="n">root_as_note_name</span> <span class="o">=</span> <span class="n">fifths2name</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sel</span><span class="p">,</span> <span class="s1">&#39;absolute_root&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span> <span class="n">ms</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">absolute_root</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">absolute_root</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sel</span><span class="p">,</span> <span class="s1">&#39;absolute_root&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_as_note_name</span>
        <span class="n">compose_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;absolute_root&#39;</span><span class="p">)</span>
        <span class="n">drop_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;absolute_root&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;rootCase&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rootCase</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="c1"># Setting values in-place is fine, ignore the warning in Pandas &gt;= 1.5.0</span>
                <span class="c1"># This can be removed, if Pandas 1.5.0 does not need to be supported any longer.</span>
                <span class="c1"># See also: https://stackoverflow.com/q/74057367/859591</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
                    <span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
                    <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                        <span class="s2">&quot;.*will attempt to set the values inplace instead of always setting a new array. &quot;</span>
                        <span class="s2">&quot;To retain the old behavior, use either.*&quot;</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sel</span><span class="p">,</span> <span class="s1">&#39;absolute_root&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sel</span><span class="p">,</span> <span class="s1">&#39;absolute_root&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">drop_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;rootCase&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">label_col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">compose_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_col</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;absolute_base&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">df</span><span class="o">.</span><span class="n">absolute_base</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">absolute_base</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
        <span class="n">base_as_note_name</span> <span class="o">=</span> <span class="n">fifths2name</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sel</span><span class="p">,</span> <span class="s1">&#39;absolute_base&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span> <span class="n">ms</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">absolute_base</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">absolute_base</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sel</span><span class="p">,</span> <span class="s1">&#39;absolute_base&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_as_note_name</span>
        <span class="n">df</span><span class="o">.</span><span class="n">absolute_base</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">absolute_base</span>
        <span class="n">compose_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;absolute_base&#39;</span><span class="p">)</span>
        <span class="n">drop_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;absolute_base&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;rightParen&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">rightParen</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">compose_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;rightParen&#39;</span><span class="p">)</span>
        <span class="n">drop_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;rightParen&#39;</span><span class="p">)</span>
    <span class="n">new_label_col</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">compose_label</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">new_label_col</span> <span class="o">=</span> <span class="n">new_label_col</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;^/$&#39;</span><span class="p">,</span> <span class="s1">&#39;empty_harmony&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">alt_cols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alt_cols</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">alt_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">alt_cols</span><span class="p">]</span>
        <span class="n">present</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">alt_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">present</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">alt_joined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">new_label_col</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">present</span><span class="p">:</span>
                <span class="n">alt_joined</span> <span class="o">+=</span> <span class="p">(</span><span class="n">alt_separator</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">])</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">new_label_col</span> <span class="o">+=</span> <span class="n">alt_joined</span>

    <span class="k">if</span> <span class="n">return_series</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_label_col</span>

    <span class="k">if</span> <span class="s1">&#39;harmony_layer&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">keep_layer</span><span class="p">:</span>
        <span class="n">drop_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;harmony_layer&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_label_col</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">drop_cols</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="df2md"><a class="viewcode-back" href="../../reference.html#ms3.utils.df2md">[docs]</a><span class="k">def</span> <span class="nf">df2md</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Overview&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MarkdownTableWriter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Turns a DataFrame into a MarkDown table. The returned writer can be converted into a string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">MarkdownTableWriter</span><span class="p">()</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">header_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">value_matrix</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">writer</span></div>


<div class="viewcode-block" id="dict2oneliner"><a class="viewcode-back" href="../../reference.html#ms3.utils.dict2oneliner">[docs]</a><span class="k">def</span> <span class="nf">dict2oneliner</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Turns a dictionary into a single-line string without brackets.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">())</span></div>

<div class="viewcode-block" id="resolve_form_abbreviations"><a class="viewcode-back" href="../../reference.html#ms3.utils.resolve_form_abbreviations">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">resolve_form_abbreviations</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="n">abbreviations</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                               <span class="n">mc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">fallback_to_lowercase</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Checks for each consecutive substring of the token if it matches one of the given abbreviations and replaces</span>
<span class="sd">    it with the corresponding long name. Trailing numbers are separated by a space in this case.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">      token: Individual token after splitting alternative readings.</span>
<span class="sd">      abbreviations: {abbreviation -&gt; long name} dict for string replacement.</span>
<span class="sd">      fallback_to_lowercase: By default, the substrings are checked against the dictionary keys and, if unsuccessful,</span>
<span class="sd">          again in lowercase. Pass False to use only the original string.</span>

<span class="sd">    Returns:</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mc_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">mc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;MC </span><span class="si">{</span><span class="n">mc</span><span class="si">}</span><span class="s2">: &quot;</span>
    <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">token</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mc_string</span><span class="si">}</span><span class="s2">&#39;</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&#39; contains a comma, which might result from a syntax error.&quot;</span><span class="p">)</span>
    <span class="n">sub_component_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\W+&quot;</span>
    <span class="n">ends_on_numbers_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\d+$&quot;</span>
    <span class="n">resolved_substrings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">original_substring</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sub_component_regex</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="n">trailing_numbers_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">ends_on_numbers_regex</span><span class="p">,</span> <span class="n">original_substring</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trailing_numbers_match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">trailing_numbers</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">substring</span> <span class="o">=</span> <span class="n">original_substring</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trailing_numbers_position</span> <span class="o">=</span> <span class="n">trailing_numbers_match</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">trailing_numbers_position</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># token is just a number</span>
                <span class="n">resolved_substrings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">original_substring</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">trailing_numbers</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">trailing_numbers_match</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
            <span class="n">substring</span> <span class="o">=</span> <span class="n">original_substring</span><span class="p">[:</span><span class="n">trailing_numbers_position</span><span class="p">]</span>
        <span class="n">lowercase</span> <span class="o">=</span> <span class="n">substring</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">check_lower</span> <span class="o">=</span> <span class="n">fallback_to_lowercase</span> <span class="ow">and</span> <span class="p">(</span><span class="n">lowercase</span> <span class="o">!=</span> <span class="n">substring</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">substring</span> <span class="ow">in</span> <span class="n">abbreviations</span><span class="p">:</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="n">abbreviations</span><span class="p">[</span><span class="n">substring</span><span class="p">]</span> <span class="o">+</span> <span class="n">trailing_numbers</span>
        <span class="k">elif</span> <span class="n">check_lower</span> <span class="ow">and</span> <span class="n">lowercase</span> <span class="ow">in</span> <span class="n">abbreviations</span><span class="p">:</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="n">abbreviations</span><span class="p">[</span><span class="n">lowercase</span><span class="p">]</span> <span class="o">+</span> <span class="n">trailing_numbers</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resolved</span> <span class="o">=</span> <span class="n">original_substring</span>
        <span class="n">resolved_substrings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resolved</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">substring</span> <span class="o">+</span> <span class="n">separator</span> <span class="k">for</span> <span class="n">substring</span><span class="p">,</span> <span class="n">separator</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">resolved_substrings</span><span class="p">,</span>
                                                                       <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">sub_component_regex</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]))</span></div>



<div class="viewcode-block" id="distribute_tokens_over_levels"><a class="viewcode-back" href="../../reference.html#ms3.utils.distribute_tokens_over_levels">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">distribute_tokens_over_levels</span><span class="p">(</span><span class="n">levels</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                  <span class="n">tokens</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                                  <span class="n">mc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="n">abbreviations</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
                                  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Takes the regex matches of one label and turns them into as many {layer -&gt; token} pairs as the label contains</span>
<span class="sd">    tokens.</span>

<span class="sd">    Args:</span>
<span class="sd">      levels: Collection of strings indicating analytical layers.</span>
<span class="sd">      tokens: Collection of tokens coming along, same size as levels.</span>
<span class="sd">      mc: Pass the label&#39;s label&#39;s MC to display it in error messages.</span>
<span class="sd">      abbreviations: {abbrevation -&gt; long name} mapping abbreviations to what they are to be replaced with</span>

<span class="sd">    Returns:</span>
<span class="sd">      A {(form_tree, level) -&gt; token} dict where form_tree is either &#39;&#39; or a letter between a-h identifying one of</span>
<span class="sd">      several trees annotated in parallel.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">column2value</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">reading_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^((?:[ivx]+\&amp;?)+):&quot;</span>
    <span class="n">mc_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">mc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;MC </span><span class="si">{</span><span class="n">mc</span><span class="si">}</span><span class="s2">: &quot;</span>
    <span class="k">for</span> <span class="n">level_str</span><span class="p">,</span> <span class="n">token_str</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
        <span class="n">split_level_info</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">level_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">))</span>
        <span class="c1"># turn layer indications into a DataFrame with the columns [&#39;level&#39;, &#39;form_tree&#39;, and &#39;reading&#39;]</span>
        <span class="n">analytical_layers</span> <span class="o">=</span> <span class="n">split_level_info</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">FORM_LEVEL_REGEX</span><span class="p">)</span>
        <span class="n">levels_include_reading</span> <span class="o">=</span> <span class="n">analytical_layers</span><span class="o">.</span><span class="n">reading</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="c1"># reading indications become part of the token and each will be followed by a colon</span>
        <span class="n">analytical_layers</span><span class="o">.</span><span class="n">reading</span> <span class="o">=</span> <span class="p">(</span><span class="n">analytical_layers</span><span class="o">.</span><span class="n">reading</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="c1"># propagate information that has been omitted in the second and following indications,</span>
        <span class="c1"># e.g. 2a&amp;b -&gt; [2a:, 2b:]; 1aii&amp;iii -&gt; [1aii:, 1aiii:]; 1ai&amp;b -&gt; [1ai:, 1b] (i.e., readings are not propagated)</span>
        <span class="n">analytical_layers</span> <span class="o">=</span> <span class="n">analytical_layers</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">)</span>
        <span class="n">analytical_layers</span><span class="o">.</span><span class="n">form_tree</span> <span class="o">=</span> <span class="n">analytical_layers</span><span class="o">.</span><span class="n">form_tree</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="c1"># split token into alternative components, replace special with normal white-space characters, and strip each</span>
        <span class="c1"># component from white space and separating commas</span>
        <span class="n">token_alternatives</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span>  <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; </span><span class="se">\n</span><span class="s1">,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">token_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; - &#39;</span><span class="p">)]</span>
        <span class="n">token_alternatives</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">token_alternatives</span> <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">abbreviations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">token_alternatives</span> <span class="o">=</span> <span class="p">[</span><span class="n">resolve_form_abbreviations</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">abbreviations</span><span class="p">,</span> <span class="n">mc</span><span class="o">=</span><span class="n">mc</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">token_alternatives</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">token_alternatives</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">levels_include_reading</span><span class="p">:</span>
                <span class="n">analytical_layers</span><span class="o">.</span><span class="n">reading</span> <span class="o">+=</span> <span class="n">token_alternatives</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">token_alternatives</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># this section deals with cases where alternative readings are or are not identified by Roman numbers,</span>
            <span class="c1"># and deals with the given Roman numbers depending on whether the analytical layers include some as well</span>
            <span class="n">token_includes_reading</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">reading_regex</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">token_alternatives</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">token_includes_reading</span><span class="p">:</span>
                <span class="n">reading_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">reading_regex</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">token_alternatives</span><span class="p">]</span>
                <span class="n">reading2token</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">readings_str</span><span class="p">,</span> <span class="n">token_component</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">reading_info</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">token_alternatives</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                    <span class="k">if</span> <span class="n">readings_str</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">reading</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">reading2token</span><span class="p">[</span><span class="n">reading</span><span class="p">]</span> <span class="o">=</span> <span class="n">token_component</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">token_component</span> <span class="o">=</span> <span class="n">token_component</span><span class="p">[</span><span class="n">readings_str</span><span class="o">.</span><span class="n">end</span><span class="p">():]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">roman</span> <span class="ow">in</span> <span class="n">readings_str</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">):</span>
                            <span class="n">reading</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">roman</span><span class="si">}</span><span class="s2">: &quot;</span>
                            <span class="k">if</span> <span class="n">levels_include_reading</span> <span class="ow">and</span> <span class="n">reading</span> <span class="ow">in</span> <span class="n">analytical_layers</span><span class="o">.</span><span class="n">reading</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                                <span class="n">column_empty</span> <span class="o">=</span> <span class="p">(</span><span class="n">analytical_layers</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                                <span class="n">show_layers</span> <span class="o">=</span> <span class="n">analytical_layers</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="o">~</span><span class="n">column_empty</span><span class="p">]</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mc_string</span><span class="si">}</span><span class="s2">Alternative reading in &#39;</span><span class="si">{</span><span class="n">token_str</span><span class="si">}</span><span class="s2">&#39; specifies Roman &#39;</span><span class="si">{</span><span class="n">reading</span><span class="si">}</span><span class="s2">&#39; which conflicts with one specified in the level:</span><span class="se">\n</span><span class="si">{</span><span class="n">show_layers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">reading2token</span><span class="p">[</span><span class="n">reading</span><span class="p">]</span> <span class="o">=</span> <span class="n">token_component</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39; - &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reading</span> <span class="o">+</span> <span class="n">tkn</span> <span class="k">for</span> <span class="n">reading</span><span class="p">,</span> <span class="n">tkn</span> <span class="ow">in</span> <span class="n">reading2token</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">levels_include_reading</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">reading_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mc_string</span><span class="si">}</span><span class="s2">&#39;</span><span class="si">{</span><span class="n">token_str</span><span class="si">}</span><span class="s2">&#39;: The first reading &#39;</span><span class="si">{</span><span class="n">reading_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; specifies Roman number in addition to those specified in the level:</span><span class="se">\n</span><span class="si">{</span><span class="n">analytical_layers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">analytical_layers</span><span class="o">.</span><span class="n">reading</span> <span class="o">+=</span> <span class="n">token_alternatives</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">token_alternatives</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="n">label</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># token does not include any Roman numbers and is used as is for all layers</span>
                <span class="n">analytical_layers</span><span class="o">.</span><span class="n">reading</span> <span class="o">+=</span> <span class="s1">&#39; - &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">token_alternatives</span><span class="p">)</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">form_tree</span><span class="p">,</span> <span class="n">level</span><span class="p">),</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">analytical_layers</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;form_tree&#39;</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">],</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">form_tree</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>  <span class="c1"># form_tree becomes first level of the columns&#39; MultiIndex, e.g. &#39;a&#39; and &#39;b&#39;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">reading</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">label</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mc_string</span><span class="si">}</span><span class="s2">Duplication of level without specifying separate readings:</span><span class="se">\n</span><span class="si">{</span><span class="n">df</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39; - &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reading</span> <span class="k">for</span> <span class="n">reading</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">reading</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">label</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">+=</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="n">label</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">column2value</span><span class="p">:</span>
                <span class="n">column2value</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="n">value</span>
                <span class="c1"># logger.warning(f&quot;{mc_string}The token &#39;{column2value[key]}&#39; for level {key} was overwritten with &#39;{value}&#39;:\nlevels: {level_str}, token: {token}&quot;)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">column2value</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">column2value</span></div>

<div class="viewcode-block" id="expand_single_form_label"><a class="viewcode-back" href="../../reference.html#ms3.utils.expand_single_form_label">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">expand_single_form_label</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default_abbreviations</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Splits a form label and applies distribute_tokens_over_levels()</span>

<span class="sd">    Args:</span>
<span class="sd">      label: Complete form label including indications of analytical layer(s).</span>
<span class="sd">      default_abbreviations: By default, each token component is checked against a mapping from abbreviations to</span>
<span class="sd">          long names. Pass False to prevent that.</span>
<span class="sd">      **kwargs: Abbreviation=&#39;long name&#39; mappings to resolve individual abbreviations</span>

<span class="sd">    Returns:</span>
<span class="sd">      A DataFrame with one column added per hierarchical layer of analysis, starting from level 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">extracted_levels</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">FORM_LEVEL_CAPTURE_REGEX</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
    <span class="n">extracted_tokens</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">FORM_LEVEL_SPLIT_REGEX</span><span class="p">,</span> <span class="n">label</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">abbreviations</span> <span class="o">=</span> <span class="n">FORM_TOKEN_ABBREVIATIONS</span> <span class="k">if</span> <span class="n">default_abbreviations</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="n">abbreviations</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">distribute_tokens_over_levels</span><span class="p">(</span><span class="n">extracted_levels</span><span class="p">,</span> <span class="n">extracted_tokens</span><span class="p">,</span> <span class="n">abbreviations</span><span class="o">=</span><span class="n">abbreviations</span><span class="p">)</span></div>


<div class="viewcode-block" id="expand_form_labels"><a class="viewcode-back" href="../../reference.html#ms3.utils.expand_form_labels">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">expand_form_labels</span><span class="p">(</span><span class="n">fl</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">fill_mn_until</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">default_abbreviations</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Expands form labels into a hierarchical view of levels in a table.</span>

<span class="sd">    Args:</span>
<span class="sd">      fl: A DataFrame containing raw form labels as retrieved from :meth:`ms3.Score.mscx.form_labels()`.</span>
<span class="sd">      fill_mn_until: Pass the last measure number if you want every measure of the piece have a row in the tree view,</span>
<span class="sd">          even if it doesn&#39;t come with a form label. This may be desired for increased intuition of proportions,</span>
<span class="sd">          rather than seeing all form labels right below each other. In order to add the empty rows, even without</span>
<span class="sd">          knowing the number of measures, pass -1.</span>
<span class="sd">      default_abbreviations: By default, each token component is checked against a mapping from abbreviations to</span>
<span class="sd">          long names. Pass False to prevent that.</span>
<span class="sd">      **kwargs: Abbreviation=&#39;long name&#39; mappings to resolve individual abbreviations</span>

<span class="sd">    Returns:</span>
<span class="sd">      A DataFrame with one column added per hierarchical layer of analysis, starting from level 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">form_labels</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">form_label</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;amp;&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">extracted_levels</span> <span class="o">=</span> <span class="n">form_labels</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">FORM_LEVEL_CAPTURE_REGEX</span><span class="p">)</span>
    <span class="n">extracted_levels</span> <span class="o">=</span> <span class="n">extracted_levels</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">fl</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">extracted_tokens</span> <span class="o">=</span> <span class="n">form_labels</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">FORM_LEVEL_SPLIT_REGEX</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># CHECKS:</span>
    <span class="c1"># extracted_tokens.apply(lambda S: S.str.contains(r&#39;(?&lt;![ixv]):&#39;).fillna(False)).any(axis=1)</span>
    <span class="c1"># extracted_tokens[extracted_tokens[0] != &#39;&#39;]</span>
    <span class="c1"># fl[fl.form_label.str.contains(&#39;:&amp;&#39;)]</span>
    <span class="n">extracted_tokens</span> <span class="o">=</span> <span class="n">extracted_tokens</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">extracted_tokens</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">extracted_levels</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="s2">&quot;Indices need to be identical after regex extraction.&quot;</span>
    <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">abbreviations</span> <span class="o">=</span> <span class="n">FORM_TOKEN_ABBREVIATIONS</span> <span class="k">if</span> <span class="n">default_abbreviations</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="n">abbreviations</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">mc</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">lvls</span><span class="p">),</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">tkns</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fl</span><span class="o">.</span><span class="n">mc</span><span class="p">,</span> <span class="n">extracted_levels</span><span class="o">.</span><span class="n">iterrows</span><span class="p">(),</span> <span class="n">extracted_tokens</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()):</span>
        <span class="n">level_select</span><span class="p">,</span> <span class="n">token_select</span> <span class="o">=</span> <span class="n">lvls</span><span class="o">.</span><span class="n">notna</span><span class="p">(),</span> <span class="n">tkns</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
        <span class="n">present_levels</span><span class="p">,</span> <span class="n">present_tokens</span> <span class="o">=</span> <span class="n">lvls</span><span class="p">[</span><span class="n">level_select</span><span class="p">],</span> <span class="n">tkns</span><span class="p">[</span><span class="n">token_select</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">level_select</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="n">token_select</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;MC </span><span class="si">{</span><span class="n">mc</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">level_select</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> levels</span><span class="se">\n</span><span class="si">{</span><span class="n">present_levels</span><span class="si">}</span><span class="se">\n</span><span class="s2">but </span><span class="si">{</span><span class="n">token_select</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> tokens:</span><span class="se">\n</span><span class="si">{</span><span class="n">present_tokens</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">result_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">distribute_tokens_over_levels</span><span class="p">(</span><span class="n">present_levels</span><span class="p">,</span> <span class="n">present_tokens</span><span class="p">,</span> <span class="n">mc</span><span class="o">=</span><span class="n">mc</span><span class="p">,</span> <span class="n">abbreviations</span><span class="o">=</span><span class="n">abbreviations</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">result_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
    <span class="n">res</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">form_types</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">form_types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># columns will be MultiIndex</span>
        <span class="k">if</span> <span class="s1">&#39;&#39;</span> <span class="ow">in</span> <span class="n">form_types</span><span class="p">:</span>
            <span class="c1"># there are labels pertaining to all form_types</span>
            <span class="n">forms</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">form_types</span> <span class="k">if</span> <span class="n">f</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
            <span class="n">pertaining_to_all</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
            <span class="n">distributed_to_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pertaining_to_all</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">forms</span><span class="p">),</span> <span class="n">keys</span><span class="o">=</span><span class="n">forms</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">level_exists</span> <span class="o">=</span> <span class="n">distributed_to_all</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">existing_level_names</span> <span class="o">=</span> <span class="n">distributed_to_all</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">level_exists</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">forms</span><span class="p">],</span>
                             <span class="n">distributed_to_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="o">~</span><span class="n">level_exists</span><span class="p">]],</span>
                            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">potentially_preexistent</span> <span class="o">=</span> <span class="n">distributed_to_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">level_exists</span><span class="p">]</span>
            <span class="n">check_double_attribution</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">existing_level_names</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">potentially_preexistent</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">check_double_attribution</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Did not distribute levels to all form types because some had already been individually specified.&quot;</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">existing_level_names</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">existing_level_names</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">potentially_preexistent</span><span class="p">)</span>
        <span class="n">fl_multiindex</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">fl</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">fl_multiindex</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">form_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">fl</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">fl</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Syntax for several form types used for a single one: &#39;</span><span class="si">{</span><span class="n">form_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fill_mn_until</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">form_types</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mn_col</span><span class="p">,</span> <span class="n">mn_onset</span> <span class="o">=</span> <span class="s1">&#39;mn&#39;</span><span class="p">,</span> <span class="s1">&#39;mn_onset&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mn_col</span><span class="p">,</span> <span class="n">mn_onset</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;mn&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;mn_onset&#39;</span><span class="p">)</span>
        <span class="n">first_mn</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">mn</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">last_mn</span> <span class="o">=</span> <span class="n">fill_mn_until</span> <span class="k">if</span> <span class="n">fill_mn_until</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">fl</span><span class="o">.</span><span class="n">mn</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">all_mns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">first_mn</span><span class="p">,</span> <span class="n">last_mn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="n">all_mns</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">mn_col</span><span class="p">]))</span>
        <span class="n">missing_mn</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">mn_col</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">missing</span><span class="p">)})</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">res</span><span class="p">,</span> <span class="n">missing_mn</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="n">mn_col</span><span class="p">,</span> <span class="n">mn_onset</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>

<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">add_collections</span><span class="p">(</span><span class="n">left</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">Dtype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">add_collections</span><span class="p">(</span><span class="n">left</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">Dtype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">add_collections</span><span class="p">(</span><span class="n">left</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">Dtype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">add_collections</span><span class="p">(</span><span class="n">left</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">Dtype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="o">...</span>
<div class="viewcode-block" id="add_collections"><a class="viewcode-back" href="../../reference.html#ms3.utils.add_collections">[docs]</a><span class="k">def</span> <span class="nf">add_collections</span><span class="p">(</span><span class="n">left</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">],</span>
                    <span class="n">right</span><span class="p">:</span> <span class="n">Collection</span><span class="p">,</span>
                    <span class="n">dtype</span><span class="p">:</span> <span class="n">Dtype</span> <span class="o">=</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Zip-adds together the strings (by default) contained in two collections regardless of their types (think of adding</span>
<span class="sd">    two columns together element-wise). Pass another ``dtype`` if you want the values to be converted to another</span>
<span class="sd">    datatype before adding them together.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="n">left</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span> <span class="o">+</span> <span class="n">right</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">result_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">left</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">result_series</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">result_series</span><span class="o">.</span><span class="n">values</span></div>

<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">cast2collection</span><span class="p">(</span><span class="n">coll</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">cast2collection</span><span class="p">(</span><span class="n">coll</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">cast2collection</span><span class="p">(</span><span class="n">coll</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">cast2collection</span><span class="p">(</span><span class="n">coll</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="o">...</span>
<span class="k">def</span> <span class="nf">cast2collection</span><span class="p">(</span><span class="n">coll</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">],</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coll</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">transform</span><span class="p">(</span><span class="n">coll</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="c1"># pandas developers doing their most annoying thing &gt;:(</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
            <span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;.*The default dtype for empty Series.*&quot;</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">result_series</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">coll</span><span class="p">),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">coll</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">result_series</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result_series</span><span class="o">.</span><span class="n">values</span>



<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">fifths2acc</span><span class="p">(</span><span class="n">fifths</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">fifths2acc</span><span class="p">(</span><span class="n">fifths</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">fifths2acc</span><span class="p">(</span><span class="n">fifths</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">fifths2acc</span><span class="p">(</span><span class="n">fifths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">fifths2acc</span><span class="p">(</span><span class="n">fifths</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="o">...</span>
<div class="viewcode-block" id="fifths2acc"><a class="viewcode-back" href="../../reference.html#ms3.utils.fifths2acc">[docs]</a><span class="k">def</span> <span class="nf">fifths2acc</span><span class="p">(</span><span class="n">fifths</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Returns accidentals for a stack of fifths that can be combined with a</span>
<span class="sd">        basic representation of the seven steps.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fifths</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">fifths</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cast2collection</span><span class="p">(</span><span class="n">coll</span><span class="o">=</span><span class="n">fifths</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">fifths2acc</span><span class="p">)</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="p">(</span><span class="n">fifths</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">7</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span> <span class="o">*</span> <span class="s1">&#39;b&#39;</span> <span class="k">if</span> <span class="n">acc</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">acc</span> <span class="o">*</span> <span class="s1">&#39;#&#39;</span></div>


<div class="viewcode-block" id="fifths2iv"><a class="viewcode-back" href="../../reference.html#ms3.utils.fifths2iv">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">fifths2iv</span><span class="p">(</span><span class="n">fifths</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
             <span class="n">smallest</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
             <span class="n">perfect</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span>
             <span class="n">major</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span>
             <span class="n">minor</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span>
             <span class="n">augmented</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span>
             <span class="n">diminished</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Return interval name of a stack of fifths such that 0 = &#39;P1&#39;, -1 = &#39;P4&#39;, -2 = &#39;m7&#39;, 4 = &#39;M3&#39; etc. If you pass</span>
<span class="sd">    ``smallest=True``, intervals of a fifth or greater will be inverted (e.g. &#39;m6&#39; =&gt; &#39;-M3&#39; and &#39;D5&#39; =&gt; &#39;-A4&#39;).</span>


<span class="sd">    Args:</span>
<span class="sd">      fifths: Number of fifths representing the inveral</span>
<span class="sd">      smallest: Pass True if you want to wrap intervals of a fifths and larger to the downward counterpart.</span>
<span class="sd">      perfect: String representing the perfect interval quality, defaults to &#39;P&#39;.</span>
<span class="sd">      major: String representing the major interval quality, defaults to &#39;M&#39;.</span>
<span class="sd">      minor: String representing the minor interval quality, defaults to &#39;m&#39;.</span>
<span class="sd">      augmented: String representing the augmented interval quality, defaults to &#39;a&#39;.</span>
<span class="sd">      diminished: String representing the diminished interval quality, defaults to &#39;d&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Name of the interval as a string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fifths_plus_one</span> <span class="o">=</span> <span class="n">fifths</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># making 0 = fourth, 1 = unison, 2 = fifth etc.</span>
    <span class="n">int_num</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;6&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;7&quot;</span><span class="p">][</span><span class="n">fifths_plus_one</span> <span class="o">%</span> <span class="mi">7</span><span class="p">]</span>
    <span class="n">sharp_wise_quality</span> <span class="o">=</span> <span class="n">augmented</span>
    <span class="n">flat_wise_quality</span> <span class="o">=</span> <span class="n">diminished</span>
    <span class="n">qualities</span> <span class="o">=</span> <span class="p">(</span><span class="n">minor</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">perfect</span><span class="p">,</span> <span class="n">perfect</span><span class="p">,</span> <span class="n">perfect</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">major</span><span class="p">)</span>
    <span class="n">quality</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">smallest</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">int_num</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">int_num</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">9</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">int_num</span><span class="p">))</span>
        <span class="n">sharp_wise_quality</span><span class="p">,</span> <span class="n">flat_wise_quality</span> <span class="o">=</span> <span class="n">flat_wise_quality</span><span class="p">,</span> <span class="n">sharp_wise_quality</span>
        <span class="n">qualities</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">qualities</span><span class="p">))</span>
        <span class="n">quality</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
    <span class="k">if</span> <span class="o">-</span><span class="mi">5</span> <span class="o">&lt;=</span> <span class="n">fifths</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">quality</span> <span class="o">+=</span> <span class="n">qualities</span><span class="p">[</span><span class="n">fifths</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">fifths</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">quality</span> <span class="o">+=</span> <span class="n">sharp_wise_quality</span> <span class="o">*</span> <span class="p">(</span><span class="n">fifths_plus_one</span> <span class="o">//</span> <span class="mi">7</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">quality</span> <span class="o">+=</span> <span class="n">flat_wise_quality</span> <span class="o">*</span> <span class="p">((</span><span class="o">-</span><span class="n">fifths</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">7</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">quality</span> <span class="o">+</span> <span class="n">int_num</span></div>

<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">tpc2name</span><span class="p">(</span><span class="n">tpc</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ms</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">minor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">tpc2name</span><span class="p">(</span><span class="n">tpc</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">ms</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">minor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">tpc2name</span><span class="p">(</span><span class="n">tpc</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">ms</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">minor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NDArray</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">tpc2name</span><span class="p">(</span><span class="n">tpc</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">ms</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">minor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">tpc2name</span><span class="p">(</span><span class="n">tpc</span><span class="p">:</span>  <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">ms</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">minor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
    <span class="o">...</span>
<div class="viewcode-block" id="tpc2name"><a class="viewcode-back" href="../../reference.html#ms3.utils.tpc2name">[docs]</a><span class="k">def</span> <span class="nf">tpc2name</span><span class="p">(</span><span class="n">tpc</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
             <span class="n">ms</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
             <span class="n">minor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Turn a tonal pitch class (TPC) into a name or perform the operation on a collection of integers.</span>

<span class="sd">    Args:</span>
<span class="sd">      tpc: Tonal pitch class(es) to turn into a note name.</span>
<span class="sd">      ms: Pass True if ``tpc`` is a MuseScore TPC, i.e. C = 14</span>
<span class="sd">      minor: Pass True if the string is to be returned as lowercase.</span>

<span class="sd">    Returns:</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">tpc</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tpc</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tpc</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cast2collection</span><span class="p">(</span><span class="n">coll</span><span class="o">=</span><span class="n">tpc</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">tpc2name</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="n">ms</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">minor</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tpc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tpc</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cast2collection</span><span class="p">(</span><span class="n">coll</span><span class="o">=</span><span class="n">tpc</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">tpc2name</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="n">ms</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">minor</span><span class="p">)</span>
    <span class="n">note_names</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">minor</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ms</span><span class="p">:</span>
        <span class="n">tpc</span> <span class="o">=</span> <span class="n">tpc</span> <span class="o">-</span> <span class="mi">14</span>
    <span class="n">acc</span><span class="p">,</span> <span class="n">ix</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">tpc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">acc_str</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span> <span class="o">*</span> <span class="s1">&#39;b&#39;</span> <span class="k">if</span> <span class="n">acc</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">acc</span> <span class="o">*</span> <span class="s1">&#39;#&#39;</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">note_names</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="si">}{</span><span class="n">acc_str</span><span class="si">}</span><span class="s2">&quot;</span></div>

<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">fifths2name</span><span class="p">(</span><span class="n">fifths</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">midi</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">ms</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">minor</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">fifths2name</span><span class="p">(</span><span class="n">fifths</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">midi</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">],</span> <span class="n">ms</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">minor</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">fifths2name</span><span class="p">(</span><span class="n">fifths</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">midi</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NDArray</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="n">ms</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">minor</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NDArray</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">fifths2name</span><span class="p">(</span><span class="n">fifths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">midi</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="n">ms</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">minor</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">fifths2name</span><span class="p">(</span><span class="n">fifths</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">midi</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="n">ms</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">minor</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
    <span class="o">...</span>
<div class="viewcode-block" id="fifths2name"><a class="viewcode-back" href="../../reference.html#ms3.utils.fifths2name">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">fifths2name</span><span class="p">(</span><span class="n">fifths</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
                <span class="n">midi</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">ms</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">minor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return note name of a stack of fifths such that</span>
<span class="sd">       0 = C, -1 = F, -2 = Bb, 1 = G etc. This is a wrapper of :func:`tpc2name`, that additionally accepts the argument</span>
<span class="sd">       ``midi`` which allows for adding octave information.</span>

<span class="sd">    Args:</span>
<span class="sd">      fifths: Tonal pitch class(es) to turn into a note name.</span>
<span class="sd">      midi: In order to include the octave into the note name, pass the corresponding MIDI pitch(es).</span>
<span class="sd">      ms: Pass True if ``fifths`` is a MuseScore TPC, i.e. C = 14</span>
<span class="sd">      minor: Pass True if the string is to be returned as lowercase.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">fifths</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fifths</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fifths</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">fifths</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">tpc2name</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="n">ms</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">minor</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">midi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">names</span>
        <span class="n">octaves</span> <span class="o">=</span> <span class="n">midi2octave</span><span class="p">(</span><span class="n">midi</span><span class="p">,</span> <span class="n">fifths</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">add_collections</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">octaves</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;string&#39;</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">tpc2name</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="n">ms</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">minor</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">midi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">name</span>
    <span class="n">octave</span> <span class="o">=</span> <span class="n">midi2octave</span><span class="p">(</span><span class="n">midi</span><span class="p">,</span> <span class="n">fifths</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">octave</span><span class="si">}</span><span class="s2">&quot;</span></div>



<div class="viewcode-block" id="fifths2pc"><a class="viewcode-back" href="../../reference.html#ms3.utils.fifths2pc">[docs]</a><span class="k">def</span> <span class="nf">fifths2pc</span><span class="p">(</span><span class="n">fifths</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Turn a stack of fifths into a chromatic pitch class.</span>
<span class="sd">        Uses: map2elements()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fifths</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">fifths</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">map2elements</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">fifths2pc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fifths</span>

    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="mi">7</span> <span class="o">*</span> <span class="n">fifths</span> <span class="o">%</span> <span class="mi">12</span><span class="p">)</span></div>



<div class="viewcode-block" id="fifths2rn"><a class="viewcode-back" href="../../reference.html#ms3.utils.fifths2rn">[docs]</a><span class="k">def</span> <span class="nf">fifths2rn</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">auto_key</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return Roman numeral of a stack of fifths such that</span>
<span class="sd">       0 = I, -1 = IV, 1 = V, -2 = bVII in major, VII in minor, etc.</span>
<span class="sd">       Uses: map2elements(), is_minor_mode()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    auto_key : :obj:`bool`, optional</span>
<span class="sd">        By default, the returned Roman numerals are uppercase. Pass True to pass upper-</span>
<span class="sd">        or lowercase according to the position in the scale.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">map2elements</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">fifths2rn</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">minor</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">fifths</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fifths</span>
    <span class="n">rn</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;VI&#39;</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">minor</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;IV&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">]</span>
    <span class="n">sel</span> <span class="o">=</span> <span class="n">fifths</span> <span class="o">+</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">minor</span> <span class="k">else</span> <span class="n">fifths</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">_fifths2str</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">rn</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">auto_key</span> <span class="ow">and</span> <span class="n">is_minor_mode</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">minor</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="fifths2sd"><a class="viewcode-back" href="../../reference.html#ms3.utils.fifths2sd">[docs]</a><span class="k">def</span> <span class="nf">fifths2sd</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return scale degree of a stack of fifths such that</span>
<span class="sd">       0 = &#39;1&#39;, -1 = &#39;4&#39;, -2 = &#39;b7&#39; in major, &#39;7&#39; in minor etc.</span>
<span class="sd">       Uses: map2elements(), fifths2str()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">map2elements</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">fifths2sd</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">minor</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">fifths</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fifths</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">minor</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">minor</span><span class="p">:</span>
        <span class="n">fifths</span> <span class="o">+=</span> <span class="mi">3</span>
    <span class="k">return</span> <span class="n">_fifths2str</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">sd</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_fifths2str</span><span class="p">(</span><span class="n">fifths</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                <span class="n">steps</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                <span class="n">inverted</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Boiler plate used by fifths2-functions.</span>

<span class="sd">    Args:</span>
<span class="sd">      fifths: Stack of fifths</span>
<span class="sd">      steps: Collection of seven names, scale degrees, intervals, etc.</span>
<span class="sd">      inverted: By default, return accidental + step. Pass True to get step + accidental instead.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Accidentals + step from ``steps`` or, if inverted, step + accidentals.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">fifths2acc</span><span class="p">(</span><span class="n">fifths</span><span class="p">)</span>
    <span class="n">fifths</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">inverted</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">steps</span><span class="p">[</span><span class="n">fifths</span> <span class="o">%</span> <span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="n">acc</span>
    <span class="k">return</span> <span class="n">acc</span> <span class="o">+</span> <span class="n">steps</span><span class="p">[</span><span class="n">fifths</span> <span class="o">%</span> <span class="mi">7</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">get_ms_version</span><span class="p">(</span><span class="n">mscx_file</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">mscx_file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;programVersion&gt;(.*?)&lt;/programVersion&gt;&quot;</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<div class="viewcode-block" id="get_musescore"><a class="viewcode-back" href="../../reference.html#ms3.utils.get_musescore">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">get_musescore</span><span class="p">(</span><span class="n">MS</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;win&#39;</span><span class="p">,</span> <span class="s1">&#39;mac&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests whether a MuseScore executable can be found on the system.</span>
<span class="sd">    Uses: test_binary()</span>


<span class="sd">    Args:</span>
<span class="sd">      MS: A path to the executable, installed command, or one of the keywords {&#39;auto&#39;, &#39;win&#39;, &#39;mac&#39;}</span>

<span class="sd">    Returns:</span>
<span class="sd">      Path to the executable if found or None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">MS</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">MS</span>
    <span class="k">if</span> <span class="n">MS</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Windows&#39;</span><span class="p">:</span> <span class="s1">&#39;win&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Darwin&#39;</span><span class="p">:</span> <span class="s1">&#39;mac&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Linux&#39;</span><span class="p">:</span> <span class="s1">&#39;mscore&#39;</span>
        <span class="p">}</span>
        <span class="n">system</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">MS</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">system</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;System could not be inferred: </span><span class="si">{</span><span class="n">system</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">MS</span> <span class="o">=</span> <span class="s1">&#39;mscore&#39;</span>
    <span class="k">if</span> <span class="n">MS</span> <span class="o">==</span> <span class="s1">&#39;win&#39;</span><span class="p">:</span>
        <span class="n">program_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PROGRAMFILES&#39;</span><span class="p">]</span>
        <span class="n">MS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">program_files</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;MuseScore 3\bin\MuseScore3.exe&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">MS</span> <span class="o">==</span> <span class="s1">&#39;mac&#39;</span><span class="p">:</span>
        <span class="n">MS</span> <span class="o">=</span> <span class="s2">&quot;/Applications/MuseScore 3.app/Contents/MacOS/mscore&quot;</span>
    <span class="k">return</span> <span class="n">test_binary</span><span class="p">(</span><span class="n">MS</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_path_component"><a class="viewcode-back" href="../../reference.html#ms3.utils.get_path_component">[docs]</a><span class="k">def</span> <span class="nf">get_path_component</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">after</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns only the path&#39;s subfolders below ``after``. If ``after`` is the last</span>
<span class="sd">    component, &#39;.&#39; is returned.&quot;&quot;&quot;</span>
    <span class="n">dir1</span><span class="p">,</span> <span class="n">base1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dir1</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;~&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">base1</span> <span class="o">==</span> <span class="n">after</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;.&#39;</span>
        <span class="k">return</span> <span class="n">path</span>
    <span class="n">dir2</span><span class="p">,</span> <span class="n">base2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dir1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">base2</span> <span class="o">==</span> <span class="n">after</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">base1</span>
    <span class="n">higher_levels</span> <span class="o">=</span> <span class="n">get_path_component</span><span class="p">(</span><span class="n">dir1</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="n">after</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">higher_levels</span><span class="p">,</span> <span class="n">base1</span><span class="p">)</span></div>


<span class="c1"># def get_quarterbeats_length(measures: pd.DataFrame, decimals: int = 2) -&gt; Tuple[float, Optional[float]]:</span>
<span class="c1">#     &quot;&quot;&quot; Returns the symbolic length and unfolded symbolic length of a piece in quarter notes.</span>
<span class="c1">#</span>
<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     measures : :obj:`pandas.DataFrame`</span>
<span class="c1">#</span>
<span class="c1">#     Returns</span>
<span class="c1">#     -------</span>
<span class="c1">#     float, float</span>
<span class="c1">#         Length and unfolded length, both measuresd in quarter notes.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     mc_durations = measures.set_index(&#39;mc&#39;).act_dur * 4.</span>
<span class="c1">#     length_qb = round(mc_durations.sum(), decimals)</span>
<span class="c1">#     try:</span>
<span class="c1">#         playthrough2mc = make_playthrough2mc(measures, logger=logger)</span>
<span class="c1">#         if len(playthrough2mc) == 0:</span>
<span class="c1">#             length_qb_unfolded = None</span>
<span class="c1">#         else:</span>
<span class="c1">#             length_qb_unfolded = round(mc_durations.loc[playthrough2mc.values].sum(), decimals)</span>
<span class="c1">#     except Exception:</span>
<span class="c1">#         length_qb_unfolded = None</span>
<span class="c1">#     return length_qb, length_qb_unfolded</span>


<div class="viewcode-block" id="group_id_tuples"><a class="viewcode-back" href="../../reference.html#ms3.utils.group_id_tuples">[docs]</a><span class="k">def</span> <span class="nf">group_id_tuples</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Turns a list of (key, ix) into a {key: [ix]}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></div>


<div class="viewcode-block" id="html2format"><a class="viewcode-back" href="../../reference.html#ms3.utils.html2format">[docs]</a><span class="k">def</span> <span class="nf">html2format</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">html_col</span><span class="o">=</span><span class="s1">&#39;color_html&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Converts the HTML column of a DataFrame into &#39;name&#39;, &#39;rgb , or &#39;rgba&#39;. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">html_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">color_name2html</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;rgb&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">html_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">color_name2rgb</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;rgba&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">html_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">color_name2rgba</span><span class="p">)</span></div>


<div class="viewcode-block" id="html_color2format"><a class="viewcode-back" href="../../reference.html#ms3.utils.html_color2format">[docs]</a><span class="k">def</span> <span class="nf">html_color2format</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Converts a single HTML color into &#39;name&#39;, &#39;rgb&#39;, or  &#39;rgba&#39;.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">h</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">hex_to_name</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">MS3_HTML</span><span class="p">[</span><span class="n">h</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">h</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;rgb&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">hex_to_rgb</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;rgba&#39;</span><span class="p">:</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">hex_to_rgb</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rgba</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">rgb</span> <span class="o">+</span> <span class="p">(</span><span class="mi">255</span><span class="p">,)))</span></div>


<div class="viewcode-block" id="html_color2name"><a class="viewcode-back" href="../../reference.html#ms3.utils.html_color2name">[docs]</a><span class="k">def</span> <span class="nf">html_color2name</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Converts a HTML color into its CSS3 name or itself if there is none.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">html_color2format</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="html_color2rgb"><a class="viewcode-back" href="../../reference.html#ms3.utils.html_color2rgb">[docs]</a><span class="k">def</span> <span class="nf">html_color2rgb</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Converts a HTML color into RGB.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">html_color2format</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;rgb&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="html_color2rgba"><a class="viewcode-back" href="../../reference.html#ms3.utils.html_color2rgba">[docs]</a><span class="k">def</span> <span class="nf">html_color2rgba</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Converts a HTML color into RGBA.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">html_color2format</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;rgba&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="interval_overlap"><a class="viewcode-back" href="../../reference.html#ms3.utils.interval_overlap">[docs]</a><span class="k">def</span> <span class="nf">interval_overlap</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Returns the overlap of two pd.Intervals as a new pd.Interval.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a, b : :obj:`pandas.Interval`</span>
<span class="sd">        Intervals for which to compute the overlap.</span>
<span class="sd">    closed : {&#39;left&#39;, &#39;right&#39;, &#39;both&#39;, &#39;neither&#39;}, optional</span>
<span class="sd">        If no value is passed, the closure of the returned interval is inferred from ``a`` and ``b``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.Interval`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">left</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">.</span><span class="n">left</span><span class="p">:</span>
        <span class="c1"># making a the leftmost interval</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span>
    <span class="k">if</span> <span class="n">closed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">right</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">.</span><span class="n">right</span><span class="p">:</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">right</span>
            <span class="n">right_closed</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">closed</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">)</span>
            <span class="n">other_iv</span> <span class="o">=</span> <span class="n">b</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">right</span>
            <span class="n">right_closed</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">closed</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">)</span>
            <span class="n">other_iv</span> <span class="o">=</span> <span class="n">a</span>
        <span class="k">if</span> <span class="n">right_closed</span> <span class="ow">and</span> <span class="n">right</span> <span class="o">==</span> <span class="n">other_iv</span><span class="o">.</span><span class="n">right</span> <span class="ow">and</span> <span class="n">other_iv</span><span class="o">.</span><span class="n">closed</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">):</span>
            <span class="n">right_closed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">left_closed</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">closed</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">left_closed</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">left</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">left</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">closed</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">):</span>
            <span class="n">left_closed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">left_closed</span> <span class="ow">and</span> <span class="n">right_closed</span><span class="p">:</span>
            <span class="n">closed</span> <span class="o">=</span> <span class="s1">&#39;both&#39;</span>
        <span class="k">elif</span> <span class="n">left_closed</span><span class="p">:</span>
            <span class="n">closed</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span>
        <span class="k">elif</span> <span class="n">right_closed</span><span class="p">:</span>
            <span class="n">closed</span> <span class="o">=</span> <span class="s1">&#39;right&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">closed</span> <span class="o">=</span> <span class="s1">&#39;neither&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">right</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">right</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">.</span><span class="n">right</span> <span class="k">else</span> <span class="n">b</span><span class="o">.</span><span class="n">right</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Interval</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="n">closed</span><span class="p">)</span></div>


<div class="viewcode-block" id="interval_overlap_size"><a class="viewcode-back" href="../../reference.html#ms3.utils.interval_overlap_size">[docs]</a><span class="k">def</span> <span class="nf">interval_overlap_size</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the size of the overlap of two pd.Intervals.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">left</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">.</span><span class="n">left</span><span class="p">:</span>
        <span class="c1"># making a the leftmost interval</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span>
    <span class="n">right</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">right</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">right</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">.</span><span class="n">right</span> <span class="k">else</span> <span class="n">b</span><span class="o">.</span><span class="n">right</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">right</span> <span class="o">-</span> <span class="n">b</span><span class="o">.</span><span class="n">left</span>
    <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">decimals</span><span class="p">)</span></div>

<div class="viewcode-block" id="is_any_row_equal"><a class="viewcode-back" href="../../reference.html#ms3.utils.is_any_row_equal">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">is_any_row_equal</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Returns True if any two rows of the two DataFrames contain the same value tuples. &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">df1</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="s2">&quot;Pass the same number of columns for both DataFrames&quot;</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df1</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">v1</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_minor_mode"><a class="viewcode-back" href="../../reference.html#ms3.utils.is_minor_mode">[docs]</a><span class="k">def</span> <span class="nf">is_minor_mode</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Returns True if the scale degree `fifths` naturally has a minor third in the scale.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">thirds</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">minor</span> <span class="k">else</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">third</span> <span class="o">=</span> <span class="n">thirds</span><span class="p">[(</span><span class="n">fifths</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span><span class="p">]</span> <span class="o">-</span> <span class="n">fifths</span>
    <span class="k">return</span> <span class="n">third</span> <span class="o">==</span> <span class="o">-</span><span class="mi">3</span></div>


<div class="viewcode-block" id="iter_nested"><a class="viewcode-back" href="../../reference.html#ms3.utils.iter_nested">[docs]</a><span class="k">def</span> <span class="nf">iter_nested</span><span class="p">(</span><span class="n">nested</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Iterate through any nested structure of lists and tuples from left to right.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">nested</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">lower</span> <span class="ow">in</span> <span class="n">iter_nested</span><span class="p">(</span><span class="n">elem</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">lower</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">elem</span></div>


<div class="viewcode-block" id="iter_selection"><a class="viewcode-back" href="../../reference.html#ms3.utils.iter_selection">[docs]</a><span class="k">def</span> <span class="nf">iter_selection</span><span class="p">(</span><span class="n">collectio</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">opposite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Returns a generator of ``collectio``. ``selector`` can be a collection of index numbers to select or unselect</span>
<span class="sd">    elements -- depending on ``opposite`` &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">collectio</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">e</span>
    <span class="k">if</span> <span class="n">opposite</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">collectio</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selector</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">e</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">collectio</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">selector</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">e</span></div>


<span class="k">def</span> <span class="nf">iterable2str</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">iterable</span>


<span class="k">def</span> <span class="nf">contains_metadata</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;metadata.tsv&#39;</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">)</span>

<div class="viewcode-block" id="first_level_subdirs"><a class="viewcode-back" href="../../reference.html#ms3.utils.first_level_subdirs">[docs]</a><span class="k">def</span> <span class="nf">first_level_subdirs</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the directory names contained in path.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">subdirs</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">subdirs</span></div>

<div class="viewcode-block" id="first_level_files_and_subdirs"><a class="viewcode-back" href="../../reference.html#ms3.utils.first_level_files_and_subdirs">[docs]</a><span class="k">def</span> <span class="nf">first_level_files_and_subdirs</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the directory names and filenames contained in path.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">subdirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">subdirs</span><span class="p">,</span> <span class="n">files</span></div>

<span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">contains_corpus_indicator</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="n">first_level_subdirs</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="n">STANDARD_NAMES_OR_GIT</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> contains a subdirectory called </span><span class="si">{</span><span class="n">subdir</span><span class="si">}</span><span class="s2"> and is assumed to be a corpus.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>


<div class="viewcode-block" id="get_first_level_corpora"><a class="viewcode-back" href="../../reference.html#ms3.utils.get_first_level_corpora">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">get_first_level_corpora</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks the first-level subdirectories of path for indicators of being a corpus. If one of them shows an</span>
<span class="sd">    indicator (presence of a &#39;metadata.tsv&#39; file, or of a &#39;.git&#39; folder or any of the default folder names), returns</span>
<span class="sd">    a list of all subdirectories.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> is not an existing directory.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">subpaths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">subdir</span><span class="p">)</span> <span class="k">for</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="n">first_level_subdirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">subdir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;.&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">subpath</span> <span class="ow">in</span> <span class="n">subpaths</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">contains_metadata</span><span class="p">(</span><span class="n">subpath</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">subpath</span><span class="si">}</span><span class="s2"> recognized as corpus directory because it contains metadata.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">subpaths</span>
        <span class="k">if</span> <span class="n">contains_corpus_indicator</span><span class="p">(</span><span class="n">subpath</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">subpaths</span>
    <span class="k">return</span> <span class="p">[]</span></div>



<div class="viewcode-block" id="join_tsvs"><a class="viewcode-back" href="../../reference.html#ms3.utils.join_tsvs">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">join_tsvs</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">sort_cols</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Performs outer join on the passed DataFrames based on &#39;mc&#39; and &#39;mc_onset&#39;, if any.</span>
<span class="sd">    Uses: functools.reduce(), sort_cols(), sort_note_lists()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dfs : :obj:`Collection`</span>
<span class="sd">        Collection of DataFrames to join.</span>
<span class="sd">    sort_cols : :obj:`bool`, optional</span>
<span class="sd">        If you pass True, the columns after those defined in :py:attr:`STANDARD_COLUMN_ORDER`</span>
<span class="sd">        will be sorted alphabetically.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">zero</span><span class="p">,</span> <span class="n">one</span><span class="p">,</span> <span class="n">two</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;mc&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;mc_onset&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">two</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">one</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zero</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">join_order</span> <span class="o">=</span> <span class="n">two</span> <span class="o">+</span> <span class="n">one</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zero</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">zero</span><span class="p">)</span><span class="si">}</span><span class="s2"> DataFrames contain none of the columns &#39;mc&#39; and &#39;mc_onset&#39;.&quot;</span><span class="p">)</span>

    <span class="n">pos_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;mc_onset&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">join_tsv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="n">join_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pos_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">join_cols</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_y&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_y&#39;</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">d</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="n">left</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">res</span><span class="p">[</span><span class="n">left</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">duplicates</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">join_tsv</span><span class="p">,</span> <span class="n">join_order</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;midi&#39;</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">sort_note_list</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">two</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">pos_cols</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;mc&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">column_order</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort_cols</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">str2inttuple</span><span class="p">(</span><span class="n">l</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;(),&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;String value &#39;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&#39; could not be converted to an integer, &#39;</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">&#39; not to an integer tuple.&quot;</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\&#39;</span><span class="s2">&quot;</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">int2bool</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">safe_frac</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">frac</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">frac</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span>

<span class="k">def</span> <span class="nf">safe_int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span>

<div class="viewcode-block" id="parse_interval_index_column"><a class="viewcode-back" href="../../reference.html#ms3.utils.parse_interval_index_column">[docs]</a><span class="k">def</span> <span class="nf">parse_interval_index_column</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Turns a column of strings in the form &#39;[0.0, 1.1)&#39; into a :obj:`pandas.IntervalIndex`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">    column : :obj:`str`, optional</span>
<span class="sd">        Name of the column containing strings. If not specified, use the index.</span>
<span class="sd">    closed : :obj:`str`, optional</span>
<span class="sd">        On whot side the intervals should be closed. Defaults to &#39;left&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.IntervalIndex`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">iv_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;[\[\(]([0-9]*\.[0-9]+), ([0-9]*\.[0-9]+)[\)\]]&quot;</span>
    <span class="k">if</span> <span class="n">column</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">iv_strings</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">iv_strings</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">iv_strings</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">iv_regex</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">iix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">IntervalIndex</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">closed</span><span class="o">=</span><span class="n">closed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">iix</span></div>


<span class="n">TSV_COLUMN_CONVERTERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;added_tones&#39;</span><span class="p">:</span> <span class="n">str2inttuple</span><span class="p">,</span>
    <span class="s1">&#39;act_dur&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span>
    <span class="s1">&#39;composed_end&#39;</span><span class="p">:</span> <span class="n">safe_int</span><span class="p">,</span>
    <span class="s1">&#39;composed_start&#39;</span><span class="p">:</span> <span class="n">safe_int</span><span class="p">,</span>
    <span class="s1">&#39;chord_tones&#39;</span><span class="p">:</span> <span class="n">str2inttuple</span><span class="p">,</span>
    <span class="s1">&#39;globalkey_is_minor&#39;</span><span class="p">:</span> <span class="n">int2bool</span><span class="p">,</span>
    <span class="s1">&#39;localkey_is_minor&#39;</span><span class="p">:</span> <span class="n">int2bool</span><span class="p">,</span>
    <span class="s1">&#39;mc_offset&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span>
    <span class="s1">&#39;mc_onset&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span>
    <span class="s1">&#39;mn_onset&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span>
    <span class="s1">&#39;movementNumber&#39;</span><span class="p">:</span> <span class="n">safe_int</span><span class="p">,</span>
    <span class="s1">&#39;next&#39;</span><span class="p">:</span> <span class="n">str2inttuple</span><span class="p">,</span>
    <span class="s1">&#39;nominal_duration&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span>
    <span class="s1">&#39;quarterbeats&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span>
    <span class="s1">&#39;quarterbeats_all_endings&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span>
    <span class="s1">&#39;onset&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span>
    <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span>
    <span class="s1">&#39;scalar&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span> <span class="p">}</span>

<span class="n">TSV_DTYPES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;absolute_base&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;absolute_root&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;alt_label&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;barline&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;base&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bass_note&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;breaks&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cadence&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;cadences_id&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;changes&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;chord&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;chord_id&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;chord_type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;color_name&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;color_html&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;color_r&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;color_g&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;color_b&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;color_a&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;dont_count&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;duration_qb&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="s1">&#39;expanded_id&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;figbass&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;globalkey&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;gracenote&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;harmonies_id&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;harmony_layer&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;keysig&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;label_type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;leftParen&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;localkey&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;marker&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;mc&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;mc_playthrough&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;midi&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;mn&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;offset:x&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;offset_x&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;offset:y&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;offset_y&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;nashville&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;notes_id&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;numbering_offset&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;numeral&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;octave&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;pedal&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;playthrough&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;phraseend&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;regex_match&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;relativeroot&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;repeats&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;rightParen&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;root&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rootCase&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;slur&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;special&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;staff&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;tied&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;timesig&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="s1">&#39;tpc&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;voice&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;voices&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;volta&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
    <span class="s1">&#39;volta_mcs&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
<span class="p">}</span>

<div class="viewcode-block" id="load_tsv"><a class="viewcode-back" href="../../reference.html#ms3.utils.load_tsv">[docs]</a><span class="k">def</span> <span class="nf">load_tsv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span>
             <span class="n">index_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span>
             <span class="n">converters</span><span class="o">=</span><span class="p">{},</span>
             <span class="n">dtype</span><span class="o">=</span><span class="p">{},</span>
             <span class="n">stringtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Loads the TSV file `path` while applying correct type conversion and parsing tuples.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : :obj:`str`</span>
<span class="sd">        Path to a TSV file as output by format_data().</span>
<span class="sd">    index_col : :obj:`list`, optional</span>
<span class="sd">        By default, the first two columns are loaded as MultiIndex.</span>
<span class="sd">        The first level distinguishes pieces and the second level the elements within.</span>
<span class="sd">    converters, dtype : :obj:`dict`, optional</span>
<span class="sd">        Enhances or overwrites the mapping from column names to types included the constants.</span>
<span class="sd">    stringtype : :obj:`bool`, optional</span>
<span class="sd">        If you&#39;re using pandas &gt;= 1.0.0 you might want to set this to True in order</span>
<span class="sd">        to be using the new `string` datatype that includes the new null type `pd.NA`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">TSV_COLUMN_CONVERTERS</span><span class="p">,</span> <span class="n">TSV_DTYPES</span>

    <span class="k">if</span> <span class="n">converters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">TSV_COLUMN_CONVERTERS</span><span class="p">)</span>
        <span class="n">conv</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">converters</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">types</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">types</span> <span class="o">=</span> <span class="n">dtype</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">TSV_DTYPES</span><span class="p">)</span>
        <span class="n">types</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stringtype</span><span class="p">:</span>
        <span class="n">types</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span> <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="nb">str</span> <span class="k">else</span> <span class="n">typ</span> <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">types</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="n">index_col</span><span class="p">,</span>
                           <span class="n">dtype</span><span class="o">=</span><span class="n">types</span><span class="p">,</span>
                           <span class="n">converters</span><span class="o">=</span><span class="n">conv</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">EmptyDataError</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="s1">&#39;mn&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
        <span class="n">mn_volta</span> <span class="o">=</span> <span class="n">mn2int</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">mn</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">mn</span> <span class="o">=</span> <span class="n">mn_volta</span><span class="o">.</span><span class="n">mn</span>
        <span class="k">if</span> <span class="n">mn_volta</span><span class="o">.</span><span class="n">volta</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;volta&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;Int64&#39;</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">volta</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mn_volta</span><span class="o">.</span><span class="n">volta</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;interval&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">iv_index</span> <span class="o">=</span> <span class="n">parse_interval_index_column</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;interval&#39;</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">iv_index</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;interval&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">df</span></div>


<span class="nd">@lru_cache</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">tsv_column2datatype</span><span class="p">():</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span>
    <span class="n">mapping</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s1">&#39;Int64&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
        <span class="s1">&#39;string&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
        <span class="nb">float</span><span class="p">:</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span>
        <span class="nb">int</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
        <span class="n">int2bool</span><span class="p">:</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span>
        <span class="n">safe_frac</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;base&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;-?\d+(?:\/\d+)?&quot;</span><span class="p">},</span>
        <span class="n">safe_int</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
        <span class="n">str2inttuple</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;base&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;\(-?\d+, ?-?\d+\)&quot;</span><span class="p">},</span>
    <span class="p">})</span>
    <span class="n">column2datatype</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">TSV_COLUMN_CONVERTERS</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">column2datatype</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">col</span><span class="p">:</span> <span class="n">mapping</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">TSV_DTYPES</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
    <span class="k">return</span> <span class="n">column2datatype</span>


<span class="nd">@lru_cache</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">tsv_column2description</span><span class="p">(</span><span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;mc&#39;</span><span class="p">:</span> <span class="s1">&#39;Measure count.&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mn&#39;</span><span class="p">:</span> <span class="s1">&#39;Measure number.&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mc_onset&#39;</span><span class="p">:</span> <span class="s2">&quot;An event&#39;s distance (fraction of a whole note) from the beginning of the MC.&quot;</span><span class="p">,</span>
        <span class="s1">&#39;mn_onset&#39;</span><span class="p">:</span> <span class="s2">&quot;An event&#39;s distance (fraction of a whole note) from the beginning of the MN.&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mapping</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>


<span class="nd">@lru_cache</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">tsv_column2schema</span><span class="p">(</span><span class="n">col</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;titles&quot;</span><span class="p">:</span> <span class="n">col</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">column2type</span> <span class="o">=</span> <span class="n">tsv_column2datatype</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column2type</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;datatype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">column2type</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">tsv_column2description</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;dc:description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">description</span>
    <span class="k">return</span> <span class="n">result</span>


<div class="viewcode-block" id="make_csvw_jsonld"><a class="viewcode-back" href="../../reference.html#ms3.utils.make_csvw_jsonld">[docs]</a><span class="k">def</span> <span class="nf">make_csvw_jsonld</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="n">columns</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                     <span class="n">urls</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
                     <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;W3C&#39;s CSV on the Web Primer: https://www.w3.org/TR/tabular-data-primer/&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;@context&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;http://www.w3.org/ns/csvw#&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;@language&quot;</span><span class="p">:</span> <span class="s2">&quot;en &quot;</span><span class="p">}],</span>
        <span class="s2">&quot;dc:title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
        <span class="s2">&quot;dialect&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;delimiter&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;dc:description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">description</span>
    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;dc:created&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;dc:creator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span>
        <span class="s2">&quot;@context&quot;</span><span class="p">:</span> <span class="s2">&quot;https://schema.org/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;@type&quot;</span><span class="p">:</span> <span class="s2">&quot;SoftwareApplication&quot;</span><span class="p">,</span>
        <span class="s2">&quot;@id&quot;</span><span class="p">:</span> <span class="s2">&quot;https://github.com/johentsch/ms3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ms3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;A parser for MuseScore 3 files.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;author&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Johannes Hentschel&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;@id&quot;</span><span class="p">:</span> <span class="s2">&quot;https://orcid.org/0000-0002-1986-9545&quot;</span><span class="p">,</span>
                   <span class="p">},</span>
        <span class="s2">&quot;softwareVersion&quot;</span><span class="p">:</span> <span class="n">MS3_VERSION</span><span class="p">,</span>
    <span class="p">}]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">urls</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">urls</span><span class="p">,</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;tables&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">p</span><span class="p">}</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">]</span>
    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;tableSchema&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;columns&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">tsv_column2schema</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span></div>

<span class="k">def</span> <span class="nf">store_csvw_jsonld</span><span class="p">(</span><span class="n">corpus</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">facet</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">columns</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                      <span class="n">files</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">titles</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;expanded&quot;</span><span class="p">:</span> <span class="s2">&quot;DCML harmony annotations&quot;</span><span class="p">,</span>
        <span class="s2">&quot;measures&quot;</span><span class="p">:</span> <span class="s2">&quot;Measure tables&quot;</span><span class="p">,</span>
        <span class="s2">&quot;notes&quot;</span><span class="p">:</span> <span class="s2">&quot;Note tables&quot;</span><span class="p">,</span>

    <span class="p">}</span>
    <span class="n">descriptions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;expanded&quot;</span><span class="p">:</span> <span class="s2">&quot;One feature matrix per score, containing one line per label. The first columns (until &#39;label&#39;) &quot;</span>
                    <span class="s2">&quot;are the same as in extracted &#39;labels&#39; tables with the difference that only those harmony labels &quot;</span>
                    <span class="s2">&quot;that match the DCML harmony annotation standard (dcmlab.github.io/standards) are included. Since &quot;</span>
                    <span class="s2">&quot;these follow a specific syntax, they can be split into their components (features) and transformed &quot;</span>
                    <span class="s2">&quot;into scale degrees. For more information, please refer to the docs at https://johentsch.github.io/ms3/columns&quot;</span><span class="p">,</span>
        <span class="s2">&quot;measures&quot;</span><span class="p">:</span> <span class="s2">&quot;One feature matrix per score, containing one line per stack of &lt;Measure&gt; tags in the score&#39;s XML tree. &quot;</span>
                    <span class="s2">&quot;They are counted in the column &#39;mc&#39; starting from 1, whereas the conventional measure numbers are shown &quot;</span>
                    <span class="s2">&quot;in the column &#39;mn&#39;. One MN is frequently composed in two (or more) MCs. Furthermore, these tables include &quot;</span>
                    <span class="s2">&quot;special bar lines, repeat signs, first and second endings, irregular measure lengths, as well as the &quot;</span>
                    <span class="s2">&quot;column &#39;next&#39; which contains follow-up MCs for unfolding a score&#39;s repeat structure. For more information, &quot;</span>
                    <span class="s2">&quot;please refer to the docs at https://johentsch.github.io/ms3/columns&quot;</span><span class="p">,</span>
        <span class="s2">&quot;notes&quot;</span><span class="p">:</span> <span class="s2">&quot;One feature matrix per score, containing one row per note head. Not every row represents an &quot;</span>
                 <span class="s2">&quot;onset because note heads may be tied together (see column &#39;tied&#39;). &quot;</span>
                 <span class="s2">&quot;For more information, please refer to the docs at https://johentsch.github.io/ms3/columns&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">titles</span><span class="p">[</span><span class="n">facet</span><span class="p">]</span> <span class="k">if</span> <span class="n">facet</span> <span class="ow">in</span> <span class="n">titles</span> <span class="k">else</span> <span class="n">facet</span>
    <span class="n">title</span> <span class="o">+=</span> <span class="s2">&quot; for &quot;</span> <span class="o">+</span> <span class="n">corpus</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">descriptions</span><span class="p">[</span><span class="n">facet</span><span class="p">]</span> <span class="k">if</span> <span class="n">facet</span> <span class="ow">in</span> <span class="n">descriptions</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">jsonld</span> <span class="o">=</span> <span class="n">make_csvw_jsonld</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                              <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span>
                              <span class="n">urls</span><span class="o">=</span><span class="n">files</span><span class="p">,</span>
                              <span class="n">description</span><span class="o">=</span><span class="n">description</span>
                              <span class="p">)</span>
    <span class="n">json_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;csv-metadata.json&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">jsonld</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">json_path</span>


<div class="viewcode-block" id="make_continuous_offset_series"><a class="viewcode-back" href="../../reference.html#ms3.utils.make_continuous_offset_series">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">make_continuous_offset_series</span><span class="p">(</span><span class="n">measures</span><span class="p">,</span> <span class="n">quarters</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">negative_anacrusis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Accepts a measure table without &#39;quarterbeats&#39; column and computes each MC&#39;s offset from the piece&#39;s beginning.</span>
<span class="sd">    Deal with voltas before passing the table.</span>

<span class="sd">    If you need an offset_dict and the measures already come with a &#39;quarterbeats&#39; column, you can call</span>
<span class="sd">    :func:`make_offset_dict_from_measures`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    measures : :obj:`pandas.DataFrame`</span>
<span class="sd">        A measures table with &#39;normal&#39; RangeIndex containing the column &#39;act_durs&#39; and one of</span>
<span class="sd">        &#39;mc&#39; or &#39;mc_playthrough&#39; (if repeats were unfolded).</span>
<span class="sd">    quarters : :obj:`bool`, optional</span>
<span class="sd">        By default, the continuous offsets are expressed in quarter notes. Pass false to leave them as fractions</span>
<span class="sd">        of a whole note.</span>
<span class="sd">    negative_anacrusis : :obj:`fractions.Fraction`</span>
<span class="sd">        By default, the first value is 0. If you pass a fraction here, the first value will be its negative and the</span>
<span class="sd">        second value will be 0.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.Series`</span>
<span class="sd">        Cumulative sum of the actual durations, shifted down by 1. Compared to the original DataFrame it has</span>
<span class="sd">        length + 2 because it adds the end value twice, once with the next index value, and once with the index &#39;end&#39;.</span>
<span class="sd">        Otherwise the end value would be lost due to the shifting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;mc_playthrough&#39;</span> <span class="ow">in</span> <span class="n">measures</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">act_durs</span> <span class="o">=</span> <span class="n">measures</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;mc_playthrough&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">act_dur</span>
    <span class="k">elif</span> <span class="s1">&#39;mc&#39;</span> <span class="ow">in</span> <span class="n">measures</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">act_durs</span> <span class="o">=</span> <span class="n">measures</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;mc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">act_dur</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Expected to have at least one column called &#39;mc&#39; or &#39;mc_playthrough&#39;.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">quarters</span><span class="p">:</span>
        <span class="n">act_durs</span> <span class="o">=</span> <span class="n">act_durs</span> <span class="o">*</span> <span class="mi">4</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">act_durs</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">last_val</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">last_ix</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ending</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">last_val</span><span class="p">,</span> <span class="n">last_val</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">last_ix</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">res</span><span class="p">,</span> <span class="n">ending</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">negative_anacrusis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">-=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">frac</span><span class="p">(</span><span class="n">negative_anacrusis</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="make_offset_dict_from_measures"><a class="viewcode-back" href="../../reference.html#ms3.utils.make_offset_dict_from_measures">[docs]</a><span class="k">def</span> <span class="nf">make_offset_dict_from_measures</span><span class="p">(</span><span class="n">measures</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">all_endings</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Turn a measure table that comes with a &#39;quarterbeats&#39; column into a dictionary that maps MCs (measure counts)</span>
<span class="sd">    to their quarterbeat offset from the piece&#39;s beginning, used for computing quarterbeats for other facets.</span>

<span class="sd">    This function is used for the default case. If you need more options, e.g. an offset dict from unfolded</span>
<span class="sd">    measures or expressed in whole notes or with negative anacrusis, use</span>
<span class="sd">    :func:`make_continuous_offset_series` instead.</span>

<span class="sd">    Args:</span>
<span class="sd">      measures: Measures table containing a &#39;quarterbeats&#39; column.</span>
<span class="sd">      all_endings: Uses the column &#39;quarterbeats_all_endings&#39; of the measures table if it has one, otherwise</span>
<span class="sd">          falls back to the default &#39;quarterbeats&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">      {MC -&gt; quarterbeat_offset}. Offsets are Fractions. If ``all_endings`` is not set to ``True``,</span>
<span class="sd">      values for MCs that are part of a first ending (or third or larger) are NA.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">measures</span> <span class="o">=</span> <span class="n">measures</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;mc&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">all_endings</span> <span class="ow">and</span> <span class="s1">&#39;quarterbeats_all_endings&#39;</span> <span class="ow">in</span> <span class="n">measures</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">col</span> <span class="o">=</span> <span class="s1">&#39;quarterbeats_all_endings&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">col</span> <span class="o">=</span> <span class="s1">&#39;quarterbeats&#39;</span>
    <span class="n">offset_dict</span> <span class="o">=</span> <span class="n">measures</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">last_row</span> <span class="o">=</span> <span class="n">measures</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">offset_dict</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">last_row</span><span class="o">.</span><span class="n">act_dur</span>
    <span class="k">return</span> <span class="n">offset_dict</span></div>


<div class="viewcode-block" id="make_id_tuples"><a class="viewcode-back" href="../../reference.html#ms3.utils.make_id_tuples">[docs]</a><span class="k">def</span> <span class="nf">make_id_tuples</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; For a given key, this function returns index tuples in the form [(key, 0), ..., (key, n)]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        indices in the form [(key, 0), ..., (key, n)]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span></div>


<div class="viewcode-block" id="make_interval_index_from_breaks"><a class="viewcode-back" href="../../reference.html#ms3.utils.make_interval_index_from_breaks">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">make_interval_index_from_breaks</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">end_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;interval&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Interpret a Series as interval breaks and make an IntervalIndex out of it.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    S : :obj:`pandas.Series`</span>
<span class="sd">        Interval breaks. It is assumed that the breaks are sorted.</span>
<span class="sd">    end_value : numeric, optional</span>
<span class="sd">        Often you want to pass the right border of the last interval.</span>
<span class="sd">    closed : :obj:`str`, optional</span>
<span class="sd">        Defaults to &#39;left&#39;. Argument passed to to :py:meth:`pandas.IntervalIndex.from_breaks`.</span>
<span class="sd">    name : :obj:`str`, optional</span>
<span class="sd">        Name of the created index. Defaults to &#39;interval&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.IntervalIndex`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">breaks</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">end_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">breaks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">end_value</span> <span class="o">&gt;</span> <span class="n">last</span><span class="p">:</span>
            <span class="n">breaks</span> <span class="o">+=</span> <span class="p">[</span><span class="n">end_value</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">breaks</span> <span class="o">+=</span> <span class="p">[</span><span class="n">last</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">iix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">IntervalIndex</span><span class="o">.</span><span class="n">from_breaks</span><span class="p">(</span><span class="n">breaks</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="n">closed</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">unsorted</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">breaks</span><span class="p">,</span> <span class="n">breaks</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="k">if</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="n">a</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unsorted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Breaks are not sorted: </span><span class="si">{</span><span class="n">unsorted</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot create IntervalIndex from these breaks:</span><span class="se">\n</span><span class="si">{</span><span class="n">breaks</span><span class="si">}</span><span class="se">\n</span><span class="s2">Exception: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">return</span> <span class="n">iix</span></div>


<div class="viewcode-block" id="make_name_columns"><a class="viewcode-back" href="../../reference.html#ms3.utils.make_name_columns">[docs]</a><span class="k">def</span> <span class="nf">make_name_columns</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Relies on the columns ``localkey`` and ``globalkey`` to transform the columns ``root`` and ``bass_notes`` from</span>
<span class="sd">    scale degrees (expressed as fifths) to absolute note names, e.g. in C major: 0 =&gt; &#39;C&#39;, 7 =&gt; &#39;C#&#39;, -5 =&gt; &#39;Db&#39;</span>
<span class="sd">    Uses: transform(), scale_degree2name&quot;&quot;&quot;</span>
    <span class="n">new_cols</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="s1">&#39;bass_note&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">new_cols</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">scale_degree2name</span><span class="p">,</span> <span class="p">[</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;localkey&#39;</span><span class="p">,</span> <span class="s1">&#39;globalkey&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">new_cols</span><span class="p">)</span></div>


<div class="viewcode-block" id="make_playthrough2mc"><a class="viewcode-back" href="../../reference.html#ms3.utils.make_playthrough2mc">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">make_playthrough2mc</span><span class="p">(</span><span class="n">measures</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Turns the column &#39;next&#39; into a mapping of playthrough_mc -&gt; mc.&quot;&quot;&quot;</span>
    <span class="n">ml</span> <span class="o">=</span> <span class="n">measures</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;mc&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="n">next2sequence</span><span class="p">(</span><span class="n">ml</span><span class="o">.</span><span class="n">next</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing unfolded sequence of MCs failed with:</span><span class="se">\n</span><span class="s2">&#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                       <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;message_id&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="p">)})</span>
        <span class="k">return</span>
    <span class="n">mc_playthrough</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mc_playthrough&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;Int64&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mc_playthrough</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">mc_playthrough</span><span class="o">.</span><span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;The first mc should be 0 or 1, not </span><span class="si">{</span><span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">mc_playthrough</span></div>

<div class="viewcode-block" id="make_playthrough_info"><a class="viewcode-back" href="../../reference.html#ms3.utils.make_playthrough_info">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">make_playthrough_info</span><span class="p">(</span><span class="n">measures</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Turns a measures table into a DataFrame or Series that can be passed as argument to :func:`unfold_repeats`.</span>
<span class="sd">    The return type is DataFrame if the unfolded measures table contains an &#39;mn_playthrough&#39; column, otherwise it</span>
<span class="sd">    is equal to the result of :func:`make_playthrough2mc`. Hence, the purpose of the function is to add an</span>
<span class="sd">    &#39;mn_playthrough&#39; column to unfolded facets whenever possible.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unfolded_measures</span> <span class="o">=</span> <span class="n">unfold_measures_table</span><span class="p">(</span><span class="n">measures</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">unfolded_measures</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">unfolded_measures</span> <span class="o">=</span> <span class="n">unfolded_measures</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;mc_playthrough&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;mn_playthrough&#39;</span> <span class="ow">in</span> <span class="n">unfolded_measures</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">unfolded_measures</span><span class="p">[[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;mn_playthrough&#39;</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">unfolded_measures</span><span class="o">.</span><span class="n">mc</span></div>


<div class="viewcode-block" id="map2elements"><a class="viewcode-back" href="../../reference.html#ms3.utils.map2elements">[docs]</a><span class="k">def</span> <span class="nf">map2elements</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; If `e` is an iterable, `f` is applied to all elements.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">map2elements</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">):</span>
                <span class="c1">### e.g., if a numerical index is transformed to strings</span>
                <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">map2elements</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="merge_ties"><a class="viewcode-back" href="../../reference.html#ms3.utils.merge_ties">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">merge_ties</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">return_dropped</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">perform_checks</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; In a note list, merge tied notes to single events with accumulated durations.</span>
<span class="sd">        Input dataframe needs columns [&#39;duration&#39;, &#39;tied&#39;, &#39;midi&#39;, &#39;staff&#39;]. This</span>
<span class="sd">        function does not handle correctly overlapping ties on the same pitch since</span>
<span class="sd">        it doesn&#39;t take into account the notational layers (&#39;voice&#39;).</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df</span>
<span class="sd">    return_dropped</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
        <span class="n">vc</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">tied</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">vc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">vc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;More than one 1 or -1:</span><span class="se">\n</span><span class="si">{</span><span class="n">vc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
        <span class="n">dur</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">drop</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="s1">&#39;ix&#39;</span><span class="p">:</span> <span class="n">ix</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">dur</span><span class="p">,</span> <span class="s1">&#39;dropped&#39;</span><span class="p">:</span> <span class="n">drop</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">merge_notes</span><span class="p">(</span><span class="n">staff_midi</span><span class="p">):</span>

        <span class="n">staff_midi</span><span class="p">[</span><span class="s1">&#39;chunks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">staff_midi</span><span class="o">.</span><span class="n">tied</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">staff_midi</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;chunks&#39;</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">merge</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;ix&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">tied</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">notna</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">tied</span><span class="o">.</span><span class="n">notna</span><span class="p">(),</span> <span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="s1">&#39;tied&#39;</span><span class="p">,</span> <span class="s1">&#39;midi&#39;</span><span class="p">,</span> <span class="s1">&#39;staff&#39;</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">perform_checks</span><span class="p">:</span>
        <span class="n">before</span> <span class="o">=</span> <span class="n">notna</span><span class="o">.</span><span class="n">tied</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="n">new_dur</span> <span class="o">=</span> <span class="n">notna</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;staff&#39;</span><span class="p">,</span> <span class="s1">&#39;midi&#39;</span><span class="p">],</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">merge_notes</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_dur</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_dur</span><span class="o">.</span><span class="n">duration</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">new_dur</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_dropped</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_dur</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;dropped&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_dur</span><span class="o">.</span><span class="n">dropped</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">new_dur</span><span class="o">.</span><span class="n">dropped</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">perform_checks</span><span class="p">:</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">tied</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">before</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">after</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;Error while merging ties. Before:</span><span class="se">\n</span><span class="si">{</span><span class="n">before</span><span class="si">}</span><span class="se">\n</span><span class="s2">After:</span><span class="se">\n</span><span class="si">{</span><span class="n">after</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="merge_chords_and_notes"><a class="viewcode-back" href="../../reference.html#ms3.utils.merge_chords_and_notes">[docs]</a><span class="k">def</span> <span class="nf">merge_chords_and_notes</span><span class="p">(</span><span class="n">chords_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                           <span class="n">notes_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Performs an outer join between a chords table and a notes table, based on the column &#39;chord_id&#39;. If the chords</span>
<span class="sd">    come with an &#39;event&#39; column, all chord events matched with at least one note will be renamed to &#39;Note&#39;.</span>
<span class="sd">    Markup displayed in individual rows (&#39;Dynamic&#39;, &#39;Spanner&#39;, &#39;StaffText&#39;, &#39;SystemText&#39;, &#39;Tempo&#39;, &#39;FiguredBass&#39;),</span>
<span class="sd">    are/remain placed before the note(s) with the same onset.</span>
<span class="sd">    Markup showing up in a Chord event&#39;s row (e.g. a Spanner ID) will be duplicated for each note pertaining to that chord,</span>
<span class="sd">    i.e., only for notes in the same staff and voice.</span>

<span class="sd">    Args:</span>
<span class="sd">      chords_table:</span>
<span class="sd">      notes_table:</span>

<span class="sd">    Returns:</span>
<span class="sd">      Merged DataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">notes_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tied&#39;</span><span class="p">,</span> <span class="s1">&#39;tpc&#39;</span><span class="p">,</span> <span class="s1">&#39;midi&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;octave&#39;</span><span class="p">,</span> <span class="s1">&#39;chord_id&#39;</span><span class="p">]</span> <span class="c1"># &#39;gracenote&#39;, &#39;tremolo&#39; would be contained in chords already</span>
    <span class="n">present_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">notes_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">notes_table</span><span class="p">]</span>
    <span class="k">assert</span> <span class="s1">&#39;chord_id&#39;</span> <span class="ow">in</span> <span class="n">present_columns</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Notes table does not come with a &#39;chord_id&#39; column needed for merging: </span><span class="si">{</span><span class="n">notes_table</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">notes_table</span><span class="p">[</span><span class="n">present_columns</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s1">&#39;chord_id&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">})</span>
    <span class="n">amend_events</span> <span class="o">=</span> <span class="s1">&#39;event&#39;</span> <span class="ow">in</span> <span class="n">chords_table</span>
    <span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">chords_table</span><span class="p">,</span> <span class="n">notes</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;chord_id&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">indicator</span><span class="o">=</span><span class="n">amend_events</span><span class="p">)</span>
    <span class="n">merged</span> <span class="o">=</span> <span class="n">sort_note_list</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">amend_events</span><span class="p">:</span>
        <span class="n">matches_mask</span> <span class="o">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">_merge</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span>
        <span class="n">merged</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">matches_mask</span><span class="p">,</span> <span class="s1">&#39;event&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Note&#39;</span>
        <span class="n">merged</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;_merge&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">merged</span></div>

<div class="viewcode-block" id="metadata2series"><a class="viewcode-back" href="../../reference.html#ms3.utils.metadata2series">[docs]</a><span class="k">def</span> <span class="nf">metadata2series</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Turns a metadata dict into a pd.Series() (for storing in a DataFrame)</span>
<span class="sd">    Uses: ambitus2oneliner(), dict2oneliner(), parts_info()</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.Series`</span>
<span class="sd">        A series allowing for storing metadata as a row of a DataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;TimeSig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict2oneliner</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;TimeSig&#39;</span><span class="p">])</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;KeySig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict2oneliner</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;KeySig&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s1">&#39;ambitus&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;ambitus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ambitus2oneliner</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;ambitus&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s1">&#39;parts&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parts_info</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;parts&#39;</span><span class="p">]))</span>
        <span class="k">del</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;parts&#39;</span><span class="p">])</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span></div>

<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">midi_and_tpc2octave</span><span class="p">(</span><span class="n">midi</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">tpc</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">midi_and_tpc2octave</span><span class="p">(</span><span class="n">midi</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">tpc</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">midi_and_tpc2octave</span><span class="p">(</span><span class="n">midi</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">tpc</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">midi_and_tpc2octave</span><span class="p">(</span><span class="n">midi</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">tpc</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">midi_and_tpc2octave</span><span class="p">(</span><span class="n">midi</span><span class="p">:</span>  <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">tpc</span><span class="p">:</span>  <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="o">...</span>
<span class="k">def</span> <span class="nf">midi_and_tpc2octave</span><span class="p">(</span><span class="n">midi</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
                        <span class="n">tpc</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">midi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">midi</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># if numpy array or Pandas Series, compute vectorized, otherwise iterate</span>
            <span class="n">midi</span><span class="o">.</span><span class="n">dtype</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">midi</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">midi_and_tpc2octave</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">midi</span><span class="p">,</span> <span class="n">tpc</span><span class="p">))</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">tpc</span> <span class="o">//</span> <span class="mi">7</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">midi</span> <span class="o">-</span> <span class="n">acc</span><span class="p">)</span> <span class="o">//</span> <span class="mi">12</span> <span class="o">-</span> <span class="mi">1</span>

<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">midi2octave</span><span class="p">(</span><span class="n">midi</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">fifths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">midi2octave</span><span class="p">(</span><span class="n">midi</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">fifths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">midi2octave</span><span class="p">(</span><span class="n">midi</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">fifths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NDArray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">midi2octave</span><span class="p">(</span><span class="n">midi</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">fifths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="o">...</span>
<span class="nd">@overload</span>
<span class="k">def</span> <span class="nf">midi2octave</span><span class="p">(</span><span class="n">midi</span><span class="p">:</span>  <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">fifths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="o">...</span>
<div class="viewcode-block" id="midi2octave"><a class="viewcode-back" href="../../reference.html#ms3.utils.midi2octave">[docs]</a><span class="k">def</span> <span class="nf">midi2octave</span><span class="p">(</span><span class="n">midi</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
                        <span class="n">fifths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">NDArray</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; For a given MIDI pitch, calculate the octave. Middle octave = 4</span>
<span class="sd">        Uses: midi_and_tpc2octave(), map2elements()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    midi : :obj:`int`</span>
<span class="sd">        MIDI pitch (positive integer)</span>
<span class="sd">    fifths : :obj:`int`, optional</span>
<span class="sd">        To be precise, for some Tonal Pitch Classes, the octave deviates</span>
<span class="sd">        from the simple formula ``MIDI // 12 - 1``, e.g. for B# or Cb.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">fifths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">midi_and_tpc2octave</span><span class="p">(</span><span class="n">midi</span><span class="p">,</span> <span class="n">fifths</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">midi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">midi</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># if numpy array or Pandas Series, compute vectorized, otherwise iterate</span>
            <span class="n">midi</span><span class="o">.</span><span class="n">dtype</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">map2elements</span><span class="p">(</span><span class="n">midi</span><span class="p">,</span> <span class="n">midi2octave</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">midi</span> <span class="o">//</span> <span class="mi">12</span> <span class="o">-</span> <span class="mi">1</span></div>


<span class="k">def</span> <span class="nf">midi2name</span><span class="p">(</span><span class="n">midi</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">midi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">midi</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">midi</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">transform</span><span class="p">(</span><span class="n">midi</span><span class="p">,</span> <span class="n">midi2name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">midi</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">map2elements</span><span class="p">(</span><span class="n">midi</span><span class="p">,</span> <span class="n">midi2name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">midi</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span>
             <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;C#/Db&#39;</span><span class="p">,</span>
             <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span>
             <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;D#/Eb&#39;</span><span class="p">,</span>
             <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span>
             <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span>
             <span class="mi">6</span><span class="p">:</span> <span class="s1">&#39;F#/Gb&#39;</span><span class="p">,</span>
             <span class="mi">7</span><span class="p">:</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span>
             <span class="mi">8</span><span class="p">:</span> <span class="s1">&#39;G#/Ab&#39;</span><span class="p">,</span>
             <span class="mi">9</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span>
             <span class="mi">10</span><span class="p">:</span> <span class="s1">&#39;A#/Bb&#39;</span><span class="p">,</span>
             <span class="mi">11</span><span class="p">:</span> <span class="s1">&#39;B&#39;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">names</span><span class="p">[</span><span class="n">midi</span> <span class="o">%</span> <span class="mi">12</span><span class="p">]</span>


<div class="viewcode-block" id="mn2int"><a class="viewcode-back" href="../../reference.html#ms3.utils.mn2int">[docs]</a><span class="k">def</span> <span class="nf">mn2int</span><span class="p">(</span><span class="n">mn_series</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Turn a series of measure numbers parsed as strings into two integer columns &#39;mn&#39; and &#39;volta&#39;. &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">split</span> <span class="o">=</span> <span class="n">mn_series</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?P&lt;mn&gt;\d+)(?P&lt;volta&gt;[a-g])?&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">mn_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mn_series</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mn&#39;</span><span class="p">,</span> <span class="s1">&#39;volta&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mn_series</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;Int64&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mn_series</span>
    <span class="n">split</span><span class="o">.</span><span class="n">mn</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">split</span><span class="o">.</span><span class="n">mn</span><span class="p">)</span>
    <span class="n">split</span><span class="o">.</span><span class="n">volta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">split</span><span class="o">.</span><span class="n">volta</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}))</span>
    <span class="k">return</span> <span class="n">split</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;Int64&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="name2format"><a class="viewcode-back" href="../../reference.html#ms3.utils.name2format">[docs]</a><span class="k">def</span> <span class="nf">name2format</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="n">name_col</span><span class="o">=</span><span class="s1">&#39;color_name&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Converts a column with CSS3 names into &#39;html&#39;, &#39;rgb&#39;, or  &#39;rgba&#39;.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">name_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">color_name2html</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;rgb&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">name_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">color_name2rgb</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;rgba&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">name_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">color_name2rgba</span><span class="p">)</span></div>


<div class="viewcode-block" id="name2fifths"><a class="viewcode-back" href="../../reference.html#ms3.utils.name2fifths">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">name2fifths</span><span class="p">(</span><span class="n">nn</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Turn a note name such as `Ab` into a tonal pitch class, such that -1=F, 0=C, 1=G etc.</span>
<span class="sd">        Uses: split_note_name()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nn</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">int</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">nn</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">nn</span>
    <span class="n">name_tpcs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
    <span class="n">accidentals</span><span class="p">,</span> <span class="n">note_name</span> <span class="o">=</span> <span class="n">split_note_name</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">note_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">step_tpc</span> <span class="o">=</span> <span class="n">name_tpcs</span><span class="p">[</span><span class="n">note_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">step_tpc</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">accidentals</span></div>


<div class="viewcode-block" id="name2pc"><a class="viewcode-back" href="../../reference.html#ms3.utils.name2pc">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">name2pc</span><span class="p">(</span><span class="n">nn</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Turn a note name such as `Ab` into a tonal pitch class, such that -1=F, 0=C, 1=G etc.</span>
<span class="sd">        Uses: split_note_name()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nn</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">int</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">nn</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">nn</span><span class="si">}</span><span class="s2">&#39; is not a valid note name.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nn</span>
    <span class="n">name_tpcs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">}</span>
    <span class="n">accidentals</span><span class="p">,</span> <span class="n">note_name</span> <span class="o">=</span> <span class="n">split_note_name</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">note_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">step_pc</span> <span class="o">=</span> <span class="n">name_tpcs</span><span class="p">[</span><span class="n">note_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">step_pc</span> <span class="o">+</span> <span class="n">accidentals</span><span class="p">)</span> <span class="o">%</span> <span class="mi">12</span></div>


<div class="viewcode-block" id="nan_eq"><a class="viewcode-back" href="../../reference.html#ms3.utils.nan_eq">[docs]</a><span class="k">def</span> <span class="nf">nan_eq</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns True if a and b are equal or both null. Works on two Series or two elements.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">b</span><span class="p">))</span></div>


<div class="viewcode-block" id="next2sequence"><a class="viewcode-back" href="../../reference.html#ms3.utils.next2sequence">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">next2sequence</span><span class="p">(</span><span class="n">next_col</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Turns a &#39;next&#39; column into the correct sequence of MCs corresponding to unfolded repetitions.</span>
<span class="sd">    Requires that the Series&#39; index be the MCs as in ``measures.set_index(&#39;mc&#39;).next``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mc</span> <span class="o">=</span> <span class="n">next_col</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">last_mc</span> <span class="o">=</span> <span class="n">next_col</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">max_iter</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">last_mc</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nxt</span> <span class="o">=</span> <span class="n">next_col</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">mc</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_iter</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nxt</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column &#39;next&#39; contains MC </span><span class="si">{</span><span class="n">mc</span><span class="si">}</span><span class="s2"> which the pieces does not have.&quot;</span><span class="p">,</span>
                       <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;message_id&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="p">)})</span>
            <span class="k">return</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mc</span><span class="p">)</span>
        <span class="n">new_mc</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span> <span class="o">=</span> <span class="n">nxt</span><span class="p">[</span><span class="n">mc</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nxt</span><span class="p">[</span><span class="n">mc</span><span class="p">]</span> <span class="o">=</span> <span class="n">rest</span>
        <span class="n">mc</span> <span class="o">=</span> <span class="n">new_mc</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">max_iter</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="no_collections_no_booleans"><a class="viewcode-back" href="../../reference.html#ms3.utils.no_collections_no_booleans">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">no_collections_no_booleans</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">coll_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bool_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cleans the DataFrame columns [&#39;next&#39;, &#39;chord_tones&#39;, &#39;added_tones&#39;, &#39;volta_mcs] from tuples and the columns</span>
<span class="sd">    [&#39;globalkey_is_minor&#39;, &#39;localkey_is_minor&#39;] from booleans, converting them all to integers</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="n">collection_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;next&#39;</span><span class="p">,</span> <span class="s1">&#39;chord_tones&#39;</span><span class="p">,</span> <span class="s1">&#39;added_tones&#39;</span><span class="p">,</span> <span class="s1">&#39;volta_mcs&#39;</span><span class="p">]</span>
    <span class="n">bool_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;globalkey_is_minor&#39;</span><span class="p">,</span> <span class="s1">&#39;localkey_is_minor&#39;</span><span class="p">,</span> <span class="s1">&#39;has_drumset&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">coll_columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">collection_cols</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">coll_columns</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bool_columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bool_cols</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bool_columns</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">collection_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df needs to be a DataFrame, not a </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="vm">__class__</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cc</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cc</span><span class="p">],</span> <span class="n">iterable2str</span><span class="p">,</span> <span class="n">column_wise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transformed iterables in the columns </span><span class="si">{</span><span class="n">cc</span><span class="si">}</span><span class="s2"> to strings.&quot;</span><span class="p">)</span>
    <span class="n">bc</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">bool_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">bc</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="c1"># need to convert to nullable boolean first</span>
            <span class="n">conv</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="s1">&#39;boolean&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">bc</span><span class="p">}</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">conv</span><span class="p">)</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">bc</span><span class="p">}</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">conv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<span class="k">def</span> <span class="nf">ordinal_suffix</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">suffixes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;st&#39;</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;nd&#39;</span><span class="p">,</span>
        <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;rd&#39;</span>
    <span class="p">}</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">suffixes</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">suffixes</span><span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">return</span> <span class="s1">&#39;th&#39;</span>


<div class="viewcode-block" id="parts_info"><a class="viewcode-back" href="../../reference.html#ms3.utils.parts_info">[docs]</a><span class="k">def</span> <span class="nf">parts_info</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Turns a (nested) ``metadata[&#39;parts&#39;]`` dict into a flat dict based on staves.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; d = s.mscx.metadata_from_parsed</span>
<span class="sd">    &gt;&gt;&gt; parts_info(d[&#39;parts&#39;])</span>
<span class="sd">    {&#39;staff_1_instrument&#39;: &#39;Voice&#39;,</span>
<span class="sd">     &#39;staff_1_ambitus&#39;: &#39;66-76 (F#4-E5)&#39;,</span>
<span class="sd">     &#39;staff_2_instrument&#39;: &#39;Voice&#39;,</span>
<span class="sd">     &#39;staff_2_ambitus&#39;: &#39;55-69 (G3-A4)&#39;,</span>
<span class="sd">     &#39;staff_3_instrument&#39;: &#39;Voice&#39;,</span>
<span class="sd">     &#39;staff_3_ambitus&#39;: &#39;48-67 (C3-G4)&#39;,</span>
<span class="sd">     &#39;staff_4_instrument&#39;: &#39;Voice&#39;,</span>
<span class="sd">     &#39;staff_4_ambitus&#39;: &#39;41-60 (F2-C4)&#39;}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">part_dict</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">part_dict</span><span class="p">[</span><span class="s1">&#39;staves&#39;</span><span class="p">]:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;staff_</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_instrument&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">part_dict</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span>
            <span class="n">amb_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_ambitus&#39;</span>
            <span class="n">res</span><span class="p">[</span><span class="n">amb_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ambitus2oneliner</span><span class="p">(</span><span class="n">part_dict</span><span class="p">[</span><span class="n">amb_name</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="path2type"><a class="viewcode-back" href="../../reference.html#ms3.utils.path2type">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">path2type</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Determine a file&#39;s type by scanning its path for default components in the constant STANDARD_NAMES.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">fext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">SCORE_EXTENSIONS</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recognized file extension &#39;</span><span class="si">{</span><span class="n">fext</span><span class="si">}</span><span class="s2">&#39; as score.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;scores&#39;</span>
    <span class="n">component2type</span> <span class="o">=</span> <span class="n">path_component2file_type_map</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">find_components</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">comp</span> <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">component2type</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="c1"># give preference to folder names before file names</span>
        <span class="n">directory</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;metadata&#39;</span> <span class="ow">in</span> <span class="n">fname</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;metadata&#39;</span>
        <span class="n">found_components</span><span class="p">,</span> <span class="n">n_found</span> <span class="o">=</span> <span class="n">find_components</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_found</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">found_components</span><span class="p">,</span> <span class="n">n_found</span> <span class="o">=</span> <span class="n">find_components</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">found_components</span><span class="p">,</span> <span class="n">n_found</span> <span class="o">=</span> <span class="n">find_components</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_found</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Type could not be inferred from path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;unknown&#39;</span>
    <span class="k">if</span> <span class="n">n_found</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">component2type</span><span class="p">[</span><span class="n">found_components</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; recognized as </span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">typ</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shortened_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">shortened_path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">shortened_path</span><span class="p">,</span> <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">shortened_path</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">component2type</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">base</span><span class="p">:</span>
                    <span class="n">typ</span> <span class="o">=</span> <span class="n">component2type</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multiple components (</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">found_components</span><span class="p">)</span><span class="si">}</span><span class="s2">) found in path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;. Chose the last one: </span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">typ</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Components </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">found_components</span><span class="p">)</span><span class="si">}</span><span class="s2"> found in path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;, but not in one of its constituents.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;other&#39;</span></div>


<span class="nd">@lru_cache</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">path_component2file_type_map</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">comp2type</span> <span class="o">=</span> <span class="p">{</span><span class="n">comp</span><span class="p">:</span> <span class="n">comp</span> <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">STANDARD_NAMES</span><span class="p">}</span>
    <span class="n">comp2type</span><span class="p">[</span><span class="s1">&#39;MS3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;scores&#39;</span>
    <span class="n">comp2type</span><span class="p">[</span><span class="s1">&#39;harmonies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;expanded&#39;</span>
    <span class="n">comp2type</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;labels&#39;</span>
    <span class="n">comp2type</span><span class="p">[</span><span class="s1">&#39;infer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;labels&#39;</span>
    <span class="k">return</span> <span class="n">comp2type</span>

<span class="k">def</span> <span class="nf">file_type2path_component_map</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">comp2type</span> <span class="o">=</span> <span class="n">path_component2file_type_map</span><span class="p">()</span>
    <span class="n">type2comps</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">comp</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">comp2type</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">type2comps</span><span class="p">[</span><span class="n">typ</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">type2comps</span><span class="p">)</span>


<div class="viewcode-block" id="pretty_dict"><a class="viewcode-back" href="../../reference.html#ms3.utils.pretty_dict">[docs]</a><span class="k">def</span> <span class="nf">pretty_dict</span><span class="p">(</span><span class="n">ugly_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">heading_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">heading_value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Turns a dictionary into a string where the keys are printed in a column, separated by &#39;-&gt;&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">heading_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">heading_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">head_key</span> <span class="o">=</span> <span class="s1">&#39;KEY&#39;</span> <span class="k">if</span> <span class="n">heading_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">heading_key</span>
        <span class="n">head_val</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">heading_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">heading_value</span>
        <span class="n">head_val_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">head_val</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">head_key</span><span class="p">:</span> <span class="n">head_val</span><span class="p">}</span>
        <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ugly_dict</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">head_val_length</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ugly_dict</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Please pass a dictionary, not a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ugly_dict</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">ugly_dict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
    <span class="n">left</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">ks</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="n">vs</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vs</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">vs</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">vs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ks</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">:{</span><span class="n">left</span><span class="si">}}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ks</span><span class="si">:{</span><span class="n">left</span><span class="si">}}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">vs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">head_val_length</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="n">head_val_length</span><span class="p">))</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>



<div class="viewcode-block" id="resolve_dir"><a class="viewcode-back" href="../../reference.html#ms3.utils.resolve_dir">[docs]</a><span class="k">def</span> <span class="nf">resolve_dir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Resolves &#39;~&#39; to HOME directory and turns ``d`` into an absolute path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;~&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></div>


<div class="viewcode-block" id="rgb2format"><a class="viewcode-back" href="../../reference.html#ms3.utils.rgb2format">[docs]</a><span class="k">def</span> <span class="nf">rgb2format</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="n">r_col</span><span class="o">=</span><span class="s1">&#39;color_r&#39;</span><span class="p">,</span> <span class="n">g_col</span><span class="o">=</span><span class="s1">&#39;color_g&#39;</span><span class="p">,</span> <span class="n">b_col</span><span class="o">=</span><span class="s1">&#39;color_b&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Converts three RGB columns into a color_html or color_name column. &quot;&quot;&quot;</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">r_col</span><span class="p">,</span> <span class="n">g_col</span><span class="p">,</span> <span class="n">b_col</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">rgb_tuple2html</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;color_html&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">rgb_tuple2name</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;color_name&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="rgb_tuple2format"><a class="viewcode-back" href="../../reference.html#ms3.utils.rgb_tuple2format">[docs]</a><span class="k">def</span> <span class="nf">rgb_tuple2format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Converts a single RGB tuple into &#39;HTML&#39; or &#39;name&#39;.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">t</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">normalize_integer_triplet</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">t</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">rgb_to_hex</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">rgb_to_name</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">MS3_RGB</span><span class="p">[</span><span class="n">norm</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">rgb_to_hex</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span></div>


<div class="viewcode-block" id="rgb_tuple2html"><a class="viewcode-back" href="../../reference.html#ms3.utils.rgb_tuple2html">[docs]</a><span class="k">def</span> <span class="nf">rgb_tuple2html</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Converts a single RGB tuple into HTML.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">rgb_tuple2format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="rgb_tuple2name"><a class="viewcode-back" href="../../reference.html#ms3.utils.rgb_tuple2name">[docs]</a><span class="k">def</span> <span class="nf">rgb_tuple2name</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Converts a single RGB tuple into its CSS3 name or to HTML if there is none.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">rgb_tuple2format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">rgba2attrs</span><span class="p">(</span><span class="n">named_tuple</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">named_tuple</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="k">def</span> <span class="nf">rgba2params</span><span class="p">(</span><span class="n">named_tuple</span><span class="p">):</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="n">rgba2attrs</span><span class="p">(</span><span class="n">named_tuple</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;color_&#39;</span><span class="o">+</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<div class="viewcode-block" id="roman_numeral2fifths"><a class="viewcode-back" href="../../reference.html#ms3.utils.roman_numeral2fifths">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">roman_numeral2fifths</span><span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">global_minor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Turn a Roman numeral into a TPC interval (e.g. for transposition purposes).</span>
<span class="sd">        Uses: split_scale_degree()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">rn</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">rn</span>
    <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">rn</span><span class="p">:</span>
        <span class="n">resolved</span> <span class="o">=</span> <span class="n">resolve_relative_keys</span><span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">global_minor</span><span class="p">)</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;minor&#39;</span> <span class="k">if</span> <span class="n">global_minor</span> <span class="k">else</span> <span class="s1">&#39;major&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Relative numeral </span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2"> mode resolved to </span><span class="si">{</span><span class="n">resolved</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">rn</span> <span class="o">=</span> <span class="n">resolved</span>
    <span class="n">rn_tpcs_maj</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
    <span class="n">rn_tpcs_min</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">}</span>
    <span class="n">accidentals</span><span class="p">,</span> <span class="n">rn_step</span> <span class="o">=</span> <span class="n">split_scale_degree</span><span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">accidentals</span><span class="p">,</span> <span class="n">rn_step</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">rn_step</span> <span class="o">=</span> <span class="n">rn_step</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">step_tpc</span> <span class="o">=</span> <span class="n">rn_tpcs_min</span><span class="p">[</span><span class="n">rn_step</span><span class="p">]</span> <span class="k">if</span> <span class="n">global_minor</span> <span class="k">else</span> <span class="n">rn_tpcs_maj</span><span class="p">[</span><span class="n">rn_step</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">step_tpc</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">accidentals</span></div>

<div class="viewcode-block" id="roman_numeral2semitones"><a class="viewcode-back" href="../../reference.html#ms3.utils.roman_numeral2semitones">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">roman_numeral2semitones</span><span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">global_minor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Turn a Roman numeral into a semitone distance from the root (0-11).</span>
<span class="sd">        Uses: split_scale_degree()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">rn</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">rn</span>
    <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">rn</span><span class="p">:</span>
        <span class="n">resolved</span> <span class="o">=</span> <span class="n">resolve_relative_keys</span><span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">global_minor</span><span class="p">)</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;minor&#39;</span> <span class="k">if</span> <span class="n">global_minor</span> <span class="k">else</span> <span class="s1">&#39;major&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Relative numeral </span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2"> mode resolved to </span><span class="si">{</span><span class="n">resolved</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">rn</span> <span class="o">=</span> <span class="n">resolved</span>
    <span class="n">rn_tpcs_maj</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">}</span>
    <span class="n">rn_tpcs_min</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
    <span class="n">accidentals</span><span class="p">,</span> <span class="n">rn_step</span> <span class="o">=</span> <span class="n">split_scale_degree</span><span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">accidentals</span><span class="p">,</span> <span class="n">rn_step</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">rn_step</span> <span class="o">=</span> <span class="n">rn_step</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">step_tpc</span> <span class="o">=</span> <span class="n">rn_tpcs_min</span><span class="p">[</span><span class="n">rn_step</span><span class="p">]</span> <span class="k">if</span> <span class="n">global_minor</span> <span class="k">else</span> <span class="n">rn_tpcs_maj</span><span class="p">[</span><span class="n">rn_step</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">step_tpc</span> <span class="o">+</span> <span class="n">accidentals</span></div>


<div class="viewcode-block" id="scale_degree2name"><a class="viewcode-back" href="../../reference.html#ms3.utils.scale_degree2name">[docs]</a><span class="k">def</span> <span class="nf">scale_degree2name</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">localkey</span><span class="p">,</span> <span class="n">globalkey</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; For example, scale degree -1 (fifths, i.e. the subdominant) of the localkey of &#39;VI&#39; within &#39;E&#39; minor is &#39;F&#39;.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sd : :obj:`int`</span>
<span class="sd">        Scale degree expressed as distance from the tonic in fifths.</span>
<span class="sd">    localkey : :obj:`str`</span>
<span class="sd">        Local key in which the scale degree is situated, as Roman numeral (can include slash notation such as V/ii).</span>
<span class="sd">    globalkey : :obj:`str`</span>
<span class="sd">        Global key as a note name. E.g. `Ab` for Ab major, or &#39;c#&#39; for C# minor.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`str`</span>
<span class="sd">        The given scale degree, expressed as a note name.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">localkey</span><span class="p">,</span> <span class="n">globalkey</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span>
    <span class="n">global_minor</span> <span class="o">=</span> <span class="n">globalkey</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">localkey</span><span class="p">:</span>
        <span class="n">localkey</span> <span class="o">=</span> <span class="n">resolve_relative_keys</span><span class="p">(</span><span class="n">localkey</span><span class="p">,</span> <span class="n">global_minor</span><span class="p">)</span>
    <span class="n">lk_fifths</span> <span class="o">=</span> <span class="n">roman_numeral2fifths</span><span class="p">(</span><span class="n">localkey</span><span class="p">,</span> <span class="n">global_minor</span><span class="p">)</span>
    <span class="n">gk_fifths</span> <span class="o">=</span> <span class="n">name2fifths</span><span class="p">(</span><span class="n">globalkey</span><span class="p">)</span>
    <span class="n">sd_transposed</span> <span class="o">=</span> <span class="n">sd</span> <span class="o">+</span> <span class="n">lk_fifths</span> <span class="o">+</span> <span class="n">gk_fifths</span>
    <span class="k">return</span> <span class="n">fifths2name</span><span class="p">(</span><span class="n">sd_transposed</span><span class="p">)</span></div>


<div class="viewcode-block" id="scan_directory"><a class="viewcode-back" href="../../reference.html#ms3.utils.scan_directory">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">scan_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                   <span class="n">file_re</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;.*&quot;</span><span class="p">,</span>
                   <span class="n">folder_re</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;.*&quot;</span><span class="p">,</span>
                   <span class="n">exclude_re</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^(\.|_)&quot;</span><span class="p">,</span>
                   <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                   <span class="n">subdirs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                   <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                   <span class="n">exclude_files_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                   <span class="n">return_metadata</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Generator of filtered file paths in ``directory``.</span>

<span class="sd">    Args:</span>
<span class="sd">      directory: Directory to be scanned for files.</span>
<span class="sd">      file_re, folder_re:</span>
<span class="sd">          Regular expressions for filtering certain file names or folder names.</span>
<span class="sd">          The regEx are checked with search(), not match(), allowing for fuzzy search.</span>
<span class="sd">      exclude_re:</span>
<span class="sd">          Exclude files and folders (unless ``exclude_files_only=True``) containing this regular expression.</span>
<span class="sd">      recursive: By default, sub-directories are recursively scanned. Pass False to scan only ``dir``.</span>
<span class="sd">      subdirs: By default, full file paths are returned. Pass True to return (path, name) tuples instead.</span>
<span class="sd">      progress: Pass True to display the progress (useful for large directories).</span>
<span class="sd">      exclude_files_only:</span>
<span class="sd">          By default, ``exclude_re`` excludes files and folder. Pass True to exclude only files matching the regEx.</span>
<span class="sd">      return_metadata:</span>
<span class="sd">          If set to True, &#39;metadata.tsv&#39; are always yielded regardless of ``file_re``.</span>

<span class="sd">    Yields:</span>
<span class="sd">      Full file path or, if ``subdirs=True``, (path, file_name) pairs in random order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">file_re</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">file_re</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;.*&quot;</span>
    <span class="k">if</span> <span class="n">folder_re</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">folder_re</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;.*&quot;</span>

    <span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">counter</span>

        <span class="k">def</span> <span class="nf">check_regex</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">excl</span><span class="o">=</span><span class="n">exclude_re</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">excl</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="k">for</span> <span class="n">dir_entry</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">scandir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">dir_entry</span><span class="o">.</span><span class="n">name</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dir_entry</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">recursive</span> <span class="ow">or</span> <span class="n">folder_re</span> <span class="o">!=</span> <span class="s1">&#39;.*&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">traverse</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">res</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pbar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">folder_re</span> <span class="o">==</span> <span class="s1">&#39;.*&#39;</span><span class="p">:</span>
                    <span class="n">folder_passes</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">folder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
                        <span class="n">folder_passes</span> <span class="o">=</span> <span class="n">check_regex</span><span class="p">(</span><span class="n">folder_re</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">,</span> <span class="n">excl</span><span class="o">=</span><span class="s1">&#39;^$&#39;</span><span class="p">)</span>  <span class="c1"># passes if the folder path matches the regex</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
                        <span class="n">folder_passes</span> <span class="o">=</span> <span class="n">check_regex</span><span class="p">(</span><span class="n">folder_re</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">excl</span><span class="o">=</span><span class="s1">&#39;^$&#39;</span><span class="p">)</span>  <span class="c1"># passes if the folder name itself matches the regex</span>
                    <span class="k">if</span> <span class="n">folder_passes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exclude_files_only</span><span class="p">:</span> <span class="c1"># True if the exclude_re should also exclude folder names</span>
                        <span class="n">folder_passes</span> <span class="o">=</span> <span class="n">check_regex</span><span class="p">(</span><span class="n">folder_re</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">)</span> <span class="c1"># is false if any part of the folder path matches exclude_re</span>
                <span class="k">if</span> <span class="n">dir_entry</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="n">folder_passes</span> <span class="ow">and</span> <span class="p">(</span><span class="n">check_regex</span><span class="p">(</span><span class="n">file_re</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">return_metadata</span> <span class="ow">and</span> <span class="n">name</span><span class="o">==</span><span class="s1">&#39;metadata.tsv&#39;</span><span class="p">)):</span>
                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">pbar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">({</span><span class="s1">&#39;selected&#39;</span><span class="p">:</span> <span class="n">counter</span><span class="p">})</span>
                    <span class="k">if</span> <span class="n">subdirs</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">path</span>

    <span class="k">if</span> <span class="n">exclude_re</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">exclude_re</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">exclude_re</span> <span class="o">=</span> <span class="s1">&#39;^$&#39;</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">resolve_dir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Not an existing directory: &quot;</span> <span class="o">+</span> <span class="n">directory</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">([])</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Scanning files&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39; files&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">progress</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">traverse</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span></div>


<div class="viewcode-block" id="column_order"><a class="viewcode-back" href="../../reference.html#ms3.utils.column_order">[docs]</a><span class="k">def</span> <span class="nf">column_order</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">first_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sort DataFrame columns so that they start with the order of ``first_cols``, followed by those not included. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">first_cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">first_cols</span> <span class="o">=</span> <span class="n">STANDARD_COLUMN_ORDER</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">remaining</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">first_cols</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
        <span class="c1"># Problem: string sort orders staff_1 staff_10 staff_11 ... and only then staff_2</span>
        <span class="n">remaining</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span>
    <span class="n">column_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">first_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span> <span class="o">+</span> <span class="n">remaining</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">column_order</span><span class="p">]</span></div>


<div class="viewcode-block" id="sort_note_list"><a class="viewcode-back" href="../../reference.html#ms3.utils.sort_note_list">[docs]</a><span class="k">def</span> <span class="nf">sort_note_list</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">mc_col</span><span class="o">=</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="n">mc_onset_col</span><span class="o">=</span><span class="s1">&#39;mc_onset&#39;</span><span class="p">,</span> <span class="n">midi_col</span><span class="o">=</span><span class="s1">&#39;midi&#39;</span><span class="p">,</span> <span class="n">duration_col</span><span class="o">=</span><span class="s1">&#39;duration&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Sort every measure (MC) by [&#39;mc_onset&#39;, &#39;midi&#39;, &#39;duration&#39;] while leaving gracenotes&#39; order (duration=0) intact.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df</span>
<span class="sd">    mc_col</span>
<span class="sd">    mc_onset_col</span>
<span class="sd">    midi_col</span>
<span class="sd">    duration_col</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">is_grace</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">duration_col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">grace_ix</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="n">is_grace</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">mc_col</span><span class="p">,</span> <span class="n">mc_onset_col</span><span class="p">])</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">has_nan</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">midi_col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">has_nan</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="c1"># Setting values in-place is fine, ignore the warning in Pandas &gt;= 1.5.0</span>
            <span class="c1"># This can be removed, if Pandas 1.5.0 does not need to be supported any longer.</span>
            <span class="c1"># See also: https://stackoverflow.com/q/74057367/859591</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
                <span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
                <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                    <span class="s2">&quot;.*will attempt to set the values inplace instead of always setting a new array. &quot;</span>
                    <span class="s2">&quot;To retain the old behavior, use either.*&quot;</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">midi_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">midi_col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">normal_ix</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">is_grace</span><span class="p">,</span> <span class="p">[</span><span class="n">mc_col</span><span class="p">,</span> <span class="n">mc_onset_col</span><span class="p">,</span> <span class="n">midi_col</span><span class="p">,</span> <span class="n">duration_col</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">mc_col</span><span class="p">,</span> <span class="n">mc_onset_col</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">gr</span><span class="p">:</span> <span class="n">gr</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">((</span><span class="n">gr</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">gr</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]))]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
    <span class="n">sorted_ixs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">grace_ix</span><span class="p">[</span><span class="n">onset</span><span class="p">],</span> <span class="n">ix</span><span class="p">))</span> <span class="k">if</span> <span class="n">onset</span> <span class="ow">in</span> <span class="n">grace_ix</span> <span class="k">else</span> <span class="n">ix</span> <span class="k">for</span> <span class="n">onset</span><span class="p">,</span> <span class="n">ix</span> <span class="ow">in</span>
                  <span class="n">normal_ix</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sorted_ixs</span><span class="p">))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">has_nan</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="c1"># Setting values in-place is fine, ignore the warning in Pandas &gt;= 1.5.0</span>
            <span class="c1"># This can be removed, if Pandas 1.5.0 does not need to be supported any longer.</span>
            <span class="c1"># See also: https://stackoverflow.com/q/74057367/859591</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
                <span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
                <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                    <span class="s2">&quot;.*will attempt to set the values inplace instead of always setting a new array. &quot;</span>
                    <span class="s2">&quot;To retain the old behavior, use either.*&quot;</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">midi_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">midi_col</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="mi">1000</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">})</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;Int64&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="sort_tpcs"><a class="viewcode-back" href="../../reference.html#ms3.utils.sort_tpcs">[docs]</a><span class="k">def</span> <span class="nf">sort_tpcs</span><span class="p">(</span><span class="n">tpcs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Sort tonal pitch classes by order on the piano.</span>
<span class="sd">        Uses: fifths2pc()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tpcs : collection of :obj:`int`</span>
<span class="sd">        Tonal pitch classes to sort.</span>
<span class="sd">    ascending : :obj:`bool`, optional</span>
<span class="sd">        Pass False to sort by descending order.</span>
<span class="sd">    start : :obj:`int`, optional</span>
<span class="sd">        Start on or above this TPC.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tpcs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">fifths2pc</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="o">-</span><span class="n">x</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">fifths2pc</span><span class="p">(</span><span class="n">tpc</span><span class="p">)</span> <span class="k">for</span> <span class="n">tpc</span> <span class="ow">in</span> <span class="n">res</span><span class="p">]</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">fifths2pc</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pcs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">pcs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span> <span class="o">+</span> <span class="n">res</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">res</span> <span class="k">if</span> <span class="n">ascending</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">res</span><span class="p">))</span></div>


<div class="viewcode-block" id="split_alternatives"><a class="viewcode-back" href="../../reference.html#ms3.utils.split_alternatives">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">split_alternatives</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;-(?!(\d|b+\d|\#+\d))&quot;</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alternatives_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Splits labels that come with an alternative separated by &#39;-&#39; and adds</span>
<span class="sd">    a new column. Only one alternative is taken into account. `df` is</span>
<span class="sd">    mutated inplace.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        Dataframe where one column contains DCML chord labels.</span>
<span class="sd">    column : :obj:`str`, optional</span>
<span class="sd">        Name of the column that holds the harmony labels.</span>
<span class="sd">    regex : :obj:`str`, optional</span>
<span class="sd">        The regular expression (or simple string) that detects the character combination used to separate alternative annotations.</span>
<span class="sd">        By default, alternatives are separated by a &#39;-&#39; that does not precede a scale degree such as &#39;b6&#39; or &#39;3&#39;.</span>
<span class="sd">    max : :obj:`int`, optional</span>
<span class="sd">        Maximum number of admitted alternatives, defaults to 2.</span>
<span class="sd">    inplace : :obj:`bool`, optional</span>
<span class="sd">        Pass True if you want to mutate ``df``.</span>
<span class="sd">    alternatives_only : :obj:`bool`, optional</span>
<span class="sd">        By default the alternatives are added to the original DataFrame (``inplace`` or not).</span>
<span class="sd">        Pass True if you just need the split alternatives.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; import pandas as pd</span>
<span class="sd">    &gt;&gt;&gt; labels = pd.read_csv(&#39;labels.csv&#39;)</span>
<span class="sd">    &gt;&gt;&gt; split_alternatives(labels, inplace=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">alternatives</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">alternatives</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">alternatives</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">alternatives</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">alternatives_only</span><span class="p">:</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;alt_</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;alt</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">alternatives</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">alternatives</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span>
        <span class="k">return</span> <span class="n">alternatives</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="nb">max</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternatives</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Labels split into alternatives.&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">alternatives</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">alternatives</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">max</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">alt_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;alt_</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;alt</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">alt_name</span><span class="p">,</span> <span class="n">alternatives</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">))</span>  <span class="c1"># replace None by NA</span>
            <span class="n">position</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternatives</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;More than </span><span class="si">{</span><span class="nb">max</span><span class="si">}</span><span class="s2"> alternatives are not taken into account:</span><span class="se">\n</span><span class="si">{</span><span class="n">alternatives</span><span class="p">[</span><span class="n">alternatives</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Contains no alternative labels.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="split_note_name"><a class="viewcode-back" href="../../reference.html#ms3.utils.split_note_name">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">split_note_name</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Splits a note name such as &#39;Ab&#39; into accidentals and name.</span>

<span class="sd">    nn : :obj:`str`</span>
<span class="sd">        Note name.</span>
<span class="sd">    count : :obj:`bool`, optional</span>
<span class="sd">        Pass True to get the accidentals as integer rather than as string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^([A-G]|[a-g])(#*|b*)$&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nn</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">nn</span> <span class="o">+</span> <span class="s2">&quot; is not a valid scale degree.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">note_name</span><span class="p">,</span> <span class="n">accidentals</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
        <span class="n">accidentals</span> <span class="o">=</span> <span class="n">accidentals</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">accidentals</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">accidentals</span><span class="p">,</span> <span class="n">note_name</span></div>


<div class="viewcode-block" id="split_scale_degree"><a class="viewcode-back" href="../../reference.html#ms3.utils.split_scale_degree">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">split_scale_degree</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Splits a scale degree such as &#39;bbVI&#39; or &#39;b6&#39; into accidentals and numeral.</span>

<span class="sd">    sd : :obj:`str`</span>
<span class="sd">        Scale degree.</span>
<span class="sd">    count : :obj:`bool`, optional</span>
<span class="sd">        Pass True to get the accidentals as integer rather than as string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(#*|b*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i|\d)$&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sd</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">sd</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sd</span><span class="si">}</span><span class="s2"> needs to be resolved, which requires information about the mode of the local key. &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;You can use ms3.utils.resolve_relative_keys(scale_degree, is_minor_context).&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sd</span><span class="si">}</span><span class="s2"> is not a valid scale degree.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">acc</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="n">acc</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">acc</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">acc</span><span class="p">,</span> <span class="n">num</span></div>


<span class="c1"># def chunkstring(string, length=80):</span>
<span class="c1">#     &quot;&quot;&quot; Generate chunks of a given length &quot;&quot;&quot;</span>
<span class="c1">#     string = str(string)</span>
<span class="c1">#     return (string[0 + i:length + i] for i in range(0, len(string), length))</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># def string2lines(string, length=80):</span>
<span class="c1">#     &quot;&quot;&quot; Use chunkstring() and make chunks into lines. &quot;&quot;&quot;</span>
<span class="c1">#     return &#39;\n&#39;.join(chunkstring(string, length))</span>


<span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">test_binary</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">command</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">command</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found MuseScore binary: </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span>
    <span class="k">if</span> <span class="n">which</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MuseScore binary not found and not an installed command: </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found MuseScore command: </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span>


<div class="viewcode-block" id="transform"><a class="viewcode-back" href="../../reference.html#ms3.utils.transform">[docs]</a><span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">param2col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">column_wise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Compute a function for every row of a DataFrame, using several cols as arguments.</span>
<span class="sd">        The result is the same as using df.apply(lambda r: func(param1=r.col1, param2=r.col2...), axis=1)</span>
<span class="sd">        but it optimizes the procedure by precomputing `func` for all occurrent parameter combinations.</span>
<span class="sd">        Uses: inspect.getfullargspec()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame` or :obj:`pandas.Series`</span>
<span class="sd">        Dataframe containing function parameters.</span>
<span class="sd">    func : :obj:`callable`</span>
<span class="sd">        The result of this function for every row will be returned.</span>
<span class="sd">    param2col : :obj:`dict` or :obj:`list`, optional</span>
<span class="sd">        Mapping from parameter names of `func` to column names.</span>
<span class="sd">        If you pass a list of column names, the columns&#39; values are passed as positional arguments.</span>
<span class="sd">        Pass None if you want to use all columns as positional arguments.</span>
<span class="sd">    column_wise : :obj:`bool`, optional</span>
<span class="sd">        Pass True if you want to map ``func`` to the elements of every column separately.</span>
<span class="sd">        This is simply an optimized version of df.apply(func) but allows for naming</span>
<span class="sd">        columns to use as function arguments. If param2col is None, ``func`` is mapped</span>
<span class="sd">        to the elements of all columns, otherwise to all columns that are not named</span>
<span class="sd">        as parameters in ``param2col``.</span>
<span class="sd">        In the case where ``func`` does not require a positional first element and</span>
<span class="sd">        you want to pass the elements of the various columns as keyword argument,</span>
<span class="sd">        give it as param2col={&#39;function_argument&#39;: None}</span>
<span class="sd">    inplace : :obj:`bool`, optional</span>
<span class="sd">        Pass True if you want to mutate ``df`` rather than getting an altered copy.</span>
<span class="sd">    **kwargs : Other parameters passed to ``func``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">column_wise</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param2col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">func</span><span class="p">,),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">param2col</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="n">var_arg</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">param2col</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
                <span class="n">apply_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">param2col</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="n">var_arg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Name only one variable keyword argument as which </span><span class="si">{</span><span class="n">apply_cols</span><span class="si">}</span><span class="s2"> are used </span><span class="si">{</span><span class="s1">&#39;argument&#39;</span><span class="si">:</span><span class="s2"> None</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="n">var_arg</span> <span class="o">=</span> <span class="n">var_arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_arg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">getfullargspec</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">param2col</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">param2col</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
                <span class="n">result_cols</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="nb">dict</span><span class="p">({</span><span class="n">var_arg</span><span class="p">:</span> <span class="n">col</span><span class="p">},</span> <span class="o">**</span><span class="n">param2col</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span>
                               <span class="n">apply_cols</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">apply_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">param2col</span><span class="p">]</span>
                <span class="n">result_cols</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">+</span> <span class="n">param2col</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">apply_cols</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result_cols</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">param2col</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">param_tuples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">param2col</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
        <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">param2col</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">t</span><span class="p">)},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">param_tuples</span><span class="p">)}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param2col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;When &#39;df&#39; is a Series, the parameter &#39;param2col&#39; has no use.&quot;</span><span class="p">)</span>
            <span class="n">param_tuples</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span>
            <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">param_tuples</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param2col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">param_tuples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">param_tuples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">param2col</span><span class="p">)]</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
            <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">param_tuples</span><span class="p">)}</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="c1"># pandas developers doing their most annoying thing &gt;:(</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
            <span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;.*The default dtype for empty Series.*&quot;</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">result_dict</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">param_tuples</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="adjacency_groups"><a class="viewcode-back" href="../../reference.html#ms3.utils.adjacency_groups">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">adjacency_groups</span><span class="p">(</span><span class="n">S</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
                     <span class="n">na_values</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span>
                     <span class="n">prevent_merge</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Turns a Series into a Series of ascending integers starting from 1 that reflect groups of successive</span>
<span class="sd">    equal values. There are several options of how to deal with NA values.</span>

<span class="sd">    Args:</span>
<span class="sd">      S: Series in which to group identical adjacent values with each other.</span>
<span class="sd">      na_values:</span>
<span class="sd">          | &#39;group&#39; creates individual groups for NA values (default).</span>
<span class="sd">          | &#39;backfill&#39; or &#39;bfill&#39; groups NA values with the subsequent group</span>
<span class="sd">          | &#39;pad&#39;, &#39;ffill&#39; groups NA values with the preceding group</span>
<span class="sd">          | Any other string works like &#39;group&#39;, with the difference that the groups will be named with this value.</span>
<span class="sd">          | Passing None means NA values &amp; ranges are being ignored, i.e. they will also be present in the output and the</span>
<span class="sd">            subsequent value will be based on the preceding value.</span>
<span class="sd">      prevent_merge:</span>
<span class="sd">          By default, if you use the `na_values` argument to fill NA values, they might lead to two groups merging.</span>
<span class="sd">          Pass True to prevent this. For example, take the sequence [&#39;a&#39;, NA, &#39;a&#39;] with ``na_values=&#39;ffill&#39;``: By default,</span>
<span class="sd">          it will be merged to one single group ``[1, 1, 1], {1: &#39;a&#39;}``. However, passing ``prevent_merge=True`` will</span>
<span class="sd">          result in ``[1, 1, 2], {1: &#39;a&#39;, 2: &#39;a&#39;}``.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A series with increasing integers that can be used for grouping.</span>
<span class="sd">      A dictionary mapping the integers to the grouped values.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reindex_flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># reindex is set to True in cases where NA values are being excluded from the operation and restored afterwards</span>
    <span class="k">if</span> <span class="n">prevent_merge</span><span class="p">:</span>
        <span class="n">forced_beginnings</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">S</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">na_values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">reindex_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">S</span>
    <span class="k">elif</span> <span class="n">na_values</span> <span class="o">==</span> <span class="s1">&#39;group&#39;</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">S</span>
    <span class="k">elif</span> <span class="n">na_values</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;backfill&#39;</span><span class="p">,</span> <span class="s1">&#39;bfill&#39;</span><span class="p">,</span> <span class="s1">&#39;pad&#39;</span><span class="p">,</span> <span class="s1">&#39;ffill&#39;</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">na_values</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">na_values</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">na_values</span> <span class="o">==</span> <span class="s1">&#39;group&#39;</span><span class="p">:</span>
            <span class="n">shifted</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">shifted</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">beginnings</span> <span class="o">=</span> <span class="o">~</span><span class="n">nan_eq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">shifted</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After treating the Series &#39;</span><span class="si">{</span><span class="n">S</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; with na_values=&#39;</span><span class="si">{</span><span class="n">na_values</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;there were still </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> NA values left.&quot;</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">beginnings</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="n">s</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">beginnings</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">reindex_flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">beginnings</span> <span class="o">=</span> <span class="n">s</span> <span class="o">!=</span> <span class="n">s</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span>
        <span class="n">beginnings</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">prevent_merge</span><span class="p">:</span>
        <span class="n">beginnings</span> <span class="o">|=</span> <span class="n">forced_beginnings</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">beginnings</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">names</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">beginnings</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">reindex_flag</span><span class="p">:</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;Int64&#39;</span><span class="p">),</span> <span class="n">names</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Erroneous outcome while computing adjacency groups: </span><span class="si">{</span><span class="n">groups</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">groups</span><span class="p">,</span> <span class="n">names</span></div>

<div class="viewcode-block" id="unfold_measures_table"><a class="viewcode-back" href="../../reference.html#ms3.utils.unfold_measures_table">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">unfold_measures_table</span><span class="p">(</span><span class="n">measures</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Returns a copy of a measures table that corresponds through a succession of MCs when playing all repeats.</span>
<span class="sd">    To distinguish between repeated MCs and MNs, it adds the continues column &#39;mc_playthrough&#39; (starting at 1) and</span>
<span class="sd">    &#39;mn_playthrough&#39; which contains the values of &#39;mn&#39; as string with letters {&#39;a&#39;, &#39;b&#39;, ...} appended.</span>

<span class="sd">    Args:</span>
<span class="sd">      measures: Measures table with columns [&#39;mc&#39;, &#39;next&#39;, &#39;dont_count&#39;]</span>

<span class="sd">    Returns:</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;mc_playthrough&#39;</span> <span class="ow">in</span> <span class="n">measures</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received a dataframe with the column &#39;mc_playthrough&#39; that is already unfolded. Returning as is.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">measures</span>
    <span class="n">playthrough2mc</span> <span class="o">=</span> <span class="n">make_playthrough2mc</span><span class="p">(</span><span class="n">measures</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">playthrough2mc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">playthrough2mc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in the repeat structure: Did not reach the stopping value -1 in measures.next:</span><span class="se">\n</span><span class="si">{</span><span class="n">measures</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;mc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Repeat structure successfully unfolded.&quot;</span><span class="p">)</span>
    <span class="n">unfolded_measures</span> <span class="o">=</span> <span class="n">unfold_repeats</span><span class="p">(</span><span class="n">measures</span><span class="p">,</span> <span class="n">playthrough2mc</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mn_playthrough_col</span> <span class="o">=</span> <span class="n">compute_mn_playthrough</span><span class="p">(</span><span class="n">unfolded_measures</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">insert_position</span> <span class="o">=</span> <span class="n">unfolded_measures</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;mc_playthrough&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">unfolded_measures</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">insert_position</span><span class="p">,</span> <span class="s1">&#39;mn_playthrough&#39;</span><span class="p">,</span> <span class="n">mn_playthrough_col</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding the column &#39;mn_playthrough&#39; to the unfolded measures table failed with:</span><span class="se">\n</span><span class="s2">&#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Measures successfully unfolded.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">unfolded_measures</span></div>


<div class="viewcode-block" id="unfold_repeats"><a class="viewcode-back" href="../../reference.html#ms3.utils.unfold_repeats">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">unfold_repeats</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                   <span class="n">playthrough_info</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Use a succesion of MCs to bring a DataFrame in this succession. MCs may repeat.</span>

<span class="sd">    Args:</span>
<span class="sd">      df: DataFrame needs to have the columns &#39;mc&#39;. If &#39;mn&#39; is present, the column &#39;mn&#39; will be added, too.</span>
<span class="sd">      playthrough2mc:</span>
<span class="sd">          A Series of the format ``{mc_playthrough: mc}`` where ``mc_playthrough`` corresponds</span>
<span class="sd">          to continuous MC</span>

<span class="sd">    Returns:</span>
<span class="sd">      A copy of the dataframe with the columns &#39;mc_playthrough&#39; and &#39;mn_playthrough&#39; (if &#39;mn&#39; is present) inserted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_occurrences</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="n">result_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;mc&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">playthrough_info</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">playthrough2mc</span> <span class="o">=</span> <span class="n">playthrough_info</span><span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">]</span>
        <span class="n">playthrough2mn</span> <span class="o">=</span> <span class="n">playthrough_info</span><span class="p">[</span><span class="s1">&#39;mn_playthrough&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">playthrough2mc</span> <span class="o">=</span> <span class="n">playthrough_info</span>
        <span class="n">playthrough2mn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">playthrough2mc</span> <span class="o">=</span> <span class="n">playthrough2mc</span><span class="p">[</span><span class="n">playthrough2mc</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">result_df</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
    <span class="n">mc_playthrough_col</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="nb">sum</span><span class="p">([[</span><span class="n">playthrough</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_occurrences</span><span class="p">[</span><span class="n">mc</span><span class="p">]</span> <span class="k">for</span> <span class="n">playthrough</span><span class="p">,</span> <span class="n">mc</span> <span class="ow">in</span> <span class="n">playthrough2mc</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span> <span class="p">[]))</span>
    <span class="n">result_df</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">playthrough2mc</span><span class="o">.</span><span class="n">values</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;mn&#39;</span> <span class="ow">in</span> <span class="n">result_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">column_position</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;mn&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">playthrough2mn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mn_playthrough_col</span> <span class="o">=</span> <span class="n">mc_playthrough_col</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">playthrough2mn</span><span class="p">)</span>
            <span class="n">result_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">column_position</span><span class="p">,</span> <span class="s1">&#39;mn_playthrough&#39;</span><span class="p">,</span> <span class="n">mn_playthrough_col</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">column_position</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;mc&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">result_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">column_position</span><span class="p">,</span> <span class="s1">&#39;mc_playthrough&#39;</span><span class="p">,</span> <span class="n">mc_playthrough_col</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result_df</span></div>


<span class="nd">@contextmanager</span>
<span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">unpack_mscz</span><span class="p">(</span><span class="n">mscz</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">tmp_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">mscz</span><span class="p">)</span>
    <span class="n">tmp_file</span> <span class="o">=</span> <span class="n">Temp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.mscx&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">Zip</span><span class="p">(</span><span class="n">mscz</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_file</span><span class="p">:</span>
        <span class="n">mscx_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">zip_file</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.mscx&#39;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mscx_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mscz</span><span class="si">}</span><span class="s2"> contains several MSCX files. Picking the first one&quot;</span><span class="p">)</span>
        <span class="n">mscx</span> <span class="o">=</span> <span class="n">mscx_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">zip_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mscx</span><span class="p">)</span> <span class="k">as</span> <span class="n">mscx_file</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">tmp_file</span> <span class="k">as</span> <span class="n">tmp</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">mscx_file</span><span class="p">:</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">tmp_file</span><span class="o">.</span><span class="n">name</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while dealing with the temporarily unpacked </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">mscz</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmp_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="capture_parse_logs"><a class="viewcode-back" href="../../reference.html#ms3.utils.capture_parse_logs">[docs]</a><span class="nd">@contextmanager</span>
<span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">capture_parse_logs</span><span class="p">(</span><span class="n">logger_object</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">,</span>
                       <span class="n">level</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LogCapturer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Within the context, the given logger will have an additional handler that captures all messages with level</span>
<span class="sd">    ``level`` or higher. At the end of the context, retrieve the message list via LocCapturer.content_list.</span>

<span class="sd">    Example:</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            with capture_parse_logs(logger, level=&#39;d&#39;) as capturer:</span>
<span class="sd">                # do the stuff of which you want to capture</span>
<span class="sd">                all_messages = capturer.content_list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">captured_warnings</span> <span class="o">=</span> <span class="n">LogCapturer</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">)</span>
    <span class="n">logger_object</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">captured_warnings</span><span class="o">.</span><span class="n">log_handler</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">captured_warnings</span>
    <span class="n">logger_object</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">captured_warnings</span><span class="o">.</span><span class="n">log_handler</span><span class="p">)</span></div>



<span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">update_labels_cfg</span><span class="p">(</span><span class="n">labels_cfg</span><span class="p">):</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;staff&#39;</span><span class="p">,</span> <span class="s1">&#39;voice&#39;</span><span class="p">,</span> <span class="s1">&#39;harmony_layer&#39;</span><span class="p">,</span> <span class="s1">&#39;positioning&#39;</span><span class="p">,</span> <span class="s1">&#39;decode&#39;</span><span class="p">,</span> <span class="s1">&#39;column_name&#39;</span><span class="p">,</span> <span class="s1">&#39;color_format&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;logger&#39;</span> <span class="ow">in</span> <span class="n">labels_cfg</span><span class="p">:</span>
        <span class="k">del</span><span class="p">(</span><span class="n">labels_cfg</span><span class="p">[</span><span class="s1">&#39;logger&#39;</span><span class="p">])</span>
    <span class="n">updated</span><span class="p">,</span> <span class="n">incorrect</span> <span class="o">=</span> <span class="n">update_cfg</span><span class="p">(</span><span class="n">cfg_dict</span><span class="o">=</span><span class="n">labels_cfg</span><span class="p">,</span> <span class="n">admitted_keys</span><span class="o">=</span><span class="n">keys</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">incorrect</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">last_5</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">stack</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">function</span><span class="si">}</span><span class="s2">()&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">plural</span> <span class="o">=</span> <span class="s1">&#39;These options are&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">incorrect</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;This option is&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">plural</span><span class="si">}</span><span class="s2"> not valid to configure labels: </span><span class="si">{</span><span class="n">incorrect</span><span class="si">}</span><span class="se">\n</span><span class="s2">Last 5 function calls leading here: </span><span class="si">{</span><span class="n">last_5</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">updated</span>


<div class="viewcode-block" id="write_metadata"><a class="viewcode-back" href="../../reference.html#ms3.utils.write_metadata">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">write_metadata</span><span class="p">(</span><span class="n">metadata_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                   <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                   <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write the DataFrame ``metadata_df`` to ``path``, updating an existing file rather than overwriting it.</span>

<span class="sd">    Args:</span>
<span class="sd">      metadata_df:</span>
<span class="sd">          DataFrame with one row per piece and an index of strings identifying pieces. The index is used for</span>
<span class="sd">          updating a potentially pre-existent file, from which the first column ∈ (&#39;fname&#39;, &#39;fnames&#39;, &#39;name&#39;, &#39;names&#39;)</span>
<span class="sd">          will be used as index.</span>
<span class="sd">      path:</span>
<span class="sd">          If folder path, the filename &#39;metadata.tsv&#39; will be appended; file_path will be used as is but a</span>
<span class="sd">          warning is thrown if the extension is not .tsv</span>
<span class="sd">      index: Pass True if you want the first column of the output to be a RangeIndex starting from 0.</span>

<span class="sd">    Returns:</span>
<span class="sd">      True if the metadata were successfully written, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">metadata_df</span> <span class="o">=</span> <span class="n">metadata_df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">)</span>
    <span class="n">metadata_df</span> <span class="o">=</span> <span class="n">enforce_fname_index_for_metadata</span><span class="p">(</span><span class="n">metadata_df</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">resolve_dir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">tsv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;metadata.tsv&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tsv_path</span> <span class="o">=</span> <span class="n">path</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">fext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">tsv_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fext</span> <span class="o">!=</span> <span class="s1">&#39;.tsv&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The output format for metadata is Tab-Separated Values (.tsv) but the file extensions is </span><span class="si">{</span><span class="n">fext</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">tsv_path</span><span class="p">):</span>
        <span class="n">output_df</span> <span class="o">=</span> <span class="n">metadata_df</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Created&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Trying to load an existing &#39;metadata.tsv&#39; file to update existing rows</span>
        <span class="n">previous</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">tsv_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;string&#39;</span><span class="p">)</span>
        <span class="n">previous</span> <span class="o">=</span> <span class="n">enforce_fname_index_for_metadata</span><span class="p">(</span><span class="n">previous</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">what</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="n">previous</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">previous</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">metadata_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">metadata_df</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span>
                            <span class="p">(</span><span class="s1">&#39;index of the existing&#39;</span><span class="p">,</span> <span class="s1">&#39;columns of the existing&#39;</span><span class="p">,</span> <span class="s1">&#39;index of the updated&#39;</span><span class="p">,</span> <span class="s1">&#39;columns of the updated&#39;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ix</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span>
                <span class="n">duplicated</span> <span class="o">=</span> <span class="n">ix</span><span class="p">[</span><span class="n">ix</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">what</span><span class="si">}</span><span class="s2"> metadata contains duplicates and no metadata were written.</span><span class="se">\n</span><span class="s2">Duplicates: </span><span class="si">{</span><span class="n">duplicated</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="n">new_cols</span> <span class="o">=</span> <span class="n">metadata_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">previous</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">shared_cols</span> <span class="o">=</span> <span class="n">metadata_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">previous</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">new_rows</span> <span class="o">=</span> <span class="n">metadata_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">previous</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">previous</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">previous</span><span class="p">,</span> <span class="n">metadata_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_rows</span><span class="p">,</span> <span class="n">shared_cols</span><span class="p">]])</span>
        <span class="n">previous</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">previous</span><span class="p">,</span> <span class="n">metadata_df</span><span class="p">[</span><span class="n">new_cols</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">previous</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metadata_df</span><span class="p">)</span>
        <span class="n">legacy_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">LEGACY_COLUMNS</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">previous</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">legacy_columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">plural</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;s </span><span class="si">{</span><span class="n">legacy_columns</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">legacy_columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">legacy_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">previous</span> <span class="o">=</span> <span class="n">previous</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">legacy_columns</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dropped legacy column</span><span class="si">{</span><span class="n">plural</span><span class="si">}</span><span class="s2"> .&quot;</span><span class="p">)</span>
        <span class="n">output_df</span> <span class="o">=</span> <span class="n">previous</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Updated&#39;</span>
    <span class="n">output_df</span> <span class="o">=</span> <span class="n">prepare_metadata_for_writing</span><span class="p">(</span><span class="n">output_df</span><span class="p">)</span>
    <span class="n">output_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">tsv_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">tsv_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="enforce_fname_index_for_metadata"><a class="viewcode-back" href="../../reference.html#ms3.utils.enforce_fname_index_for_metadata">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">enforce_fname_index_for_metadata</span><span class="p">(</span><span class="n">metadata_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a copy of the DataFrame that has an index level called &#39;fname&#39;.&quot;&quot;&quot;</span>
    <span class="n">possible_column_names</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;fname&#39;</span><span class="p">,</span> <span class="s1">&#39;fnames&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;names&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="n">metadata_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">possible_column_names</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">metadata_df</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fname_col</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">possible_column_names</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metadata_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Metadata is expected to come with a column or index level called &#39;fname&#39; or (previously) &#39;fnames&#39;.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fname_col</span> <span class="o">!=</span> <span class="s1">&#39;fname&#39;</span><span class="p">:</span>
        <span class="n">metadata_df</span> <span class="o">=</span> <span class="n">metadata_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">fname_col</span><span class="p">:</span> <span class="s1">&#39;fname&#39;</span><span class="p">})</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Renamed column &#39;</span><span class="si">{</span><span class="n">fname_col</span><span class="si">}</span><span class="s2">&#39; -&gt; &#39;fname&#39;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metadata_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;fname&#39;</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="n">append</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_markdown"><a class="viewcode-back" href="../../reference.html#ms3.utils.write_markdown">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">write_markdown</span><span class="p">(</span><span class="n">metadata_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a subset of the DataFrame ``metadata_df`` to ``path`` in markdown format. If the file exists, it will be</span>
<span class="sd">    scanned for a line containing the string &#39;# Overview&#39; and overwritten from that line onwards.</span>

<span class="sd">    Args:</span>
<span class="sd">      metadata_df: DataFrame containing metadata.</span>
<span class="sd">      file_path: Path of the markdown file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rename4markdown</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;fname&#39;</span><span class="p">:</span> <span class="s1">&#39;file_name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;last_mn&#39;</span><span class="p">:</span> <span class="s1">&#39;measures&#39;</span><span class="p">,</span>
        <span class="s1">&#39;label_count&#39;</span><span class="p">:</span> <span class="s1">&#39;labels&#39;</span><span class="p">,</span>
        <span class="s1">&#39;harmony_version&#39;</span><span class="p">:</span> <span class="s1">&#39;standard&#39;</span><span class="p">,</span>
        <span class="s1">&#39;annotators&#39;</span><span class="p">:</span> <span class="s1">&#39;annotators&#39;</span><span class="p">,</span>
        <span class="s1">&#39;reviewers&#39;</span><span class="p">:</span> <span class="s1">&#39;reviewers&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">rename4markdown</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rename4markdown</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">metadata_df</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>
    <span class="n">drop_index</span> <span class="o">=</span> <span class="s1">&#39;fnames&#39;</span> <span class="ow">in</span> <span class="n">metadata_df</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">md</span> <span class="o">=</span> <span class="n">metadata_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="n">drop_index</span><span class="p">)[</span><span class="nb">list</span><span class="p">(</span><span class="n">rename4markdown</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">md</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">rename4markdown</span><span class="p">)</span>
    <span class="n">md_table</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">df2md</span><span class="p">(</span><span class="n">md</span><span class="p">))</span>
    <span class="n">md_table</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">*Overview table updated using [ms3](https://johentsch.github.io/ms3/) </span><span class="si">{</span><span class="n">MS3_VERSION</span><span class="si">}</span><span class="s2">.*</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Updated&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Created&#39;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># in case the README.md exists, everything from the line including &#39;# Overview&#39; (or last line otherwise) is overwritten</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;# Overview&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">md_table</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">prepare_metadata_for_writing</span><span class="p">(</span><span class="n">metadata_df</span><span class="p">):</span>
    <span class="c1"># convert_to_str = {c: &#39;string&#39; for c in (&#39;length_qb&#39;, &#39;length_qb_unfolded&#39;, &#39;all_notes_qb&#39;) if c in metadata_df}</span>
    <span class="c1"># if len(convert_to_str) &gt; 0:</span>
    <span class="c1">#     metadata_df = metadata_df.astype(convert_to_str, errors=&#39;ignore&#39;)</span>
    <span class="n">metadata_df</span> <span class="o">=</span> <span class="n">metadata_df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
    <span class="n">metadata_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">metadata_df</span> <span class="o">=</span> <span class="n">column_order</span><span class="p">(</span><span class="n">metadata_df</span><span class="p">,</span> <span class="n">METADATA_COLUMN_ORDER</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># on Windows, make sure the paths are written with / separators</span>
    <span class="n">path_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;subdir&#39;</span><span class="p">,</span> <span class="s1">&#39;rel_path&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metadata_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">path_cols</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="c1"># Setting values in-place is fine, ignore the warning in Pandas &gt;= 1.5.0</span>
            <span class="c1"># This can be removed, if Pandas 1.5.0 does not need to be supported any longer.</span>
            <span class="c1"># See also: https://stackoverflow.com/q/74057367/859591</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
                <span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
                <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                    <span class="s2">&quot;.*will attempt to set the values inplace instead of always setting a new array. &quot;</span>
                    <span class="s2">&quot;To retain the old behavior, use either.*&quot;</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">metadata_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="n">staff_cols</span><span class="p">,</span> <span class="n">other_cols</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">metadata_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^staff_(\d+)&quot;</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
            <span class="n">staff_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">other_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="n">staff_cols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">staff_cols</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^staff_(\d+)&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">metadata_df</span> <span class="o">=</span> <span class="n">metadata_df</span><span class="p">[</span><span class="n">other_cols</span> <span class="o">+</span> <span class="n">staff_cols</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metadata_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">RangeIndex</span><span class="p">):</span>
        <span class="n">metadata_df</span> <span class="o">=</span> <span class="n">metadata_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">metadata_df</span>


<div class="viewcode-block" id="write_tsv"><a class="viewcode-back" href="../../reference.html#ms3.utils.write_tsv">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">write_tsv</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">pre_process</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Write a DataFrame to a TSV or CSV file based on the extension of &#39;file_path&#39;.</span>
<span class="sd">    Uses: :py:func:`no_collections_no_booleans`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        DataFrame to write.</span>
<span class="sd">    file_path : :obj:`str`</span>
<span class="sd">        File to create or overwrite. If the extension is .tsv, the argument &#39;sep&#39; will be set to &#39;\t&#39;, otherwise the</span>
<span class="sd">        extension is expected to be .csv and the default separator &#39;,&#39; will be used.</span>
<span class="sd">    pre_process : :obj:`bool`, optional</span>
<span class="sd">        By default, DataFrame cells containing lists and tuples will be transformed to strings and Booleans will be</span>
<span class="sd">        converted to 0 and 1 (otherwise they will be written out as True and False). Pass False to prevent.</span>
<span class="sd">    kwargs :</span>
<span class="sd">        Additional keyword arguments will be passed on to :py:meth:`pandas.DataFrame.to_csv`.</span>
<span class="sd">        Defaults arguments are ``index=False`` and ``sep=&#39;\t&#39;`` (assuming extension &#39;.tsv&#39;, see above).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span><span class="p">,</span> <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">resolve_dir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="n">fname</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;.tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;.csv&#39;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;This function expects file_path to include the file name ending on .csv or .tsv, not &#39;</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;.tsv&#39;</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="s1">&#39;index&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">pre_process</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">no_collections_no_booleans</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2"> written with parameters </span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="abs2rel_key"><a class="viewcode-back" href="../../reference.html#ms3.utils.abs2rel_key">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">abs2rel_key</span><span class="p">(</span><span class="n">absolute</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">localkey</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">global_minor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Expresses a Roman numeral as scale degree relative to a given localkey.</span>
<span class="sd">    The result changes depending on whether Roman numeral and localkey are</span>
<span class="sd">    interpreted within a global major or minor key.</span>

<span class="sd">    Uses: :py:func:`split_scale_degree`</span>


<span class="sd">    Args:</span>
<span class="sd">      absolute: Absolute key expressed as Roman scale degree of the local key.</span>
<span class="sd">      localkey: The local key in terms of which ``absolute`` will be expressed.</span>
<span class="sd">      global_minor: Has to be set to True if `absolute` and `localkey` are scale degrees of a global minor key.</span>

<span class="sd">    Examples:</span>
<span class="sd">      In a minor context, the key of II would appear within the key of vii as #III.</span>

<span class="sd">          &gt;&gt;&gt; abs2rel_key(&#39;iv&#39;, &#39;VI&#39;, global_minor=False)</span>
<span class="sd">          &#39;bvi&#39;       # F minor expressed with respect to A major</span>
<span class="sd">          &gt;&gt;&gt; abs2rel_key(&#39;iv&#39;, &#39;vi&#39;, global_minor=False)</span>
<span class="sd">          &#39;vi&#39;      # F minor expressed with respect to A minor</span>
<span class="sd">          &gt;&gt;&gt; abs2rel_key(&#39;iv&#39;, &#39;VI&#39;, global_minor=True)</span>
<span class="sd">          &#39;vi&#39;      # F minor expressed with respect to Ab major</span>
<span class="sd">          &gt;&gt;&gt; abs2rel_key(&#39;iv&#39;, &#39;vi&#39;, global_minor=True)</span>
<span class="sd">          &#39;#vi&#39;       # F minor expressed with respect to Ab minor</span>

<span class="sd">          &gt;&gt;&gt; abs2rel_key(&#39;VI&#39;, &#39;IV&#39;, global_minor=False)</span>
<span class="sd">          &#39;III&#39;       # A major expressed with respect to F major</span>
<span class="sd">          &gt;&gt;&gt; abs2rel_key(&#39;VI&#39;, &#39;iv&#39;, global_minor=False)</span>
<span class="sd">          &#39;#III&#39;       # A major expressed with respect to F minor</span>
<span class="sd">          &gt;&gt;&gt; abs2rel_key(&#39;VI&#39;, &#39;IV&#39;, global_minor=True)</span>
<span class="sd">          &#39;bIII&#39;       # Ab major expressed with respect to F major</span>
<span class="sd">          &gt;&gt;&gt; abs2rel_key(&#39;VI&#39;, &#39;iv&#39;, global_minor=False)</span>
<span class="sd">          &#39;III&#39;       # Ab major expressed with respect to F minor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">absolute</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">localkey</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">absolute</span>
    <span class="n">absolute</span> <span class="o">=</span> <span class="n">resolve_relative_keys</span><span class="p">(</span><span class="n">absolute</span><span class="p">)</span>
    <span class="n">localkey</span> <span class="o">=</span> <span class="n">resolve_relative_keys</span><span class="p">(</span><span class="n">localkey</span><span class="p">)</span>
    <span class="n">maj_rn</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">]</span>
    <span class="n">min_rn</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;ii&#39;</span><span class="p">,</span> <span class="s1">&#39;iii&#39;</span><span class="p">,</span> <span class="s1">&#39;iv&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;vi&#39;</span><span class="p">,</span> <span class="s1">&#39;vii&#39;</span><span class="p">]</span>
    <span class="n">white_key_major_accidentals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
    <span class="n">abs_accidentals</span><span class="p">,</span> <span class="n">absolute</span> <span class="o">=</span> <span class="n">split_scale_degree</span><span class="p">(</span><span class="n">absolute</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">localkey_accidentals</span><span class="p">,</span> <span class="n">localkey</span> <span class="o">=</span> <span class="n">split_scale_degree</span><span class="p">(</span><span class="n">localkey</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">resulting_accidentals</span> <span class="o">=</span> <span class="n">abs_accidentals</span> <span class="o">-</span> <span class="n">localkey_accidentals</span>
    <span class="n">numerals</span> <span class="o">=</span> <span class="n">maj_rn</span> <span class="k">if</span> <span class="n">absolute</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="k">else</span> <span class="n">min_rn</span>
    <span class="n">localkey_index</span> <span class="o">=</span> <span class="n">maj_rn</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">localkey</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="n">result_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">numerals</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">absolute</span><span class="p">)</span> <span class="o">-</span> <span class="n">localkey_index</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span>
    <span class="n">result_numeral</span> <span class="o">=</span> <span class="n">numerals</span><span class="p">[</span><span class="n">result_index</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">localkey</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span> <span class="ow">and</span> <span class="n">result_index</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]:</span>
        <span class="n">resulting_accidentals</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">global_minor</span><span class="p">:</span>
        <span class="n">localkey_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">localkey_index</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span>
    <span class="n">resulting_accidentals</span> <span class="o">-=</span> <span class="n">white_key_major_accidentals</span><span class="p">[</span><span class="n">localkey_index</span><span class="p">][</span><span class="n">result_index</span><span class="p">]</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">resulting_accidentals</span> <span class="o">*</span> <span class="s1">&#39;#&#39;</span> <span class="k">if</span> <span class="n">resulting_accidentals</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="n">resulting_accidentals</span> <span class="o">*</span> <span class="s1">&#39;b&#39;</span>
    <span class="k">return</span> <span class="n">acc</span> <span class="o">+</span> <span class="n">result_numeral</span></div>


<div class="viewcode-block" id="rel2abs_key"><a class="viewcode-back" href="../../reference.html#ms3.utils.rel2abs_key">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">rel2abs_key</span><span class="p">(</span><span class="n">relative</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">localkey</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">global_minor</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Expresses a Roman numeral that is expressed relative to a localkey</span>
<span class="sd">    as scale degree of the global key. For local keys {III, iii, VI, vi, VII, vii}</span>
<span class="sd">    the result changes depending on whether the global key is major or minor.</span>

<span class="sd">    Uses: :py:func:`split_scale_degree`</span>


<span class="sd">    Args:</span>
<span class="sd">      relative: Relative key or chord expressed as Roman scale degree of the local key.</span>
<span class="sd">      localkey: The local key to which `rel` is relative.</span>
<span class="sd">      global_minor: Has to be set to True if `localkey` is a scale degree of a global minor key.</span>

<span class="sd">    Examples:</span>
<span class="sd">      If the label viio6/VI appears in the context of the local key VI or vi,</span>
<span class="sd">      the absolute key to which viio6 applies depends on the global key.</span>
<span class="sd">      The comments express the examples in relation to global C major or C minor.</span>

<span class="sd">          &gt;&gt;&gt; rel2abs_key(&#39;vi&#39;, &#39;VI&#39;, global_minor=False)</span>
<span class="sd">          &#39;#iv&#39;       # vi of A major = F# minor</span>
<span class="sd">          &gt;&gt;&gt; rel2abs_key(&#39;vi&#39;, &#39;vi&#39;, global_minor=False)</span>
<span class="sd">          &#39;iv&#39;      # vi of A minor = F minor</span>
<span class="sd">          &gt;&gt;&gt; rel2abs_key(&#39;vi&#39;, &#39;VI&#39;, global_minor=True)</span>
<span class="sd">          &#39;iv&#39;      # vi of Ab major = F minor</span>
<span class="sd">          &gt;&gt;&gt; rel2abs_key(&#39;vi&#39;, &#39;vi&#39;, global_minor=True)</span>
<span class="sd">          &#39;biv&#39;       # vi of Ab minor = Fb minor</span>

<span class="sd">      The same examples hold if you&#39;re expressing in terms of the global key</span>
<span class="sd">      the root of a VI-chord within the local keys VI or vi.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">relative</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">localkey</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">relative</span>
    <span class="n">relative</span> <span class="o">=</span> <span class="n">resolve_relative_keys</span><span class="p">(</span><span class="n">relative</span><span class="p">)</span>
    <span class="n">localkey</span> <span class="o">=</span> <span class="n">resolve_relative_keys</span><span class="p">(</span><span class="n">localkey</span><span class="p">)</span>
    <span class="n">maj_rn</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">]</span>
    <span class="n">min_rn</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;ii&#39;</span><span class="p">,</span> <span class="s1">&#39;iii&#39;</span><span class="p">,</span> <span class="s1">&#39;iv&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;vi&#39;</span><span class="p">,</span> <span class="s1">&#39;vii&#39;</span><span class="p">]</span>
    <span class="n">white_key_major_accidentals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                             <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
    <span class="n">relative_accidentals</span><span class="p">,</span> <span class="n">relative</span> <span class="o">=</span> <span class="n">split_scale_degree</span><span class="p">(</span><span class="n">relative</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">localkey_accidentals</span><span class="p">,</span> <span class="n">localkey</span> <span class="o">=</span> <span class="n">split_scale_degree</span><span class="p">(</span><span class="n">localkey</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">resulting_accidentals</span> <span class="o">=</span> <span class="n">relative_accidentals</span> <span class="o">+</span> <span class="n">localkey_accidentals</span>
    <span class="n">numerals</span> <span class="o">=</span> <span class="n">maj_rn</span> <span class="k">if</span> <span class="n">relative</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="k">else</span> <span class="n">min_rn</span>
    <span class="n">rel_num</span> <span class="o">=</span> <span class="n">numerals</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">relative</span><span class="p">)</span>
    <span class="n">localkey_index</span> <span class="o">=</span> <span class="n">maj_rn</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">localkey</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="n">result_numeral</span> <span class="o">=</span> <span class="n">numerals</span><span class="p">[(</span><span class="n">rel_num</span> <span class="o">+</span> <span class="n">localkey_index</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">localkey</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span> <span class="ow">and</span> <span class="n">rel_num</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]:</span>
        <span class="n">resulting_accidentals</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">global_minor</span><span class="p">:</span>
        <span class="n">localkey_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">localkey_index</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span>
    <span class="n">resulting_accidentals</span> <span class="o">+=</span> <span class="n">white_key_major_accidentals</span><span class="p">[</span><span class="n">rel_num</span><span class="p">][</span><span class="n">localkey_index</span><span class="p">]</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">resulting_accidentals</span> <span class="o">*</span> <span class="s1">&#39;#&#39;</span> <span class="k">if</span> <span class="n">resulting_accidentals</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="n">resulting_accidentals</span> <span class="o">*</span> <span class="s1">&#39;b&#39;</span>
    <span class="k">return</span> <span class="n">acc</span> <span class="o">+</span> <span class="n">result_numeral</span></div>


<div class="viewcode-block" id="make_interval_index_from_durations"><a class="viewcode-back" href="../../reference.html#ms3.utils.make_interval_index_from_durations">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">make_interval_index_from_durations</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">position_col</span><span class="o">=</span><span class="s1">&#39;quarterbeats&#39;</span><span class="p">,</span> <span class="n">duration_col</span><span class="o">=</span><span class="s1">&#39;duration_qb&#39;</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                               <span class="nb">round</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;interval&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given an annotations table with positions and durations, create an :obj:`pandas.IntervalIndex`.</span>
<span class="sd">    Returns None if any row is underspecified.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        Annotation table containing the columns of ``position_col`` (default: &#39;quarterbeats&#39;) and ``duration_col``</span>
<span class="sd">        default: &#39;duration_qb&#39;).</span>
<span class="sd">    position_col : :obj:`str`, optional</span>
<span class="sd">        Name of the column containing positions, used as left boundaries.</span>
<span class="sd">    duration_col : :obj:`str`, optional</span>
<span class="sd">        Name of the column containing durations which will be added to the positions to obtain right boundaries.</span>
<span class="sd">    closed : :obj:`str`, optional</span>
<span class="sd">        &#39;left&#39;, &#39;right&#39; or &#39;both&#39; &lt;- defining the interval boundaries</span>
<span class="sd">    round : :obj:`int`, optional</span>
<span class="sd">        To how many decimal places to round the intervals&#39; boundary values.</span>
<span class="sd">    name : :obj:`str`, optional</span>
<span class="sd">        Name of the created index. Defaults to &#39;interval&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.IntervalIndex`</span>
<span class="sd">        A copy of ``df`` with the original index replaced and underspecified rows removed (those where no interval</span>
<span class="sd">        could be coputed).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="n">position_col</span><span class="p">,</span> <span class="n">duration_col</span><span class="p">)):</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="n">position_col</span><span class="p">,</span> <span class="n">duration_col</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">plural</span> <span class="o">=</span> <span class="s1">&#39;s&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column</span><span class="si">{</span><span class="n">plural</span><span class="si">}</span><span class="s2"> not present in DataFrame: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">position_col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">df</span><span class="p">[</span><span class="n">duration_col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[[</span><span class="n">position_col</span><span class="p">,</span> <span class="n">duration_col</span><span class="p">]]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not make IntervalIndex because of missing values:</span><span class="se">\n</span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">position_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="n">duration_col</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">round</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">round</span><span class="p">),</span> <span class="n">right</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">round</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">IntervalIndex</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">right</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="n">closed</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating IntervalIndex failed with exception </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="replace_index_by_intervals"><a class="viewcode-back" href="../../reference.html#ms3.utils.replace_index_by_intervals">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">replace_index_by_intervals</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">position_col</span><span class="o">=</span><span class="s1">&#39;quarterbeats&#39;</span><span class="p">,</span> <span class="n">duration_col</span><span class="o">=</span><span class="s1">&#39;duration_qb&#39;</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                               <span class="n">filter_zero_duration</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">round</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;interval&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given an annotations table with positions and durations, replaces its index with an :obj:`pandas.IntervalIndex`.</span>
<span class="sd">    Underspecified rows are removed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        Annotation table containing the columns of ``position_col`` (default: &#39;quarterbeats&#39;) and ``duration_col``</span>
<span class="sd">        default: &#39;duration_qb&#39;).</span>
<span class="sd">    position_col : :obj:`str`, optional</span>
<span class="sd">        Name of the column containing positions.</span>
<span class="sd">    duration_col : :obj:`str`, optional</span>
<span class="sd">        Name of the column containing durations.</span>
<span class="sd">    closed : :obj:`str`, optional</span>
<span class="sd">        &#39;left&#39;, &#39;right&#39; or &#39;both&#39; &lt;- defining the interval boundaries</span>
<span class="sd">    filter_zero_duration : :obj:`bool`, optional</span>
<span class="sd">        Defaults to False, meaning that rows with zero durations are maintained. Pass True to remove them.</span>
<span class="sd">    round : :obj:`int`, optional</span>
<span class="sd">        To how many decimal places to round the intervals&#39; boundary values.</span>
<span class="sd">    name : :obj:`str`, optional</span>
<span class="sd">        Name of the created index. Defaults to &#39;interval&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.DataFrame`</span>
<span class="sd">        A copy of ``df`` with the original index replaced and underspecified rows removed (those where no interval</span>
<span class="sd">        could be computed).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="n">position_col</span><span class="p">,</span> <span class="n">duration_col</span><span class="p">)):</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="n">position_col</span><span class="p">,</span> <span class="n">duration_col</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">plural</span> <span class="o">=</span> <span class="s1">&#39;s&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column</span><span class="si">{</span><span class="n">plural</span><span class="si">}</span><span class="s2"> not present in DataFrame: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">position_col</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">position_col</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="p">[</span><span class="n">duration_col</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
    <span class="n">n_dropped</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">filter_zero_duration</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">duration_col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">n_dropped</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Had to drop </span><span class="si">{</span><span class="n">n_dropped</span><span class="si">}</span><span class="s2"> rows for creating the IntervalIndex:</span><span class="se">\n</span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">iv_index</span> <span class="o">=</span> <span class="n">make_interval_index_from_durations</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">position_col</span><span class="o">=</span><span class="n">position_col</span><span class="p">,</span> <span class="n">duration_col</span><span class="o">=</span><span class="n">duration_col</span><span class="p">,</span>
                    <span class="n">closed</span><span class="o">=</span><span class="n">closed</span><span class="p">,</span> <span class="nb">round</span><span class="o">=</span><span class="nb">round</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">duration_col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="c1"># Setting values in-place is fine, ignore the warning in Pandas &gt;= 1.5.0</span>
            <span class="c1"># This can be removed, if Pandas 1.5.0 does not need to be supported any longer.</span>
            <span class="c1"># See also: https://stackoverflow.com/q/74057367/859591</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
                <span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
                <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="p">(</span>
                    <span class="s2">&quot;.*will attempt to set the values inplace instead of always setting a new array. &quot;</span>
                    <span class="s2">&quot;To retain the old behavior, use either.*&quot;</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">duration_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">duration_col</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">iv_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Creating IntervalIndex failed.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">iv_index</span>
    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="boolean_mode_col2strings"><a class="viewcode-back" href="../../reference.html#ms3.utils.boolean_mode_col2strings">[docs]</a><span class="k">def</span> <span class="nf">boolean_mode_col2strings</span><span class="p">(</span><span class="n">S</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Turn the boolean is_minor columns into string columns such that True =&gt; &#39;minor&#39;, False =&gt; &#39;major&#39;.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">S</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="kc">True</span><span class="p">:</span> <span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="s1">&#39;major&#39;</span><span class="p">})</span></div>

<div class="viewcode-block" id="replace_boolean_mode_by_strings"><a class="viewcode-back" href="../../reference.html#ms3.utils.replace_boolean_mode_by_strings">[docs]</a><span class="k">def</span> <span class="nf">replace_boolean_mode_by_strings</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Replaces boolean &#39;_is_minor&#39; columns with string columns renamed to &#39;_mode&#39;.</span>
<span class="sd">    Example: df[&#39;some_col&#39;, &#39;some_name_is_minor&#39;] =&gt; df[&#39;some_col&#39;, &#39;some_name_mode&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bool_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_is_minor&#39;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bool_cols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">renaming</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">bool_cols</span><span class="p">:</span>
        <span class="n">numeral_name</span> <span class="o">=</span> <span class="n">col_name</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;_is_minor&#39;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">new_col_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">numeral_name</span><span class="si">}</span><span class="s2">_mode&quot;</span>
            <span class="n">new_col</span> <span class="o">=</span> <span class="n">boolean_mode_col2strings</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">])</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_col</span>
            <span class="n">renaming</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_col_name</span>
    <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">renaming</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="resolve_relative_keys"><a class="viewcode-back" href="../../reference.html#ms3.utils.resolve_relative_keys">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">resolve_relative_keys</span><span class="p">(</span><span class="n">relativeroot</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Resolve nested relative keys, e.g. &#39;V/V/V&#39; =&gt; &#39;VI&#39;.</span>

<span class="sd">    Uses: :py:func:`rel2abs_key`, :py:func:`str_is_minor`</span>

<span class="sd">    relativeroot : :obj:`str`</span>
<span class="sd">        One or several relative keys, e.g. iv/v/VI (fourth scale degree of the fifth scale degree of the sixth scale degree)</span>
<span class="sd">    minor : :obj:`bool`, optional</span>
<span class="sd">        Pass True if the last of the relative keys is to be interpreted within a minor context.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">relativeroot</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">relativeroot</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="n">relativeroot</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spl</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">relativeroot</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">applied</span><span class="p">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">spl</span>
        <span class="k">return</span> <span class="n">rel2abs_key</span><span class="p">(</span><span class="n">applied</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">previous</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spl</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">spl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">rel2abs_key</span><span class="p">(</span><span class="n">resolve_relative_keys</span><span class="p">(</span><span class="n">previous</span><span class="p">,</span> <span class="n">str_is_minor</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="n">is_name</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span> <span class="n">last</span><span class="p">,</span> <span class="n">minor</span><span class="p">)</span></div>


<div class="viewcode-block" id="series_is_minor"><a class="viewcode-back" href="../../reference.html#ms3.utils.series_is_minor">[docs]</a><span class="k">def</span> <span class="nf">series_is_minor</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">is_name</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Returns boolean Series where every value in ``S`` representing a minor key/chord is True.&quot;&quot;&quot;</span>
    <span class="c1"># regex = r&#39;([A-Ga-g])[#|b]*&#39; if is_name else &#39;[#|b]*(\w+)&#39;</span>
    <span class="c1"># return S.str.replace(regex, lambda m: m.group(1)).str.islower()</span>
    <span class="k">return</span> <span class="n">S</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span>  <span class="c1"># as soon as one character is not lowercase, it should be major</span></div>


<div class="viewcode-block" id="str_is_minor"><a class="viewcode-back" href="../../reference.html#ms3.utils.str_is_minor">[docs]</a><span class="k">def</span> <span class="nf">str_is_minor</span><span class="p">(</span><span class="n">tone</span><span class="p">,</span> <span class="n">is_name</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Returns True if ``tone`` represents a minor key or chord.&quot;&quot;&quot;</span>
    <span class="c1"># regex = r&#39;([A-Ga-g])[#|b]*&#39; if is_name else &#39;[#|b]*(\w+)&#39;</span>
    <span class="c1"># m = re.match(regex, tone)</span>
    <span class="c1"># if m is None:</span>
    <span class="c1">#     return m</span>
    <span class="c1"># return m.group(1).islower()</span>
    <span class="k">return</span> <span class="n">tone</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span></div>


<div class="viewcode-block" id="transpose_changes"><a class="viewcode-back" href="../../reference.html#ms3.utils.transpose_changes">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">transpose_changes</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">old_num</span><span class="p">,</span> <span class="n">new_num</span><span class="p">,</span> <span class="n">old_minor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">new_minor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Since the interval sizes expressed by the changes of the DCML harmony syntax</span>
<span class="sd">    depend on the numeral&#39;s position in the scale, these may change if the numeral</span>
<span class="sd">    is transposed. This function expresses the same changes for the new position.</span>
<span class="sd">    Chord tone alterations (of 3 and 5) stay untouched.</span>

<span class="sd">    Uses: :py:func:`changes2tpc`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    changes : :obj:`str`</span>
<span class="sd">        A string of changes following the DCML harmony standard.</span>
<span class="sd">    old_num, new_num : :obj:`str`:</span>
<span class="sd">        Old numeral, new numeral.</span>
<span class="sd">    old_minor, new_minor : :obj:`bool`, optional</span>
<span class="sd">        For each numeral, pass True if it occurs in a minor context.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">changes</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">changes</span>
    <span class="n">old</span> <span class="o">=</span> <span class="n">changes2tpc</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">old_num</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">old_minor</span><span class="p">,</span> <span class="n">root_alterations</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">new</span> <span class="o">=</span> <span class="n">changes2tpc</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">new_num</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">new_minor</span><span class="p">,</span> <span class="n">root_alterations</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">get_acc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">n</span> <span class="o">*</span> <span class="s1">&#39;#&#39;</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="n">n</span> <span class="o">*</span> <span class="s1">&#39;b&#39;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">full</span><span class="p">,</span> <span class="n">added</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">chord_interval</span><span class="p">,</span> <span class="n">iv1</span><span class="p">),</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">iv2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">iv1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">iv1</span> <span class="o">==</span> <span class="n">iv2</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">iv2</span> <span class="o">-</span> <span class="n">iv1</span>
            <span class="k">if</span> <span class="n">d</span> <span class="o">%</span> <span class="mi">7</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The difference between the intervals of </span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">old_num</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">new_num</span><span class="si">}</span><span class="s2"> (in </span><span class="si">{</span><span class="s1">&#39;minor&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">minor</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;major&#39;</span><span class="si">}</span><span class="s2">) don&#39;t differ by chromatic semitones.&quot;</span><span class="p">)</span>
            <span class="n">n_acc</span> <span class="o">=</span> <span class="n">acc</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">acc</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
            <span class="n">new_acc</span> <span class="o">=</span> <span class="n">get_acc</span><span class="p">(</span><span class="n">n_acc</span> <span class="o">-</span> <span class="n">d</span> <span class="o">//</span> <span class="mi">7</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">added</span> <span class="o">+</span> <span class="n">new_acc</span> <span class="o">+</span> <span class="n">chord_interval</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>


<div class="viewcode-block" id="features2tpcs"><a class="viewcode-back" href="../../reference.html#ms3.utils.features2tpcs">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">features2tpcs</span><span class="p">(</span><span class="n">numeral</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figbass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">changes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">relativeroot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">merge_tones</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bass_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given the features of a chord label, this function returns the chord tones</span>
<span class="sd">    in the order of the inversion, starting from the bass note. The tones are</span>
<span class="sd">    expressed as tonal pitch classes, where -1=F, 0=C, 1=G etc.</span>

<span class="sd">    Uses: :py:func:`~.utils.changes2list`, :py:func:`~.utils.name2fifths`, :py:func:`~.utils.resolve_relative_keys`, :py:func:`~.utils.roman_numeral2fifths`,</span>
<span class="sd">    :py:func:`~.utils.sort_tpcs`, :py:func:`~.utils.str_is_minor`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    numeral: :obj:`str`</span>
<span class="sd">        Roman numeral of the chord&#39;s root</span>
<span class="sd">    form: {None, &#39;M&#39;, &#39;o&#39;, &#39;+&#39; &#39;%&#39;}, optional</span>
<span class="sd">        Indicates the chord type if not a major or minor triad (for which ``form`` is None).</span>
<span class="sd">        &#39;%&#39; and &#39;M&#39; can only occur as tetrads, not as triads.</span>
<span class="sd">    figbass: {None, &#39;6&#39;, &#39;64&#39;, &#39;7&#39;, &#39;65&#39;, &#39;43&#39;, &#39;2&#39;}, optional</span>
<span class="sd">        Indicates chord&#39;s inversion. Pass None for triad root position.</span>
<span class="sd">    changes: :obj:`str`, optional</span>
<span class="sd">        Added steps such as &#39;+6&#39; or suspensions such as &#39;4&#39; or any combination such as (9+64).</span>
<span class="sd">        Numbers need to be in descending order.</span>
<span class="sd">    relativeroot: :obj:`str`, optional</span>
<span class="sd">        Pass a Roman scale degree if `numeral` is to be applied to a different scale</span>
<span class="sd">        degree of the local key, as in &#39;V65/V&#39;</span>
<span class="sd">    key : :obj:`str` or :obj:`int`, optional</span>
<span class="sd">        The local key expressed as the root&#39;s note name or a tonal pitch class.</span>
<span class="sd">        If it is a name and `minor` is `None`, uppercase means major and lowercase minor.</span>
<span class="sd">        If it is a tonal pitch class, `minor` needs to be specified.</span>
<span class="sd">    minor : :obj:`bool`, optional</span>
<span class="sd">        Pass True for minor and False for major. Can be omitted if `key` is a note name.</span>
<span class="sd">        This affects calculation of chords related to III, VI and VII.</span>
<span class="sd">    merge_tones : :obj:`bool`, optional</span>
<span class="sd">        Pass False if you want the function to return two tuples, one with (potentially suspended)</span>
<span class="sd">        chord tones and one with added notes.</span>
<span class="sd">    bass_only : :obj:`bool`, optional</span>
<span class="sd">        Return only the bass note instead of all chord tones.</span>
<span class="sd">    mc : int or str</span>
<span class="sd">        Pass measure count to display it in warnings.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">numeral</span><span class="p">)</span> <span class="ow">or</span> <span class="n">numeral</span> <span class="o">==</span> <span class="s1">&#39;@none&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bass_only</span> <span class="ow">or</span> <span class="n">merge_tones</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;chord_tones&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span>
                <span class="s1">&#39;added_tones&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span>
                <span class="s1">&#39;root&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span>
            <span class="p">}</span>
    <span class="n">form</span><span class="p">,</span> <span class="n">figbass</span><span class="p">,</span> <span class="n">changes</span><span class="p">,</span> <span class="n">relativeroot</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
        <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">else</span> <span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">figbass</span><span class="p">,</span> <span class="n">changes</span><span class="p">,</span> <span class="n">relativeroot</span><span class="p">))</span>
    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">numeral</span><span class="si">}{</span><span class="n">form</span><span class="si">}{</span><span class="n">figbass</span><span class="si">}{</span><span class="s1">&#39;(&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">changes</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;)&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">changes</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}{</span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">relativeroot</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">relativeroot</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">MC</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">mc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;MC </span><span class="si">{</span><span class="n">mc</span><span class="si">}</span><span class="s1">: &#39;</span>
    <span class="k">if</span> <span class="n">minor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">minor</span> <span class="o">=</span> <span class="n">str_is_minor</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">is_name</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mode inferred from </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;If parameter &#39;minor&#39; is not specified, &#39;key&#39; needs to be a string, not </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">key</span> <span class="o">=</span> <span class="n">name2fifths</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">form</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;+M&#39;</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="n">figbass</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;65&#39;</span><span class="p">,</span> <span class="s1">&#39;43&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;2&#39;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}{</span><span class="n">label</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">form</span><span class="si">}</span><span class="s2"> requires figbass (7, 65, 43, or 2) since it specifies a chord&#39;s seventh.&quot;</span>

    <span class="k">if</span> <span class="n">relativeroot</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">resolved</span> <span class="o">=</span> <span class="n">resolve_relative_keys</span><span class="p">(</span><span class="n">relativeroot</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">rel_minor</span> <span class="o">=</span> <span class="n">str_is_minor</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="n">is_name</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">transp</span> <span class="o">=</span> <span class="n">roman_numeral2fifths</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}</span><span class="s2">Chord applied to </span><span class="si">{</span><span class="n">relativeroot</span><span class="si">}</span><span class="s2">. Therefore transposing it by </span><span class="si">{</span><span class="n">transp</span><span class="si">}</span><span class="s2"> fifths.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">features2tpcs</span><span class="p">(</span><span class="n">numeral</span><span class="o">=</span><span class="n">numeral</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">figbass</span><span class="o">=</span><span class="n">figbass</span><span class="p">,</span> <span class="n">relativeroot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">changes</span><span class="o">=</span><span class="n">changes</span><span class="p">,</span>
                             <span class="n">key</span><span class="o">=</span><span class="n">key</span> <span class="o">+</span> <span class="n">transp</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">rel_minor</span><span class="p">,</span> <span class="n">merge_tones</span><span class="o">=</span><span class="n">merge_tones</span><span class="p">,</span> <span class="n">bass_only</span><span class="o">=</span><span class="n">bass_only</span><span class="p">,</span> <span class="n">mc</span><span class="o">=</span><span class="n">mc</span><span class="p">,</span>
                             <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">numeral</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;#vii&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">minor</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}{</span><span class="n">numeral</span><span class="si">}</span><span class="s2"> in major context corrected to </span><span class="si">{</span><span class="n">numeral</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                       <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;message_id&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">27</span><span class="p">,</span> <span class="n">MC</span><span class="p">)})</span>
        <span class="n">numeral</span> <span class="o">=</span> <span class="n">numeral</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">root_alteration</span><span class="p">,</span> <span class="n">num_degree</span> <span class="o">=</span> <span class="n">split_scale_degree</span><span class="p">(</span><span class="n">numeral</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>

    <span class="c1"># build 2-octave diatonic scale on C major/minor</span>
    <span class="n">root</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">num_degree</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="n">tpcs</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">key</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)]</span> <span class="k">if</span> <span class="n">minor</span> <span class="k">else</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">key</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)]</span>
    <span class="c1"># starting the scale from chord root, i.e. root will be tpcs[0], the chord&#39;s seventh tpcs[6] etc.</span>
    <span class="n">tpcs</span> <span class="o">=</span> <span class="n">tpcs</span><span class="p">[</span><span class="n">root</span><span class="p">:]</span> <span class="o">+</span> <span class="n">tpcs</span><span class="p">[:</span><span class="n">root</span><span class="p">]</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">tpcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">root_alteration</span>
    <span class="n">tpcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">root</span>  <span class="c1"># octave stays diatonic, is not altered</span>
    <span class="c1">#logger.debug(f&quot;{num_degree}: The {&#39;minor&#39; if minor else &#39;major&#39;} scale starting from the root: {tpcs}&quot;)</span>

    <span class="k">def</span> <span class="nf">set_iv</span><span class="p">(</span><span class="n">chord_interval</span><span class="p">,</span> <span class="n">interval_size</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Add to the interval of a given chord interval in `tpcs` (both viewed from the root note).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        chord_interval : :obj:`int`</span>
<span class="sd">            Pass 0 for the root note, 2 for the third, 8 for the ninth etc.</span>
<span class="sd">        interval_size : :obj:`int`</span>
<span class="sd">            Stack-of-fifths interval.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">tpcs</span><span class="p">,</span> <span class="n">root</span>
        <span class="n">iv</span> <span class="o">=</span> <span class="n">root</span> <span class="o">+</span> <span class="n">interval_size</span>
        <span class="n">tpcs</span><span class="p">[</span><span class="n">chord_interval</span><span class="p">]</span> <span class="o">=</span> <span class="n">iv</span>
        <span class="n">tpcs</span><span class="p">[</span><span class="n">chord_interval</span> <span class="o">+</span> <span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">iv</span>

    <span class="n">is_triad</span> <span class="o">=</span> <span class="n">figbass</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;64&#39;</span><span class="p">]</span>
    <span class="n">is_seventh_chord</span> <span class="o">=</span> <span class="n">figbass</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;65&#39;</span><span class="p">,</span> <span class="s1">&#39;43&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_triad</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_seventh_chord</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}{</span><span class="n">figbass</span><span class="si">}</span><span class="s2"> is not a valid chord inversion.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">form</span> <span class="o">==</span> <span class="s1">&#39;o&#39;</span><span class="p">:</span>
        <span class="n">set_iv</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">set_iv</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_seventh_chord</span><span class="p">:</span>
            <span class="n">set_iv</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">9</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">form</span> <span class="o">==</span> <span class="s1">&#39;%&#39;</span><span class="p">:</span>
        <span class="n">set_iv</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">set_iv</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">set_iv</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">form</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
        <span class="n">set_iv</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">set_iv</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_seventh_chord</span><span class="p">:</span>
            <span class="n">set_iv</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">form</span> <span class="o">==</span> <span class="s1">&#39;+M&#39;</span><span class="p">:</span>
        <span class="n">set_iv</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">set_iv</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">set_iv</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># triad with or without major or minor seven</span>
        <span class="n">set_iv</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_degree</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
            <span class="n">set_iv</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">set_iv</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span>
            <span class="n">set_iv</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_seventh_chord</span><span class="p">:</span>
            <span class="n">set_iv</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">tone_functions</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_seventh_chord</span> <span class="k">else</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">root_position</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">[</span><span class="n">tpcs</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tone_functions</span><span class="p">}</span>
    <span class="n">replacements</span>  <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tone_functions</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">replace_chord_tone</span><span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="n">by</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">root_position</span><span class="p">,</span> <span class="n">replacements</span>
        <span class="k">if</span> <span class="n">which</span> <span class="ow">in</span> <span class="n">root_position</span><span class="p">:</span>
            <span class="n">root_position</span><span class="p">[</span><span class="n">which</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">replacements</span><span class="p">[</span><span class="n">which</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">by</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Only chord tones [0,2,4,(6)] can be replaced, not </span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># apply changes</span>
    <span class="n">alts</span> <span class="o">=</span> <span class="n">changes2list</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">added_notes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">full</span><span class="p">,</span> <span class="n">add_remove</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">chord_interval</span> <span class="ow">in</span> <span class="n">alts</span><span class="p">:</span>
        <span class="n">added</span> <span class="o">=</span> <span class="n">add_remove</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span>
        <span class="n">substracted</span> <span class="o">=</span> <span class="n">add_remove</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span>
        <span class="n">replacing_upper</span> <span class="o">=</span> <span class="n">add_remove</span> <span class="o">==</span> <span class="s1">&#39;^&#39;</span>
        <span class="n">replacing_lower</span> <span class="o">=</span> <span class="n">add_remove</span> <span class="o">==</span> <span class="s1">&#39;v&#39;</span>
        <span class="n">chord_interval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chord_interval</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="c1">### From here on, `chord_interval` is decremented, i.e. the root is 0, the seventh is 6 etc. (just like in `tpcs`)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">chord_interval</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">substracted</span><span class="p">)</span> <span class="ow">or</span> <span class="n">chord_interval</span> <span class="o">&gt;</span> <span class="mi">13</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}</span><span class="s2">Change </span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2"> is meaningless and ignored because it concerns chord tone </span><span class="si">{</span><span class="n">chord_interval</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">next_octave</span> <span class="o">=</span> <span class="n">chord_interval</span> <span class="o">&gt;</span> <span class="mi">7</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="n">acc</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">acc</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">))</span>
        <span class="n">new_val</span> <span class="o">=</span> <span class="n">tpcs</span><span class="p">[</span><span class="n">chord_interval</span><span class="p">]</span> <span class="o">+</span> <span class="n">shift</span>
        <span class="k">if</span> <span class="n">substracted</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">chord_interval</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tone_functions</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}</span><span class="s2">The change </span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2"> has no effect because it concerns an interval which is not implied by </span><span class="si">{</span><span class="n">numeral</span><span class="si">}{</span><span class="n">form</span><span class="si">}{</span><span class="n">figbass</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">root_position</span><span class="p">[</span><span class="n">chord_interval</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="n">added</span><span class="p">:</span>
            <span class="n">added_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">next_octave</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">replacing_lower</span><span class="p">,</span> <span class="n">replacing_upper</span><span class="p">,</span> <span class="n">substracted</span><span class="p">)):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}{</span><span class="n">full</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> has no effect in </span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2">  because the interval is larger than an octave.&quot;</span><span class="p">)</span>
            <span class="n">added_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">chord_interval</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]:</span>  <span class="c1"># these are changes to scale degree 2, 4, 6 that replace the lower neighbour unless they have a # or ^</span>
            <span class="k">if</span> <span class="s1">&#39;#&#39;</span> <span class="ow">in</span> <span class="n">acc</span> <span class="ow">or</span> <span class="n">replacing_upper</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;#&#39;</span> <span class="ow">in</span> <span class="n">acc</span> <span class="ow">and</span> <span class="n">replacing_upper</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}</span><span class="s2">^ is redundant in </span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">chord_interval</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">is_triad</span><span class="p">:</span>  <span class="c1"># leading tone to 7 but not in seventh chord</span>
                    <span class="n">added_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">replace_chord_tone</span><span class="p">(</span><span class="n">chord_interval</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new_val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">replacing_lower</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}</span><span class="s2">v is redundant in </span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">replace_chord_tone</span><span class="p">(</span><span class="n">chord_interval</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new_val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># chord tone alterations</span>
            <span class="k">if</span> <span class="n">replacing_lower</span><span class="p">:</span>
                <span class="c1"># TODO: This must be possible, e.g. V(6v5) where 5 is suspension of 4</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}{</span><span class="n">full</span><span class="si">}</span><span class="s2"> -&gt; chord tones cannot replace neighbours, use + instead.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">chord_interval</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">figbass</span> <span class="o">!=</span> <span class="s1">&#39;7&#39;</span><span class="p">:</span>  <span class="c1"># 7th are a special case:</span>
                <span class="k">if</span> <span class="n">figbass</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>  <span class="c1"># in root position triads they are added</span>
                    <span class="c1"># TODO: The standard is lacking a distinction, because the root in root pos. can also be replaced from below!</span>
                    <span class="n">added_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">figbass</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;64&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;#&#39;</span> <span class="ow">in</span> <span class="n">acc</span><span class="p">:</span>  <span class="c1"># in inverted triads they replace the root, as does #7</span>
                    <span class="n">replace_chord_tone</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">new_val</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># otherwise they are unclear</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}</span><span class="s2">In seventh chords, such as </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">, it is not clear whether the </span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2"> alters the 7 or replaces the 8 and should not be used.&quot;</span><span class="p">,</span>
                        <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="p">)})</span>
            <span class="k">elif</span> <span class="n">tpcs</span><span class="p">[</span><span class="n">chord_interval</span><span class="p">]</span> <span class="o">==</span> <span class="n">new_val</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}</span><span class="s2">The change </span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2"> has no effect in </span><span class="si">{</span><span class="n">numeral</span><span class="si">}{</span><span class="n">form</span><span class="si">}{</span><span class="n">figbass</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">root_position</span><span class="p">[</span><span class="n">chord_interval</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_val</span><span class="p">]</span>

    <span class="n">figbass2bass</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;7&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;6&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;65&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;64&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;43&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;2&#39;</span><span class="p">:</span> <span class="mi">3</span>
    <span class="p">}</span>
    <span class="n">bass</span> <span class="o">=</span> <span class="n">figbass2bass</span><span class="p">[</span><span class="n">figbass</span><span class="p">]</span>
    <span class="n">chord_tones</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tone_function_names</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;3rd&#39;</span><span class="p">,</span>
        <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;5th&#39;</span><span class="p">,</span>
        <span class="mi">6</span><span class="p">:</span> <span class="s1">&#39;7th&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">tf</span> <span class="ow">in</span> <span class="n">tone_functions</span><span class="p">[</span><span class="n">bass</span><span class="p">:]</span> <span class="o">+</span> <span class="n">tone_functions</span><span class="p">[:</span><span class="n">bass</span><span class="p">]:</span>
        <span class="n">chord_tone</span><span class="p">,</span> <span class="n">replacing_tones</span> <span class="o">=</span> <span class="n">root_position</span><span class="p">[</span><span class="n">tf</span><span class="p">],</span> <span class="n">replacements</span><span class="p">[</span><span class="n">tf</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">chord_tone</span> <span class="o">==</span> <span class="n">replacing_tones</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}{</span><span class="n">label</span><span class="si">}</span><span class="s2"> results in a chord without </span><span class="si">{</span><span class="n">tone_function_names</span><span class="p">[</span><span class="n">tf</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">chord_tone</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">chord_tones</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chord_tone</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">replacing_tones</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}{</span><span class="n">label</span><span class="si">}</span><span class="s2"> results in a chord tone </span><span class="si">{</span><span class="n">tone_function_names</span><span class="p">[</span><span class="n">tf</span><span class="p">]</span><span class="si">}</span><span class="s2"> AND its replacement(s) (TPC </span><span class="si">{</span><span class="n">replacing_tones</span><span class="si">}</span><span class="s2">). &quot;</span>
                               <span class="sa">f</span><span class="s2">&quot;You might want to add a + to distinguish from a suspension, or add this warning to IGNORED_WARNINGS with a comment.&quot;</span><span class="p">,</span>
                               <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">mc</span><span class="p">,</span> <span class="n">label</span><span class="p">)})</span>
        <span class="n">chord_tones</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">replacing_tones</span><span class="p">)</span>

    <span class="n">bass_tpc</span> <span class="o">=</span> <span class="n">chord_tones</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">bass_only</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">bass_tpc</span>
    <span class="k">elif</span> <span class="n">merge_tones</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sort_tpcs</span><span class="p">(</span><span class="n">chord_tones</span> <span class="o">+</span> <span class="n">added_notes</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">bass_tpc</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;chord_tones&#39;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">chord_tones</span><span class="p">),</span>
            <span class="s1">&#39;added_tones&#39;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">added_notes</span><span class="p">),</span>
            <span class="s1">&#39;root&#39;</span><span class="p">:</span> <span class="n">root</span><span class="p">,</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="path2parent_corpus"><a class="viewcode-back" href="../../reference.html#ms3.utils.path2parent_corpus">[docs]</a><span class="k">def</span> <span class="nf">path2parent_corpus</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Walk up the path and return the name of the first superdirectory that is a git repository or contains a &#39;metadata.tsv&#39; file.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">listdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;metadata.tsv&#39;</span> <span class="ow">in</span> <span class="n">listdir</span> <span class="ow">or</span> <span class="s1">&#39;.git&#39;</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">path</span>
        <span class="k">return</span> <span class="n">path2parent_corpus</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="chord2tpcs"><a class="viewcode-back" href="../../reference.html#ms3.utils.chord2tpcs">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">chord2tpcs</span><span class="p">(</span><span class="n">chord</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split a chord label into its features and apply features2tpcs().</span>

<span class="sd">    Uses: features2tpcs()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    chord : :obj:`str`</span>
<span class="sd">        Chord label that can be split into the features [&#39;numeral&#39;, &#39;form&#39;, &#39;figbass&#39;, &#39;changes&#39;, &#39;relativeroot&#39;].</span>
<span class="sd">    regex : :obj:`re.Pattern`, optional</span>
<span class="sd">        Compiled regex with named groups for the five features. By default, the current version of the DCML harmony</span>
<span class="sd">        annotation standard is used.</span>
<span class="sd">    **kwargs :</span>
<span class="sd">        arguments for features2tpcs (pass MC to show it in warnings!)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">regex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="n">DCML_REGEX</span>
    <span class="n">chord_features</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">chord</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">chord_features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">chord</span><span class="si">}</span><span class="s2"> does not match the regex.&quot;</span>
    <span class="n">chord_features</span> <span class="o">=</span> <span class="n">chord_features</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
    <span class="n">numeral</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">figbass</span><span class="p">,</span> <span class="n">changes</span><span class="p">,</span> <span class="n">relativeroot</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">chord_features</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;numeral&#39;</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="s1">&#39;figbass&#39;</span><span class="p">,</span> <span class="s1">&#39;changes&#39;</span><span class="p">,</span> <span class="s1">&#39;relativeroot&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">features2tpcs</span><span class="p">(</span><span class="n">numeral</span><span class="o">=</span><span class="n">numeral</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">figbass</span><span class="o">=</span><span class="n">figbass</span><span class="p">,</span> <span class="n">changes</span><span class="o">=</span><span class="n">changes</span><span class="p">,</span> <span class="n">relativeroot</span><span class="o">=</span><span class="n">relativeroot</span><span class="p">,</span>
                         <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="transpose"><a class="viewcode-back" href="../../reference.html#ms3.utils.transpose">[docs]</a><span class="k">def</span> <span class="nf">transpose</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Add `n` to all elements `e` recursively.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">map2elements</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">parse_ignored_warnings</span><span class="p">(</span><span class="n">messages</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="n">parse_ignored_warnings</span><span class="p">([</span><span class="n">messages</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">message</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="n">parse_ignored_warnings</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">message</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">):</span>
                <span class="c1"># if several lines of a warning were copied, use only the first one</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># if the annotator copied too much, cut off the redundant information at the end</span>
                    <span class="n">redundant</span> <span class="o">=</span>  <span class="n">message</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39; -- &#39;</span><span class="p">)</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="p">[:</span><span class="n">redundant</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">split_re</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^(.*) (\S+)$&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">msg</span><span class="p">,</span> <span class="n">logger_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">split_re</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The following message could not be split, apparently it does not end with the logger_name: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">raise</span>
                <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">level</span><span class="p">)</span> <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="s1">&#39;INFO&#39;</span><span class="p">,</span> <span class="s1">&#39;WARNING&#39;</span><span class="p">,</span> <span class="s1">&#39;ERROR&#39;</span><span class="p">,</span> <span class="s1">&#39;CRITICAL&#39;</span><span class="p">)):</span>
                        <span class="c1"># message_id has not (yet) specified for this log message and is ignored;</span>
                        <span class="c1"># a warning could be implemented at this point</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected log message format: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">tuple_start</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">tuple_str</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">tuple_start</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">str2inttuple</span><span class="p">(</span><span class="n">tuple_str</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">logger_name</span><span class="p">,</span> <span class="n">info</span>

<div class="viewcode-block" id="ignored_warnings2dict"><a class="viewcode-back" href="../../reference.html#ms3.utils.ignored_warnings2dict">[docs]</a><span class="k">def</span> <span class="nf">ignored_warnings2dict</span><span class="p">(</span><span class="n">messages</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Args:</span>
<span class="sd">      messages:</span>

<span class="sd">    Returns:</span>
<span class="sd">      {logger_name -&gt; [ignored_warnings]} dict.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ignored_warnings</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">logger_name</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">parse_ignored_warnings</span><span class="p">(</span><span class="n">messages</span><span class="p">):</span>
        <span class="n">ignored_warnings</span><span class="p">[</span><span class="n">logger_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ignored_warnings</span><span class="p">)</span></div>

<div class="viewcode-block" id="parse_ignored_warnings_file"><a class="viewcode-back" href="../../reference.html#ms3.utils.parse_ignored_warnings_file">[docs]</a><span class="k">def</span> <span class="nf">parse_ignored_warnings_file</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse file with log messages that have to be ignored to the dict.</span>
<span class="sd">    The expected structure of message: warning_type (warning_type_id, *integers) file</span>
<span class="sd">    Example of message: INCORRECT_VOLTA_MN_WARNING (2, 94) ms3.Parse.mixed_files.Did03M-Son_regina-1762-Sarti.mscx.MeasureList</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    key : :obj:`str`</span>
<span class="sd">        | Path to IGNORED_WARNINGS</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj: dict</span>
<span class="sd">        {logger_name: [(message_id, label_of_message), (message_id, label_of_message), ...]}.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">resolve_dir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ignored_warnings2dict</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span></div>


<div class="viewcode-block" id="overlapping_chunk_per_interval"><a class="viewcode-back" href="../../reference.html#ms3.utils.overlapping_chunk_per_interval">[docs]</a><span class="k">def</span> <span class="nf">overlapping_chunk_per_interval</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                                   <span class="n">intervals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Interval</span><span class="p">],</span>
                                   <span class="n">truncate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Interval</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; For each interval, create a chunk of the given DataFrame based on its IntervalIndex.</span>
<span class="sd">    This is an optimized algorithm compared to calling IntervalIndex.overlaps(interval) for each</span>
<span class="sd">    given interval, with the additional advantage that it will not discard rows where the</span>
<span class="sd">    interval is zero, such as [25.0, 25.0).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        The DataFrame is expected to come with an IntervalIndex and contain the columns &#39;quarterbeats&#39; and &#39;duration_qb&#39;.</span>
<span class="sd">        Those can be obtained through ``Parse.get_lists(interval_index=True)`` or</span>
<span class="sd">        ``Parse.iter_transformed(interval_index=True)``.</span>
<span class="sd">    intervals : :obj:`list` of :obj:`pd.Interval`</span>
<span class="sd">        The intervals defining the chunks&#39; dimensions. Expected to be non-overlapping and monotonically increasing.</span>
<span class="sd">    truncate : :obj:`bool`, optional</span>
<span class="sd">        Defaults to True, meaning that the interval index and the &#39;duration_qb&#39; will be adapted for overlapping intervals.</span>
<span class="sd">        Pass False to get chunks with all overlapping intervals as they are.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`dict`</span>
<span class="sd">        {interval -&gt; chunk}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lefts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">values</span>    <span class="c1"># lefts and rights will get shorter (potentially) with every</span>
    <span class="n">rights</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># interval, in order to reduce the time for comparing values</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">current_start_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">)</span> <span class="c1"># length remains the same</span>
    <span class="k">for</span> <span class="n">iv</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">:</span>
        <span class="c1"># assumes intervals are non-overlapping and monotonically increasing</span>
        <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">iv</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">iv</span><span class="o">.</span><span class="n">right</span>
        <span class="c1"># never again check events ending before the current interval&#39;s start</span>
        <span class="n">not_ending_before_l</span> <span class="o">=</span> <span class="p">(</span><span class="n">rights</span> <span class="o">&gt;=</span> <span class="n">l</span><span class="p">)</span>
        <span class="n">lefts</span> <span class="o">=</span> <span class="n">lefts</span><span class="p">[</span><span class="n">not_ending_before_l</span><span class="p">]</span>
        <span class="n">rights</span> <span class="o">=</span> <span class="n">rights</span><span class="p">[</span><span class="n">not_ending_before_l</span><span class="p">]</span>
        <span class="n">current_start_mask</span><span class="p">[</span><span class="n">current_start_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">not_ending_before_l</span>
        <span class="n">starting_before_r</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="n">lefts</span><span class="p">)</span>
        <span class="n">not_ending_on_l_except_empty</span> <span class="o">=</span> <span class="p">(</span><span class="n">rights</span> <span class="o">!=</span> <span class="n">l</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">lefts</span> <span class="o">==</span> <span class="n">l</span><span class="p">)</span>
        <span class="n">overlapping</span> <span class="o">=</span> <span class="p">(</span><span class="n">starting_before_r</span> <span class="o">&amp;</span> <span class="n">not_ending_on_l_except_empty</span><span class="p">)</span>
        <span class="n">bool_mask</span> <span class="o">=</span> <span class="n">current_start_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">bool_mask</span><span class="p">[</span><span class="n">current_start_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">overlapping</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">bool_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">truncate</span><span class="p">:</span>
            <span class="n">new_lefts</span><span class="p">,</span> <span class="n">new_rights</span> <span class="o">=</span> <span class="n">lefts</span><span class="p">[</span><span class="n">overlapping</span><span class="p">],</span> <span class="n">rights</span><span class="p">[</span><span class="n">overlapping</span><span class="p">]</span>
            <span class="n">starting_before_l</span><span class="p">,</span> <span class="n">ending_after_r</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_lefts</span> <span class="o">&lt;</span> <span class="n">l</span><span class="p">),</span> <span class="p">(</span><span class="n">new_rights</span> <span class="o">&gt;</span> <span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">starting_before_l</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">ending_after_r</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">new_lefts</span><span class="p">[</span><span class="n">starting_before_l</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span>
                <span class="n">new_rights</span><span class="p">[</span><span class="n">ending_after_r</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
                <span class="n">chunk</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">IntervalIndex</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">(</span><span class="n">new_lefts</span><span class="p">,</span> <span class="n">new_rights</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
                <span class="n">chunk</span><span class="o">.</span><span class="n">duration_qb</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_rights</span> <span class="o">-</span> <span class="n">new_lefts</span><span class="p">)</span>
                <span class="n">chunk</span><span class="o">.</span><span class="n">quarterbeats</span> <span class="o">=</span> <span class="n">new_lefts</span>
                <span class="n">chunk</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;quarterbeats&#39;</span><span class="p">,</span> <span class="s1">&#39;duration_qb&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">chunks</span><span class="p">[</span><span class="n">iv</span><span class="p">]</span> <span class="o">=</span> <span class="n">chunk</span>
    <span class="k">return</span> <span class="n">chunks</span></div>


<div class="viewcode-block" id="infer_tsv_type"><a class="viewcode-back" href="../../reference.html#ms3.utils.infer_tsv_type">[docs]</a><span class="k">def</span> <span class="nf">infer_tsv_type</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Infers the contents of a DataFrame from the presence of particular columns.&quot;&quot;&quot;</span>
    <span class="n">type2cols</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;notes&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;tpc&#39;</span><span class="p">,</span> <span class="s1">&#39;midi&#39;</span><span class="p">],</span>
        <span class="s1">&#39;events&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Chord/durationType&#39;</span><span class="p">,</span> <span class="s1">&#39;Rest/durationType&#39;</span><span class="p">],</span>
        <span class="s1">&#39;chords&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;chord_id&#39;</span><span class="p">],</span>
        <span class="s1">&#39;rests&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;nominal_duration&#39;</span><span class="p">],</span>
        <span class="s1">&#39;expanded&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;numeral&#39;</span><span class="p">],</span>
        <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;harmony_layer&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;label_type&#39;</span><span class="p">],</span>
        <span class="s1">&#39;measures&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;act_dur&#39;</span><span class="p">],</span>
        <span class="s1">&#39;cadences&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;cadence&#39;</span><span class="p">],</span>
        <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;fname&#39;</span><span class="p">],</span>
        <span class="s1">&#39;form_labels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;form_label&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">columns</span> <span class="ow">in</span> <span class="n">type2cols</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">t</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;mn&#39;</span><span class="p">]):</span>
        <span class="k">return</span> <span class="s1">&#39;labels&#39;</span>
    <span class="k">return</span> <span class="s1">&#39;unknown&#39;</span></div>


<div class="viewcode-block" id="reduce_dataframe_duration_to_first_row"><a class="viewcode-back" href="../../reference.html#ms3.utils.reduce_dataframe_duration_to_first_row">[docs]</a><span class="k">def</span> <span class="nf">reduce_dataframe_duration_to_first_row</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Reduces a DataFrame to its row and updates the duration_qb column to reflect the reduced duration.</span>

<span class="sd">    Args:</span>
<span class="sd">      df: Dataframe of which to keep only the first row. If it has an IntervalIndex, the interval is updated to</span>
<span class="sd">          reflect the whole duration.</span>

<span class="sd">    Returns:</span>
<span class="sd">      DataFrame with one row.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
    <span class="n">first_loc</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="c1"># if isinstance(ix, pd.Interval) or (isinstance(ix, tuple) and isinstance(ix[-1], pd.Interval)):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">IntervalIndex</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">idx</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">idx</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>
        <span class="n">iv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Interval</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="n">idx</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
        <span class="n">row</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">IntervalIndex</span><span class="p">([</span><span class="n">iv</span><span class="p">])</span>
        <span class="n">row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">iv</span><span class="p">,</span> <span class="s1">&#39;duration_qb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iv</span><span class="o">.</span><span class="n">length</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_duration</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">duration_qb</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">first_loc</span><span class="p">,</span> <span class="s1">&#39;duration_qb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_duration</span>
    <span class="k">return</span> <span class="n">row</span></div>




<div class="viewcode-block" id="File"><a class="viewcode-back" href="../../reference.html#ms3.utils.File">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">File</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Storing path and file name information for one file.&quot;&quot;&quot;</span>
    <span class="n">ix</span><span class="p">:</span> <span class="nb">int</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Index integer (ID)&quot;&quot;&quot;</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Recognized type ∈ :attr:`ms3._typing.Facet`&quot;&quot;&quot;</span>
    <span class="n">file</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;File name including extension.&quot;&quot;&quot;</span>
    <span class="n">fname</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;fname excluding the suffix (after registering the file with a :obj:`Piece`).&quot;&quot;&quot;</span>
    <span class="n">fext</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;File extensions.&quot;&quot;&quot;</span>
    <span class="n">subdir</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Directory relative to the corpus path (e.g. &#39;./MS3&#39;).&quot;&quot;&quot;</span>
    <span class="n">corpus_path</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Absolute path of the file&#39;s parent directory that is considered as corpus directory.&quot;&quot;&quot;</span>
    <span class="n">rel_path</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;File path relative to the corpus path. Equivalent to &lt;subdir&gt;/&lt;file&gt;.&quot;&quot;&quot;</span>
    <span class="n">full_path</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Absolute file path.&quot;&quot;&quot;</span>
    <span class="n">directory</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Absolute folder path where the file is located.&quot;&quot;&quot;</span>
    <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Upon registering the File with a :obj:`Piece`, if the current fname has a suffix compared to the Piece&#39;s fname, </span>
<span class="sd">    suffix is removed from the File object&#39;s fname field and added to the suffix field.&quot;&quot;&quot;</span>
    <span class="n">commit_sha</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The the file has been retrieved from a particular git revision, this is set to the revision&#39;s hash.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;, suffix: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="n">commit</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_sha</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;@</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">commit_sha</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ix</span><span class="si">}</span><span class="s2">: &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">rel_path</span><span class="si">}</span><span class="s2">&#39;</span><span class="si">{</span><span class="n">commit</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span></div>

<span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">automatically_choose_from_disambiguated_files</span><span class="p">(</span><span class="n">disambiguated_choices</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">File</span><span class="p">],</span>
                                                  <span class="n">fname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                                  <span class="n">file_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                                  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">File</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">disambiguated_choices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">disambiguated_choices</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">disamb_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">disambiguated_choices</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">disambiguated_choices</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">files_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">disamb_series</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">choice_between_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s1">&#39;scores&#39;</span><span class="p">:</span>
        <span class="c1"># if a score is requested, check if there is only a single MSCX or otherwise MSCZ file and pick that</span>
        <span class="n">fexts</span> <span class="o">=</span> <span class="n">files_df</span><span class="o">.</span><span class="n">fext</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">fext_counts</span> <span class="o">=</span> <span class="n">fexts</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;.mscx&#39;</span> <span class="ow">in</span> <span class="n">fext_counts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fext_counts</span><span class="p">[</span><span class="s1">&#39;.mscx&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">selected_file</span> <span class="o">=</span> <span class="n">disamb_series</span><span class="p">[</span><span class="n">fexts</span> <span class="o">==</span> <span class="s1">&#39;.mscx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;In order to pick one from the </span><span class="si">{</span><span class="n">choice_between_n</span><span class="si">}</span><span class="s2"> scores with fname &#39;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&#39;, &#39;</span><span class="si">{</span><span class="n">selected_file</span><span class="o">.</span><span class="n">rel_path</span><span class="si">}</span><span class="s2">&#39; was selected because it is the only &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;one in MSCX format.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">selected_file</span>
        <span class="k">elif</span> <span class="s1">&#39;.mscz&#39;</span> <span class="ow">in</span> <span class="n">fext_counts</span> <span class="ow">and</span> <span class="n">fext_counts</span><span class="p">[</span><span class="s1">&#39;.mscz&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">selected_file</span> <span class="o">=</span> <span class="n">disamb_series</span><span class="p">[</span><span class="n">fexts</span> <span class="o">==</span> <span class="s1">&#39;.mscz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;In order to pick one from the </span><span class="si">{</span><span class="n">choice_between_n</span><span class="si">}</span><span class="s2"> scores with fname &#39;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&#39;, &#39;</span><span class="si">{</span><span class="n">selected_file</span><span class="o">.</span><span class="n">rel_path</span><span class="si">}</span><span class="s2">&#39; was selected because it is the only &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;one in MSCZ format.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">selected_file</span>
    <span class="c1"># as first disambiguation criterion, check if the shortest disambiguation string pertains to 1 file only and pick that</span>
    <span class="n">disamb_str_lengths</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">disamb_series</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">len</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">disamb_series</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">shortest_length_selector</span> <span class="o">=</span> <span class="p">(</span><span class="n">disamb_str_lengths</span> <span class="o">==</span> <span class="n">disamb_str_lengths</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">n_have_shortest_length</span> <span class="o">=</span> <span class="n">shortest_length_selector</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">n_have_shortest_length</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">disamb_str_lengths</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
        <span class="n">selected_file</span> <span class="o">=</span> <span class="n">disamb_series</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;In order to pick one from the </span><span class="si">{</span><span class="n">choice_between_n</span><span class="si">}</span><span class="s2"> &#39;</span><span class="si">{</span><span class="n">file_type</span><span class="si">}</span><span class="s2">&#39; with fname &#39;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&#39;, the one with the shortest disambiguating string &#39;</span><span class="si">{</span><span class="n">ix</span><span class="si">}</span><span class="s2">&#39; was selected.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">selected_file</span>
    <span class="k">if</span> <span class="n">file_type</span> <span class="o">!=</span> <span class="s1">&#39;unknown&#39;</span><span class="p">:</span>
        <span class="c1"># otherwise, check if only one file is lying in a directory with default name</span>
        <span class="n">subdirs</span> <span class="o">=</span> <span class="n">files_df</span><span class="o">.</span><span class="n">subdir</span>
        <span class="n">default_components</span> <span class="o">=</span> <span class="n">file_type2path_component_map</span><span class="p">()[</span><span class="n">file_type</span><span class="p">]</span>
        <span class="n">default_components_regex</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\.&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">default_components</span><span class="p">)</span>
        <span class="n">default_selector</span> <span class="o">=</span> <span class="n">subdirs</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">default_components_regex</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">default_selector</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">subdir</span> <span class="o">=</span> <span class="n">subdirs</span><span class="p">[</span><span class="n">default_selector</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">selected_file</span> <span class="o">=</span> <span class="n">disamb_series</span><span class="p">[</span><span class="n">default_selector</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;In order to pick one from the </span><span class="si">{</span><span class="n">choice_between_n</span><span class="si">}</span><span class="s2"> &#39;</span><span class="si">{</span><span class="n">file_type</span><span class="si">}</span><span class="s2">&#39; with fname &#39;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&#39;, the one in the default subdir &#39;</span><span class="si">{</span><span class="n">subdir</span><span class="si">}</span><span class="s2">&#39; was selected.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">selected_file</span>
        <span class="c1"># or if only one file contains a default name in its suffix</span>
        <span class="n">suffixes</span> <span class="o">=</span> <span class="n">files_df</span><span class="o">.</span><span class="n">suffix</span>
        <span class="n">default_selector</span> <span class="o">=</span> <span class="n">suffixes</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">default_components_regex</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">default_selector</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="n">suffixes</span><span class="p">[</span><span class="n">default_selector</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">selected_file</span> <span class="o">=</span> <span class="n">disamb_series</span><span class="p">[</span><span class="n">default_selector</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;In order to pick one from the </span><span class="si">{</span><span class="n">choice_between_n</span><span class="si">}</span><span class="s2"> &#39;</span><span class="si">{</span><span class="n">file_type</span><span class="si">}</span><span class="s2">&#39; with fname &#39;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&#39;, the one in the default suffix &#39;</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&#39; was selected.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">selected_file</span>
    <span class="c1"># if no file was selected, try again with only those having the shortest disambiguation strings</span>
    <span class="k">if</span> <span class="n">shortest_length_selector</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="c1"># if all disambiguation strings already have the shortest length, as a last resort</span>
        <span class="c1"># fall back to the lexigographically first</span>
        <span class="n">sorted_disamb_series</span> <span class="o">=</span> <span class="n">disamb_series</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="n">disamb</span> <span class="o">=</span> <span class="n">sorted_disamb_series</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">selected_file</span> <span class="o">=</span> <span class="n">sorted_disamb_series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to automatically choose from the </span><span class="si">{</span><span class="n">choice_between_n</span><span class="si">}</span><span class="s2"> &#39;</span><span class="si">{</span><span class="n">file_type</span><span class="si">}</span><span class="s2">&#39; with fname &#39;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&#39;. I&#39;m picking &#39;</span><span class="si">{</span><span class="n">selected_file</span><span class="o">.</span><span class="n">rel_path</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;because its disambiguation string &#39;</span><span class="si">{</span><span class="n">disamb</span><span class="si">}</span><span class="s2">&#39; is the lexicographically first among </span><span class="si">{</span><span class="n">sorted_disamb_series</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">selected_file</span>
    <span class="n">only_shortest_disamb_str</span> <span class="o">=</span> <span class="n">disamb_series</span><span class="p">[</span><span class="n">shortest_length_selector</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After the first unsuccessful attempt to choose from </span><span class="si">{</span><span class="n">choice_between_n</span><span class="si">}</span><span class="s2"> &#39;</span><span class="si">{</span><span class="n">file_type</span><span class="si">}</span><span class="s2">&#39; with fname &#39;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&#39;, trying again &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;after reducing the choices to the </span><span class="si">{</span><span class="n">shortest_length_selector</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> with the shortest disambiguation strings.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">automatically_choose_from_disambiguated_files</span><span class="p">(</span><span class="n">only_shortest_disamb_str</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">file_type</span><span class="p">)</span>

<div class="viewcode-block" id="ask_user_to_choose"><a class="viewcode-back" href="../../reference.html#ms3.utils.ask_user_to_choose">[docs]</a><span class="k">def</span> <span class="nf">ask_user_to_choose</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">choices</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ask user to input an integer and return the nth choice selected by the user.&quot;&quot;&quot;</span>
    <span class="n">n_choices</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">choices</span><span class="p">)</span>
    <span class="n">range_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;1-</span><span class="si">{</span><span class="n">n_choices</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">int_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value &#39;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&#39; could not be converted to an integer.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">int_i</span> <span class="o">&lt;=</span> <span class="n">n_choices</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value &#39;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&#39; is not within </span><span class="si">{</span><span class="n">range_str</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">int_i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">choices</span><span class="p">[</span><span class="n">int_i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span></div>


<span class="k">def</span> <span class="nf">ask_user_to_choose_from_disambiguated_files</span><span class="p">(</span><span class="n">disambiguated_choices</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">File</span><span class="p">],</span>
                                                <span class="n">fname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                                <span class="n">file_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">File</span><span class="p">]:</span>
    <span class="n">sorted_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">disambiguated_choices</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">s</span><span class="p">))</span>
    <span class="n">disambiguated_choices</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">disambiguated_choices</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sorted_keys</span><span class="p">}</span>
    <span class="n">file_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">disambiguated_choices</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">disamb_strings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">disambiguated_choices</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;disambiguation_str&#39;</span><span class="p">)</span>
    <span class="n">choices_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">disamb_strings</span><span class="p">,</span>
                            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">file_list</span><span class="p">)[[</span><span class="s1">&#39;rel_path&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;ix&#39;</span><span class="p">]]],</span>
                           <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">choices_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;select:&#39;</span><span class="p">)</span>
    <span class="n">range_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;1-</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">disambiguated_choices</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Selection [</span><span class="si">{</span><span class="n">range_str</span><span class="si">}</span><span class="s2">]: &quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Several &#39;</span><span class="si">{</span><span class="n">file_type</span><span class="si">}</span><span class="s2">&#39; available for &#39;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2">&#39;:</span><span class="se">\n</span><span class="si">{</span><span class="n">choices_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Please select one of the files by passing an integer between </span><span class="si">{</span><span class="n">range_str</span><span class="si">}</span><span class="s2"> (or 0 for none):&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ask_user_to_choose</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">file_list</span><span class="p">)</span>


<div class="viewcode-block" id="disambiguate_files"><a class="viewcode-back" href="../../reference.html#ms3.utils.disambiguate_files">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">disambiguate_files</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="n">File</span><span class="p">],</span> <span class="n">fname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">choose</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;ask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">File</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Receives a collection of :obj:`File` with the aim to pick one of them.</span>
<span class="sd">    First, a dictionary is created where the keys are disambiguation strings based on the files&#39; paths and</span>
<span class="sd">    suffixes.</span>

<span class="sd">    Args:</span>
<span class="sd">      files:</span>
<span class="sd">      choose: If &#39;auto&#39; (default), the file with the shortest disambiguation string is chosen. Set to True</span>
<span class="sd">          if you want to be asked to manually choose a file.</span>

<span class="sd">    Returns:</span>
<span class="sd">      The selected file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_files</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_files</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">choose</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;ask&#39;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The value for choose needs to be &#39;auto&#39; or &#39;ask&#39;, not </span><span class="si">{</span><span class="n">choose</span><span class="si">}</span><span class="s2">. Setting to &#39;auto&#39;.&quot;</span><span class="p">)</span>
        <span class="n">choose</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>
    <span class="n">disambiguation_dict</span> <span class="o">=</span> <span class="n">files2disambiguation_dict</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">choose</span> <span class="o">==</span> <span class="s1">&#39;ask&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ask_user_to_choose_from_disambiguated_files</span><span class="p">(</span><span class="n">disambiguation_dict</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">file_type</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">automatically_choose_from_disambiguated_files</span><span class="p">(</span><span class="n">disambiguation_dict</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">file_type</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span></div>

<span class="c1"># @function_logger</span>
<span class="c1"># def disambiguate_parsed_files(tuples_with_file_as_first_element: Collection[Tuple], fname: str, file_type: str, choose: Literal[&#39;auto&#39;, &#39;ask&#39;] = &#39;auto&#39;) -&gt; Optional[File]:</span>
<span class="c1">#     files = [tup[0] for tup in tuples_with_file_as_first_element]</span>
<span class="c1">#     selected = disambiguate_files(files, fname=fname, file_type=file_type, choose=choose, logger=logger)</span>
<span class="c1">#     if selected is None:</span>
<span class="c1">#         return</span>
<span class="c1">#     for tup in tuples_with_file_as_first_element:</span>
<span class="c1">#         if tup[0] == selected:</span>
<span class="c1">#             return tup</span>


<div class="viewcode-block" id="files2disambiguation_dict"><a class="viewcode-back" href="../../reference.html#ms3.utils.files2disambiguation_dict">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">files2disambiguation_dict</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="n">File</span><span class="p">],</span> <span class="n">include_disambiguator</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FileDict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Takes a list of :class:`File` returns a dictionary with disambiguating strings based on path components.</span>
<span class="sd">    of distinct strings to distinguish files pertaining to the same type.&quot;&quot;&quot;</span>
    <span class="n">n_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_files</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_files</span><span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">f</span><span class="o">.</span><span class="n">type</span><span class="p">:</span> <span class="n">f</span><span class="p">}</span>
    <span class="n">disambiguation</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">disambiguation</span><span class="p">))</span> <span class="o">==</span> <span class="n">n_files</span><span class="p">:</span>
        <span class="c1"># done disambiguating</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">disambiguation</span><span class="p">,</span> <span class="n">files</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">include_disambiguator</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">disambiguation</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Including the disambiguator removes the facet name, but the files pertain to &quot;</span>
                     <span class="sa">f</span><span class="s2">&quot;several facets: </span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="n">disambiguation</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># first, try to disambiguate based on the files&#39; sub-directories</span>
    <span class="n">subdirs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">file_type</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">type</span>
        <span class="n">subdir</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">subdir</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\/.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">subdir</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">file_type</span><span class="p">):</span>
            <span class="n">subdir</span> <span class="o">=</span> <span class="n">subdir</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">file_type</span><span class="p">):]</span>
        <span class="k">if</span> <span class="n">subdir</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\/&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">subdir</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">subdirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subdir</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">subdirs</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># files can (partially) be disambiguated because they are in different sub-directories</span>
        <span class="k">if</span> <span class="n">include_disambiguator</span><span class="p">:</span>
            <span class="n">disambiguation</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;subdir: </span><span class="si">{</span><span class="s1">&#39;.&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">subdir</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">subdir</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">disamb</span><span class="p">,</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">disambiguation</span><span class="p">,</span> <span class="n">subdirs</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">disambiguation</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">disamb</span><span class="p">,</span> <span class="n">subdir</span><span class="p">)</span> <span class="k">for</span> <span class="n">disamb</span><span class="p">,</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">disambiguation</span><span class="p">,</span> <span class="n">subdirs</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">disambiguation</span><span class="p">))</span> <span class="o">==</span> <span class="n">n_files</span><span class="p">:</span>
        <span class="c1"># done disambiguating</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">disambiguation</span><span class="p">,</span> <span class="n">files</span><span class="p">))</span>
    <span class="c1"># next, try adding detected suffixes</span>
    <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">include_disambiguator</span><span class="p">:</span>
                <span class="n">disambiguation</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, suffix: </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">disambiguation</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">]&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">disambiguation</span><span class="p">))</span> <span class="o">==</span> <span class="n">n_files</span><span class="p">:</span>
        <span class="c1"># done disambiguating</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">disambiguation</span><span class="p">,</span> <span class="n">files</span><span class="p">))</span>
    <span class="c1"># now, add file extensions to disambiguate further</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fext</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">include_disambiguator</span><span class="p">:</span>
                <span class="n">disambiguation</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, fext: </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">fext</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">disambiguation</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">+=</span> <span class="n">f</span><span class="o">.</span><span class="n">fext</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">disambiguation</span><span class="p">))</span> <span class="o">==</span> <span class="n">n_files</span><span class="p">:</span>
        <span class="c1"># done disambiguating</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">disambiguation</span><span class="p">,</span> <span class="n">files</span><span class="p">))</span>
    <span class="n">str_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">disambiguation</span><span class="p">)</span>
    <span class="n">duplicate_disambiguation_strings</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="n">str_counts</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">ambiguate_files</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">disamb</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">disambiguation</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span> <span class="k">if</span> <span class="n">disamb</span> <span class="o">==</span> <span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">duplicate_disambiguation_strings</span><span class="p">}</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">disambiguation</span><span class="p">,</span> <span class="n">files</span><span class="p">))</span>
    <span class="n">remaining_ones</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">duplicate_disambiguation_strings</span><span class="p">}</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The following files could not be ambiguated: </span><span class="si">{</span><span class="n">ambiguate_files</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="sa">f</span><span class="s2">&quot;In the result, only these remain: </span><span class="si">{</span><span class="n">remaining_ones</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="literal_type2tuple"><a class="viewcode-back" href="../../reference.html#ms3.utils.literal_type2tuple">[docs]</a><span class="k">def</span> <span class="nf">literal_type2tuple</span><span class="p">(</span><span class="n">typ</span><span class="p">:</span> <span class="n">TypeVar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Turns the first Literal included in the TypeVar into a list of values. The first literal value</span>
<span class="sd">    needs to be a string, otherwise the function may lead to unexpected behaviour.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">typ</span><span class="o">.</span><span class="n">__args__</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">typ</span><span class="o">.</span><span class="n">__args__</span>
    <span class="k">return</span> <span class="n">literal_type2tuple</span><span class="p">(</span><span class="n">typ</span><span class="o">.</span><span class="n">__args__</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="argument_and_literal_type2list"><a class="viewcode-back" href="../../reference.html#ms3.utils.argument_and_literal_type2list">[docs]</a><span class="nd">@lru_cache</span>
<span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">argument_and_literal_type2list</span><span class="p">(</span><span class="n">argument</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">]],</span>
                                   <span class="n">typ</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">TypeVar</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                   <span class="n">none_means_all</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                   <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Makes sure that an input value is a list of strings and that all strings are valid w.r.t. to</span>
<span class="sd">    the type&#39;s expected literal values (strings).</span>

<span class="sd">    Args:</span>
<span class="sd">      argument:</span>
<span class="sd">          If string, wrapped in a list, otherwise expected to be a tuple of strings (passing a list will fail).</span>
<span class="sd">          If None, a list of all possible values according to the type is returned if none_means_all.</span>
<span class="sd">      typ:</span>
<span class="sd">          A typing.Literal declaration or a TypeVar where the first component is one, or a tuple of allowed values.</span>
<span class="sd">          All allowed values should be strings.</span>
<span class="sd">      none_means_all:</span>
<span class="sd">          By default, None values are replaced with all allowed values, if specified.</span>
<span class="sd">          Pass False to return None in this case.</span>

<span class="sd">    Returns:</span>
<span class="sd">      The list of accepted strings.</span>
<span class="sd">      The list of rejected strings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">allowed</span> <span class="o">=</span> <span class="n">typ</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">allowed</span> <span class="o">=</span> <span class="n">literal_type2tuple</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">argument</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">none_means_all</span> <span class="ow">and</span> <span class="n">allowed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">allowed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">argument</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">argument</span> <span class="o">=</span> <span class="p">[</span><span class="n">argument</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">allowed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">argument</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">singular_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">allwd</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="n">allwd</span> <span class="k">for</span> <span class="n">allwd</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">}</span>
    <span class="n">accepted</span><span class="p">,</span> <span class="n">rejected</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">argument</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">:</span>
            <span class="n">accepted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">singular_dict</span><span class="p">:</span>
            <span class="n">accepted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">singular_dict</span><span class="p">[</span><span class="n">arg</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rejected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="n">n_rejected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rejected</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_rejected</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n_rejected</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;This is not an accepted value: </span><span class="si">{</span><span class="n">rejected</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;Choose from </span><span class="si">{</span><span class="n">allowed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;These are not accepted value, only: </span><span class="si">{</span><span class="n">rejected</span><span class="si">}</span><span class="s2">&quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;Choose from </span><span class="si">{</span><span class="n">allowed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">accepted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">accepted</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pass at least one of </span><span class="si">{</span><span class="n">allowed</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">return</span></div>

<span class="n">L</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">)</span>

<span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">check_argument_against_literal_type</span><span class="p">(</span><span class="n">argument</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                        <span class="n">typ</span><span class="p">:</span> <span class="n">L</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">L</span><span class="p">]:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">argument</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Argument needs to be a string, not &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">argument</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">allowed</span> <span class="o">=</span> <span class="n">literal_type2tuple</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
    <span class="n">singular_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">allwd</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="n">allwd</span> <span class="k">for</span> <span class="n">allwd</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">argument</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed</span> <span class="ow">and</span> <span class="n">argument</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">singular_dict</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid argument &#39;</span><span class="si">{</span><span class="n">argument</span><span class="si">}</span><span class="s2">&#39;. Pass one of </span><span class="si">{</span><span class="n">allowed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">argument</span> <span class="ow">in</span> <span class="n">singular_dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">singular_dict</span><span class="p">[</span><span class="n">argument</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">argument</span>

<div class="viewcode-block" id="resolve_facets_param"><a class="viewcode-back" href="../../reference.html#ms3.utils.resolve_facets_param">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">resolve_facets_param</span><span class="p">(</span><span class="n">facets</span><span class="p">,</span> <span class="n">facet_type_var</span><span class="p">:</span> <span class="n">TypeVar</span> <span class="o">=</span> <span class="n">Facet</span><span class="p">,</span> <span class="n">none_means_all</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Like :func:`argument_and_literal_type2list`, but also resolves &#39;tsv&#39; to all non-score facets.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">facets</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">facets</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;tsvs&#39;</span><span class="p">):</span>
        <span class="n">selected_facets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">literal_type2tuple</span><span class="p">(</span><span class="n">facet_type_var</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;scores&#39;</span> <span class="ow">in</span> <span class="n">selected_facets</span><span class="p">:</span>
            <span class="n">selected_facets</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;scores&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">facets</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">facets</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">facets</span><span class="p">)</span>
        <span class="n">selected_facets</span> <span class="o">=</span> <span class="n">argument_and_literal_type2list</span><span class="p">(</span><span class="n">facets</span><span class="p">,</span> <span class="n">facet_type_var</span><span class="p">,</span> <span class="n">none_means_all</span><span class="o">=</span><span class="n">none_means_all</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="c1">#logger.debug(f&quot;Resolved argument &#39;{facets}&#39; to {selected_facets}.&quot;)</span>
    <span class="k">return</span> <span class="n">selected_facets</span></div>

<span class="k">def</span> <span class="nf">bold_font</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[1m</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="se">\033</span><span class="s2">[0;0m&quot;</span>

<span class="k">def</span> <span class="nf">available_views2str</span><span class="p">(</span><span class="n">views_dict</span><span class="p">:</span> <span class="n">ViewDict</span><span class="p">,</span> <span class="n">active_view_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">view_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">view</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">view</span> <span class="ow">in</span> <span class="n">views_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">current_view</span> <span class="o">=</span> <span class="n">view_names</span><span class="p">[</span><span class="n">active_view_name</span><span class="p">]</span>
    <span class="n">view_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">bold_font</span><span class="p">(</span><span class="n">current_view</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">view_names</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="n">current_view</span><span class="p">]</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">view_list</span><span class="p">)</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>


<div class="viewcode-block" id="unpack_json_paths"><a class="viewcode-back" href="../../reference.html#ms3.utils.unpack_json_paths">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">unpack_json_paths</span><span class="p">(</span><span class="n">paths</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mutates the list with paths by replacing .json files with the list (of paths) contained in them.&quot;&quot;&quot;</span>
    <span class="n">json_ixs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_ixs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">json_ixs</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">loaded_paths</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">paths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">loaded_paths</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unpacked the </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">loaded_paths</span><span class="p">)</span><span class="si">}</span><span class="s2"> paths found in </span><span class="si">{</span><span class="n">paths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">del</span> <span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not load paths from </span><span class="si">{</span><span class="n">paths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> because of the following error(s):</span><span class="se">\n</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="resolve_paths_argument"><a class="viewcode-back" href="../../reference.html#ms3.utils.resolve_paths_argument">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">resolve_paths_argument</span><span class="p">(</span><span class="n">paths</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
                           <span class="n">files</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Makes sure that the given path(s) exists(s) and filters out those that don&#39;t.</span>

<span class="sd">    Args:</span>
<span class="sd">      paths: One or several paths given as strings.</span>
<span class="sd">      files: By default, only file paths are returned. Set to False to return only folders.</span>

<span class="sd">    Returns:</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">paths</span><span class="p">]</span>
    <span class="n">resolved_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">resolve_dir</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">not_a_file</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_a_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_a_file</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;No existing file at </span><span class="si">{</span><span class="n">not_a_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;These are not paths of existing files: </span><span class="si">{</span><span class="n">not_a_file</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">resolved_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">not_a_folder</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_a_folder</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">not_a_folder</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">not_a_folder</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> is not a path to an existing folder.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;These are not paths of existing folders: </span><span class="si">{</span><span class="n">not_a_folder</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">resolved_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">resolved_paths</span></div>

<div class="viewcode-block" id="compute_path_from_file"><a class="viewcode-back" href="../../reference.html#ms3.utils.compute_path_from_file">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">compute_path_from_file</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="n">File</span><span class="p">,</span>
                           <span class="n">root_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">folder</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constructs a path based on the arguments.</span>

<span class="sd">    Args:</span>
<span class="sd">      file: This function uses the fields corpus_path, subdir, and type.</span>
<span class="sd">      root_dir:</span>
<span class="sd">          Defaults to None, meaning that the path is constructed based on the corpus_path.</span>
<span class="sd">          Pass a directory to construct the path relative to it instead. If ``folder`` is an absolute path,</span>
<span class="sd">          ``root_dir`` is ignored.</span>
<span class="sd">      folder:</span>
<span class="sd">          * If ``folder`` is None (default), the files&#39; type will be appended to the ``root_dir``.</span>
<span class="sd">          * If ``folder`` is an absolute path, ``root_dir`` will be ignored.</span>
<span class="sd">          * If ``folder`` is a relative path starting with a dot ``.`` the relative path is appended to the file&#39;s subdir.</span>
<span class="sd">            For example, ``..\notes`` will resolve to a sibling directory of the one where the ``file`` is located.</span>
<span class="sd">          * If ``folder`` is a relative path that does not begin with a dot ``.``, it will be appended to the</span>
<span class="sd">            ``root_dir``.</span>
<span class="sd">          * If ``folder`` == &#39;&#39; (empty string), the result will be `root_dir`.</span>

<span class="sd">    Returns:</span>
<span class="sd">      The constructed directory path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">folder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;~&#39;</span> <span class="ow">in</span> <span class="n">folder</span><span class="p">):</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">resolve_dir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">folder</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">corpus_path</span> <span class="k">if</span> <span class="n">root_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">resolve_dir</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">folder</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">root</span>
        <span class="k">elif</span> <span class="n">folder</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">subdir</span><span class="p">,</span> <span class="n">folder</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">folder</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">path</span></div>

<div class="viewcode-block" id="make_file_path"><a class="viewcode-back" href="../../reference.html#ms3.utils.make_file_path">[docs]</a><span class="k">def</span> <span class="nf">make_file_path</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="n">File</span><span class="p">,</span>
                   <span class="n">root_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                   <span class="n">fext</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;.tsv&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Constructs a file path based on the arguments.</span>

<span class="sd">    Args:</span>
<span class="sd">      file: This function uses the fields fname, corpus_path, subdir, and type.</span>
<span class="sd">      root_dir:</span>
<span class="sd">        Defaults to None, meaning that the path is constructed based on the corpus_path.</span>
<span class="sd">        Pass a directory to construct the path relative to it instead. If ``folder`` is an absolute path,</span>
<span class="sd">        ``root_dir`` is ignored.</span>
<span class="sd">      folder:</span>
<span class="sd">        Different behaviours are available. Note that only the third option ensures that file paths are distinct for</span>
<span class="sd">        files that have identical fnames but are located in different subdirectories of the same corpus.</span>
<span class="sd">        * If ``folder`` is None (default), the files&#39; type will be appended to the ``root_dir``.</span>
<span class="sd">        * If ``folder`` is an absolute path, ``root_dir`` will be ignored.</span>
<span class="sd">        * If ``folder`` is a relative path starting with a dot ``.`` the relative path is appended to the file&#39;s subdir.</span>
<span class="sd">          For example, ``..\notes`` will resolve to a sibling directory of the one where the ``file`` is located.</span>
<span class="sd">        * If ``folder`` is a relative path that does not begin with a dot ``.``, it will be appended to the</span>
<span class="sd">          ``root_dir``.</span>
<span class="sd">      suffix: String to append to the file&#39;s fname.</span>
<span class="sd">      fext: File extension to append to the (fname+suffix). Defaults to ``.tsv``.</span>

<span class="sd">    Returns:</span>
<span class="sd">      The constructed file path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">fext</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">compute_path_from_file</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">root_dir</span><span class="o">=</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">fname</span> <span class="o">+</span> <span class="n">suffix</span> <span class="o">+</span> <span class="n">fext</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span></div>

<div class="viewcode-block" id="string2identifier"><a class="viewcode-back" href="../../reference.html#ms3.utils.string2identifier">[docs]</a><span class="k">def</span> <span class="nf">string2identifier</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">remove_leading_underscore</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transform a string in a way that it can be used as identifier (variable or attribute name).</span>
<span class="sd">    Solution by Kenan Banks on https://stackoverflow.com/a/3303361</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Remove invalid characters</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[^0-9a-zA-Z_]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

    <span class="c1"># Remove leading characters until we find a letter or underscore</span>
    <span class="n">regex</span> <span class="o">=</span> <span class="s1">&#39;^[^a-zA-Z]+&#39;</span> <span class="k">if</span> <span class="n">remove_leading_underscore</span> <span class="k">else</span> <span class="s1">&#39;^[^a-zA-Z_]+&#39;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">s</span></div>

<span class="nd">@lru_cache</span><span class="p">()</span>
<span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">get_git_commit</span><span class="p">(</span><span class="n">repo_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">git_revision</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">git</span><span class="o">.</span><span class="n">Commit</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">git</span><span class="o">.</span><span class="n">Repo</span><span class="p">(</span><span class="n">repo_path</span><span class="p">,</span> <span class="n">search_parent_directories</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">repo_path</span><span class="si">}</span><span class="s2"> is not an existing git repository: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">repo</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">git_revision</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">BadName</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">git_revision</span><span class="si">}</span><span class="s2"> does not resolve to a commit for repo </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">repo_path</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="parse_tsv_file_at_git_revision"><a class="viewcode-back" href="../../reference.html#ms3.utils.parse_tsv_file_at_git_revision">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">parse_tsv_file_at_git_revision</span><span class="p">(</span><span class="n">file</span><span class="p">:</span> <span class="n">File</span><span class="p">,</span>
                                   <span class="n">git_revision</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                   <span class="n">repo_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FileDataframeTupleMaybe</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pass a File object of a TSV file and an identifier for a git revision to retrieve the parsed TSV file at that commit.</span>
<span class="sd">    The file needs to have existed at the revision in question.</span>

<span class="sd">    Args:</span>
<span class="sd">      file:</span>
<span class="sd">      git_revision:</span>
<span class="sd">      repo_path:</span>

<span class="sd">    Returns:</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;scores&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parsing older revisions of scores is not implemented. Checkout the revision yourself.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">repo_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">repo_path</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">corpus_path</span>
    <span class="n">commit</span> <span class="o">=</span> <span class="n">get_git_commit</span><span class="p">(</span><span class="n">repo_path</span><span class="p">,</span> <span class="n">git_revision</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">commit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">commit_sha</span> <span class="o">=</span> <span class="n">commit</span><span class="o">.</span><span class="n">hexsha</span>
    <span class="n">short_sha</span> <span class="o">=</span> <span class="n">commit_sha</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span>
    <span class="n">commit_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">short_sha</span><span class="si">}</span><span class="s2"> with message &#39;</span><span class="si">{</span><span class="n">commit</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="k">if</span> <span class="n">short_sha</span> <span class="o">!=</span> <span class="n">git_revision</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolved &#39;</span><span class="si">{</span><span class="n">git_revision</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="n">short_sha</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
    <span class="n">rel_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">rel_path</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">targetfile</span> <span class="o">=</span> <span class="n">commit</span><span class="o">.</span><span class="n">tree</span> <span class="o">/</span> <span class="n">rel_path</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="c1"># add logic here to find older path when the file has been moved or renamed</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rel_path</span><span class="si">}</span><span class="s2"> did not exist at commit </span><span class="si">{</span><span class="n">commit_info</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">targetfile</span><span class="o">.</span><span class="n">data_stream</span><span class="o">.</span><span class="n">read</span><span class="p">())</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="n">load_tsv</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parsing </span><span class="si">{</span><span class="n">rel_path</span><span class="si">}</span><span class="s2"> @ commit </span><span class="si">{</span><span class="n">commit_info</span><span class="si">}</span><span class="s2"> failed with the following exception:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">new_file</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">commit_sha</span><span class="o">=</span><span class="n">commit_sha</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_file</span><span class="p">,</span> <span class="n">parsed</span></div>


<span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">check_phrase_annotations</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                             <span class="n">column</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
    <span class="n">p_col</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
    <span class="n">opening</span> <span class="o">=</span> <span class="n">p_col</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">)</span>
    <span class="n">closing</span> <span class="o">=</span> <span class="n">p_col</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;mn_playthrough&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">position_col</span> <span class="o">=</span> <span class="s1">&#39;mn_playthrough&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column &#39;mn_playthrough&#39; is missing, so my assessment of the phrase annotations might be wrong.&quot;</span><span class="p">)</span>
        <span class="n">position_col</span> <span class="o">=</span> <span class="s1">&#39;mn&#39;</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">position_col</span><span class="p">,</span> <span class="n">column</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">opening</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">!=</span> <span class="n">closing</span><span class="o">.</span><span class="n">sum</span><span class="p">():</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">opening</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">columns</span><span class="p">]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">closing</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">columns</span><span class="p">]</span>
        <span class="n">compare</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">o</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">c</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;mn&#39;</span> <span class="ow">in</span> <span class="n">compare</span><span class="p">:</span>
            <span class="n">compare</span> <span class="o">=</span> <span class="n">compare</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s1">&#39;mn&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">})</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Phrase beginning and endings don&#39;t match:</span><span class="se">\n</span><span class="si">{</span><span class="n">compare</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">16</span><span class="p">,)})</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>
</pre></div>

            </article>
            
            
            
            <footer class="bd-footer-article">
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
            
          </div>
          
          
          
            <div class="bd-sidebar-secondary bd-toc">
              
<div class="toc-item">
  
<div id="searchbox"></div>
</div>

<div class="toc-item">
  
</div>

<div class="toc-item">
  
</div>

            </div>
          
          
        </div>
        <footer class="bd-footer-content">
          <div class="bd-footer-content__inner">
            
          </div>
        </footer>
        
      </main>
    </div>
  </div>

  
    
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94"></script>

  <footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    
<p class="copyright">

    &copy; Copyright 2020, johentsch.<br>

</p>

  </div>
  
  <div class="footer-item">
    <p class="theme-version">
    Built with the
    <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">
        PyData Sphinx Theme
    </a>
    0.12.0.
</p>
  </div>
  
  <div class="footer-item">
    
<p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.3.0.<br>
</p>

  </div>
  
</div>
  </footer>
  </body>
</html>