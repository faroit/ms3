


<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ms3.utils &#8212; ms3 0.5.3.post0.dev88+g764fcd4.dirty documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/cloud.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noticia+Text:400,i,b,bi|Open+Sans:400,i,b,bi|Roboto+Mono:400,i,b,bi&amp;display=swap" type="text/css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>

    
    
     
        <script src="../../_static/jquery.cookie.js"></script>
    

    
     
        <script src="../../_static/cloud.base.js"></script>
    

    
     
        <script src="../../_static/cloud.js"></script>
    

    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">ms3 0.5.3.post0.dev88+g764fcd4.dirty documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">ms3.utils</a></li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ms3.utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">sys</span><span class="o">,</span> <span class="nn">platform</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Iterator</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">fractions</span> <span class="kn">import</span> <span class="n">Fraction</span> <span class="k">as</span> <span class="n">frac</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">repeat</span><span class="p">,</span> <span class="n">takewhile</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">which</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">NamedTemporaryFile</span> <span class="k">as</span> <span class="n">Temp</span>
<span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span> <span class="k">as</span> <span class="n">Zip</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">webcolors</span>
<span class="kn">from</span> <span class="nn">pathos</span> <span class="kn">import</span> <span class="n">multiprocessing</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">pytablewriter</span> <span class="kn">import</span> <span class="n">MarkdownTableWriter</span>

<span class="kn">from</span> <span class="nn">.logger</span> <span class="kn">import</span> <span class="n">function_logger</span><span class="p">,</span> <span class="n">update_cfg</span><span class="p">,</span> <span class="n">LogCapturer</span>

<span class="n">METADATA_COLUMN_ORDER</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rel_paths&#39;</span><span class="p">,</span> <span class="s1">&#39;fnames&#39;</span><span class="p">,</span> <span class="s1">&#39;last_mc&#39;</span><span class="p">,</span> <span class="s1">&#39;last_mn&#39;</span><span class="p">,</span> <span class="s1">&#39;length_qb&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;length_qb_unfolded&#39;</span><span class="p">,</span> <span class="s1">&#39;all_notes_qb&#39;</span><span class="p">,</span> <span class="s1">&#39;n_onsets&#39;</span><span class="p">,</span> <span class="s1">&#39;n_onset_positions&#39;</span><span class="p">,</span> <span class="s1">&#39;TimeSig&#39;</span><span class="p">,</span> <span class="s1">&#39;KeySig&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;label_count&#39;</span><span class="p">,</span> <span class="s1">&#39;annotated_key&#39;</span><span class="p">,</span> <span class="s1">&#39;annotators&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;reviewers&#39;</span><span class="p">,</span> <span class="s1">&#39;composer&#39;</span><span class="p">,</span> <span class="s1">&#39;workTitle&#39;</span><span class="p">,</span> <span class="s1">&#39;movementNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;movementTitle&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;workNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;poet&#39;</span><span class="p">,</span> <span class="s1">&#39;lyricist&#39;</span><span class="p">,</span> <span class="s1">&#39;arranger&#39;</span><span class="p">,</span> <span class="s1">&#39;copyright&#39;</span><span class="p">,</span> <span class="s1">&#39;creationDate&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;mscVersion&#39;</span><span class="p">,</span> <span class="s1">&#39;platform&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;translator&#39;</span><span class="p">,</span> <span class="s1">&#39;musescore&#39;</span><span class="p">,</span> <span class="s1">&#39;ambitus&#39;</span><span class="p">]</span>

<span class="n">STANDARD_COLUMN_ORDER</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;mc_playthrough&#39;</span><span class="p">,</span> <span class="s1">&#39;mn&#39;</span><span class="p">,</span> <span class="s1">&#39;mn_playthrough&#39;</span><span class="p">,</span> <span class="s1">&#39;quarterbeats&#39;</span><span class="p">,</span> <span class="s1">&#39;mc_onset&#39;</span><span class="p">,</span> <span class="s1">&#39;mn_onset&#39;</span><span class="p">,</span> <span class="s1">&#39;beat&#39;</span><span class="p">,</span>
    <span class="s1">&#39;event&#39;</span><span class="p">,</span> <span class="s1">&#39;timesig&#39;</span><span class="p">,</span> <span class="s1">&#39;staff&#39;</span><span class="p">,</span> <span class="s1">&#39;voice&#39;</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="s1">&#39;tied&#39;</span><span class="p">,</span>
    <span class="s1">&#39;gracenote&#39;</span><span class="p">,</span> <span class="s1">&#39;nominal_duration&#39;</span><span class="p">,</span> <span class="s1">&#39;scalar&#39;</span><span class="p">,</span> <span class="s1">&#39;tpc&#39;</span><span class="p">,</span> <span class="s1">&#39;midi&#39;</span><span class="p">,</span> <span class="s1">&#39;volta&#39;</span><span class="p">,</span> <span class="s1">&#39;chord_id&#39;</span><span class="p">]</span>

<span class="n">STANDARD_NAMES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;notes&#39;</span><span class="p">,</span> <span class="s1">&#39;rests&#39;</span><span class="p">,</span> <span class="s1">&#39;notes_and_rests&#39;</span><span class="p">,</span> <span class="s1">&#39;measures&#39;</span><span class="p">,</span> <span class="s1">&#39;events&#39;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">,</span> <span class="s1">&#39;chords&#39;</span><span class="p">,</span> <span class="s1">&#39;expanded&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;harmonies&#39;</span><span class="p">,</span> <span class="s1">&#39;cadences&#39;</span><span class="p">,</span> <span class="s1">&#39;form_labels&#39;</span><span class="p">,</span> <span class="s1">&#39;MS3&#39;</span><span class="p">,</span> <span class="s1">&#39;scores&#39;</span><span class="p">]</span>
<span class="sd">&quot;&quot;&quot;:obj:`list`</span>
<span class="sd">Indicators for corpora: If a folder contains any file or folder beginning or ending on any of these names, it is </span>
<span class="sd">considered to be a corpus by the function :py:func:`iterate_corpora`.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">STANDARD_NAMES_OR_GIT</span> <span class="o">=</span> <span class="n">STANDARD_NAMES</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;.git&quot;</span><span class="p">]</span>


<span class="n">DCML_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">^(\.?</span>
<span class="s2">    ((?P&lt;globalkey&gt;[a-gA-G](b*|\#*))\.)?</span>
<span class="s2">    ((?P&lt;localkey&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)+)\.)?</span>
<span class="s2">    ((?P&lt;pedal&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)+)\[)?</span>
<span class="s2">    (?P&lt;chord&gt;</span>
<span class="s2">        (?P&lt;numeral&gt;(b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i|Ger|It|Fr|@none))</span>
<span class="s2">        (?P&lt;form&gt;(%|o|\+|M|\+M))?</span>
<span class="s2">        (?P&lt;figbass&gt;(7|65|43|42|2|64|6))?</span>
<span class="s2">        (\((?P&lt;changes&gt;((\+|-|\^|v)?(b*|\#*)\d)+)\))?</span>
<span class="s2">        (/(?P&lt;relativeroot&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)*))?</span>
<span class="s2">    )</span>
<span class="s2">    (?P&lt;pedalend&gt;\])?</span>
<span class="s2">)?</span>
<span class="s2">(\|(?P&lt;cadence&gt;((HC|PAC|IAC|DC|EC|PC)(\..+?)?)))?</span>
<span class="s2">(?P&lt;phraseend&gt;(\\\\|\}\{|\{|\}))?$</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;:obj:`str`</span>
<span class="sd">Constant with a regular expression that recognizes labels conforming to the DCML harmony annotation standard excluding those</span>
<span class="sd">consisting of two alternatives.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">DCML_DOUBLE_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                                ^(?P&lt;first&gt;</span>
<span class="s2">                                  (\.?</span>
<span class="s2">                                    ((?P&lt;globalkey&gt;[a-gA-G](b*|\#*))\.)?</span>
<span class="s2">                                    ((?P&lt;localkey&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)+)\.)?</span>
<span class="s2">                                    ((?P&lt;pedal&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)+)\[)?</span>
<span class="s2">                                    (?P&lt;chord&gt;</span>
<span class="s2">                                        (?P&lt;numeral&gt;(b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i|Ger|It|Fr|@none))</span>
<span class="s2">                                        (?P&lt;form&gt;(%|o|\+|M|\+M))?</span>
<span class="s2">                                        (?P&lt;figbass&gt;(7|65|43|42|2|64|6))?</span>
<span class="s2">                                        (\((?P&lt;changes&gt;((\+|-|\^|v)?(b*|\#*)\d)+)\))?</span>
<span class="s2">                                        (/(?P&lt;relativeroot&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)*))?</span>
<span class="s2">                                    )</span>
<span class="s2">                                    (?P&lt;pedalend&gt;\])?</span>
<span class="s2">                                  )?</span>
<span class="s2">                                  (\|(?P&lt;cadence&gt;((HC|PAC|IAC|DC|EC|PC)(\..+?)?)))?</span>
<span class="s2">                                  (?P&lt;phraseend&gt;(\\\\|\}\{|\{|\})</span>
<span class="s2">                                  )?</span>
<span class="s2">                                 )</span>
<span class="s2">                                 (-</span>
<span class="s2">                                  (?P&lt;second&gt;</span>
<span class="s2">                                    ((?P&lt;globalkey2&gt;[a-gA-G](b*|\#*))\.)?</span>
<span class="s2">                                    ((?P&lt;localkey2&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)+)\.)?</span>
<span class="s2">                                    ((?P&lt;pedal2&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)+)\[)?</span>
<span class="s2">                                    (?P&lt;chord2&gt;</span>
<span class="s2">                                        (?P&lt;numeral2&gt;(b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i|Ger|It|Fr|@none))</span>
<span class="s2">                                        (?P&lt;form2&gt;(%|o|\+|M|\+M))?</span>
<span class="s2">                                        (?P&lt;figbass2&gt;(7|65|43|42|2|64|6))?</span>
<span class="s2">                                        (\((?P&lt;changes2&gt;((\+|-|\^|v)?(b*|\#*)\d)+)\))?</span>
<span class="s2">                                        (/(?P&lt;relativeroot2&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)*))?</span>
<span class="s2">                                    )</span>
<span class="s2">                                    (?P&lt;pedalend2&gt;\])?</span>
<span class="s2">                                  )?</span>
<span class="s2">                                  (\|(?P&lt;cadence2&gt;((HC|PAC|IAC|DC|EC|PC)(\..+?)?)))?</span>
<span class="s2">                                  (?P&lt;phraseend2&gt;(\\\\|\}\{|\{|\})</span>
<span class="s2">                                  )?</span>
<span class="s2">                                 )?</span>
<span class="s2">                                $</span>
<span class="s2">                                &quot;&quot;&quot;</span><span class="p">,</span>
                        <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;:obj:`str`</span>
<span class="sd">Constant with a regular expression that recognizes complete labels conforming to the DCML harmony annotation standard </span>
<span class="sd">including those consisting of two alternatives, without having to split them. It is simply a doubled version of DCML_REGEX.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">FORM_DETECTION_REGEX</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\d{1,2}(?:i+|\w)?:&quot;</span>
<span class="n">FORM_LEVEL_REGEX</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?P&lt;levels&gt;(?:(?:\d{1,2})(?:i+|\w)?[\&amp;=]?)+):(?P&lt;token&gt;(?:\D|\d+(?!(?:$|i+|\w)?[\&amp;=:]))+)&quot;</span>


<span class="n">MS3_HTML</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;#005500&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkgreen&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aa0000&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkred&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aa5500&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_sienna&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#00aa00&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_green&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aaaa00&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkgoldenrod&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aaff00&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_chartreuse&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#00007f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_navy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aa007f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkmagenta&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#00557f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_teal&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aa557f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_indianred&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#00aa7f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkcyan&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aaaa7f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkgray&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aaff7f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_palegreen&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aa00ff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkviolet&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#0055ff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_dodgerblue&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aa55ff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_mediumorchid&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#00aaff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_deepskyblue&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aaaaff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_lightsteelblue&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aaffff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_paleturquoise&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#550000&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_maroon&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#555500&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkolivegreen&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#ff5500&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_orangered&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#55aa00&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_olive&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#ffaa00&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_orange&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#55ff00&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_lawngreen&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#55007f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_indigo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#ff007f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_deeppink&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#55557f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkslateblue&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#ff557f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_lightcoral&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#55aa7f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_mediumseagreen&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#ffaa7f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_lightsalmon&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#55ff7f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_lightgreen&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#ffff7f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_khaki&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#5500ff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_blue&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#5555ff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_royalblue&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#ff55ff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_violet&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#55aaff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_cornflowerblue&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#ffaaff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_lightpink&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#55ffff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_aquamarine&#39;</span><span class="p">}</span>

<span class="n">MS3_RGB</span> <span class="o">=</span> <span class="p">{(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_darkgreen&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_darkred&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_sienna&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_green&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_darkgoldenrod&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_chartreuse&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_navy&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_darkmagenta&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_teal&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_indianred&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_darkcyan&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_darkgray&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_palegreen&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_darkviolet&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_dodgerblue&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_mediumorchid&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_deepskyblue&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_lightsteelblue&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_paleturquoise&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_maroon&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_darkolivegreen&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_orangered&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_olive&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_orange&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_lawngreen&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_indigo&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_deeppink&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_darkslateblue&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_lightcoral&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_mediumseagreen&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_lightsalmon&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_lightgreen&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_khaki&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_blue&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_royalblue&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_violet&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_cornflowerblue&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_lightpink&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_aquamarine&#39;</span><span class="p">}</span>

<span class="n">MS3_COLORS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">MS3_HTML</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<span class="n">CSS2MS3</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">:]:</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">MS3_COLORS</span><span class="p">}</span>
<span class="n">CSS_COLORS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">webcolors</span><span class="o">.</span><span class="n">CSS3_NAMES_TO_HEX</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">COLORS</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([[</span><span class="n">c</span><span class="p">,</span> <span class="n">CSS2MS3</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CSS2MS3</span> <span class="k">else</span> <span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CSS_COLORS</span><span class="p">],</span> <span class="p">[])</span>
<span class="n">rgba</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;RGBA&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">])</span>


<div class="viewcode-block" id="map_dict"><a class="viewcode-back" href="../../reference.html#ms3.utils.map_dict">[docs]</a><span class="k">class</span> <span class="nc">map_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Such a dictionary can be mapped to a Series to replace its values but leaving the values absent from the dict keys intact.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__missing__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span></div>


<div class="viewcode-block" id="assert_all_lines_equal"><a class="viewcode-back" href="../../reference.html#ms3.utils.assert_all_lines_equal">[docs]</a><span class="k">def</span> <span class="nf">assert_all_lines_equal</span><span class="p">(</span><span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="n">original</span><span class="p">,</span> <span class="n">tmp_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Compares two multiline strings to test equality.&quot;&quot;&quot;</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">bef</span><span class="p">,</span> <span class="n">aft</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">bef</span><span class="p">,</span> <span class="n">aft</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">before</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(),</span> <span class="n">after</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()),</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">bef</span> <span class="o">!=</span> <span class="n">aft</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">line_n</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">diff</span><span class="p">)</span>
        <span class="n">ln</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">line_n</span><span class="p">)))</span> <span class="c1"># length of the longest line number</span>
        <span class="n">left_col</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">left</span><span class="p">)</span> <span class="c1"># length of the longest line</span>
        <span class="n">folder</span><span class="p">,</span> <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
        <span class="n">tmp_persist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">tmp_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tmp_persist</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">original</span><span class="p">,</span> <span class="n">tmp_persist</span><span class="p">)]</span> <span class="o">+</span> <span class="n">diff</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">a</span><span class="si">:{</span><span class="n">ln</span><span class="si">}}</span><span class="s2">  </span><span class="si">{</span><span class="n">b</span><span class="si">:{</span><span class="n">left_col</span><span class="si">}}</span><span class="s2">    </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">)</span></div>


<div class="viewcode-block" id="assert_dfs_equal"><a class="viewcode-back" href="../../reference.html#ms3.utils.assert_dfs_equal">[docs]</a><span class="k">def</span> <span class="nf">assert_dfs_equal</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot; Compares the common columns of two DataFrames to test equality. Uses: nan_eq()&quot;&quot;&quot;</span>
    <span class="n">old_l</span><span class="p">,</span> <span class="n">new_l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">old</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
    <span class="n">greater_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">old_l</span><span class="p">,</span> <span class="n">new_l</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">old_l</span> <span class="o">!=</span> <span class="n">new_l</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Old length: </span><span class="si">{</span><span class="n">old_l</span><span class="si">}</span><span class="s2">, new length: </span><span class="si">{</span><span class="n">new_l</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">old_is_shorter</span> <span class="o">=</span> <span class="n">new_l</span> <span class="o">==</span> <span class="n">greater_length</span>
        <span class="n">shorter</span> <span class="o">=</span> <span class="n">old</span> <span class="k">if</span> <span class="n">old_is_shorter</span> <span class="k">else</span> <span class="n">new</span>
        <span class="n">missing_rows</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">old_l</span> <span class="o">-</span> <span class="n">new_l</span><span class="p">)</span>
        <span class="n">shorter_cols</span> <span class="o">=</span> <span class="n">shorter</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">patch</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="s1">&#39;missing row&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">shorter_cols</span><span class="p">)]</span> <span class="o">*</span> <span class="n">missing_rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">shorter_cols</span><span class="p">)</span>
        <span class="n">shorter</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">shorter</span><span class="p">,</span> <span class="n">patch</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">old_is_shorter</span><span class="p">:</span>
            <span class="n">old</span> <span class="o">=</span> <span class="n">shorter</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">shorter</span>
    <span class="n">old</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;old_ix&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">new</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;new_ix&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">old</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">new</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">]</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="o">~</span><span class="n">nan_eq</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="k">for</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">o</span><span class="p">),</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">(),</span> <span class="n">new</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">())]</span>
    <span class="n">old_bool</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="n">ix</span><span class="p">:</span> <span class="n">bool_series</span> <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">bool_series</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">},</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
    <span class="n">new_bool</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="n">ix</span><span class="p">:</span> <span class="n">bool_series</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">bool_series</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">},</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
    <span class="n">diffs_per_col</span> <span class="o">=</span> <span class="n">old_bool</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_diff</span><span class="p">():</span>
        <span class="n">comp_str</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;mc&#39;</span> <span class="ow">in</span> <span class="n">old</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">position_col</span> <span class="o">=</span> <span class="s1">&#39;mc&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;last_mc&#39;</span> <span class="ow">in</span> <span class="n">old</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">position_col</span> <span class="o">=</span> <span class="s1">&#39;last_mc&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">position_col</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">n_diffs</span> <span class="ow">in</span> <span class="n">diffs_per_col</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">n_diffs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">position_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">columns</span> <span class="o">=</span> <span class="n">col</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">position_col</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
                <span class="n">comparison</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">old</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">old_bool</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">20</span><span class="p">],</span>
                                        <span class="n">new</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_bool</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span>
                                       <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                       <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;old&#39;</span><span class="p">,</span> <span class="s1">&#39;new&#39;</span><span class="p">])</span>
                <span class="n">comp_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n_diffs</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">greater_length</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">n_diffs</span> <span class="o">/</span> <span class="n">greater_length</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> %) rows are different for </span><span class="si">{</span><span class="n">col</span><span class="si">}{</span><span class="s1">&#39; (showing first 20)&#39;</span> <span class="k">if</span> <span class="n">n_diffs</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="n">comparison</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">comp_str</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">diffs_per_col</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">show_diff</span><span class="p">()</span></div>



<div class="viewcode-block" id="ambitus2oneliner"><a class="viewcode-back" href="../../reference.html#ms3.utils.ambitus2oneliner">[docs]</a><span class="k">def</span> <span class="nf">ambitus2oneliner</span><span class="p">(</span><span class="n">ambitus</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turns a ``metadata[&#39;parts&#39;][staff_id]`` dictionary into a string.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;min_midi&#39;</span> <span class="ow">in</span> <span class="n">ambitus</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ambitus</span><span class="p">[</span><span class="s1">&#39;min_midi&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">ambitus</span><span class="p">[</span><span class="s1">&#39;max_midi&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">ambitus</span><span class="p">[</span><span class="s1">&#39;min_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">ambitus</span><span class="p">[</span><span class="s1">&#39;max_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;max_midi&#39;</span> <span class="ow">in</span> <span class="n">ambitus</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ambitus</span><span class="p">[</span><span class="s1">&#39;max_midi&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">ambitus</span><span class="p">[</span><span class="s1">&#39;max_midi&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">ambitus</span><span class="p">[</span><span class="s1">&#39;max_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">ambitus</span><span class="p">[</span><span class="s1">&#39;max_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span></div>



<div class="viewcode-block" id="changes2list"><a class="viewcode-back" href="../../reference.html#ms3.utils.changes2list">[docs]</a><span class="k">def</span> <span class="nf">changes2list</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Splits a string of changes into a list of 4-tuples.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; changes2list(&#39;+#7b5&#39;)</span>
<span class="sd">    [(&#39;+#7&#39;, &#39;+&#39;, &#39;#&#39;, &#39;7&#39;),</span>
<span class="sd">     (&#39;b5&#39;,  &#39;&#39;,  &#39;b&#39;, &#39;5&#39;)]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;((\+|-|\^|v)?(#+|b+)?(1\d|\d))&quot;</span><span class="p">,</span> <span class="n">changes</span><span class="p">)]</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">sort</span> <span class="k">else</span> <span class="n">res</span></div>



<div class="viewcode-block" id="changes2tpc"><a class="viewcode-back" href="../../reference.html#ms3.utils.changes2tpc">[docs]</a><span class="k">def</span> <span class="nf">changes2tpc</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">numeral</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">root_alterations</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a numeral and changes, computes the intervals that the changes represent.</span>
<span class="sd">    Changes do not express absolute intervals but instead depend on the numeral and the mode.</span>

<span class="sd">    Uses: split_scale_degree(), changes2list()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    changes : :obj:`str`</span>
<span class="sd">        A string of changes following the DCML harmony standard.</span>
<span class="sd">    numeral : :obj:`str`</span>
<span class="sd">        Roman numeral. If it is preceded by accidentals, it depends on the parameter</span>
<span class="sd">        `root_alterations` whether these are taken into account.</span>
<span class="sd">    minor : :obj:`bool`, optional</span>
<span class="sd">        Set to true if the `numeral` occurs in a minor context.</span>
<span class="sd">    root_alterations : :obj:`bool`, optional</span>
<span class="sd">        Set to True if accidentals of the root should change the result.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">root_alteration</span><span class="p">,</span> <span class="n">num_degree</span> <span class="o">=</span> <span class="n">split_scale_degree</span><span class="p">(</span><span class="n">numeral</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="c1"># build 2-octave diatonic scale on C major/minor</span>
    <span class="n">root</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">num_degree</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="n">tpcs</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)]</span> <span class="k">if</span> <span class="n">minor</span> <span class="k">else</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)]</span>
    <span class="n">tpcs</span> <span class="o">=</span> <span class="n">tpcs</span><span class="p">[</span><span class="n">root</span><span class="p">:]</span> <span class="o">+</span> <span class="n">tpcs</span><span class="p">[:</span><span class="n">root</span><span class="p">]</span>  <span class="c1"># starting the scale from chord root</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">tpcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">root_alterations</span><span class="p">:</span>
        <span class="n">root</span> <span class="o">+=</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">root_alteration</span>
        <span class="n">tpcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">root</span>

    <span class="n">alts</span> <span class="o">=</span> <span class="n">changes2list</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">acc2tpc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">accidentals</span><span class="p">:</span> <span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="n">accidentals</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">accidentals</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">[(</span><span class="n">full</span><span class="p">,</span> <span class="n">added</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">chord_interval</span><span class="p">,</span>
             <span class="p">(</span><span class="n">tpcs</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">chord_interval</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">acc2tpc</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span> <span class="o">-</span> <span class="n">root</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">chord_interval</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span>
            <span class="n">full</span><span class="p">,</span> <span class="n">added</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">chord_interval</span> <span class="ow">in</span> <span class="n">alts</span><span class="p">]</span></div>



<div class="viewcode-block" id="check_labels"><a class="viewcode-back" href="../../reference.html#ms3.utils.check_labels">[docs]</a><span class="k">def</span> <span class="nf">check_labels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="n">split_regex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;mc_onset&#39;</span><span class="p">,</span> <span class="s1">&#39;staff&#39;</span><span class="p">,</span> <span class="s1">&#39;voice&#39;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;  Checks the labels in ``column`` against ``regex`` and returns those that don&#39;t match.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        DataFrame containing a column with labels.</span>
<span class="sd">    regex : :obj:`str`</span>
<span class="sd">        Regular expression that incorrect labels don&#39;t match.</span>
<span class="sd">    column : :obj:`str`, optional</span>
<span class="sd">        Column name where the labels are. Defaults to &#39;label&#39;</span>
<span class="sd">    split_regex : :obj:`str`, optional</span>
<span class="sd">        If you pass a regular expression (or simple string), it will be used to split the labels before checking the</span>
<span class="sd">        resulting column separately. Instead, pass True to use the default (a &#39;-&#39; that does not precede a scale degree).</span>
<span class="sd">    return_cols : :obj:`list`, optional</span>
<span class="sd">        Pass a list of the DataFrame columns that you want to be displayed for the wrong labels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        DataFrame with wrong labels.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">split_regex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">split_regex</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">check_this</span> <span class="o">=</span> <span class="n">split_alternatives</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">column</span><span class="p">,</span> <span class="n">alternatives_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">check_this</span> <span class="o">=</span> <span class="n">split_alternatives</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">column</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="n">split_regex</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">alternatives_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">check_this</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">column</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">regex</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">!=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="vm">__class__</span><span class="p">:</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
    <span class="n">not_matched</span> <span class="o">=</span> <span class="n">check_this</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="o">~</span><span class="n">c</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">return_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">select_wrong</span> <span class="o">=</span> <span class="n">not_matched</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">check_this</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">not_matched</span><span class="p">,</span> <span class="n">other</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="n">select_wrong</span><span class="p">]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;^/$&#39;</span><span class="p">,</span> <span class="s1">&#39;empty_harmony&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_wrong</span><span class="p">,</span> <span class="n">cols</span><span class="p">],</span> <span class="n">res</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>





<div class="viewcode-block" id="color2rgba"><a class="viewcode-back" href="../../reference.html#ms3.utils.color2rgba">[docs]</a><span class="k">def</span> <span class="nf">color2rgba</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Pass a RGB or RGBA tuple, HTML color or name to convert it to RGBA &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rgba</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rgba</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="p">(</span><span class="mi">255</span><span class="p">,)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rgba</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">html_color2rgba</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">color_name2rgba</span><span class="p">(</span><span class="n">c</span><span class="p">)</span></div>



<div class="viewcode-block" id="color_name2format"><a class="viewcode-back" href="../../reference.html#ms3.utils.color_name2format">[docs]</a><span class="k">def</span> <span class="nf">color_name2format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;rgb&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts a single CSS3 name into one of &#39;HTML&#39;, &#39;rgb&#39;, or &#39;rgba&#39;&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">n</span>
    <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">CSS3_NAMES_TO_HEX</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">name_to_hex</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">MS3_HTML</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">html</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">MS3_HTML</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">n</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">n</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">html</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;rgb&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">hex_to_rgb</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;rgba&#39;</span><span class="p">:</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">hex_to_rgb</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rgba</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">rgb</span> <span class="o">+</span> <span class="p">(</span><span class="mi">255</span><span class="p">,)))</span>
    <span class="k">return</span> <span class="n">html</span></div>


<div class="viewcode-block" id="color_name2html"><a class="viewcode-back" href="../../reference.html#ms3.utils.color_name2html">[docs]</a><span class="k">def</span> <span class="nf">color_name2html</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts a single CSS3 name into HTML&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">color_name2format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="color_name2rgb"><a class="viewcode-back" href="../../reference.html#ms3.utils.color_name2rgb">[docs]</a><span class="k">def</span> <span class="nf">color_name2rgb</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts a single CSS3 name into RGB&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">color_name2format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;rgb&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="color_name2rgba"><a class="viewcode-back" href="../../reference.html#ms3.utils.color_name2rgba">[docs]</a><span class="k">def</span> <span class="nf">color_name2rgba</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts a single CSS3 name into RGBA&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">color_name2format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;rgba&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="color_params2rgba"><a class="viewcode-back" href="../../reference.html#ms3.utils.color_params2rgba">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">color_params2rgba</span><span class="p">(</span><span class="n">color_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_html</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_g</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_b</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_a</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; For functions where the color can be specified in four different ways (HTML string, CSS name,</span>
<span class="sd">    RGB, or RGBA), convert the given parameters to RGBA.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    color_name : :obj:`str`, optional</span>
<span class="sd">        As a name you can use CSS colors or MuseScore colors (see :py:attr:`.MS3_COLORS`).</span>
<span class="sd">    color_html : :obj:`str`, optional</span>
<span class="sd">        An HTML color needs to be string of length 6.</span>
<span class="sd">    color_r : :obj:`int`, optional</span>
<span class="sd">        If you specify the color as RGB(A), you also need to specify color_g and color_b.</span>
<span class="sd">    color_g : :obj:`int`, optional</span>
<span class="sd">        If you specify the color as RGB(A), you also need to specify color_r and color_b.</span>
<span class="sd">    color_b : :obj:`int`, optional</span>
<span class="sd">        If you specify the color as RGB(A), you also need to specify color_r and color_g.</span>
<span class="sd">    color_a : :obj:`int`, optional</span>
<span class="sd">        If you have specified an RGB color, the alpha value defaults to 255 unless specified otherwise.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`rgba`</span>
<span class="sd">        :obj:`namedtuple` with four integers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">[</span><span class="n">color_name</span><span class="p">,</span> <span class="n">color_html</span><span class="p">,</span> <span class="n">color_r</span><span class="p">,</span> <span class="n">color_g</span><span class="p">,</span> <span class="n">color_b</span><span class="p">,</span> <span class="n">color_a</span><span class="p">]):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;None of the parameters have been specified. Returning None.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">color_r</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">color_a</span><span class="p">):</span>
            <span class="n">color_a</span> <span class="o">=</span> <span class="mi">255</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">color_g</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">color_b</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">color_name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">color_html</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not a valid RGB color: </span><span class="si">{</span><span class="p">(</span><span class="n">color_r</span><span class="p">,</span> <span class="n">color_g</span><span class="p">,</span> <span class="n">color_b</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">color_r</span><span class="p">,</span> <span class="n">color_g</span><span class="p">,</span> <span class="n">color_b</span><span class="p">,</span> <span class="n">color_a</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">color_html</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">color2rgba</span><span class="p">(</span><span class="n">color_html</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">color_name</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">color2rgba</span><span class="p">(</span><span class="n">color_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rgba</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">allnamesequal</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

<div class="viewcode-block" id="commonprefix"><a class="viewcode-back" href="../../reference.html#ms3.utils.commonprefix">[docs]</a><span class="k">def</span> <span class="nf">commonprefix</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns common prefix of a list of paths.</span>
<span class="sd">    Uses: allnamesequal(), itertools.takewhile()&quot;&quot;&quot;</span>
    <span class="n">bydirectorylevels</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">takewhile</span><span class="p">(</span><span class="n">allnamesequal</span><span class="p">,</span> <span class="n">bydirectorylevels</span><span class="p">))</span></div>


<div class="viewcode-block" id="compute_mn"><a class="viewcode-back" href="../../reference.html#ms3.utils.compute_mn">[docs]</a><span class="k">def</span> <span class="nf">compute_mn</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Compute measure numbers from a measure list with columns [&#39;dont_count&#39;, &#39;numbering_offset&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">excluded</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;dont_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;numbering_offset&#39;</span><span class="p">]</span>
    <span class="n">mn</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">excluded</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">offset</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="n">mn</span> <span class="o">+=</span> <span class="n">offset</span>
    <span class="k">return</span> <span class="n">mn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;mn&#39;</span><span class="p">)</span></div>




<span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">MS</span><span class="o">=</span><span class="s1">&#39;mscore&#39;</span><span class="p">):</span>
    <span class="n">process</span> <span class="o">=</span> <span class="p">[</span><span class="n">MS</span><span class="p">,</span> <span class="s2">&quot;-fo&quot;</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span><span class="p">]</span> <span class="c1">#[MS, &#39;--appimage-extract-and-run&#39;, &quot;-fo&quot;, new, old] if MS.endswith(&#39;.AppImage&#39;) else [MS, &quot;-fo&quot;, new, old]</span>
    <span class="k">if</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">process</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converted </span><span class="si">{</span><span class="n">old</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">new</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Error while converting &quot;</span> <span class="o">+</span> <span class="n">old</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_convert_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Auxiliary function allowing to use Pool.starmap() with keyword arguments (needed in order to</span>
<span class="sd">    pass the logger argument which is not part of the signature of convert() ).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">convert</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="convert_folder"><a class="viewcode-back" href="../../reference.html#ms3.utils.convert_folder">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">convert_folder</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="p">[],</span> <span class="n">target_extension</span><span class="o">=</span><span class="s1">&#39;mscx&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="s1">&#39;.*&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">ms</span><span class="o">=</span><span class="s1">&#39;mscore&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Convert all files in `dir` that have one of the `extensions` to .mscx format using the executable `MS`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    directory : :obj:`str`</span>
<span class="sd">        Directory in which to look for files to convert.</span>
<span class="sd">    paths : :obj:`list` of `dir`</span>
<span class="sd">        List of file paths to convert. These are not filtered by any means.</span>
<span class="sd">    target_dir : :obj:`str`</span>
<span class="sd">        Directory where to store converted files. Defaults to ``directory``</span>
<span class="sd">    extensions : list, optional</span>
<span class="sd">        If you want to convert only certain formats, give those, e.g. [&#39;mscz&#39;, &#39;xml&#39;]</span>
<span class="sd">    recursive : bool, optional</span>
<span class="sd">        Subdirectories as well.</span>
<span class="sd">    MS : str, optional</span>
<span class="sd">        Give the path to the MuseScore executable on your system. Need only if</span>
<span class="sd">        the command &#39;mscore&#39; does not execute MuseScore on your system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">MS</span> <span class="o">=</span> <span class="n">get_musescore</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">MS</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;MuseScore not found: </span><span class="si">{</span><span class="n">ms</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">paths</span><span class="p">)),</span> <span class="s2">&quot;Pass at least a directory or one path.&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">paths</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">target_extension</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
        <span class="n">target_extension</span> <span class="o">=</span> <span class="n">target_extension</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">conversion_params</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#logger.info(f&quot;Traversing {dir} {&#39;&#39; if recursive else &#39;non-&#39;}recursively...&quot;)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">exclude_re</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;^(?:(?!(</span><span class="si">{</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span><span class="si">}</span><span class="s2">)).)*$&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">exclude_re</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">target_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">target_dir</span> <span class="o">=</span> <span class="n">directory</span>
    <span class="n">new_dirs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">subdir_file_tuples</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">([])</span>
    <span class="k">if</span> <span class="n">directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subdir_file_tuples</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="n">subdir_file_tuples</span><span class="p">,</span>
                                   <span class="n">scan_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">file_re</span><span class="o">=</span><span class="n">regex</span><span class="p">,</span> <span class="n">exclude_re</span><span class="o">=</span><span class="n">exclude_re</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span>
                                                  <span class="n">subdirs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exclude_files_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">paths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subdir_file_tuples</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="n">subdir_file_tuples</span><span class="p">,</span>
                                   <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">resolve_dir</span><span class="p">(</span><span class="n">path</span><span class="p">))</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">subdir</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">subdir_file_tuples</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="n">new_dirs</span><span class="p">:</span>
            <span class="n">new_subdir</span> <span class="o">=</span> <span class="n">new_dirs</span><span class="p">[</span><span class="n">subdir</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_subdir</span> <span class="o">=</span> <span class="n">subdir</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">old_subdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>
                <span class="n">new_subdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="n">old_subdir</span><span class="p">)</span> <span class="k">if</span> <span class="n">old_subdir</span> <span class="o">!=</span> <span class="s1">&#39;.&#39;</span> <span class="k">else</span> <span class="n">target_dir</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">new_subdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">new_dirs</span><span class="p">[</span><span class="n">subdir</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_subdir</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">target_extension</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">target_extension</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">old</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_subdir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">new</span><span class="p">):</span>
            <span class="n">conversion_params</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">dict</span><span class="p">(</span><span class="n">old</span><span class="o">=</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">new</span><span class="p">,</span> <span class="n">MS</span><span class="o">=</span><span class="n">MS</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="s1">&#39;exists already. Pass -o to overwrite.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conversion_params</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No files to convert.&quot;</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">_convert_kwargs</span><span class="p">,</span> <span class="n">conversion_params</span><span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">MS</span> <span class="ow">in</span> <span class="n">conversion_params</span><span class="p">:</span>
            <span class="n">convert</span><span class="p">(</span><span class="n">old</span><span class="o">=</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">new</span><span class="p">,</span> <span class="n">MS</span><span class="o">=</span><span class="n">MS</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span></div>


<div class="viewcode-block" id="decode_harmonies"><a class="viewcode-back" href="../../reference.html#ms3.utils.decode_harmonies">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">decode_harmonies</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">label_col</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="n">keep_layer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_series</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alt_cols</span><span class="o">=</span><span class="s1">&#39;alt_label&#39;</span><span class="p">,</span> <span class="n">alt_separator</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;MuseScore stores types 2 (Nashville) and 3 (absolute chords) in several columns. This function returns a copy of</span>
<span class="sd">    the DataFrame ``Annotations.df`` where the label column contains the strings corresponding to these columns.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        DataFrame with encoded harmony labels as stored in an :obj:`Annotations` object.</span>
<span class="sd">    label_col : :obj:`str`, optional</span>
<span class="sd">        Column name where the main components (&lt;name&gt; tag) are stored, defaults to &#39;label&#39;</span>
<span class="sd">    keep_layer : :obj:`bool`, optional</span>
<span class="sd">        Defaults to True, retaining the &#39;harmony_layer&#39; column and setting types 2 and 3 to 0.</span>
<span class="sd">    return_series : :obj:`bool`, optional</span>
<span class="sd">        If set to True, only the decoded labels column is returned as a Series rather than a copy of ``df``.</span>
<span class="sd">    alt_cols : :obj:`str` or :obj:`list`, optional</span>
<span class="sd">        Column(s) with alternative labels that are joined with the label columns using ``alt_separator``. Defaults to</span>
<span class="sd">        &#39;alt_label&#39;. Suppress by passing None.</span>
<span class="sd">    alt_separator: :obj:`str`, optional</span>
<span class="sd">        Separator for joining ``alt_cols``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.DataFrame` or :obj:`pandas.Series`</span>
<span class="sd">        Decoded harmony labels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">drop_cols</span><span class="p">,</span> <span class="n">compose_label</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s1">&#39;nashville&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">nashville</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sel</span><span class="p">,</span> <span class="n">label_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sel</span><span class="p">,</span> <span class="s1">&#39;nashville&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sel</span><span class="p">,</span> <span class="n">label_col</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">drop_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;nashville&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;leftParen&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">leftParen</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">compose_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;leftParen&#39;</span><span class="p">)</span>
        <span class="n">drop_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;leftParen&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;absolute_root&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">df</span><span class="o">.</span><span class="n">absolute_root</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">absolute_root</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sel</span><span class="p">,</span> <span class="s1">&#39;absolute_root&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fifths2name</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sel</span><span class="p">,</span> <span class="s1">&#39;absolute_root&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span> <span class="n">ms</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">compose_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;absolute_root&#39;</span><span class="p">)</span>
        <span class="n">drop_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;absolute_root&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;rootCase&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rootCase</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sel</span><span class="p">,</span> <span class="s1">&#39;absolute_root&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sel</span><span class="p">,</span> <span class="s1">&#39;absolute_root&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">drop_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;rootCase&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">label_col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">compose_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_col</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;absolute_base&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">df</span><span class="o">.</span><span class="n">absolute_base</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">absolute_base</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sel</span><span class="p">,</span> <span class="s1">&#39;absolute_base&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fifths2name</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sel</span><span class="p">,</span> <span class="s1">&#39;absolute_base&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span> <span class="n">ms</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">absolute_base</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">absolute_base</span>
        <span class="n">compose_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;absolute_base&#39;</span><span class="p">)</span>
        <span class="n">drop_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;absolute_base&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;rightParen&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">rightParen</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">compose_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;rightParen&#39;</span><span class="p">)</span>
        <span class="n">drop_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;rightParen&#39;</span><span class="p">)</span>
    <span class="n">new_label_col</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">compose_label</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">new_label_col</span> <span class="o">=</span> <span class="n">new_label_col</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;^/$&#39;</span><span class="p">,</span> <span class="s1">&#39;empty_harmony&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">alt_cols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alt_cols</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">alt_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">alt_cols</span><span class="p">]</span>
        <span class="n">present</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">alt_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">present</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">alt_joined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">new_label_col</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">present</span><span class="p">:</span>
                <span class="n">alt_joined</span> <span class="o">+=</span> <span class="p">(</span><span class="n">alt_separator</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">])</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">new_label_col</span> <span class="o">+=</span> <span class="n">alt_joined</span>

    <span class="k">if</span> <span class="n">return_series</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_label_col</span>

    <span class="k">if</span> <span class="s1">&#39;harmony_layer&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">keep_layer</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">harmony_layer</span><span class="o">.</span><span class="n">isin</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="s1">&#39;harmony_layer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">drop_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;harmony_layer&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_label_col</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">drop_cols</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="df2md"><a class="viewcode-back" href="../../reference.html#ms3.utils.df2md">[docs]</a><span class="k">def</span> <span class="nf">df2md</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Overview&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turns a DataFrame into a MarkDown table. The returned writer can be converted into a string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">MarkdownTableWriter</span><span class="p">()</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">header_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">value_matrix</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">writer</span></div>


<div class="viewcode-block" id="dict2oneliner"><a class="viewcode-back" href="../../reference.html#ms3.utils.dict2oneliner">[docs]</a><span class="k">def</span> <span class="nf">dict2oneliner</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turns a dictionary into a single-line string without brackets.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">())</span></div>

<div class="viewcode-block" id="expand_form_labels"><a class="viewcode-back" href="../../reference.html#ms3.utils.expand_form_labels">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">expand_form_labels</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span> <span class="n">fill_mn_until</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Expands form labels into a hierarchical view of levels.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fill_mn_until : :obj:`int`, optional</span>
<span class="sd">        Pass the last measure number in order to insert rows for every measure without a form label.</span>
<span class="sd">        If you pass -1, the measure number of the last form label will be used.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">distribute_levels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">mc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes the regex matches of one label and turns them into one row where</span>
<span class="sd">        the levels become column names. Pass label&#39;s MC to display it in error messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">col2val</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">levels_re</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(\d{1,2})(i+|\w)?[\&amp;=]?&quot;</span>
        <span class="k">for</span> <span class="n">levels</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">hybrid</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">levels_re</span><span class="p">,</span> <span class="n">levels</span><span class="p">):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">hybrid</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>  <span class="c1"># hybrid becomes first index level, e.g. &#39;a&#39; and &#39;b&#39;</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">col2val</span><span class="p">:</span>
                    <span class="n">mc_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">mc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;MC </span><span class="si">{</span><span class="n">mc</span><span class="si">}</span><span class="s2">: &quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mc_string</span><span class="si">}</span><span class="s2">The token &#39;</span><span class="si">{</span><span class="n">col2val</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; for level </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> was overwritten with &#39;</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&#39;:</span><span class="se">\n</span><span class="si">{</span><span class="n">df</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">col2val</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
        <span class="k">return</span> <span class="n">col2val</span>

    <span class="n">matches</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">form_label</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">FORM_LEVEL_REGEX</span><span class="p">)</span>
    <span class="n">matches</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">matches</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> ,&#39;</span><span class="p">)</span>
    <span class="n">mcs</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">levels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">matches</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">nlevels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># all index levels except the one for the matches</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">distribute_levels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">mcs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">matches</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">levels</span><span class="p">)}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
    <span class="n">res</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">form_types</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">form_types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># columns will be MultiIndex</span>
        <span class="k">if</span> <span class="s1">&#39;&#39;</span> <span class="ow">in</span> <span class="n">form_types</span><span class="p">:</span>
            <span class="c1"># there are labels pertaining to all form_types</span>
            <span class="n">forms</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">form_types</span> <span class="k">if</span> <span class="n">f</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
            <span class="n">pertaining_to_all</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
            <span class="n">distributed_to_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pertaining_to_all</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">forms</span><span class="p">),</span> <span class="n">keys</span><span class="o">=</span><span class="n">forms</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">level_exists</span> <span class="o">=</span> <span class="n">distributed_to_all</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">existing_level_names</span> <span class="o">=</span> <span class="n">distributed_to_all</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">level_exists</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">forms</span><span class="p">],</span> <span class="n">distributed_to_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="o">~</span><span class="n">level_exists</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">potentially_preexistent</span> <span class="o">=</span> <span class="n">distributed_to_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">level_exists</span><span class="p">]</span>
            <span class="n">check_double_attribution</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">existing_level_names</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">potentially_preexistent</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">check_double_attribution</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Could not distribute levels to all form types because some had already been individually specified.&quot;</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">existing_level_names</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">existing_level_names</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">potentially_preexistent</span><span class="p">)</span>
        <span class="n">fl_multiindex</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">fl</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">fl_multiindex</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">form_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">fl</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Syntax for several form types used for a single one: &#39;</span><span class="si">{</span><span class="n">form_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fill_mn_until</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">form_types</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mn_col</span><span class="p">,</span> <span class="n">mn_onset</span> <span class="o">=</span> <span class="s1">&#39;mn&#39;</span><span class="p">,</span> <span class="s1">&#39;mn_onset&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mn_col</span><span class="p">,</span> <span class="n">mn_onset</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;mn&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;mn_onset&#39;</span><span class="p">)</span>
        <span class="n">first_mn</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">mn</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">last_mn</span> <span class="o">=</span> <span class="n">fill_mn_until</span> <span class="k">if</span> <span class="n">fill_mn_until</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="n">fl</span><span class="o">.</span><span class="n">mn</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">all_mns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">first_mn</span><span class="p">,</span> <span class="n">last_mn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="n">all_mns</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">mn_col</span><span class="p">]))</span>
        <span class="n">missing_mn</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">mn_col</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">missing</span><span class="p">)})</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">res</span><span class="p">,</span> <span class="n">missing_mn</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="n">mn_col</span><span class="p">,</span> <span class="n">mn_onset</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="fifths2acc"><a class="viewcode-back" href="../../reference.html#ms3.utils.fifths2acc">[docs]</a><span class="k">def</span> <span class="nf">fifths2acc</span><span class="p">(</span><span class="n">fifths</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns accidentals for a stack of fifths that can be combined with a</span>
<span class="sd">        basic representation of the seven steps.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fifths</span> <span class="o">//</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="s1">&#39;b&#39;</span> <span class="k">if</span> <span class="n">fifths</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">fifths</span> <span class="o">//</span> <span class="mi">7</span> <span class="o">*</span> <span class="s1">&#39;#&#39;</span></div>


<div class="viewcode-block" id="fifths2iv"><a class="viewcode-back" href="../../reference.html#ms3.utils.fifths2iv">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">fifths2iv</span><span class="p">(</span><span class="n">fifths</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
             <span class="n">smallest</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
             <span class="n">perfect</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span>
             <span class="n">major</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span>
             <span class="n">minor</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span>
             <span class="n">augmented</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span>
             <span class="n">diminished</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Return interval name of a stack of fifths such that 0 = &#39;P1&#39;, -1 = &#39;P4&#39;, -2 = &#39;m7&#39;, 4 = &#39;M3&#39; etc. If you pass</span>
<span class="sd">    ``smallest=True``, intervals of a fifth or greater will be inverted (e.g. &#39;m6&#39; =&gt; &#39;-M3&#39; and &#39;D5&#39; =&gt; &#39;-A4&#39;).</span>


<span class="sd">    Args:</span>
<span class="sd">        fifths: Number of fifths representing the inveral</span>
<span class="sd">        smallest: Pass True if you want to wrap intervals of a fifths and larger to the downward counterpart.</span>
<span class="sd">        perfect: String representing the perfect interval quality, defaults to &#39;P&#39;.</span>
<span class="sd">        major: String representing the major interval quality, defaults to &#39;M&#39;.</span>
<span class="sd">        minor: String representing the minor interval quality, defaults to &#39;m&#39;.</span>
<span class="sd">        augmented: String representing the augmented interval quality, defaults to &#39;a&#39;.</span>
<span class="sd">        diminished: String representing the diminished interval quality, defaults to &#39;d&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Name of the interval as a string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fifths_plus_one</span> <span class="o">=</span> <span class="n">fifths</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># making 0 = fourth, 1 = unison, 2 = fifth etc.</span>
    <span class="n">int_num</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;6&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;7&quot;</span><span class="p">][</span><span class="n">fifths_plus_one</span> <span class="o">%</span> <span class="mi">7</span><span class="p">]</span>
    <span class="n">sharp_wise_quality</span> <span class="o">=</span> <span class="n">augmented</span>
    <span class="n">flat_wise_quality</span> <span class="o">=</span> <span class="n">diminished</span>
    <span class="n">qualities</span> <span class="o">=</span> <span class="p">(</span><span class="n">minor</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">perfect</span><span class="p">,</span> <span class="n">perfect</span><span class="p">,</span> <span class="n">perfect</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">major</span><span class="p">)</span>
    <span class="n">quality</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">smallest</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">int_num</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">int_num</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">9</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">int_num</span><span class="p">))</span>
        <span class="n">sharp_wise_quality</span><span class="p">,</span> <span class="n">flat_wise_quality</span> <span class="o">=</span> <span class="n">flat_wise_quality</span><span class="p">,</span> <span class="n">sharp_wise_quality</span>
        <span class="n">qualities</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">qualities</span><span class="p">))</span>
        <span class="n">quality</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
    <span class="k">if</span> <span class="o">-</span><span class="mi">5</span> <span class="o">&lt;=</span> <span class="n">fifths</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">quality</span> <span class="o">+=</span> <span class="n">qualities</span><span class="p">[</span><span class="n">fifths</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">fifths</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">quality</span> <span class="o">+=</span> <span class="n">sharp_wise_quality</span> <span class="o">*</span> <span class="p">(</span><span class="n">fifths_plus_one</span> <span class="o">//</span> <span class="mi">7</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">quality</span> <span class="o">+=</span> <span class="n">flat_wise_quality</span> <span class="o">*</span> <span class="p">((</span><span class="o">-</span><span class="n">fifths</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">7</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">quality</span> <span class="o">+</span> <span class="n">int_num</span></div>


<div class="viewcode-block" id="fifths2name"><a class="viewcode-back" href="../../reference.html#ms3.utils.fifths2name">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">fifths2name</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">midi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return note name of a stack of fifths such that</span>
<span class="sd">       0 = C, -1 = F, -2 = Bb, 1 = G etc.</span>
<span class="sd">       Uses: map2elements(), fifths2str()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fifths : :obj:`int`</span>
<span class="sd">        Tonal pitch class to turn into a note name.</span>
<span class="sd">    midi : :obj:`int`</span>
<span class="sd">        In order to include the octave into the note name,</span>
<span class="sd">        pass the corresponding MIDI pitch.</span>
<span class="sd">    ms : :obj:`bool`, optional</span>
<span class="sd">        Pass True if ``fifths`` is a MuseScore TPC, i.e. C = 14</span>
<span class="sd">    minor : :obj:`bool`, optional</span>
<span class="sd">        Pass True if the string is to be returned as lowercase.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fifths</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">fifths</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fifths</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">fifths2name</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="n">ms</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">map2elements</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">fifths2name</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="n">ms</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fifths</span>

    <span class="k">if</span> <span class="n">ms</span><span class="p">:</span>
        <span class="n">fifths</span> <span class="o">-=</span> <span class="mi">14</span>
    <span class="n">note_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">]</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">_fifths2str</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">note_names</span><span class="p">,</span> <span class="n">inverted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">midi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">octave</span> <span class="o">=</span> <span class="n">midi2octave</span><span class="p">(</span><span class="n">midi</span><span class="p">,</span> <span class="n">fifths</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">octave</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">minor</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">name</span></div>



<div class="viewcode-block" id="fifths2pc"><a class="viewcode-back" href="../../reference.html#ms3.utils.fifths2pc">[docs]</a><span class="k">def</span> <span class="nf">fifths2pc</span><span class="p">(</span><span class="n">fifths</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turn a stack of fifths into a chromatic pitch class.</span>
<span class="sd">        Uses: map2elements()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fifths</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">fifths</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">map2elements</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">fifths2pc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fifths</span>

    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="mi">7</span> <span class="o">*</span> <span class="n">fifths</span> <span class="o">%</span> <span class="mi">12</span><span class="p">)</span></div>



<div class="viewcode-block" id="fifths2rn"><a class="viewcode-back" href="../../reference.html#ms3.utils.fifths2rn">[docs]</a><span class="k">def</span> <span class="nf">fifths2rn</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">auto_key</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return Roman numeral of a stack of fifths such that</span>
<span class="sd">       0 = I, -1 = IV, 1 = V, -2 = bVII in major, VII in minor, etc.</span>
<span class="sd">       Uses: map2elements(), is_minor_mode()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    auto_key : :obj:`bool`, optional</span>
<span class="sd">        By default, the returned Roman numerals are uppercase. Pass True to pass upper-</span>
<span class="sd">        or lowercase according to the position in the scale.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">map2elements</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">fifths2rn</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">minor</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">fifths</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fifths</span>
    <span class="n">rn</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;VI&#39;</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">minor</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;IV&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">]</span>
    <span class="n">sel</span> <span class="o">=</span> <span class="n">fifths</span> <span class="o">+</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">minor</span> <span class="k">else</span> <span class="n">fifths</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">_fifths2str</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">rn</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">auto_key</span> <span class="ow">and</span> <span class="n">is_minor_mode</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">minor</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="fifths2sd"><a class="viewcode-back" href="../../reference.html#ms3.utils.fifths2sd">[docs]</a><span class="k">def</span> <span class="nf">fifths2sd</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return scale degree of a stack of fifths such that</span>
<span class="sd">       0 = &#39;1&#39;, -1 = &#39;4&#39;, -2 = &#39;b7&#39; in major, &#39;7&#39; in minor etc.</span>
<span class="sd">       Uses: map2elements(), fifths2str()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">map2elements</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">fifths2sd</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">minor</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">fifths</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fifths</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">minor</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">minor</span><span class="p">:</span>
        <span class="n">fifths</span> <span class="o">+=</span> <span class="mi">3</span>
    <span class="k">return</span> <span class="n">_fifths2str</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">sd</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_fifths2str</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">inverted</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Boiler plate used by fifths2-functions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fifths</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">fifths2acc</span><span class="p">(</span><span class="n">fifths</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inverted</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">steps</span><span class="p">[</span><span class="n">fifths</span> <span class="o">%</span> <span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="n">acc</span>
    <span class="k">return</span> <span class="n">acc</span> <span class="o">+</span> <span class="n">steps</span><span class="p">[</span><span class="n">fifths</span> <span class="o">%</span> <span class="mi">7</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">get_ms_version</span><span class="p">(</span><span class="n">mscx_file</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">mscx_file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;programVersion&gt;(.*?)&lt;/programVersion&gt;&quot;</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<div class="viewcode-block" id="get_musescore"><a class="viewcode-back" href="../../reference.html#ms3.utils.get_musescore">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">get_musescore</span><span class="p">(</span><span class="n">MS</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Tests whether a MuseScore executable can be found on the system.</span>
<span class="sd">    Uses: test_binary()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    MS : :obj:`str`</span>
<span class="sd">        A path to the executable, installed command, or one of the keywords {&#39;auto&#39;, &#39;win&#39;, &#39;mac&#39;}</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`str`</span>
<span class="sd">        Path to the executable if found or None.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">MS</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">MS</span>
    <span class="k">if</span> <span class="n">MS</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Windows&#39;</span><span class="p">:</span> <span class="s1">&#39;win&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Darwin&#39;</span><span class="p">:</span> <span class="s1">&#39;mac&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Linux&#39;</span><span class="p">:</span> <span class="s1">&#39;mscore&#39;</span>
        <span class="p">}</span>
        <span class="n">system</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">MS</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">system</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;System could not be inferred: </span><span class="si">{</span><span class="n">system</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">MS</span> <span class="o">=</span> <span class="s1">&#39;mscore&#39;</span>
    <span class="k">if</span> <span class="n">MS</span> <span class="o">==</span> <span class="s1">&#39;win&#39;</span><span class="p">:</span>
        <span class="n">program_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PROGRAMFILES&#39;</span><span class="p">]</span>
        <span class="n">MS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">program_files</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;MuseScore 3\bin\MuseScore3.exe&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">MS</span> <span class="o">==</span> <span class="s1">&#39;mac&#39;</span><span class="p">:</span>
        <span class="n">MS</span> <span class="o">=</span> <span class="s2">&quot;/Applications/MuseScore 3.app/Contents/MacOS/mscore&quot;</span>
    <span class="k">return</span> <span class="n">test_binary</span><span class="p">(</span><span class="n">MS</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_path_component"><a class="viewcode-back" href="../../reference.html#ms3.utils.get_path_component">[docs]</a><span class="k">def</span> <span class="nf">get_path_component</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">after</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns only the path&#39;s subfolders below ``after``. If ``after`` is the last</span>
<span class="sd">    component, &#39;.&#39; is returned.&quot;&quot;&quot;</span>
    <span class="n">dir1</span><span class="p">,</span> <span class="n">base1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dir1</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;~&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">base1</span> <span class="o">==</span> <span class="n">after</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;.&#39;</span>
        <span class="k">return</span> <span class="n">path</span>
    <span class="n">dir2</span><span class="p">,</span> <span class="n">base2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">dir1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">base2</span> <span class="o">==</span> <span class="n">after</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">base1</span>
    <span class="n">higher_levels</span> <span class="o">=</span> <span class="n">get_path_component</span><span class="p">(</span><span class="n">dir1</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="n">after</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">higher_levels</span><span class="p">,</span> <span class="n">base1</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_quarterbeats_length"><a class="viewcode-back" href="../../reference.html#ms3.utils.get_quarterbeats_length">[docs]</a><span class="k">def</span> <span class="nf">get_quarterbeats_length</span><span class="p">(</span><span class="n">measures</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns the symbolic length and unfolded symbolic length of a piece in quarter notes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    measures : :obj:`pandas.DataFrame`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float, float</span>
<span class="sd">        Length and unfolded length, both measuresd in quarter notes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mc_durations</span> <span class="o">=</span> <span class="n">measures</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;mc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">act_dur</span> <span class="o">*</span> <span class="mf">4.</span>
    <span class="n">length_qb</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">mc_durations</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">decimals</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">playthrough2mc</span> <span class="o">=</span> <span class="n">make_playthrough2mc</span><span class="p">(</span><span class="n">measures</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">playthrough2mc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">length_qb_unfolded</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">length_qb_unfolded</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">mc_durations</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">playthrough2mc</span><span class="o">.</span><span class="n">values</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">decimals</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">length_qb_unfolded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">length_qb</span><span class="p">,</span> <span class="n">length_qb_unfolded</span></div>


<div class="viewcode-block" id="group_id_tuples"><a class="viewcode-back" href="../../reference.html#ms3.utils.group_id_tuples">[docs]</a><span class="k">def</span> <span class="nf">group_id_tuples</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turns a list of (key, ix) into a {key: [ix]}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></div>


<div class="viewcode-block" id="html2format"><a class="viewcode-back" href="../../reference.html#ms3.utils.html2format">[docs]</a><span class="k">def</span> <span class="nf">html2format</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">html_col</span><span class="o">=</span><span class="s1">&#39;color_html&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts the HTML column of a DataFrame into &#39;name&#39;, &#39;rgb , or &#39;rgba&#39;. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">html_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">color_name2html</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;rgb&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">html_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">color_name2rgb</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;rgba&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">html_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">color_name2rgba</span><span class="p">)</span></div>


<div class="viewcode-block" id="html_color2format"><a class="viewcode-back" href="../../reference.html#ms3.utils.html_color2format">[docs]</a><span class="k">def</span> <span class="nf">html_color2format</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts a single HTML color into &#39;name&#39;, &#39;rgb&#39;, or  &#39;rgba&#39;.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">h</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">hex_to_name</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">MS3_HTML</span><span class="p">[</span><span class="n">h</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">h</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;rgb&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">hex_to_rgb</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;rgba&#39;</span><span class="p">:</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">hex_to_rgb</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rgba</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">rgb</span> <span class="o">+</span> <span class="p">(</span><span class="mi">255</span><span class="p">,)))</span></div>


<div class="viewcode-block" id="html_color2name"><a class="viewcode-back" href="../../reference.html#ms3.utils.html_color2name">[docs]</a><span class="k">def</span> <span class="nf">html_color2name</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts a HTML color into its CSS3 name or itself if there is none.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">html_color2format</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="html_color2rgb"><a class="viewcode-back" href="../../reference.html#ms3.utils.html_color2rgb">[docs]</a><span class="k">def</span> <span class="nf">html_color2rgb</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts a HTML color into RGB.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">html_color2format</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;rgb&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="html_color2rgba"><a class="viewcode-back" href="../../reference.html#ms3.utils.html_color2rgba">[docs]</a><span class="k">def</span> <span class="nf">html_color2rgba</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts a HTML color into RGBA.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">html_color2format</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;rgba&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="interval_overlap"><a class="viewcode-back" href="../../reference.html#ms3.utils.interval_overlap">[docs]</a><span class="k">def</span> <span class="nf">interval_overlap</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns the overlap of two pd.Intervals as a new pd.Interval.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a, b : :obj:`pandas.Interval`</span>
<span class="sd">        Intervals for which to compute the overlap.</span>
<span class="sd">    closed : {&#39;left&#39;, &#39;right&#39;, &#39;both&#39;, &#39;neither&#39;}, optional</span>
<span class="sd">        If no value is passed, the closure of the returned interval is inferred from ``a`` and ``b``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.Interval`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">left</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">.</span><span class="n">left</span><span class="p">:</span>
        <span class="c1"># making a the leftmost interval</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span>
    <span class="k">if</span> <span class="n">closed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">right</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">.</span><span class="n">right</span><span class="p">:</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">right</span>
            <span class="n">right_closed</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">closed</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">)</span>
            <span class="n">other_iv</span> <span class="o">=</span> <span class="n">b</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">right</span>
            <span class="n">right_closed</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">closed</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">)</span>
            <span class="n">other_iv</span> <span class="o">=</span> <span class="n">a</span>
        <span class="k">if</span> <span class="n">right_closed</span> <span class="ow">and</span> <span class="n">right</span> <span class="o">==</span> <span class="n">other_iv</span><span class="o">.</span><span class="n">right</span> <span class="ow">and</span> <span class="n">other_iv</span><span class="o">.</span><span class="n">closed</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">):</span>
            <span class="n">right_closed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">left_closed</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">closed</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">left_closed</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">left</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">left</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">closed</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">):</span>
            <span class="n">left_closed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">left_closed</span> <span class="ow">and</span> <span class="n">right_closed</span><span class="p">:</span>
            <span class="n">closed</span> <span class="o">=</span> <span class="s1">&#39;both&#39;</span>
        <span class="k">elif</span> <span class="n">left_closed</span><span class="p">:</span>
            <span class="n">closed</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span>
        <span class="k">elif</span> <span class="n">right_closed</span><span class="p">:</span>
            <span class="n">closed</span> <span class="o">=</span> <span class="s1">&#39;right&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">closed</span> <span class="o">=</span> <span class="s1">&#39;neither&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">right</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">right</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">.</span><span class="n">right</span> <span class="k">else</span> <span class="n">b</span><span class="o">.</span><span class="n">right</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Interval</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="n">closed</span><span class="p">)</span></div>


<div class="viewcode-block" id="interval_overlap_size"><a class="viewcode-back" href="../../reference.html#ms3.utils.interval_overlap_size">[docs]</a><span class="k">def</span> <span class="nf">interval_overlap_size</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the size of the overlap of two pd.Intervals.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">left</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">.</span><span class="n">left</span><span class="p">:</span>
        <span class="c1"># making a the leftmost interval</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span>
    <span class="n">right</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">right</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">right</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">.</span><span class="n">right</span> <span class="k">else</span> <span class="n">b</span><span class="o">.</span><span class="n">right</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">right</span> <span class="o">-</span> <span class="n">b</span><span class="o">.</span><span class="n">left</span>
    <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">decimals</span><span class="p">)</span></div>

<div class="viewcode-block" id="is_any_row_equal"><a class="viewcode-back" href="../../reference.html#ms3.utils.is_any_row_equal">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">is_any_row_equal</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns True if any two rows of the two DataFrames contain the same value tuples. &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">df1</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="s2">&quot;Pass the same number of columns for both DataFrames&quot;</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df1</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">v1</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_minor_mode"><a class="viewcode-back" href="../../reference.html#ms3.utils.is_minor_mode">[docs]</a><span class="k">def</span> <span class="nf">is_minor_mode</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns True if the scale degree `fifths` naturally has a minor third in the scale.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">thirds</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">minor</span> <span class="k">else</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">third</span> <span class="o">=</span> <span class="n">thirds</span><span class="p">[(</span><span class="n">fifths</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span><span class="p">]</span> <span class="o">-</span> <span class="n">fifths</span>
    <span class="k">return</span> <span class="n">third</span> <span class="o">==</span> <span class="o">-</span><span class="mi">3</span></div>


<div class="viewcode-block" id="iter_nested"><a class="viewcode-back" href="../../reference.html#ms3.utils.iter_nested">[docs]</a><span class="k">def</span> <span class="nf">iter_nested</span><span class="p">(</span><span class="n">nested</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Iterate through any nested structure of lists and tuples from left to right.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">nested</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">lower</span> <span class="ow">in</span> <span class="n">iter_nested</span><span class="p">(</span><span class="n">elem</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">lower</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">elem</span></div>


<div class="viewcode-block" id="iter_selection"><a class="viewcode-back" href="../../reference.html#ms3.utils.iter_selection">[docs]</a><span class="k">def</span> <span class="nf">iter_selection</span><span class="p">(</span><span class="n">collectio</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">opposite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a generator of ``collectio``. ``selector`` can be a collection of index numbers to select or unselect</span>
<span class="sd">    elements -- depending on ``opposite`` &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">selector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">collectio</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">e</span>
    <span class="k">if</span> <span class="n">opposite</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">collectio</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selector</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">e</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">collectio</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">selector</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">e</span></div>


<span class="k">def</span> <span class="nf">iterable2str</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">iterable</span>

<span class="c1"># @function_logger</span>
<span class="c1"># def iterate_subcorpora(path: str,</span>
<span class="c1">#                        prefixes: Iterable = None, # Iterable[str] would require python&gt;=3.9</span>
<span class="c1">#                        suffixes: Iterable = None,</span>
<span class="c1">#                        ignore_case: bool = True) -&gt; Iterator:</span>
<span class="c1">#     &quot;&quot;&quot; Recursively walk through subdirectory and files but stop and return path as soon as</span>
<span class="c1">#     at least one file or at least one folder matches at least one prefix or at least one suffix.</span>
<span class="c1">#</span>
<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     path : :obj:`str`</span>
<span class="c1">#         Directory to scan.</span>
<span class="c1">#     prefixes : :obj:`collections.abc.Iterable`, optional</span>
<span class="c1">#         Current directory is returned if at least one contained item starts with one of the prefixes.</span>
<span class="c1">#     suffixes : :obj:`collections.abc.Iterable`, optional</span>
<span class="c1">#         Current directory is returned if at least one contained item ends with one of the suffixes.</span>
<span class="c1">#         Files are tested against suffixes including and excluding file extensions.</span>
<span class="c1">#         Defaults to ``[&#39;notes&#39;, &#39;rests&#39;, &#39;notes_and_rests&#39;, &#39;measures&#39;, &#39;events&#39;, &#39;labels&#39;, &#39;chords&#39;, &#39;expanded&#39;,</span>
<span class="c1">#         &#39;harmonies&#39;, &#39;cadences&#39;, &#39;form_labels&#39;, &#39;MS3&#39;]``</span>
<span class="c1">#     ignore_case : :obj:`bool`, optional</span>
<span class="c1">#         Defaults to True, meaning that file and folder names match prefixes and suffixes independent</span>
<span class="c1">#         of capitalization.</span>
<span class="c1">#</span>
<span class="c1">#     Yields</span>
<span class="c1">#     ------</span>
<span class="c1">#     :obj:`str`</span>
<span class="c1">#         Full path of the next subcorpus.</span>
<span class="c1">#</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def check_fname(s):</span>
<span class="c1">#         if ignore_case:</span>
<span class="c1">#             return any(s.lower().startswith(p) for p in prefixes) or \</span>
<span class="c1">#                    any(s.lower().endswith(suf) for suf in suffixes)</span>
<span class="c1">#         return any(s.startswith(p) for p in prefixes) or \</span>
<span class="c1">#                any(s.endswith(suf) for suf in suffixes)</span>
<span class="c1">#</span>
<span class="c1">#     if prefixes is None:</span>
<span class="c1">#         prefixes = [&#39;metadata.tsv&#39;] + STANDARD_NAMES</span>
<span class="c1">#     if suffixes is None:</span>
<span class="c1">#         suffixes = []</span>
<span class="c1">#</span>
<span class="c1">#     if ignore_case:</span>
<span class="c1">#         prefixes = [p.lower() for p in prefixes]</span>
<span class="c1">#         suffixes = [s.lower() for s in suffixes]</span>
<span class="c1">#</span>
<span class="c1">#     for d, subdirs, files in os.walk(path):</span>
<span class="c1">#         subdirs[:] = sorted(subdirs)</span>
<span class="c1">#         if files != []:</span>
<span class="c1">#             fnames, _ = zip(*[os.path.splitext(f) for f in files])</span>
<span class="c1">#         else:</span>
<span class="c1">#             fnames = []</span>
<span class="c1">#         for item_type, items_to_check in zip((&#39;fname.ext&#39;, &#39;subdirectory&#39;, &#39;fname&#39;), (files, subdirs, fnames)):</span>
<span class="c1">#             if any(check_fname(i) for i in items_to_check):</span>
<span class="c1">#                 match = next(i for i in items_to_check if check_fname(i))</span>
<span class="c1">#                 logger.debug(f&quot;Yielding {d} because the contained {item_type} &#39;{match}&#39; matched.&quot;)</span>
<span class="c1">#                 del (subdirs[:])</span>
<span class="c1">#                 yield d</span>
<span class="c1">#                 break</span>

<span class="k">def</span> <span class="nf">contains_metadata</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="s1">&#39;metadata.tsv&#39;</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">)</span>

<div class="viewcode-block" id="first_level_subdirs"><a class="viewcode-back" href="../../reference.html#ms3.utils.first_level_subdirs">[docs]</a><span class="k">def</span> <span class="nf">first_level_subdirs</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the directory names contained in path.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">subdirs</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">subdirs</span></div>

<span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">contains_corpus_indicator</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="n">first_level_subdirs</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="n">STANDARD_NAMES_OR_GIT</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> contains a subdirectory called </span><span class="si">{</span><span class="n">subdir</span><span class="si">}</span><span class="s2"> and is assumed to be a corpus.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>


<div class="viewcode-block" id="iterate_corpora"><a class="viewcode-back" href="../../reference.html#ms3.utils.iterate_corpora">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">iterate_corpora</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns path if it is a subcorpus or yields its subdirectories if they are. First and most prevalent indicator</span>
<span class="sd">    of a subcorpus is presence of a &#39;metadata.tsv&#39; file. Second indicator is presence of a default folder name or</span>
<span class="sd">    score file.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">contains_metadata</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">path</span>
    <span class="n">subpaths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">subdir</span><span class="p">)</span> <span class="k">for</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="n">first_level_subdirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">subdir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;.&#39;</span><span class="p">]</span>
    <span class="n">yield_subpaths</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">subpath</span> <span class="ow">in</span> <span class="n">subpaths</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">contains_metadata</span><span class="p">(</span><span class="n">subpath</span><span class="p">):</span>
            <span class="n">yield_subpaths</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">yield_subpaths</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">contains_corpus_indicator</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">path</span>
        <span class="k">for</span> <span class="n">subpath</span> <span class="ow">in</span> <span class="n">subpaths</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">contains_corpus_indicator</span><span class="p">(</span><span class="n">subpath</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">):</span>
                <span class="n">yield_subpaths</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">yield_subpaths</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">path</span>
    <span class="k">yield from</span> <span class="n">subpaths</span></div>


<div class="viewcode-block" id="join_tsvs"><a class="viewcode-back" href="../../reference.html#ms3.utils.join_tsvs">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">join_tsvs</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">sort_cols</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Performs outer join on the passed DataFrames based on &#39;mc&#39; and &#39;mc_onset&#39;, if any.</span>
<span class="sd">    Uses: functools.reduce(), sort_cols(), sort_note_lists()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dfs : :obj:`Collection`</span>
<span class="sd">        Collection of DataFrames to join.</span>
<span class="sd">    sort_cols : :obj:`bool`, optional</span>
<span class="sd">        If you pass True, the columns after those defined in :py:attr:`STANDARD_COLUMN_ORDER`</span>
<span class="sd">        will be sorted alphabetically.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">zero</span><span class="p">,</span> <span class="n">one</span><span class="p">,</span> <span class="n">two</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;mc&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;mc_onset&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">two</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">one</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zero</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">join_order</span> <span class="o">=</span> <span class="n">two</span> <span class="o">+</span> <span class="n">one</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zero</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">zero</span><span class="p">)</span><span class="si">}</span><span class="s2"> DataFrames contain none of the columns &#39;mc&#39; and &#39;mc_onset&#39;.&quot;</span><span class="p">)</span>

    <span class="n">pos_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;mc_onset&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">join_tsv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="n">join_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pos_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">join_cols</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_y&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_y&#39;</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">d</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="n">left</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">res</span><span class="p">[</span><span class="n">left</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">duplicates</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">join_tsv</span><span class="p">,</span> <span class="n">join_order</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;midi&#39;</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">sort_note_list</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">two</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">pos_cols</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;mc&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">column_order</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort_cols</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">str2inttuple</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;(),&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;String value &#39;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&#39; could not be converted to an integer, &#39;</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">&#39; not to an integer tuple.&quot;</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\&#39;</span><span class="s2">&quot;</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">int2bool</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">safe_frac</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">frac</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span>

<span class="k">def</span> <span class="nf">safe_int</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span>

<div class="viewcode-block" id="parse_interval_index_column"><a class="viewcode-back" href="../../reference.html#ms3.utils.parse_interval_index_column">[docs]</a><span class="k">def</span> <span class="nf">parse_interval_index_column</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turns a column of strings in the form &#39;[0.0, 1.1)&#39; into a :obj:`pandas.IntervalIndex`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">    column : :obj:`str`, optional</span>
<span class="sd">        Name of the column containing strings. If not specified, use the index.</span>
<span class="sd">    closed : :obj:`str`, optional</span>
<span class="sd">        On whot side the intervals should be closed. Defaults to &#39;left&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.IntervalIndex`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">iv_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;[\[\(]([0-9]*\.[0-9]+), ([0-9]*\.[0-9]+)[\)\]]&quot;</span>
    <span class="k">if</span> <span class="n">column</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">iv_strings</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">iv_strings</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">iv_strings</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">iv_regex</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">iix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">IntervalIndex</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">closed</span><span class="o">=</span><span class="n">closed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">iix</span></div>

<div class="viewcode-block" id="load_tsv"><a class="viewcode-back" href="../../reference.html#ms3.utils.load_tsv">[docs]</a><span class="k">def</span> <span class="nf">load_tsv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">converters</span><span class="o">=</span><span class="p">{},</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{},</span> <span class="n">stringtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Loads the TSV file `path` while applying correct type conversion and parsing tuples.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : :obj:`str`</span>
<span class="sd">        Path to a TSV file as output by format_data().</span>
<span class="sd">    index_col : :obj:`list`, optional</span>
<span class="sd">        By default, the first two columns are loaded as MultiIndex.</span>
<span class="sd">        The first level distinguishes pieces and the second level the elements within.</span>
<span class="sd">    converters, dtype : :obj:`dict`, optional</span>
<span class="sd">        Enhances or overwrites the mapping from column names to types included the constants.</span>
<span class="sd">    stringtype : :obj:`bool`, optional</span>
<span class="sd">        If you&#39;re using pandas &gt;= 1.0.0 you might want to set this to True in order</span>
<span class="sd">        to be using the new `string` datatype that includes the new null type `pd.NA`.</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">CONVERTERS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;added_tones&#39;</span><span class="p">:</span> <span class="n">str2inttuple</span><span class="p">,</span>
        <span class="s1">&#39;act_dur&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span>
        <span class="s1">&#39;composed_end&#39;</span><span class="p">:</span> <span class="n">safe_int</span><span class="p">,</span>
        <span class="s1">&#39;composed_start&#39;</span><span class="p">:</span> <span class="n">safe_int</span><span class="p">,</span>
        <span class="s1">&#39;chord_tones&#39;</span><span class="p">:</span> <span class="n">str2inttuple</span><span class="p">,</span>
        <span class="s1">&#39;globalkey_is_minor&#39;</span><span class="p">:</span> <span class="n">int2bool</span><span class="p">,</span>
        <span class="s1">&#39;localkey_is_minor&#39;</span><span class="p">:</span> <span class="n">int2bool</span><span class="p">,</span>
        <span class="s1">&#39;mc_offset&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span>
        <span class="s1">&#39;mc_onset&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span>
        <span class="s1">&#39;mn_onset&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span>
        <span class="s1">&#39;movementNumber&#39;</span><span class="p">:</span> <span class="n">safe_int</span><span class="p">,</span>
        <span class="s1">&#39;next&#39;</span><span class="p">:</span> <span class="n">str2inttuple</span><span class="p">,</span>
        <span class="s1">&#39;nominal_duration&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span>
        <span class="s1">&#39;quarterbeats&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span>
        <span class="s1">&#39;onset&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span>
        <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span>
        <span class="s1">&#39;scalar&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span> <span class="p">}</span>

    <span class="n">DTYPES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;absolute_base&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;absolute_root&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;alt_label&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;barline&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;base&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;bass_note&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cadence&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;cadences_id&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;changes&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;chord&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;chord_id&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;chord_type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;color_name&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;color_html&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;color_r&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;color_g&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;color_b&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;color_a&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dont_count&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;expanded_id&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;figbass&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;globalkey&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;gracenote&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;harmonies_id&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;harmony_layer&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
        <span class="s1">&#39;keysig&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;label_type&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
        <span class="s1">&#39;leftParen&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;localkey&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;mc&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mc_playthrough&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;midi&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mn&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;offset:x&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;offset_x&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;offset:y&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;offset_y&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;nashville&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;notes_id&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;numbering_offset&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;numeral&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;pedal&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;playthrough&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;phraseend&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;regex_match&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
        <span class="s1">&#39;relativeroot&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;repeats&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;rightParen&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;root&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;rootCase&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;slur&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;special&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;staff&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tied&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;timesig&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;tpc&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;voice&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;voices&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;volta&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">converters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">CONVERTERS</span><span class="p">)</span>
        <span class="n">conv</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">converters</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">types</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">types</span> <span class="o">=</span> <span class="n">dtype</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">DTYPES</span><span class="p">)</span>
        <span class="n">types</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stringtype</span><span class="p">:</span>
        <span class="n">types</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span> <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="nb">str</span> <span class="k">else</span> <span class="n">typ</span> <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">types</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="n">index_col</span><span class="p">,</span>
                       <span class="n">dtype</span><span class="o">=</span><span class="n">types</span><span class="p">,</span>
                       <span class="n">converters</span><span class="o">=</span><span class="n">conv</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;mn&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
        <span class="n">mn_volta</span> <span class="o">=</span> <span class="n">mn2int</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">mn</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">mn</span> <span class="o">=</span> <span class="n">mn_volta</span><span class="o">.</span><span class="n">mn</span>
        <span class="k">if</span> <span class="n">mn_volta</span><span class="o">.</span><span class="n">volta</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;volta&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;Int64&#39;</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">volta</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mn_volta</span><span class="o">.</span><span class="n">volta</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;interval&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">iv_index</span> <span class="o">=</span> <span class="n">parse_interval_index_column</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;interval&#39;</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">iv_index</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;interval&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="make_continuous_offset_dict"><a class="viewcode-back" href="../../reference.html#ms3.utils.make_continuous_offset_dict">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">make_continuous_offset_dict</span><span class="p">(</span><span class="n">measures</span><span class="p">,</span> <span class="n">quarters</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">negative_anacrusis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Takes a measures table and compute each MC&#39;s offset from the piece&#39;s beginning. Deal with</span>
<span class="sd">    voltas before passing the table.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    measures : :obj:`pandas.DataFrame`</span>
<span class="sd">        A measures table with &#39;normal&#39; RangeIndex containing the column &#39;act_durs&#39; and one of</span>
<span class="sd">        &#39;mc&#39; or &#39;mc_playthrough&#39; (if repeats were unfolded).</span>
<span class="sd">    quarters : :obj:`bool`, optional</span>
<span class="sd">        By default, the continuous offsets are expressed in quarter notes. Pass false to leave them as fractions</span>
<span class="sd">        of a whole note.</span>
<span class="sd">    negative_anacrusis : :obj:`fractions.Fraction`</span>
<span class="sd">        By default, the first value is 0. If you pass a fraction here, the first value will be its negative and the</span>
<span class="sd">        second value will be 0.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.Series`</span>
<span class="sd">        Cumulative sum of the actual durations, shifted down by 1.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;mc_playthrough&#39;</span> <span class="ow">in</span> <span class="n">measures</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">act_durs</span> <span class="o">=</span> <span class="n">measures</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;mc_playthrough&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">act_dur</span>
    <span class="k">elif</span> <span class="s1">&#39;mc&#39;</span> <span class="ow">in</span> <span class="n">measures</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">act_durs</span> <span class="o">=</span> <span class="n">measures</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;mc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">act_dur</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Expected to have at least one column called &#39;mc&#39; or &#39;mc_playthrough&#39;.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">quarters</span><span class="p">:</span>
        <span class="n">act_durs</span> <span class="o">=</span> <span class="n">act_durs</span> <span class="o">*</span> <span class="mi">4</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">act_durs</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">last_val</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">last_ix</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ending</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">last_val</span><span class="p">,</span> <span class="n">last_val</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">last_ix</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">res</span><span class="p">,</span> <span class="n">ending</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">negative_anacrusis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">-=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">frac</span><span class="p">(</span><span class="n">negative_anacrusis</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="make_id_tuples"><a class="viewcode-back" href="../../reference.html#ms3.utils.make_id_tuples">[docs]</a><span class="k">def</span> <span class="nf">make_id_tuples</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; For a given key, this function returns index tuples in the form [(key, 0), ..., (key, n)]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        indices in the form [(key, 0), ..., (key, n)]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span></div>


<div class="viewcode-block" id="make_interval_index_from_breaks"><a class="viewcode-back" href="../../reference.html#ms3.utils.make_interval_index_from_breaks">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">make_interval_index_from_breaks</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">end_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;interval&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Interpret a Series as interval breaks and make an IntervalIndex out of it.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    S : :obj:`pandas.Series`</span>
<span class="sd">        Interval breaks. It is assumed that the breaks are sorted.</span>
<span class="sd">    end_value : numeric, optional</span>
<span class="sd">        Often you want to pass the right border of the last interval.</span>
<span class="sd">    closed : :obj:`str`, optional</span>
<span class="sd">        Defaults to &#39;left&#39;. Argument passed to to :py:meth:`pandas.IntervalIndex.from_breaks`.</span>
<span class="sd">    name : :obj:`str`, optional</span>
<span class="sd">        Name of the created index. Defaults to &#39;interval&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.IntervalIndex`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">breaks</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">end_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">breaks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">end_value</span> <span class="o">&gt;</span> <span class="n">last</span><span class="p">:</span>
            <span class="n">breaks</span> <span class="o">+=</span> <span class="p">[</span><span class="n">end_value</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">breaks</span> <span class="o">+=</span> <span class="p">[</span><span class="n">last</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">iix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">IntervalIndex</span><span class="o">.</span><span class="n">from_breaks</span><span class="p">(</span><span class="n">breaks</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="n">closed</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">unsorted</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">breaks</span><span class="p">,</span> <span class="n">breaks</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="k">if</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="n">a</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unsorted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Breaks are not sorted: </span><span class="si">{</span><span class="n">unsorted</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot create IntervalIndex from these breaks:</span><span class="se">\n</span><span class="si">{</span><span class="n">breaks</span><span class="si">}</span><span class="se">\n</span><span class="s2">Exception: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">return</span> <span class="n">iix</span></div>


<div class="viewcode-block" id="make_name_columns"><a class="viewcode-back" href="../../reference.html#ms3.utils.make_name_columns">[docs]</a><span class="k">def</span> <span class="nf">make_name_columns</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Relies on the columns ``localkey`` and ``globalkey`` to transform the columns ``root`` and ``bass_notes`` from</span>
<span class="sd">    scale degrees (expressed as fifths) to absolute note names, e.g. in C major: 0 =&gt; &#39;C&#39;, 7 =&gt; &#39;C#&#39;, -5 =&gt; &#39;Db&#39;</span>
<span class="sd">    Uses: transform(), scale_degree2name&quot;&quot;&quot;</span>
    <span class="n">new_cols</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="s1">&#39;bass_note&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">new_cols</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">scale_degree2name</span><span class="p">,</span> <span class="p">[</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;localkey&#39;</span><span class="p">,</span> <span class="s1">&#39;globalkey&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">new_cols</span><span class="p">)</span></div>


<span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">make_playthrough2mc</span><span class="p">(</span><span class="n">measures</span><span class="p">):</span>
    <span class="n">ml</span> <span class="o">=</span> <span class="n">measures</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;mc&#39;</span><span class="p">)</span>
    <span class="n">seq</span> <span class="o">=</span> <span class="n">next2sequence</span><span class="p">(</span><span class="n">ml</span><span class="o">.</span><span class="n">next</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="c1">############## &lt; v0.5: playthrough &lt;=&gt; mn; &gt;= v0.5: playthrough &lt;=&gt; mc</span>
    <span class="c1"># playthrough = compute_mn(ml[[&#39;dont_count&#39;, &#39;numbering_offset&#39;]].loc[seq]).rename(&#39;playthrough&#39;)</span>
    <span class="n">mc_playthrough</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mc_playthrough&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;Int64&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mc_playthrough</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">mc_playthrough</span><span class="o">.</span><span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;The first mc should be 0 or 1, not </span><span class="si">{</span><span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">mc_playthrough</span>


<div class="viewcode-block" id="map2elements"><a class="viewcode-back" href="../../reference.html#ms3.utils.map2elements">[docs]</a><span class="k">def</span> <span class="nf">map2elements</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; If `e` is an iterable, `f` is applied to all elements.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">map2elements</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">):</span>
                <span class="c1">### e.g., if a numerical index is transformed to strings</span>
                <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">map2elements</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="merge_ties"><a class="viewcode-back" href="../../reference.html#ms3.utils.merge_ties">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">merge_ties</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">return_dropped</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">perform_checks</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; In a note list, merge tied notes to single events with accumulated durations.</span>
<span class="sd">        Input dataframe needs columns [&#39;duration&#39;, &#39;tied&#39;, &#39;midi&#39;, &#39;staff&#39;]. This</span>
<span class="sd">        function does not handle correctly overlapping ties on the same pitch since</span>
<span class="sd">        it doesn&#39;t take into account the notational layers (&#39;voice&#39;).</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df</span>
<span class="sd">    return_dropped</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
        <span class="n">vc</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">tied</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">vc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">vc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;More than one 1 or -1:</span><span class="se">\n</span><span class="si">{</span><span class="n">vc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
        <span class="n">dur</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">drop</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="s1">&#39;ix&#39;</span><span class="p">:</span> <span class="n">ix</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">dur</span><span class="p">,</span> <span class="s1">&#39;dropped&#39;</span><span class="p">:</span> <span class="n">drop</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">merge_notes</span><span class="p">(</span><span class="n">staff_midi</span><span class="p">):</span>

        <span class="n">staff_midi</span><span class="p">[</span><span class="s1">&#39;chunks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">staff_midi</span><span class="o">.</span><span class="n">tied</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">staff_midi</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;chunks&#39;</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">merge</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;ix&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">tied</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">notna</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">tied</span><span class="o">.</span><span class="n">notna</span><span class="p">(),</span> <span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="s1">&#39;tied&#39;</span><span class="p">,</span> <span class="s1">&#39;midi&#39;</span><span class="p">,</span> <span class="s1">&#39;staff&#39;</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">perform_checks</span><span class="p">:</span>
        <span class="n">before</span> <span class="o">=</span> <span class="n">notna</span><span class="o">.</span><span class="n">tied</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="n">new_dur</span> <span class="o">=</span> <span class="n">notna</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;staff&#39;</span><span class="p">,</span> <span class="s1">&#39;midi&#39;</span><span class="p">],</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">merge_notes</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_dur</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_dur</span><span class="o">.</span><span class="n">duration</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">new_dur</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_dropped</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_dur</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;dropped&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_dur</span><span class="o">.</span><span class="n">dropped</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">new_dur</span><span class="o">.</span><span class="n">dropped</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">perform_checks</span><span class="p">:</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">tied</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">before</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">after</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;Error while merging ties. Before:</span><span class="se">\n</span><span class="si">{</span><span class="n">before</span><span class="si">}</span><span class="se">\n</span><span class="s2">After:</span><span class="se">\n</span><span class="si">{</span><span class="n">after</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="metadata2series"><a class="viewcode-back" href="../../reference.html#ms3.utils.metadata2series">[docs]</a><span class="k">def</span> <span class="nf">metadata2series</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turns a metadata dict into a pd.Series() (for storing in a DataFrame)</span>
<span class="sd">    Uses: ambitus2oneliner(), dict2oneliner(), parts_info()</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.Series`</span>
<span class="sd">        A series allowing for storing metadata as a row of a DataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;TimeSig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict2oneliner</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;TimeSig&#39;</span><span class="p">])</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;KeySig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict2oneliner</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;KeySig&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s1">&#39;ambitus&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;ambitus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ambitus2oneliner</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;ambitus&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s1">&#39;parts&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parts_info</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;parts&#39;</span><span class="p">]))</span>
        <span class="k">del</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;parts&#39;</span><span class="p">])</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span></div>


<div class="viewcode-block" id="midi2octave"><a class="viewcode-back" href="../../reference.html#ms3.utils.midi2octave">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">midi2octave</span><span class="p">(</span><span class="n">midi</span><span class="p">,</span> <span class="n">fifths</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; For a given MIDI pitch, calculate the octave. Middle octave = 4</span>
<span class="sd">        Uses: fifths2pc(), map2elements()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    midi : :obj:`int`</span>
<span class="sd">        MIDI pitch (positive integer)</span>
<span class="sd">    fifths : :obj:`int`, optional</span>
<span class="sd">        To be precise, for some Tonal Pitch Classes, the octave deviates</span>
<span class="sd">        from the simple formula ``MIDI // 12 - 1``, e.g. for B# or Cb.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">midi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">midi</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">midi</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">map2elements</span><span class="p">(</span><span class="n">midi</span><span class="p">,</span> <span class="n">midi2octave</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">midi</span>
    <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">fifths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">fifths2pc</span><span class="p">(</span><span class="n">fifths</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">midi</span> <span class="o">%</span> <span class="mi">12</span> <span class="o">!=</span> <span class="n">pc</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;midi2octave(): The Tonal Pitch Class </span><span class="si">{</span><span class="n">fifths</span><span class="si">}</span><span class="s2"> cannot be MIDI pitch </span><span class="si">{</span><span class="n">midi</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fifths</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="mi">12</span><span class="p">,</span>  <span class="c1"># B#</span>
            <span class="mi">19</span><span class="p">,</span>  <span class="c1"># B##</span>
            <span class="mi">26</span><span class="p">,</span>  <span class="c1"># B###</span>
            <span class="mi">24</span><span class="p">,</span>  <span class="c1"># A###</span>
        <span class="p">]:</span>
            <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">fifths</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="o">-</span><span class="mi">7</span><span class="p">,</span>  <span class="c1"># Cb</span>
            <span class="o">-</span><span class="mi">14</span><span class="p">,</span>  <span class="c1"># Cbb</span>
            <span class="o">-</span><span class="mi">21</span><span class="p">,</span>  <span class="c1"># Cbbb</span>
            <span class="o">-</span><span class="mi">19</span><span class="p">,</span>  <span class="c1"># Dbbb</span>
        <span class="p">]:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">midi</span> <span class="o">//</span> <span class="mi">12</span> <span class="o">+</span> <span class="n">i</span></div>


<span class="k">def</span> <span class="nf">midi2name</span><span class="p">(</span><span class="n">midi</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">midi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">midi</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">midi</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">midi</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">midi2name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">midi</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">map2elements</span><span class="p">(</span><span class="n">midi</span><span class="p">,</span> <span class="n">midi2name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">midi</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span>
             <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;C#/Db&#39;</span><span class="p">,</span>
             <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span>
             <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;D#/Eb&#39;</span><span class="p">,</span>
             <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span>
             <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span>
             <span class="mi">6</span><span class="p">:</span> <span class="s1">&#39;F#/Gb&#39;</span><span class="p">,</span>
             <span class="mi">7</span><span class="p">:</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span>
             <span class="mi">8</span><span class="p">:</span> <span class="s1">&#39;G#/Ab&#39;</span><span class="p">,</span>
             <span class="mi">9</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span>
             <span class="mi">10</span><span class="p">:</span> <span class="s1">&#39;A#/Bb&#39;</span><span class="p">,</span>
             <span class="mi">11</span><span class="p">:</span> <span class="s1">&#39;B&#39;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">names</span><span class="p">[</span><span class="n">midi</span> <span class="o">%</span> <span class="mi">12</span><span class="p">]</span>


<div class="viewcode-block" id="mn2int"><a class="viewcode-back" href="../../reference.html#ms3.utils.mn2int">[docs]</a><span class="k">def</span> <span class="nf">mn2int</span><span class="p">(</span><span class="n">mn_series</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turn a series of measure numbers parsed as strings into two integer columns &#39;mn&#39; and &#39;volta&#39;. &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">split</span> <span class="o">=</span> <span class="n">mn_series</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?P&lt;mn&gt;\d+)(?P&lt;volta&gt;[a-g])?&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">mn_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mn_series</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mn&#39;</span><span class="p">,</span> <span class="s1">&#39;volta&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mn_series</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;Int64&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mn_series</span>
    <span class="n">split</span><span class="o">.</span><span class="n">mn</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">split</span><span class="o">.</span><span class="n">mn</span><span class="p">)</span>
    <span class="n">split</span><span class="o">.</span><span class="n">volta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">split</span><span class="o">.</span><span class="n">volta</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}))</span>
    <span class="k">return</span> <span class="n">split</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;Int64&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="name2format"><a class="viewcode-back" href="../../reference.html#ms3.utils.name2format">[docs]</a><span class="k">def</span> <span class="nf">name2format</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="n">name_col</span><span class="o">=</span><span class="s1">&#39;color_name&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts a column with CSS3 names into &#39;html&#39;, &#39;rgb&#39;, or  &#39;rgba&#39;.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">name_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">color_name2html</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;rgb&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">name_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">color_name2rgb</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;rgba&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">name_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">color_name2rgba</span><span class="p">)</span></div>


<div class="viewcode-block" id="name2fifths"><a class="viewcode-back" href="../../reference.html#ms3.utils.name2fifths">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">name2fifths</span><span class="p">(</span><span class="n">nn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turn a note name such as `Ab` into a tonal pitch class, such that -1=F, 0=C, 1=G etc.</span>
<span class="sd">        Uses: split_note_name()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nn</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">int</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">nn</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">nn</span>
    <span class="n">name_tpcs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
    <span class="n">accidentals</span><span class="p">,</span> <span class="n">note_name</span> <span class="o">=</span> <span class="n">split_note_name</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">note_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">step_tpc</span> <span class="o">=</span> <span class="n">name_tpcs</span><span class="p">[</span><span class="n">note_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">step_tpc</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">accidentals</span></div>


<div class="viewcode-block" id="name2pc"><a class="viewcode-back" href="../../reference.html#ms3.utils.name2pc">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">name2pc</span><span class="p">(</span><span class="n">nn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turn a note name such as `Ab` into a tonal pitch class, such that -1=F, 0=C, 1=G etc.</span>
<span class="sd">        Uses: split_note_name()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nn</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">int</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">nn</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">nn</span><span class="si">}</span><span class="s2">&#39; is not a valid note name.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nn</span>
    <span class="n">name_tpcs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">}</span>
    <span class="n">accidentals</span><span class="p">,</span> <span class="n">note_name</span> <span class="o">=</span> <span class="n">split_note_name</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">note_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">step_pc</span> <span class="o">=</span> <span class="n">name_tpcs</span><span class="p">[</span><span class="n">note_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">step_pc</span> <span class="o">+</span> <span class="n">accidentals</span><span class="p">)</span> <span class="o">%</span> <span class="mi">12</span></div>


<div class="viewcode-block" id="nan_eq"><a class="viewcode-back" href="../../reference.html#ms3.utils.nan_eq">[docs]</a><span class="k">def</span> <span class="nf">nan_eq</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns True if a and b are equal or both null. Works on two Series or two elements.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">b</span><span class="p">))</span></div>


<div class="viewcode-block" id="next2sequence"><a class="viewcode-back" href="../../reference.html#ms3.utils.next2sequence">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">next2sequence</span><span class="p">(</span><span class="n">next_col</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turns a &#39;next&#39; column into the correct sequence of MCs corresponding to unfolded repetitions.</span>
<span class="sd">    Requires that the Series&#39; index be the MCs as in ``measures.set_index(&#39;mc&#39;).next``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mc</span> <span class="o">=</span> <span class="n">next_col</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">last_mc</span> <span class="o">=</span> <span class="n">next_col</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">max_iter</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">last_mc</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nxt</span> <span class="o">=</span> <span class="n">next_col</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">mc</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_iter</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mc</span><span class="p">)</span>
        <span class="n">new_mc</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span> <span class="o">=</span> <span class="n">nxt</span><span class="p">[</span><span class="n">mc</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nxt</span><span class="p">[</span><span class="n">mc</span><span class="p">]</span> <span class="o">=</span> <span class="n">rest</span>
        <span class="n">mc</span> <span class="o">=</span> <span class="n">new_mc</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">max_iter</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="no_collections_no_booleans"><a class="viewcode-back" href="../../reference.html#ms3.utils.no_collections_no_booleans">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">no_collections_no_booleans</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">coll_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bool_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cleans the DataFrame columns [&#39;next&#39;, &#39;chord_tones&#39;, &#39;added_tones&#39;] from tuples and the columns</span>
<span class="sd">    [&#39;globalkey_is_minor&#39;, &#39;localkey_is_minor&#39;] from booleans, converting them all to integers</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="n">collection_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;next&#39;</span><span class="p">,</span> <span class="s1">&#39;chord_tones&#39;</span><span class="p">,</span> <span class="s1">&#39;added_tones&#39;</span><span class="p">]</span>
    <span class="n">bool_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;globalkey_is_minor&#39;</span><span class="p">,</span> <span class="s1">&#39;localkey_is_minor&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">coll_columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">collection_cols</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">coll_columns</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bool_columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bool_cols</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bool_columns</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">collection_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df needs to be a DataFrame, not a </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="vm">__class__</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cc</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cc</span><span class="p">],</span> <span class="n">iterable2str</span><span class="p">,</span> <span class="n">column_wise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transformed iterables in the columns </span><span class="si">{</span><span class="n">cc</span><span class="si">}</span><span class="s2"> to strings.&quot;</span><span class="p">)</span>
    <span class="n">bc</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">bool_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="nb">int</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">bc</span><span class="p">}</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">conv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<span class="k">def</span> <span class="nf">ordinal_suffix</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">suffixes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;st&#39;</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;nd&#39;</span><span class="p">,</span>
        <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;rd&#39;</span>
    <span class="p">}</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">suffixes</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">suffixes</span><span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">return</span> <span class="s1">&#39;th&#39;</span>


<div class="viewcode-block" id="parts_info"><a class="viewcode-back" href="../../reference.html#ms3.utils.parts_info">[docs]</a><span class="k">def</span> <span class="nf">parts_info</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Turns a (nested) ``metadata[&#39;parts&#39;]`` dict into a flat dict based on staves.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; d = s.mscx.metadata</span>
<span class="sd">    &gt;&gt;&gt; parts_info(d[&#39;parts&#39;])</span>
<span class="sd">    {&#39;staff_1_instrument&#39;: &#39;Voice&#39;,</span>
<span class="sd">     &#39;staff_1_ambitus&#39;: &#39;66-76 (F#4-E5)&#39;,</span>
<span class="sd">     &#39;staff_2_instrument&#39;: &#39;Voice&#39;,</span>
<span class="sd">     &#39;staff_2_ambitus&#39;: &#39;55-69 (G3-A4)&#39;,</span>
<span class="sd">     &#39;staff_3_instrument&#39;: &#39;Voice&#39;,</span>
<span class="sd">     &#39;staff_3_ambitus&#39;: &#39;48-67 (C3-G4)&#39;,</span>
<span class="sd">     &#39;staff_4_instrument&#39;: &#39;Voice&#39;,</span>
<span class="sd">     &#39;staff_4_ambitus&#39;: &#39;41-60 (F2-C4)&#39;}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">part_dict</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">part_dict</span><span class="p">[</span><span class="s1">&#39;staves&#39;</span><span class="p">]:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;staff_</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_instrument&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">part_dict</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span>
            <span class="n">amb_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_ambitus&#39;</span>
            <span class="n">res</span><span class="p">[</span><span class="n">amb_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ambitus2oneliner</span><span class="p">(</span><span class="n">part_dict</span><span class="p">[</span><span class="n">amb_name</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="path2type"><a class="viewcode-back" href="../../reference.html#ms3.utils.path2type">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">path2type</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Determine a file&#39;s type by scanning its path for default components in the constant STANDARD_NAMES.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">comp2type</span> <span class="o">=</span> <span class="p">{</span><span class="n">comp</span><span class="p">:</span> <span class="n">comp</span> <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">STANDARD_NAMES</span><span class="p">}</span>
    <span class="n">comp2type</span><span class="p">[</span><span class="s1">&#39;MS3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;scores&#39;</span>
    <span class="n">comp2type</span><span class="p">[</span><span class="s1">&#39;harmonies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;expanded&#39;</span>
    <span class="k">def</span> <span class="nf">find_components</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">comp</span> <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comp2type</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="c1"># give preference to folder names before file names</span>
        <span class="n">directory</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">found_components</span><span class="p">,</span> <span class="n">n_found</span> <span class="o">=</span> <span class="n">find_components</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_found</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">found_components</span><span class="p">,</span> <span class="n">n_found</span> <span class="o">=</span> <span class="n">find_components</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">found_components</span><span class="p">,</span> <span class="n">n_found</span> <span class="o">=</span> <span class="n">find_components</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_found</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score_extensions</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;.mscx&#39;</span><span class="p">,</span> <span class="s1">&#39;.mscz&#39;</span><span class="p">,</span> <span class="s1">&#39;.cap&#39;</span><span class="p">,</span> <span class="s1">&#39;.capx&#39;</span><span class="p">,</span> <span class="s1">&#39;.midi&#39;</span><span class="p">,</span> <span class="s1">&#39;.mid&#39;</span><span class="p">,</span> <span class="s1">&#39;.musicxml&#39;</span><span class="p">,</span> <span class="s1">&#39;.mxl&#39;</span><span class="p">,</span> <span class="s1">&#39;.xml&#39;</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">fext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">score_extensions</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recognized file extension &#39;</span><span class="si">{</span><span class="n">fext</span><span class="si">}</span><span class="s2">&#39; as score.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;scores&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Type could not be inferred from path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;unknown&#39;</span>
    <span class="k">if</span> <span class="n">n_found</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">comp2type</span><span class="p">[</span><span class="n">found_components</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; recognized as </span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">typ</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shortened_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">shortened_path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">shortened_path</span><span class="p">,</span> <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">shortened_path</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comp2type</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">base</span><span class="p">:</span>
                    <span class="n">typ</span> <span class="o">=</span> <span class="n">comp2type</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multiple components (</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">found_components</span><span class="p">)</span><span class="si">}</span><span class="s2">) found in path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;. Chose the last one: </span><span class="si">{</span><span class="n">typ</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">typ</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Components </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">found_components</span><span class="p">)</span><span class="si">}</span><span class="s2"> found in path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;, but not in one of its constituents.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;other&#39;</span></div>


<div class="viewcode-block" id="pretty_dict"><a class="viewcode-back" href="../../reference.html#ms3.utils.pretty_dict">[docs]</a><span class="k">def</span> <span class="nf">pretty_dict</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">heading</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turns a dictionary into a string where the keys are printed in a column, separated by &#39;-&gt;&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">heading</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">KEY</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">heading</span><span class="p">),</span> <span class="o">**</span><span class="n">d</span><span class="p">)</span>
    <span class="n">left</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">ks</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="n">vs</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vs</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">vs</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">vs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ks</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="si">:{</span><span class="n">left</span><span class="si">}}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ks</span><span class="si">:{</span><span class="n">left</span><span class="si">}}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">vs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">heading</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">heading</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>



<div class="viewcode-block" id="resolve_dir"><a class="viewcode-back" href="../../reference.html#ms3.utils.resolve_dir">[docs]</a><span class="k">def</span> <span class="nf">resolve_dir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Resolves &#39;~&#39; to HOME directory and turns ``d`` into an absolute path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;~&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></div>


<div class="viewcode-block" id="rgb2format"><a class="viewcode-back" href="../../reference.html#ms3.utils.rgb2format">[docs]</a><span class="k">def</span> <span class="nf">rgb2format</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="n">r_col</span><span class="o">=</span><span class="s1">&#39;color_r&#39;</span><span class="p">,</span> <span class="n">g_col</span><span class="o">=</span><span class="s1">&#39;color_g&#39;</span><span class="p">,</span> <span class="n">b_col</span><span class="o">=</span><span class="s1">&#39;color_b&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts three RGB columns into a color_html or color_name column. &quot;&quot;&quot;</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">r_col</span><span class="p">,</span> <span class="n">g_col</span><span class="p">,</span> <span class="n">b_col</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">rgb_tuple2html</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;color_html&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">rgb_tuple2name</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;color_name&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="rgb_tuple2format"><a class="viewcode-back" href="../../reference.html#ms3.utils.rgb_tuple2format">[docs]</a><span class="k">def</span> <span class="nf">rgb_tuple2format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts a single RGB tuple into &#39;HTML&#39; or &#39;name&#39;.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">t</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">normalize_integer_triplet</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">t</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">rgb_to_hex</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">rgb_to_name</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">MS3_RGB</span><span class="p">[</span><span class="n">norm</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">rgb_to_hex</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span></div>


<div class="viewcode-block" id="rgb_tuple2html"><a class="viewcode-back" href="../../reference.html#ms3.utils.rgb_tuple2html">[docs]</a><span class="k">def</span> <span class="nf">rgb_tuple2html</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts a single RGB tuple into HTML.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">rgb_tuple2format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="rgb_tuple2name"><a class="viewcode-back" href="../../reference.html#ms3.utils.rgb_tuple2name">[docs]</a><span class="k">def</span> <span class="nf">rgb_tuple2name</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts a single RGB tuple into its CSS3 name or to HTML if there is none.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">rgb_tuple2format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">rgba2attrs</span><span class="p">(</span><span class="n">named_tuple</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">named_tuple</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="k">def</span> <span class="nf">rgba2params</span><span class="p">(</span><span class="n">named_tuple</span><span class="p">):</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="n">rgba2attrs</span><span class="p">(</span><span class="n">named_tuple</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;color_&#39;</span><span class="o">+</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<div class="viewcode-block" id="roman_numeral2fifths"><a class="viewcode-back" href="../../reference.html#ms3.utils.roman_numeral2fifths">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">roman_numeral2fifths</span><span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">global_minor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turn a Roman numeral into a TPC interval (e.g. for transposition purposes).</span>
<span class="sd">        Uses: split_scale_degree()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">rn</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">rn</span>
    <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">rn</span><span class="p">:</span>
        <span class="n">resolved</span> <span class="o">=</span> <span class="n">resolve_relative_keys</span><span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">global_minor</span><span class="p">)</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;minor&#39;</span> <span class="k">if</span> <span class="n">global_minor</span> <span class="k">else</span> <span class="s1">&#39;major&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Relative numeral </span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2"> mode resolved to </span><span class="si">{</span><span class="n">resolved</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">rn</span> <span class="o">=</span> <span class="n">resolved</span>
    <span class="n">rn_tpcs_maj</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
    <span class="n">rn_tpcs_min</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">}</span>
    <span class="n">accidentals</span><span class="p">,</span> <span class="n">rn_step</span> <span class="o">=</span> <span class="n">split_scale_degree</span><span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">accidentals</span><span class="p">,</span> <span class="n">rn_step</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">rn_step</span> <span class="o">=</span> <span class="n">rn_step</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">step_tpc</span> <span class="o">=</span> <span class="n">rn_tpcs_min</span><span class="p">[</span><span class="n">rn_step</span><span class="p">]</span> <span class="k">if</span> <span class="n">global_minor</span> <span class="k">else</span> <span class="n">rn_tpcs_maj</span><span class="p">[</span><span class="n">rn_step</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">step_tpc</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">accidentals</span></div>


<div class="viewcode-block" id="roman_numeral2semitones"><a class="viewcode-back" href="../../reference.html#ms3.utils.roman_numeral2semitones">[docs]</a><span class="k">def</span> <span class="nf">roman_numeral2semitones</span><span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">global_minor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turn a Roman numeral into a semitone distance from the root (0-11).</span>
<span class="sd">        Uses: split_scale_degree()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">rn</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">rn</span>
    <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">rn</span><span class="p">:</span>
        <span class="n">resolved</span> <span class="o">=</span> <span class="n">resolve_relative_keys</span><span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">global_minor</span><span class="p">)</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;minor&#39;</span> <span class="k">if</span> <span class="n">global_minor</span> <span class="k">else</span> <span class="s1">&#39;major&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Relative numeral </span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2"> mode resolved to </span><span class="si">{</span><span class="n">resolved</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">rn</span> <span class="o">=</span> <span class="n">resolved</span>
    <span class="n">rn_tpcs_maj</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">}</span>
    <span class="n">rn_tpcs_min</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
    <span class="n">accidentals</span><span class="p">,</span> <span class="n">rn_step</span> <span class="o">=</span> <span class="n">split_scale_degree</span><span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">accidentals</span><span class="p">,</span> <span class="n">rn_step</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">rn_step</span> <span class="o">=</span> <span class="n">rn_step</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">step_tpc</span> <span class="o">=</span> <span class="n">rn_tpcs_min</span><span class="p">[</span><span class="n">rn_step</span><span class="p">]</span> <span class="k">if</span> <span class="n">global_minor</span> <span class="k">else</span> <span class="n">rn_tpcs_maj</span><span class="p">[</span><span class="n">rn_step</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">step_tpc</span> <span class="o">+</span> <span class="n">accidentals</span></div>


<div class="viewcode-block" id="scale_degree2name"><a class="viewcode-back" href="../../reference.html#ms3.utils.scale_degree2name">[docs]</a><span class="k">def</span> <span class="nf">scale_degree2name</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">localkey</span><span class="p">,</span> <span class="n">globalkey</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; For example, scale degree -1 (fifths, i.e. the subdominant) of the localkey of &#39;VI&#39; within &#39;E&#39; minor is &#39;F&#39;.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sd : :obj:`int`</span>
<span class="sd">        Scale degree expressed as distance from the tonic in fifths.</span>
<span class="sd">    localkey : :obj:`str`</span>
<span class="sd">        Local key in which the scale degree is situated, as Roman numeral (can include slash notation such as V/ii).</span>
<span class="sd">    globalkey : :obj:`str`</span>
<span class="sd">        Global key as a note name. E.g. `Ab` for Ab major, or &#39;c#&#39; for C# minor.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`str`</span>
<span class="sd">        The given scale degree, expressed as a note name.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">localkey</span><span class="p">,</span> <span class="n">globalkey</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span>
    <span class="n">global_minor</span> <span class="o">=</span> <span class="n">globalkey</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">localkey</span><span class="p">:</span>
        <span class="n">localkey</span> <span class="o">=</span> <span class="n">resolve_relative_keys</span><span class="p">(</span><span class="n">localkey</span><span class="p">,</span> <span class="n">global_minor</span><span class="p">)</span>
    <span class="n">lk_fifths</span> <span class="o">=</span> <span class="n">roman_numeral2fifths</span><span class="p">(</span><span class="n">localkey</span><span class="p">,</span> <span class="n">global_minor</span><span class="p">)</span>
    <span class="n">gk_fifths</span> <span class="o">=</span> <span class="n">name2fifths</span><span class="p">(</span><span class="n">globalkey</span><span class="p">)</span>
    <span class="n">sd_transposed</span> <span class="o">=</span> <span class="n">sd</span> <span class="o">+</span> <span class="n">lk_fifths</span> <span class="o">+</span> <span class="n">gk_fifths</span>
    <span class="k">return</span> <span class="n">fifths2name</span><span class="p">(</span><span class="n">sd_transposed</span><span class="p">)</span></div>


<div class="viewcode-block" id="scan_directory"><a class="viewcode-back" href="../../reference.html#ms3.utils.scan_directory">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">scan_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">file_re</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;.*&quot;</span><span class="p">,</span> <span class="n">folder_re</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;.*&quot;</span><span class="p">,</span> <span class="n">exclude_re</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;^(\.|_)&quot;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subdirs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exclude_files_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_metadata</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Generator of file names in ``directory``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dir : :obj:`str`</span>
<span class="sd">        Directory to be scanned for files.</span>
<span class="sd">    file_re, folder_re : :obj:`str` or :obj:`re.Pattern`, optional</span>
<span class="sd">        Regular expressions for filtering certain file names or folder names.</span>
<span class="sd">        The regEx are checked with search(), not match(), allowing for fuzzy search.</span>
<span class="sd">    recursive : :obj:`bool`, optional</span>
<span class="sd">        By default, sub-directories are recursively scanned. Pass False to scan only ``dir``.</span>
<span class="sd">    subdirs : :obj:`bool`, optional</span>
<span class="sd">        By default, full file paths are returned. Pass True to return (path, name) tuples instead.</span>
<span class="sd">    progress : :obj:`bool`, optional</span>
<span class="sd">        By default, the scanning process is shown. Pass False to prevent.</span>
<span class="sd">    exclude_files_only : :obj:`bool`, optional</span>
<span class="sd">        By default, ``exclude_re`` excludes files and folder. Pass True to exclude only files matching the regEx.</span>
<span class="sd">    return_metadata: :obj:`bool`, optional</span>
<span class="sd">        Independent of file_re, files called &#39;metadata.tsv&#39; are always yielded.</span>


<span class="sd">    Yields</span>
<span class="sd">    ------</span>
<span class="sd">    list</span>
<span class="sd">        List of full paths meeting the criteria.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">file_re</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">file_re</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;.*&quot;</span>
    <span class="k">if</span> <span class="n">folder_re</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">folder_re</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;.*&quot;</span>

    <span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">counter</span>

        <span class="k">def</span> <span class="nf">check_regex</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">excl</span><span class="o">=</span><span class="n">exclude_re</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">excl</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="k">for</span> <span class="n">dir_entry</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">scandir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">dir_entry</span><span class="o">.</span><span class="n">name</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dir_entry</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">recursive</span> <span class="ow">or</span> <span class="n">folder_re</span> <span class="o">!=</span> <span class="s1">&#39;.*&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">traverse</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">res</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pbar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">folder_re</span> <span class="o">==</span> <span class="s1">&#39;.*&#39;</span><span class="p">:</span>
                    <span class="n">folder_passes</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">folder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
                        <span class="n">folder_passes</span> <span class="o">=</span> <span class="n">check_regex</span><span class="p">(</span><span class="n">folder_re</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">,</span> <span class="n">excl</span><span class="o">=</span><span class="s1">&#39;^$&#39;</span><span class="p">)</span>  <span class="c1"># passes if the folder path matches the regex</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
                        <span class="n">folder_passes</span> <span class="o">=</span> <span class="n">check_regex</span><span class="p">(</span><span class="n">folder_re</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">excl</span><span class="o">=</span><span class="s1">&#39;^$&#39;</span><span class="p">)</span>  <span class="c1"># passes if the folder name itself matches the regex</span>
                    <span class="k">if</span> <span class="n">folder_passes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exclude_files_only</span><span class="p">:</span> <span class="c1"># True if the exclude_re should also exclude folder names</span>
                        <span class="n">folder_passes</span> <span class="o">=</span> <span class="n">check_regex</span><span class="p">(</span><span class="n">folder_re</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">)</span> <span class="c1"># is false if any part of the folder path matches exclude_re</span>
                <span class="k">if</span> <span class="n">dir_entry</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="n">folder_passes</span> <span class="ow">and</span> <span class="p">(</span><span class="n">check_regex</span><span class="p">(</span><span class="n">file_re</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">return_metadata</span> <span class="ow">and</span> <span class="n">name</span><span class="o">==</span><span class="s1">&#39;metadata.tsv&#39;</span><span class="p">)):</span>
                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">pbar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">({</span><span class="s1">&#39;selected&#39;</span><span class="p">:</span> <span class="n">counter</span><span class="p">})</span>
                    <span class="k">if</span> <span class="n">subdirs</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">path</span>

    <span class="k">if</span> <span class="n">exclude_re</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">exclude_re</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">exclude_re</span> <span class="o">=</span> <span class="s1">&#39;^$&#39;</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">resolve_dir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Not an existing directory: &quot;</span> <span class="o">+</span> <span class="n">directory</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">([])</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Scanning files&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39; files&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">progress</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">traverse</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span></div>


<div class="viewcode-block" id="column_order"><a class="viewcode-back" href="../../reference.html#ms3.utils.column_order">[docs]</a><span class="k">def</span> <span class="nf">column_order</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">first_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sort DataFrame columns so that they start with the order of ``first_cols``, followed by those not included. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">first_cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">first_cols</span> <span class="o">=</span> <span class="n">STANDARD_COLUMN_ORDER</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">remaining</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">first_cols</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
        <span class="c1"># Problem: string sort orders staff_1 staff_10 staff_11 ... and only then staff_2</span>
        <span class="n">remaining</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span>
    <span class="n">column_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">first_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span> <span class="o">+</span> <span class="n">remaining</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">column_order</span><span class="p">]</span></div>


<div class="viewcode-block" id="sort_note_list"><a class="viewcode-back" href="../../reference.html#ms3.utils.sort_note_list">[docs]</a><span class="k">def</span> <span class="nf">sort_note_list</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">mc_col</span><span class="o">=</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="n">mc_onset_col</span><span class="o">=</span><span class="s1">&#39;mc_onset&#39;</span><span class="p">,</span> <span class="n">midi_col</span><span class="o">=</span><span class="s1">&#39;midi&#39;</span><span class="p">,</span> <span class="n">duration_col</span><span class="o">=</span><span class="s1">&#39;duration&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Sort every measure (MC) by [&#39;mc_onset&#39;, &#39;midi&#39;, &#39;duration&#39;] while leaving gracenotes&#39; order (duration=0) intact.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df</span>
<span class="sd">    mc_col</span>
<span class="sd">    mc_onset_col</span>
<span class="sd">    midi_col</span>
<span class="sd">    duration_col</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_grace</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">duration_col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">grace_ix</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="n">is_grace</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">mc_col</span><span class="p">,</span> <span class="n">mc_onset_col</span><span class="p">])</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">has_nan</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">midi_col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">has_nan</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">midi_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">midi_col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">normal_ix</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">is_grace</span><span class="p">,</span> <span class="p">[</span><span class="n">mc_col</span><span class="p">,</span> <span class="n">mc_onset_col</span><span class="p">,</span> <span class="n">midi_col</span><span class="p">,</span> <span class="n">duration_col</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">mc_col</span><span class="p">,</span> <span class="n">mc_onset_col</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">gr</span><span class="p">:</span> <span class="n">gr</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">((</span><span class="n">gr</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">gr</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]))]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
    <span class="n">sorted_ixs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">grace_ix</span><span class="p">[</span><span class="n">onset</span><span class="p">],</span> <span class="n">ix</span><span class="p">))</span> <span class="k">if</span> <span class="n">onset</span> <span class="ow">in</span> <span class="n">grace_ix</span> <span class="k">else</span> <span class="n">ix</span> <span class="k">for</span> <span class="n">onset</span><span class="p">,</span> <span class="n">ix</span> <span class="ow">in</span>
                  <span class="n">normal_ix</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sorted_ixs</span><span class="p">))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">has_nan</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">midi_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">midi_col</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="mi">1000</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">})</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;Int64&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="sort_tpcs"><a class="viewcode-back" href="../../reference.html#ms3.utils.sort_tpcs">[docs]</a><span class="k">def</span> <span class="nf">sort_tpcs</span><span class="p">(</span><span class="n">tpcs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Sort tonal pitch classes by order on the piano.</span>
<span class="sd">        Uses: fifths2pc()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tpcs : collection of :obj:`int`</span>
<span class="sd">        Tonal pitch classes to sort.</span>
<span class="sd">    ascending : :obj:`bool`, optional</span>
<span class="sd">        Pass False to sort by descending order.</span>
<span class="sd">    start : :obj:`int`, optional</span>
<span class="sd">        Start on or above this TPC.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tpcs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">fifths2pc</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="o">-</span><span class="n">x</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">fifths2pc</span><span class="p">(</span><span class="n">tpc</span><span class="p">)</span> <span class="k">for</span> <span class="n">tpc</span> <span class="ow">in</span> <span class="n">res</span><span class="p">]</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">fifths2pc</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pcs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">pcs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span> <span class="o">+</span> <span class="n">res</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">res</span> <span class="k">if</span> <span class="n">ascending</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">res</span><span class="p">))</span></div>


<div class="viewcode-block" id="split_alternatives"><a class="viewcode-back" href="../../reference.html#ms3.utils.split_alternatives">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">split_alternatives</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;-(?!(\d|b+\d|\#+\d))&quot;</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alternatives_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Splits labels that come with an alternative separated by &#39;-&#39; and adds</span>
<span class="sd">    a new column. Only one alternative is taken into account. `df` is</span>
<span class="sd">    mutated inplace.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        Dataframe where one column contains DCML chord labels.</span>
<span class="sd">    column : :obj:`str`, optional</span>
<span class="sd">        Name of the column that holds the harmony labels.</span>
<span class="sd">    regex : :obj:`str`, optional</span>
<span class="sd">        The regular expression (or simple string) that detects the character combination used to separate alternative annotations.</span>
<span class="sd">        By default, alternatives are separated by a &#39;-&#39; that does not precede a scale degree such as &#39;b6&#39; or &#39;3&#39;.</span>
<span class="sd">    max : :obj:`int`, optional</span>
<span class="sd">        Maximum number of admitted alternatives, defaults to 2.</span>
<span class="sd">    inplace : :obj:`bool`, optional</span>
<span class="sd">        Pass True if you want to mutate ``df``.</span>
<span class="sd">    alternatives_only : :obj:`bool`, optional</span>
<span class="sd">        By default the alternatives are added to the original DataFrame (``inplace`` or not).</span>
<span class="sd">        Pass True if you just need the split alternatives.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; import pandas as pd</span>
<span class="sd">    &gt;&gt;&gt; labels = pd.read_csv(&#39;labels.csv&#39;)</span>
<span class="sd">    &gt;&gt;&gt; split_alternatives(labels, inplace=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">alternatives</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">alternatives</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">alternatives</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">alternatives</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">alternatives_only</span><span class="p">:</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;alt_</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;alt</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">alternatives</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">alternatives</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span>
        <span class="k">return</span> <span class="n">alternatives</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="nb">max</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternatives</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Labels split into alternatives.&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">alternatives</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">alternatives</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">max</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">alt_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;alt_</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;alt</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">alt_name</span><span class="p">,</span> <span class="n">alternatives</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span>  <span class="c1"># replace None by NaN</span>
            <span class="n">position</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternatives</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;More than </span><span class="si">{</span><span class="nb">max</span><span class="si">}</span><span class="s2"> alternatives are not taken into account:</span><span class="se">\n</span><span class="si">{</span><span class="n">alternatives</span><span class="p">[</span><span class="n">alternatives</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Contains no alternative labels.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="split_note_name"><a class="viewcode-back" href="../../reference.html#ms3.utils.split_note_name">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">split_note_name</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Splits a note name such as &#39;Ab&#39; into accidentals and name.</span>

<span class="sd">    nn : :obj:`str`</span>
<span class="sd">        Note name.</span>
<span class="sd">    count : :obj:`bool`, optional</span>
<span class="sd">        Pass True to get the accidentals as integer rather than as string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^([A-G]|[a-g])(#*|b*)$&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nn</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">nn</span> <span class="o">+</span> <span class="s2">&quot; is not a valid scale degree.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">note_name</span><span class="p">,</span> <span class="n">accidentals</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
        <span class="n">accidentals</span> <span class="o">=</span> <span class="n">accidentals</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">accidentals</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">accidentals</span><span class="p">,</span> <span class="n">note_name</span></div>


<div class="viewcode-block" id="split_scale_degree"><a class="viewcode-back" href="../../reference.html#ms3.utils.split_scale_degree">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">split_scale_degree</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Splits a scale degree such as &#39;bbVI&#39; or &#39;b6&#39; into accidentals and numeral.</span>

<span class="sd">    sd : :obj:`str`</span>
<span class="sd">        Scale degree.</span>
<span class="sd">    count : :obj:`bool`, optional</span>
<span class="sd">        Pass True to get the accidentals as integer rather than as string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(#*|b*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i|\d)$&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sd</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sd</span><span class="si">}</span><span class="s2"> is not a valid scale degree.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">acc</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="n">acc</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">acc</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">acc</span><span class="p">,</span> <span class="n">num</span></div>


<span class="c1"># def chunkstring(string, length=80):</span>
<span class="c1">#     &quot;&quot;&quot; Generate chunks of a given length &quot;&quot;&quot;</span>
<span class="c1">#     string = str(string)</span>
<span class="c1">#     return (string[0 + i:length + i] for i in range(0, len(string), length))</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># def string2lines(string, length=80):</span>
<span class="c1">#     &quot;&quot;&quot; Use chunkstring() and make chunks into lines. &quot;&quot;&quot;</span>
<span class="c1">#     return &#39;\n&#39;.join(chunkstring(string, length))</span>


<span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">test_binary</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">command</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">command</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found MuseScore binary: </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span>
    <span class="k">if</span> <span class="n">which</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MuseScore binary not found and not an installed command: </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found MuseScore command: </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span>


<div class="viewcode-block" id="transform"><a class="viewcode-back" href="../../reference.html#ms3.utils.transform">[docs]</a><span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">param2col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">column_wise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Compute a function for every row of a DataFrame, using several cols as arguments.</span>
<span class="sd">        The result is the same as using df.apply(lambda r: func(param1=r.col1, param2=r.col2...), axis=1)</span>
<span class="sd">        but it optimizes the procedure by precomputing `func` for all occurrent parameter combinations.</span>
<span class="sd">        Uses: inspect.getfullargspec()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame` or :obj:`pandas.Series`</span>
<span class="sd">        Dataframe containing function parameters.</span>
<span class="sd">    func : :obj:`callable`</span>
<span class="sd">        The result of this function for every row will be returned.</span>
<span class="sd">    param2col : :obj:`dict` or :obj:`list`, optional</span>
<span class="sd">        Mapping from parameter names of `func` to column names.</span>
<span class="sd">        If you pass a list of column names, the columns&#39; values are passed as positional arguments.</span>
<span class="sd">        Pass None if you want to use all columns as positional arguments.</span>
<span class="sd">    column_wise : :obj:`bool`, optional</span>
<span class="sd">        Pass True if you want to map ``func`` to the elements of every column separately.</span>
<span class="sd">        This is simply an optimized version of df.apply(func) but allows for naming</span>
<span class="sd">        columns to use as function arguments. If param2col is None, ``func`` is mapped</span>
<span class="sd">        to the elements of all columns, otherwise to all columns that are not named</span>
<span class="sd">        as parameters in ``param2col``.</span>
<span class="sd">        In the case where ``func`` does not require a positional first element and</span>
<span class="sd">        you want to pass the elements of the various columns as keyword argument,</span>
<span class="sd">        give it as param2col={&#39;function_argument&#39;: None}</span>
<span class="sd">    inplace : :obj:`bool`, optional</span>
<span class="sd">        Pass True if you want to mutate ``df`` rather than getting an altered copy.</span>
<span class="sd">    **kwargs : Other parameters passed to ``func``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">column_wise</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param2col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">func</span><span class="p">,),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">param2col</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="n">var_arg</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">param2col</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
                <span class="n">apply_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">param2col</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="n">var_arg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Name only one variable keyword argument as which </span><span class="si">{</span><span class="n">apply_cols</span><span class="si">}</span><span class="s2"> are used </span><span class="si">{</span><span class="s1">&#39;argument&#39;</span><span class="si">:</span><span class="s2"> None</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="n">var_arg</span> <span class="o">=</span> <span class="n">var_arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_arg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">getfullargspec</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">param2col</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">param2col</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
                <span class="n">result_cols</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="nb">dict</span><span class="p">({</span><span class="n">var_arg</span><span class="p">:</span> <span class="n">col</span><span class="p">},</span> <span class="o">**</span><span class="n">param2col</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span>
                               <span class="n">apply_cols</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">apply_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">param2col</span><span class="p">]</span>
                <span class="n">result_cols</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">+</span> <span class="n">param2col</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">apply_cols</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result_cols</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">param2col</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">param_tuples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">param2col</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
        <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">param2col</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">t</span><span class="p">)},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">param_tuples</span><span class="p">)}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param2col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;When &#39;df&#39; is a Series, the parameter &#39;param2col&#39; has no use.&quot;</span><span class="p">)</span>
            <span class="n">param_tuples</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span>
            <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">param_tuples</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param2col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">param_tuples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">param_tuples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">param2col</span><span class="p">)]</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
            <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">param_tuples</span><span class="p">)}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">result_dict</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">param_tuples</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="adjacency_groups"><a class="viewcode-back" href="../../reference.html#ms3.utils.adjacency_groups">[docs]</a><span class="k">def</span> <span class="nf">adjacency_groups</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">na_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prevent_merge</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    S : :obj:`pandas.Series`</span>
<span class="sd">        Series in which to group identical adjacent values with each other.</span>
<span class="sd">    na_values : :obj:`str`, optional</span>
<span class="sd">        | How to treat (groups of) NA values. By default, NA values are being ignored.</span>
<span class="sd">        | &#39;group&#39; creates individual groups for NA values</span>
<span class="sd">        | &#39;backfill&#39; or &#39;bfill&#39; groups NA values with the subsequent group</span>
<span class="sd">        | &#39;pad&#39;, &#39;ffill&#39; groups NA values with the preceding group</span>
<span class="sd">        | Any other string works like &#39;group&#39;, with the difference that the groups will be named with this value.</span>
<span class="sd">    prevent_merge : :obj:`bool`, optional</span>
<span class="sd">        By default, if you use the `na_values` argument to fill NA values, they might lead to two groups merging.</span>
<span class="sd">        Pass True to prevent this. For example, take the sequence [&#39;a&#39;, NA, &#39;a&#39;] with ``na_values=&#39;ffill&#39;``: By default,</span>
<span class="sd">        it will be merged to one single group ``[1, 1, 1], {1: &#39;a&#39;}``. However, passing ``prevent_merge=True`` will</span>
<span class="sd">        result in ``[1, 1, 2], {1: &#39;a&#39;, 2: &#39;a&#39;}``.</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.Series</span>
<span class="sd">        A series with increasing integers that can be used for grouping.</span>
<span class="sd">    :obj:`dict`</span>
<span class="sd">        A dictionary mapping the integers to the grouped values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reindex_flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">prevent_merge</span><span class="p">:</span>
        <span class="n">forced_beginnings</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">S</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">na_values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">reindex_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">S</span>
    <span class="k">elif</span> <span class="n">na_values</span> <span class="o">==</span> <span class="s1">&#39;group&#39;</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">S</span>
    <span class="k">elif</span> <span class="n">na_values</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;backfill&#39;</span><span class="p">,</span> <span class="s1">&#39;bfill&#39;</span><span class="p">,</span> <span class="s1">&#39;pad&#39;</span><span class="p">,</span> <span class="s1">&#39;ffill&#39;</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">na_values</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">na_values</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">na_values</span> <span class="o">==</span> <span class="s1">&#39;group&#39;</span><span class="p">:</span>
            <span class="n">shifted</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">shifted</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">beginnings</span> <span class="o">=</span> <span class="o">~</span><span class="n">nan_eq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">shifted</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After treating the Series &#39;</span><span class="si">{</span><span class="n">S</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; with na_values=&#39;</span><span class="si">{</span><span class="n">na_values</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
                           <span class="sa">f</span><span class="s2">&quot;there were still </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2"> NA values left.&quot;</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">beginnings</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="n">s</span><span class="o">.</span><span class="n">shift</span><span class="p">())</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">beginnings</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">reindex_flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">beginnings</span> <span class="o">=</span> <span class="n">s</span> <span class="o">!=</span> <span class="n">s</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span>
        <span class="n">beginnings</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">prevent_merge</span><span class="p">:</span>
        <span class="n">beginnings</span> <span class="o">|=</span> <span class="n">forced_beginnings</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">beginnings</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">names</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">beginnings</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">reindex_flag</span><span class="p">:</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">groups</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;Int64&#39;</span><span class="p">),</span> <span class="n">names</span></div>


<div class="viewcode-block" id="unfold_repeats"><a class="viewcode-back" href="../../reference.html#ms3.utils.unfold_repeats">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">unfold_repeats</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">playthrough2mc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Use a succesion of MCs to bring a DataFrame in this succession. MCs may repeat.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        DataFrame needs to have the columns &#39;mc&#39; and &#39;mn&#39;.</span>
<span class="sd">    playthrough2mc : :obj:`pandas.Series`</span>
<span class="sd">        A Series of the format ``{mc_playthrough: mc}`` where ``mc_playthrough`` corresponds</span>
<span class="sd">        to continuous MC</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">############## &lt; v0.5: playthrough &lt;=&gt; mn; &gt;= v0.5: playthrough &lt;=&gt; mc</span>
    <span class="n">vc</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;mc&#39;</span><span class="p">)</span>
    <span class="n">seq</span> <span class="o">=</span> <span class="n">playthrough2mc</span><span class="p">[</span><span class="n">playthrough2mc</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
    <span class="n">playthrough_col</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([[</span><span class="n">playthrough</span><span class="p">]</span> <span class="o">*</span> <span class="n">vc</span><span class="p">[</span><span class="n">mc</span><span class="p">]</span> <span class="k">for</span> <span class="n">playthrough</span><span class="p">,</span> <span class="n">mc</span> <span class="ow">in</span> <span class="n">seq</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span> <span class="p">[])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">seq</span><span class="o">.</span><span class="n">values</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">res</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;mc&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;mc_playthrough&#39;</span><span class="p">,</span> <span class="n">playthrough_col</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>


<span class="nd">@contextmanager</span>
<span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">unpack_mscz</span><span class="p">(</span><span class="n">mscz</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">tmp_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">mscz</span><span class="p">)</span>
    <span class="n">tmp_file</span> <span class="o">=</span> <span class="n">Temp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.mscx&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">Zip</span><span class="p">(</span><span class="n">mscz</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_file</span><span class="p">:</span>
        <span class="n">mscx_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">zip_file</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.mscx&#39;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mscx_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mscz</span><span class="si">}</span><span class="s2"> contains several MSCX files. Picking the first one&quot;</span><span class="p">)</span>
        <span class="n">mscx</span> <span class="o">=</span> <span class="n">mscx_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">zip_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mscx</span><span class="p">)</span> <span class="k">as</span> <span class="n">mscx_file</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">tmp_file</span> <span class="k">as</span> <span class="n">tmp</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">mscx_file</span><span class="p">:</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">tmp_file</span><span class="o">.</span><span class="n">name</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while dealing with the temporarily unpacked </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">mscz</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmp_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<span class="nd">@contextmanager</span>
<span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">capture_parse_logs</span><span class="p">(</span><span class="n">logger_object</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">):</span>
    <span class="n">captured_warnings</span> <span class="o">=</span> <span class="n">LogCapturer</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">)</span>
    <span class="n">logger_object</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">captured_warnings</span><span class="o">.</span><span class="n">log_handler</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">captured_warnings</span>
    <span class="n">logger_object</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">captured_warnings</span><span class="o">.</span><span class="n">log_handler</span><span class="p">)</span>



<span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">update_labels_cfg</span><span class="p">(</span><span class="n">labels_cfg</span><span class="p">):</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;staff&#39;</span><span class="p">,</span> <span class="s1">&#39;voice&#39;</span><span class="p">,</span> <span class="s1">&#39;harmony_layer&#39;</span><span class="p">,</span> <span class="s1">&#39;positioning&#39;</span><span class="p">,</span> <span class="s1">&#39;decode&#39;</span><span class="p">,</span> <span class="s1">&#39;column_name&#39;</span><span class="p">,</span> <span class="s1">&#39;color_format&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;logger&#39;</span> <span class="ow">in</span> <span class="n">labels_cfg</span><span class="p">:</span>
        <span class="k">del</span><span class="p">(</span><span class="n">labels_cfg</span><span class="p">[</span><span class="s1">&#39;logger&#39;</span><span class="p">])</span>
    <span class="n">updated</span> <span class="o">=</span> <span class="n">update_cfg</span><span class="p">(</span><span class="n">cfg_dict</span><span class="o">=</span><span class="n">labels_cfg</span><span class="p">,</span> <span class="n">admitted_keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;logger&#39;</span> <span class="ow">in</span> <span class="n">updated</span><span class="p">:</span>
        <span class="k">del</span><span class="p">(</span><span class="n">updated</span><span class="p">[</span><span class="s1">&#39;logger&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">updated</span>


<span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">write_metadata</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">markdown</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">resolve_dir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">tsv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;metadata.tsv&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tsv_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">tsv_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">tsv_path</span><span class="p">):</span>
        <span class="n">write_this</span> <span class="o">=</span> <span class="n">df</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Created&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Trying to load an existing &#39;metadata.tsv&#39; file to update overlapping indices, assuming two index levels</span>
            <span class="n">previous</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">tsv_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;rel_paths&#39;</span><span class="p">,</span> <span class="s1">&#39;fnames&#39;</span><span class="p">])</span>
            <span class="n">df_tmp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">)</span>
            <span class="n">df_tmp</span> <span class="o">=</span> <span class="n">df_tmp</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;rel_paths&#39;</span><span class="p">,</span> <span class="s1">&#39;fnames&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">what</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="n">previous</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">previous</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">df_tmp</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_tmp</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span>
                          <span class="p">(</span><span class="s1">&#39;index of the existing&#39;</span><span class="p">,</span> <span class="s1">&#39;columns of the existing&#39;</span><span class="p">,</span> <span class="s1">&#39;index of the updated&#39;</span><span class="p">,</span> <span class="s1">&#39;columns of the updated&#39;</span><span class="p">)):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ix</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span>
                    <span class="n">duplicated</span> <span class="o">=</span> <span class="n">ix</span><span class="p">[</span><span class="n">ix</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">what</span><span class="si">}</span><span class="s2"> metadata contains duplicates and no metadata were written.</span><span class="se">\n</span><span class="s2">Duplicates: </span><span class="si">{</span><span class="n">duplicated</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
            <span class="n">ix_union</span> <span class="o">=</span> <span class="n">previous</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">col_union</span> <span class="o">=</span> <span class="n">previous</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">previous</span> <span class="o">=</span> <span class="n">previous</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">ix_union</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">col_union</span><span class="p">)</span>
            <span class="n">previous</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_tmp</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_tmp</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_tmp</span>
            <span class="n">write_this</span> <span class="o">=</span> <span class="n">previous</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Updated&#39;</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updating existing metadata at </span><span class="si">{</span><span class="n">tsv_path</span><span class="si">}</span><span class="s2"> failed with the following error:</span><span class="se">\n</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">write_this</span> <span class="o">=</span> <span class="n">df</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Replaced &#39;</span>
    <span class="n">convert_to_str</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;length_qb&#39;</span><span class="p">,</span> <span class="s1">&#39;length_qb_unfolded&#39;</span><span class="p">,</span> <span class="s1">&#39;all_notes_qb&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="p">}</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">convert_to_str</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">write_this</span> <span class="o">=</span> <span class="n">write_this</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">convert_to_str</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
    <span class="n">write_this</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">write_this</span> <span class="o">=</span> <span class="n">column_order</span><span class="p">(</span><span class="n">write_this</span><span class="p">,</span> <span class="n">METADATA_COLUMN_ORDER</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">staff_cols</span><span class="p">,</span> <span class="n">other_cols</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">write_this</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">staff_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^staff_(\d+)&quot;</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="k">else</span> <span class="n">other_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="n">staff_cols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">staff_cols</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^staff_(\d+)&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">write_this</span> <span class="o">=</span> <span class="n">write_this</span><span class="p">[</span><span class="n">other_cols</span> <span class="o">+</span> <span class="n">staff_cols</span><span class="p">]</span>
    <span class="n">write_this</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">tsv_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">tsv_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">markdown</span><span class="p">:</span>
        <span class="n">rename4markdown</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;fnames&#39;</span><span class="p">:</span> <span class="s1">&#39;file_name&#39;</span><span class="p">,</span>
            <span class="s1">&#39;last_mn&#39;</span><span class="p">:</span> <span class="s1">&#39;measures&#39;</span><span class="p">,</span>
            <span class="s1">&#39;label_count&#39;</span><span class="p">:</span> <span class="s1">&#39;labels&#39;</span><span class="p">,</span>
            <span class="s1">&#39;harmony_version&#39;</span><span class="p">:</span> <span class="s1">&#39;standard&#39;</span><span class="p">,</span>
            <span class="s1">&#39;annotators&#39;</span><span class="p">:</span> <span class="s1">&#39;annotators&#39;</span><span class="p">,</span>
            <span class="s1">&#39;reviewers&#39;</span><span class="p">:</span> <span class="s1">&#39;reviewers&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">drop_index</span> <span class="o">=</span> <span class="s1">&#39;fnames&#39;</span> <span class="ow">in</span> <span class="n">write_this</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">write_this</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="n">drop_index</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">rename4markdown</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">md</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">md</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">rename4markdown</span><span class="p">)[</span><span class="nb">list</span><span class="p">(</span><span class="n">rename4markdown</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span>
        <span class="n">md_table</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">df2md</span><span class="p">(</span><span class="n">md</span><span class="p">))</span>

        <span class="n">readme</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;README.rst.md&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">readme</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Updated&#39;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">readme</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Created&#39;</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># in case the README.rst exists, everything from the line including &#39;# Overview&#39; (or last line otherwise) is overwritten</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">readme</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;# Overview&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">md_table</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">readme</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="write_tsv"><a class="viewcode-back" href="../../reference.html#ms3.utils.write_tsv">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">write_tsv</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">pre_process</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Write a DataFrame to a TSV or CSV file based on the extension of &#39;file_path&#39;.</span>
<span class="sd">    Uses: :py:func:`no_collections_no_booleans`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        DataFrame to write.</span>
<span class="sd">    file_path : :obj:`str`</span>
<span class="sd">        File to create or overwrite. If the extension is .tsv, the argument &#39;sep&#39; will be set to &#39;\t&#39;, otherwise the</span>
<span class="sd">        extension is expected to be .csv and the default separator &#39;,&#39; will be used.</span>
<span class="sd">    pre_process : :obj:`bool`, optional</span>
<span class="sd">        By default, DataFrame cells containing lists and tuples will be transformed to strings and Booleans will be</span>
<span class="sd">        converted to 0 and 1 (otherwise they will be written out as True and False). Pass False to prevent.</span>
<span class="sd">    kwargs :</span>
<span class="sd">        Additional keyword arguments will be passed on to :py:meth:`pandas.DataFrame.to_csv`.</span>
<span class="sd">        Defaults arguments are ``index=False`` and ``sep=&#39;\t&#39;`` (assuming extension &#39;.tsv&#39;, see above).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">resolve_dir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;.tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;.csv&#39;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;This function expects file_path to include the file name ending on .csv or tsv, not &#39;</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;.tsv&#39;</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="s1">&#39;index&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">pre_process</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">no_collections_no_booleans</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2"> written with parameters </span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="abs2rel_key"><a class="viewcode-back" href="../../reference.html#ms3.utils.abs2rel_key">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">abs2rel_key</span><span class="p">(</span><span class="n">absolute</span><span class="p">,</span> <span class="n">localkey</span><span class="p">,</span> <span class="n">global_minor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Expresses a Roman numeral as scale degree relative to a given localkey.</span>
<span class="sd">    The result changes depending on whether Roman numeral and localkey are</span>
<span class="sd">    interpreted within a global major or minor key.</span>

<span class="sd">    Uses: :py:func:`split_scale_degree`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    absolute : :obj:`str`</span>
<span class="sd">        Relative key expressed as Roman scale degree of the local key.</span>
<span class="sd">    localkey : :obj:`str`</span>
<span class="sd">        The local key in terms of which `absolute` will be expressed.</span>
<span class="sd">    global_minor : bool, optional</span>
<span class="sd">        Has to be set to True if `absolute` and `localkey` are scale degrees of a global minor key.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    In a minor context, the key of II would appear within the key of vii as #III.</span>

<span class="sd">        &gt;&gt;&gt; abs2rel_key(&#39;iv&#39;, &#39;VI&#39;, global_minor=False)</span>
<span class="sd">        &#39;bvi&#39;       # F minor expressed with respect to A major</span>
<span class="sd">        &gt;&gt;&gt; abs2rel_key(&#39;iv&#39;, &#39;vi&#39;, global_minor=False)</span>
<span class="sd">        &#39;vi&#39;        # F minor expressed with respect to A minor</span>
<span class="sd">        &gt;&gt;&gt; abs2rel_key(&#39;iv&#39;, &#39;VI&#39;, global_minor=True)</span>
<span class="sd">        &#39;vi&#39;        # F minor expressed with respect to Ab major</span>
<span class="sd">        &gt;&gt;&gt; abs2rel_key(&#39;iv&#39;, &#39;vi&#39;, global_minor=True)</span>
<span class="sd">        &#39;#vi&#39;       # F minor expressed with respect to Ab minor</span>

<span class="sd">        &gt;&gt;&gt; abs2rel_key(&#39;VI&#39;, &#39;IV&#39;, global_minor=False)</span>
<span class="sd">        &#39;III&#39;       # A major expressed with respect to F major</span>
<span class="sd">        &gt;&gt;&gt; abs2rel_key(&#39;VI&#39;, &#39;iv&#39;, global_minor=False)</span>
<span class="sd">        &#39;#III&#39;       # A major expressed with respect to F minor</span>
<span class="sd">        &gt;&gt;&gt; abs2rel_key(&#39;VI&#39;, &#39;IV&#39;, global_minor=True)</span>
<span class="sd">        &#39;bIII&#39;       # Ab major expressed with respect to F major</span>
<span class="sd">        &gt;&gt;&gt; abs2rel_key(&#39;VI&#39;, &#39;iv&#39;, global_minor=False)</span>
<span class="sd">        &#39;III&#39;       # Ab major expressed with respect to F minor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">absolute</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">maj_rn</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">]</span>
    <span class="n">min_rn</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;ii&#39;</span><span class="p">,</span> <span class="s1">&#39;iii&#39;</span><span class="p">,</span> <span class="s1">&#39;iv&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;vi&#39;</span><span class="p">,</span> <span class="s1">&#39;vii&#39;</span><span class="p">]</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
    <span class="n">abs_acc</span><span class="p">,</span> <span class="n">absolute</span> <span class="o">=</span> <span class="n">split_scale_degree</span><span class="p">(</span><span class="n">absolute</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">localkey_acc</span><span class="p">,</span> <span class="n">localkey</span> <span class="o">=</span> <span class="n">split_scale_degree</span><span class="p">(</span><span class="n">localkey</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="n">abs_acc</span> <span class="o">-</span> <span class="n">localkey_acc</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="n">maj_rn</span> <span class="k">if</span> <span class="n">absolute</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="k">else</span> <span class="n">min_rn</span>
    <span class="n">key_num</span> <span class="o">=</span> <span class="n">maj_rn</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">localkey</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="n">abs_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">steps</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">absolute</span><span class="p">)</span> <span class="o">-</span> <span class="n">key_num</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">steps</span><span class="p">[</span><span class="n">abs_num</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">localkey</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span> <span class="ow">and</span> <span class="n">abs_num</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]:</span>
        <span class="n">shift</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">global_minor</span><span class="p">:</span>
        <span class="n">key_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">key_num</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span>
    <span class="n">shift</span> <span class="o">-=</span> <span class="n">shifts</span><span class="p">[</span><span class="n">key_num</span><span class="p">][</span><span class="n">abs_num</span><span class="p">]</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">*</span> <span class="s1">&#39;#&#39;</span> <span class="k">if</span> <span class="n">shift</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="n">shift</span> <span class="o">*</span> <span class="s1">&#39;b&#39;</span>
    <span class="k">return</span> <span class="n">acc</span> <span class="o">+</span> <span class="n">step</span></div>


<div class="viewcode-block" id="rel2abs_key"><a class="viewcode-back" href="../../reference.html#ms3.utils.rel2abs_key">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">rel2abs_key</span><span class="p">(</span><span class="n">rel</span><span class="p">,</span> <span class="n">localkey</span><span class="p">,</span> <span class="n">global_minor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Expresses a Roman numeral that is expressed relative to a localkey</span>
<span class="sd">    as scale degree of the global key. For local keys {III, iii, VI, vi, VII, vii}</span>
<span class="sd">    the result changes depending on whether the global key is major or minor.</span>

<span class="sd">    Uses: :py:func:`split_scale_degree`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rel : :obj:`str`</span>
<span class="sd">        Relative key or chord expressed as Roman scale degree of the local key.</span>
<span class="sd">    localkey : :obj:`str`</span>
<span class="sd">        The local key to which `rel` is relative.</span>
<span class="sd">    global_minor : bool, optional</span>
<span class="sd">        Has to be set to True if `localkey` is a scale degree of a global minor key.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    If the label viio6/VI appears in the context of the local key VI or vi,</span>
<span class="sd">    the absolute key to which viio6 applies depends on the global key.</span>
<span class="sd">    The comments express the examples in relation to global C major or C minor.</span>

<span class="sd">        &gt;&gt;&gt; rel2abs_key(&#39;vi&#39;, &#39;VI&#39;, global_minor=False)</span>
<span class="sd">        &#39;#iv&#39;       # vi of A major = F# minor</span>
<span class="sd">        &gt;&gt;&gt; rel2abs_key(&#39;vi&#39;, &#39;vi&#39;, global_minor=False)</span>
<span class="sd">        &#39;iv&#39;        # vi of A minor = F minor</span>
<span class="sd">        &gt;&gt;&gt; rel2abs_key(&#39;vi&#39;, &#39;VI&#39;, global_minor=True)</span>
<span class="sd">        &#39;iv&#39;        # vi of Ab major = F minor</span>
<span class="sd">        &gt;&gt;&gt; rel2abs_key(&#39;vi&#39;, &#39;vi&#39;, global_minor=True)</span>
<span class="sd">        &#39;biv&#39;       # vi of Ab minor = Fb minor</span>

<span class="sd">    The same examples hold if you&#39;re expressing in terms of the global key</span>
<span class="sd">    the root of a VI-chord within the local keys VI or vi.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">localkey</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">rel</span>
    <span class="n">maj_rn</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">]</span>
    <span class="n">min_rn</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;ii&#39;</span><span class="p">,</span> <span class="s1">&#39;iii&#39;</span><span class="p">,</span> <span class="s1">&#39;iv&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;vi&#39;</span><span class="p">,</span> <span class="s1">&#39;vii&#39;</span><span class="p">]</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
    <span class="n">rel_acc</span><span class="p">,</span> <span class="n">rel</span> <span class="o">=</span> <span class="n">split_scale_degree</span><span class="p">(</span><span class="n">rel</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">localkey_acc</span><span class="p">,</span> <span class="n">localkey</span> <span class="o">=</span> <span class="n">split_scale_degree</span><span class="p">(</span><span class="n">localkey</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="n">rel_acc</span> <span class="o">+</span> <span class="n">localkey_acc</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="n">maj_rn</span> <span class="k">if</span> <span class="n">rel</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="k">else</span> <span class="n">min_rn</span>
    <span class="n">rel_num</span> <span class="o">=</span> <span class="n">steps</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span>
    <span class="n">key_num</span> <span class="o">=</span> <span class="n">maj_rn</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">localkey</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">steps</span><span class="p">[(</span><span class="n">rel_num</span> <span class="o">+</span> <span class="n">key_num</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">localkey</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span> <span class="ow">and</span> <span class="n">rel_num</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]:</span>
        <span class="n">shift</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">global_minor</span><span class="p">:</span>
        <span class="n">key_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">key_num</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span>
    <span class="n">shift</span> <span class="o">+=</span> <span class="n">shifts</span><span class="p">[</span><span class="n">rel_num</span><span class="p">][</span><span class="n">key_num</span><span class="p">]</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">*</span> <span class="s1">&#39;#&#39;</span> <span class="k">if</span> <span class="n">shift</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="n">shift</span> <span class="o">*</span> <span class="s1">&#39;b&#39;</span>
    <span class="k">return</span> <span class="n">acc</span> <span class="o">+</span> <span class="n">step</span></div>


<div class="viewcode-block" id="make_interval_index_from_durations"><a class="viewcode-back" href="../../reference.html#ms3.utils.make_interval_index_from_durations">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">make_interval_index_from_durations</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">position_col</span><span class="o">=</span><span class="s1">&#39;quarterbeats&#39;</span><span class="p">,</span> <span class="n">duration_col</span><span class="o">=</span><span class="s1">&#39;duration_qb&#39;</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                               <span class="nb">round</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;interval&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given an annotations table with positions and durations, create an :obj:`pandas.IntervalIndex`.</span>
<span class="sd">    Returns None if any row is underspecified.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        Annotation table containing the columns of ``position_col`` (default: &#39;quarterbeats&#39;) and ``duration_col``</span>
<span class="sd">        default: &#39;duration_qb&#39;).</span>
<span class="sd">    position_col : :obj:`str`, optional</span>
<span class="sd">        Name of the column containing positions, used as left boundaries.</span>
<span class="sd">    duration_col : :obj:`str`, optional</span>
<span class="sd">        Name of the column containing durations which will be added to the positions to obtain right boundaries.</span>
<span class="sd">    closed : :obj:`str`, optional</span>
<span class="sd">        &#39;left&#39;, &#39;right&#39; or &#39;both&#39; &lt;- defining the interval boundaries</span>
<span class="sd">    round : :obj:`int`, optional</span>
<span class="sd">        To how many decimal places to round the intervals&#39; boundary values.</span>
<span class="sd">    name : :obj:`str`, optional</span>
<span class="sd">        Name of the created index. Defaults to &#39;interval&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.IntervalIndex`</span>
<span class="sd">        A copy of ``df`` with the original index replaced and underspecified rows removed (those where no interval</span>
<span class="sd">        could be coputed).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="n">position_col</span><span class="p">,</span> <span class="n">duration_col</span><span class="p">)):</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="n">position_col</span><span class="p">,</span> <span class="n">duration_col</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">plural</span> <span class="o">=</span> <span class="s1">&#39;s&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column</span><span class="si">{</span><span class="n">plural</span><span class="si">}</span><span class="s2"> not present in DataFrame: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">position_col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">df</span><span class="p">[</span><span class="n">duration_col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[[</span><span class="n">position_col</span><span class="p">,</span> <span class="n">duration_col</span><span class="p">]]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not make IntervalIndex because of missing values:</span><span class="se">\n</span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">position_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="n">duration_col</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">round</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">round</span><span class="p">),</span> <span class="n">right</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">round</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">IntervalIndex</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">right</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="n">closed</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating IntervalIndex failed with exception </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="replace_index_by_intervals"><a class="viewcode-back" href="../../reference.html#ms3.utils.replace_index_by_intervals">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">replace_index_by_intervals</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">position_col</span><span class="o">=</span><span class="s1">&#39;quarterbeats&#39;</span><span class="p">,</span> <span class="n">duration_col</span><span class="o">=</span><span class="s1">&#39;duration_qb&#39;</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                               <span class="n">filter_zero_duration</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">round</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;interval&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given an annotations table with positions and durations, replaces its index with an :obj:`pandas.IntervalIndex`.</span>
<span class="sd">    Underspecified rows are removed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        Annotation table containing the columns of ``position_col`` (default: &#39;quarterbeats&#39;) and ``duration_col``</span>
<span class="sd">        default: &#39;duration_qb&#39;).</span>
<span class="sd">    position_col : :obj:`str`, optional</span>
<span class="sd">        Name of the column containing positions.</span>
<span class="sd">    duration_col : :obj:`str`, optional</span>
<span class="sd">        Name of the column containing durations.</span>
<span class="sd">    closed : :obj:`str`, optional</span>
<span class="sd">        &#39;left&#39;, &#39;right&#39; or &#39;both&#39; &lt;- defining the interval boundaries</span>
<span class="sd">    filter_zero_duration : :obj:`bool`, optional</span>
<span class="sd">        Defaults to False, meaning that rows with zero durations are maintained. Pass True to remove them.</span>
<span class="sd">    round : :obj:`int`, optional</span>
<span class="sd">        To how many decimal places to round the intervals&#39; boundary values.</span>
<span class="sd">    name : :obj:`str`, optional</span>
<span class="sd">        Name of the created index. Defaults to &#39;interval&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.DataFrame`</span>
<span class="sd">        A copy of ``df`` with the original index replaced and underspecified rows removed (those where no interval</span>
<span class="sd">        could be coputed).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="n">position_col</span><span class="p">,</span> <span class="n">duration_col</span><span class="p">)):</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="n">position_col</span><span class="p">,</span> <span class="n">duration_col</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">plural</span> <span class="o">=</span> <span class="s1">&#39;s&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Column</span><span class="si">{</span><span class="n">plural</span><span class="si">}</span><span class="s2"> not present in DataFrame: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">position_col</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">filter_zero_duration</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">duration_col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">iv_index</span> <span class="o">=</span> <span class="n">make_interval_index_from_durations</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">position_col</span><span class="o">=</span><span class="n">position_col</span><span class="p">,</span> <span class="n">duration_col</span><span class="o">=</span><span class="n">duration_col</span><span class="p">,</span>
                    <span class="n">closed</span><span class="o">=</span><span class="n">closed</span><span class="p">,</span> <span class="nb">round</span><span class="o">=</span><span class="nb">round</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">iv_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Creating IntervalIndex failed.&quot;</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">iv_index</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="resolve_relative_keys"><a class="viewcode-back" href="../../reference.html#ms3.utils.resolve_relative_keys">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">resolve_relative_keys</span><span class="p">(</span><span class="n">relativeroot</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Resolve nested relative keys, e.g. &#39;V/V/V&#39; =&gt; &#39;VI&#39;.</span>

<span class="sd">    Uses: :py:func:`rel2abs_key`, :py:func:`str_is_minor`</span>

<span class="sd">    relativeroot : :obj:`str`</span>
<span class="sd">        One or several relative keys, e.g. iv/v/VI (fourth scale degree of the fifth scale degree of the sixth scale degree)</span>
<span class="sd">    minor : :obj:`bool`, optional</span>
<span class="sd">        Pass True if the last of the relative keys is to be interpreted within a minor context.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">relativeroot</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">relativeroot</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="n">relativeroot</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spl</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">relativeroot</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">applied</span><span class="p">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">spl</span>
        <span class="k">return</span> <span class="n">rel2abs_key</span><span class="p">(</span><span class="n">applied</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">previous</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spl</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">spl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">rel2abs_key</span><span class="p">(</span><span class="n">resolve_relative_keys</span><span class="p">(</span><span class="n">previous</span><span class="p">,</span> <span class="n">str_is_minor</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="n">is_name</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span> <span class="n">last</span><span class="p">,</span> <span class="n">minor</span><span class="p">)</span></div>


<div class="viewcode-block" id="series_is_minor"><a class="viewcode-back" href="../../reference.html#ms3.utils.series_is_minor">[docs]</a><span class="k">def</span> <span class="nf">series_is_minor</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">is_name</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns boolean Series where every value in ``S`` representing a minor key/chord is True.&quot;&quot;&quot;</span>
    <span class="c1"># regex = r&#39;([A-Ga-g])[#|b]*&#39; if is_name else &#39;[#|b]*(\w+)&#39;</span>
    <span class="c1"># return S.str.replace(regex, lambda m: m.group(1)).str.islower()</span>
    <span class="k">return</span> <span class="n">S</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span>  <span class="c1"># as soon as one character is not lowercase, it should be major</span></div>


<div class="viewcode-block" id="str_is_minor"><a class="viewcode-back" href="../../reference.html#ms3.utils.str_is_minor">[docs]</a><span class="k">def</span> <span class="nf">str_is_minor</span><span class="p">(</span><span class="n">tone</span><span class="p">,</span> <span class="n">is_name</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns True if ``tone`` represents a minor key or chord.&quot;&quot;&quot;</span>
    <span class="c1"># regex = r&#39;([A-Ga-g])[#|b]*&#39; if is_name else &#39;[#|b]*(\w+)&#39;</span>
    <span class="c1"># m = re.match(regex, tone)</span>
    <span class="c1"># if m is None:</span>
    <span class="c1">#     return m</span>
    <span class="c1"># return m.group(1).islower()</span>
    <span class="k">return</span> <span class="n">tone</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span></div>


<div class="viewcode-block" id="transpose_changes"><a class="viewcode-back" href="../../reference.html#ms3.utils.transpose_changes">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">transpose_changes</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">old_num</span><span class="p">,</span> <span class="n">new_num</span><span class="p">,</span> <span class="n">old_minor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">new_minor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Since the interval sizes expressed by the changes of the DCML harmony syntax</span>
<span class="sd">    depend on the numeral&#39;s position in the scale, these may change if the numeral</span>
<span class="sd">    is transposed. This function expresses the same changes for the new position.</span>
<span class="sd">    Chord tone alterations (of 3 and 5) stay untouched.</span>

<span class="sd">    Uses: :py:func:`changes2tpc`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    changes : :obj:`str`</span>
<span class="sd">        A string of changes following the DCML harmony standard.</span>
<span class="sd">    old_num, new_num : :obj:`str`:</span>
<span class="sd">        Old numeral, new numeral.</span>
<span class="sd">    old_minor, new_minor : :obj:`bool`, optional</span>
<span class="sd">        For each numeral, pass True if it occurs in a minor context.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">changes</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">changes</span>
    <span class="n">old</span> <span class="o">=</span> <span class="n">changes2tpc</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">old_num</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">old_minor</span><span class="p">,</span> <span class="n">root_alterations</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">new</span> <span class="o">=</span> <span class="n">changes2tpc</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">new_num</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">new_minor</span><span class="p">,</span> <span class="n">root_alterations</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">get_acc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">n</span> <span class="o">*</span> <span class="s1">&#39;#&#39;</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="n">n</span> <span class="o">*</span> <span class="s1">&#39;b&#39;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">full</span><span class="p">,</span> <span class="n">added</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">chord_interval</span><span class="p">,</span> <span class="n">iv1</span><span class="p">),</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">iv2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">iv1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">iv1</span> <span class="o">==</span> <span class="n">iv2</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">iv2</span> <span class="o">-</span> <span class="n">iv1</span>
            <span class="k">if</span> <span class="n">d</span> <span class="o">%</span> <span class="mi">7</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The difference between the intervals of </span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">old_num</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">new_num</span><span class="si">}</span><span class="s2"> (in </span><span class="si">{</span><span class="s1">&#39;minor&#39;</span> <span class="k">if</span> <span class="n">minor</span> <span class="k">else</span> <span class="s1">&#39;major&#39;</span><span class="si">}</span><span class="s2">) don&#39;t differ by chromatic semitones.&quot;</span><span class="p">)</span>
            <span class="n">n_acc</span> <span class="o">=</span> <span class="n">acc</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">acc</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
            <span class="n">new_acc</span> <span class="o">=</span> <span class="n">get_acc</span><span class="p">(</span><span class="n">n_acc</span> <span class="o">-</span> <span class="n">d</span> <span class="o">//</span> <span class="mi">7</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">added</span> <span class="o">+</span> <span class="n">new_acc</span> <span class="o">+</span> <span class="n">chord_interval</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>


<div class="viewcode-block" id="features2tpcs"><a class="viewcode-back" href="../../reference.html#ms3.utils.features2tpcs">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">features2tpcs</span><span class="p">(</span><span class="n">numeral</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figbass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">changes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">relativeroot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">merge_tones</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bass_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given the features of a chord label, this function returns the chord tones</span>
<span class="sd">    in the order of the inversion, starting from the bass note. The tones are</span>
<span class="sd">    expressed as tonal pitch classes, where -1=F, 0=C, 1=G etc.</span>

<span class="sd">    Uses: :py:func:`~.utils.changes2list`, :py:func:`~.utils.name2fifths`, :py:func:`~.utils.resolve_relative_keys`, :py:func:`~.utils.roman_numeral2fifths`,</span>
<span class="sd">    :py:func:`~.utils.sort_tpcs`, :py:func:`~.utils.str_is_minor`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    numeral: :obj:`str`</span>
<span class="sd">        Roman numeral of the chord&#39;s root</span>
<span class="sd">    form: {None, &#39;M&#39;, &#39;o&#39;, &#39;+&#39; &#39;%&#39;}, optional</span>
<span class="sd">        Indicates the chord type if not a major or minor triad (for which ``form`` is None).</span>
<span class="sd">        &#39;%&#39; and &#39;M&#39; can only occur as tetrads, not as triads.</span>
<span class="sd">    figbass: {None, &#39;6&#39;, &#39;64&#39;, &#39;7&#39;, &#39;65&#39;, &#39;43&#39;, &#39;2&#39;}, optional</span>
<span class="sd">        Indicates chord&#39;s inversion. Pass None for triad root position.</span>
<span class="sd">    changes: :obj:`str`, optional</span>
<span class="sd">        Added steps such as &#39;+6&#39; or suspensions such as &#39;4&#39; or any combination such as (9+64).</span>
<span class="sd">        Numbers need to be in descending order.</span>
<span class="sd">    relativeroot: :obj:`str`, optional</span>
<span class="sd">        Pass a Roman scale degree if `numeral` is to be applied to a different scale</span>
<span class="sd">        degree of the local key, as in &#39;V65/V&#39;</span>
<span class="sd">    key : :obj:`str` or :obj:`int`, optional</span>
<span class="sd">        The local key expressed as the root&#39;s note name or a tonal pitch class.</span>
<span class="sd">        If it is a name and `minor` is `None`, uppercase means major and lowercase minor.</span>
<span class="sd">        If it is a tonal pitch class, `minor` needs to be specified.</span>
<span class="sd">    minor : :obj:`bool`, optional</span>
<span class="sd">        Pass True for minor and False for major. Can be omitted if `key` is a note name.</span>
<span class="sd">        This affects calculation of chords related to III, VI and VII.</span>
<span class="sd">    merge_tones : :obj:`bool`, optional</span>
<span class="sd">        Pass False if you want the function to return two tuples, one with (potentially suspended)</span>
<span class="sd">        chord tones and one with added notes.</span>
<span class="sd">    bass_only : :obj:`bool`, optional</span>
<span class="sd">        Return only the bass note instead of all chord tones.</span>
<span class="sd">    mc : int or str</span>
<span class="sd">        Pass measure count to display it in warnings.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">numeral</span><span class="p">)</span> <span class="ow">or</span> <span class="n">numeral</span> <span class="o">==</span> <span class="s1">&#39;@none&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bass_only</span> <span class="ow">or</span> <span class="n">merge_tones</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;chord_tones&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                <span class="s1">&#39;added_tones&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                <span class="s1">&#39;root&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="p">}</span>
    <span class="n">form</span><span class="p">,</span> <span class="n">figbass</span><span class="p">,</span> <span class="n">changes</span><span class="p">,</span> <span class="n">relativeroot</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
        <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">else</span> <span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">figbass</span><span class="p">,</span> <span class="n">changes</span><span class="p">,</span> <span class="n">relativeroot</span><span class="p">))</span>
    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">numeral</span><span class="si">}{</span><span class="n">form</span><span class="si">}{</span><span class="n">figbass</span><span class="si">}{</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">changes</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="k">if</span> <span class="n">changes</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="si">}{</span><span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">relativeroot</span> <span class="k">if</span> <span class="n">relativeroot</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">MC</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">mc</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;MC </span><span class="si">{</span><span class="n">mc</span><span class="si">}</span><span class="s1">: &#39;</span>
    <span class="k">if</span> <span class="n">minor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">minor</span> <span class="o">=</span> <span class="n">str_is_minor</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">is_name</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mode inferred from </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;If parameter &#39;minor&#39; is not specified, &#39;key&#39; needs to be a string, not </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">key</span> <span class="o">=</span> <span class="n">name2fifths</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">form</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;+M&#39;</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="n">figbass</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;65&#39;</span><span class="p">,</span> <span class="s1">&#39;43&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;2&#39;</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}{</span><span class="n">label</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">form</span><span class="si">}</span><span class="s2"> requires figbass (7, 65, 43, or 2) since it specifies a chord&#39;s seventh.&quot;</span>

    <span class="k">if</span> <span class="n">relativeroot</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">resolved</span> <span class="o">=</span> <span class="n">resolve_relative_keys</span><span class="p">(</span><span class="n">relativeroot</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">rel_minor</span> <span class="o">=</span> <span class="n">str_is_minor</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="n">is_name</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">transp</span> <span class="o">=</span> <span class="n">roman_numeral2fifths</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}</span><span class="s2">Chord applied to </span><span class="si">{</span><span class="n">relativeroot</span><span class="si">}</span><span class="s2">. Therefore transposing it by </span><span class="si">{</span><span class="n">transp</span><span class="si">}</span><span class="s2"> fifths.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">features2tpcs</span><span class="p">(</span><span class="n">numeral</span><span class="o">=</span><span class="n">numeral</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">figbass</span><span class="o">=</span><span class="n">figbass</span><span class="p">,</span> <span class="n">relativeroot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">changes</span><span class="o">=</span><span class="n">changes</span><span class="p">,</span>
                             <span class="n">key</span><span class="o">=</span><span class="n">key</span> <span class="o">+</span> <span class="n">transp</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">rel_minor</span><span class="p">,</span> <span class="n">merge_tones</span><span class="o">=</span><span class="n">merge_tones</span><span class="p">,</span> <span class="n">bass_only</span><span class="o">=</span><span class="n">bass_only</span><span class="p">,</span> <span class="n">mc</span><span class="o">=</span><span class="n">mc</span><span class="p">,</span>
                             <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">numeral</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;#vii&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">minor</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}{</span><span class="n">numeral</span><span class="si">}</span><span class="s2"> in major context corrected to </span><span class="si">{</span><span class="n">numeral</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">numeral</span> <span class="o">=</span> <span class="n">numeral</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">root_alteration</span><span class="p">,</span> <span class="n">num_degree</span> <span class="o">=</span> <span class="n">split_scale_degree</span><span class="p">(</span><span class="n">numeral</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>

    <span class="c1"># build 2-octave diatonic scale on C major/minor</span>
    <span class="n">root</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">num_degree</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="n">tpcs</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">key</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)]</span> <span class="k">if</span> <span class="n">minor</span> <span class="k">else</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">key</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)]</span>
    <span class="c1"># starting the scale from chord root, i.e. root will be tpcs[0], the chord&#39;s seventh tpcs[6] etc.</span>
    <span class="n">tpcs</span> <span class="o">=</span> <span class="n">tpcs</span><span class="p">[</span><span class="n">root</span><span class="p">:]</span> <span class="o">+</span> <span class="n">tpcs</span><span class="p">[:</span><span class="n">root</span><span class="p">]</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">tpcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">root_alteration</span>
    <span class="n">tpcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">root</span>  <span class="c1"># octave stays diatonic, is not altered</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">num_degree</span><span class="si">}</span><span class="s2">: The </span><span class="si">{</span><span class="s1">&#39;minor&#39;</span> <span class="k">if</span> <span class="n">minor</span> <span class="k">else</span> <span class="s1">&#39;major&#39;</span><span class="si">}</span><span class="s2"> scale starting from the root: </span><span class="si">{</span><span class="n">tpcs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_iv</span><span class="p">(</span><span class="n">chord_interval</span><span class="p">,</span> <span class="n">interval_size</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add to the interval of a given chord interval in `tpcs` (both viewed from the root note).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        chord_interval : :obj:`int`</span>
<span class="sd">            Pass 0 for the root note, 2 for the third, 8 for the ninth etc.</span>
<span class="sd">        interval_size : :obj:`int`</span>
<span class="sd">            Stack-of-fifths interval.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">nonlocal</span> <span class="n">tpcs</span><span class="p">,</span> <span class="n">root</span>
        <span class="n">iv</span> <span class="o">=</span> <span class="n">root</span> <span class="o">+</span> <span class="n">interval_size</span>
        <span class="n">tpcs</span><span class="p">[</span><span class="n">chord_interval</span><span class="p">]</span> <span class="o">=</span> <span class="n">iv</span>
        <span class="n">tpcs</span><span class="p">[</span><span class="n">chord_interval</span> <span class="o">+</span> <span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">iv</span>

    <span class="n">is_triad</span> <span class="o">=</span> <span class="n">figbass</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;64&#39;</span><span class="p">]</span>
    <span class="n">is_seventh_chord</span> <span class="o">=</span> <span class="n">figbass</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;65&#39;</span><span class="p">,</span> <span class="s1">&#39;43&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_triad</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_seventh_chord</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}{</span><span class="n">figbass</span><span class="si">}</span><span class="s2"> is not a valid chord inversion.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">form</span> <span class="o">==</span> <span class="s1">&#39;o&#39;</span><span class="p">:</span>
        <span class="n">set_iv</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">set_iv</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_seventh_chord</span><span class="p">:</span>
            <span class="n">set_iv</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">9</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">form</span> <span class="o">==</span> <span class="s1">&#39;%&#39;</span><span class="p">:</span>
        <span class="n">set_iv</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">set_iv</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">set_iv</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">form</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
        <span class="n">set_iv</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">set_iv</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_seventh_chord</span><span class="p">:</span>
            <span class="n">set_iv</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">form</span> <span class="o">==</span> <span class="s1">&#39;+M&#39;</span><span class="p">:</span>
        <span class="n">set_iv</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">set_iv</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">set_iv</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># triad with or without major or minor seven</span>
        <span class="n">set_iv</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_degree</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
            <span class="n">set_iv</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">set_iv</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span>
            <span class="n">set_iv</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_seventh_chord</span><span class="p">:</span>
            <span class="n">set_iv</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">tone_functions</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_seventh_chord</span> <span class="k">else</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">root_position</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">[</span><span class="n">tpcs</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tone_functions</span><span class="p">}</span>
    <span class="n">replacements</span>  <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tone_functions</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">replace_chord_tone</span><span class="p">(</span><span class="n">which</span><span class="p">,</span> <span class="n">by</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">root_position</span><span class="p">,</span> <span class="n">replacements</span>
        <span class="k">if</span> <span class="n">which</span> <span class="ow">in</span> <span class="n">root_position</span><span class="p">:</span>
            <span class="n">root_position</span><span class="p">[</span><span class="n">which</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">replacements</span><span class="p">[</span><span class="n">which</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">by</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Only chord tones [0,2,4,(6)] can be replaced, not </span><span class="si">{</span><span class="n">which</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># apply changes</span>
    <span class="n">alts</span> <span class="o">=</span> <span class="n">changes2list</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">added_notes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">full</span><span class="p">,</span> <span class="n">add_remove</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">chord_interval</span> <span class="ow">in</span> <span class="n">alts</span><span class="p">:</span>
        <span class="n">added</span> <span class="o">=</span> <span class="n">add_remove</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span>
        <span class="n">substracted</span> <span class="o">=</span> <span class="n">add_remove</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span>
        <span class="n">replacing_upper</span> <span class="o">=</span> <span class="n">add_remove</span> <span class="o">==</span> <span class="s1">&#39;^&#39;</span>
        <span class="n">replacing_lower</span> <span class="o">=</span> <span class="n">add_remove</span> <span class="o">==</span> <span class="s1">&#39;v&#39;</span>
        <span class="n">chord_interval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chord_interval</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="c1">### From here on, `chord_interval` is decremented, i.e. the root is 0, the seventh is 6 etc. (just like in `tpcs`)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">chord_interval</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">substracted</span><span class="p">)</span> <span class="ow">or</span> <span class="n">chord_interval</span> <span class="o">&gt;</span> <span class="mi">13</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}</span><span class="s2">Change </span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2"> is meaningless and ignored because it concerns chord tone </span><span class="si">{</span><span class="n">chord_interval</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">next_octave</span> <span class="o">=</span> <span class="n">chord_interval</span> <span class="o">&gt;</span> <span class="mi">7</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="n">acc</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">acc</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">))</span>
        <span class="n">new_val</span> <span class="o">=</span> <span class="n">tpcs</span><span class="p">[</span><span class="n">chord_interval</span><span class="p">]</span> <span class="o">+</span> <span class="n">shift</span>
        <span class="k">if</span> <span class="n">substracted</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">chord_interval</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tone_functions</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}</span><span class="s2">The change </span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2"> has no effect because it concerns an interval which is not implied by </span><span class="si">{</span><span class="n">numeral</span><span class="si">}{</span><span class="n">form</span><span class="si">}{</span><span class="n">figbass</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">root_position</span><span class="p">[</span><span class="n">chord_interval</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="n">added</span><span class="p">:</span>
            <span class="n">added_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">next_octave</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">replacing_lower</span><span class="p">,</span> <span class="n">replacing_upper</span><span class="p">,</span> <span class="n">substracted</span><span class="p">)):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}{</span><span class="n">full</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> has no effect in </span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2">  because the interval is larger than an octave.&quot;</span><span class="p">)</span>
            <span class="n">added_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">chord_interval</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]:</span>  <span class="c1"># these are changes to scale degree 2, 4, 6 that replace the lower neighbour unless they have a # or ^</span>
            <span class="k">if</span> <span class="s1">&#39;#&#39;</span> <span class="ow">in</span> <span class="n">acc</span> <span class="ow">or</span> <span class="n">replacing_upper</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;#&#39;</span> <span class="ow">in</span> <span class="n">acc</span> <span class="ow">and</span> <span class="n">replacing_upper</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}</span><span class="s2">^ is redundant in </span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">chord_interval</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">is_triad</span><span class="p">:</span>  <span class="c1"># leading tone to 7 but not in seventh chord</span>
                    <span class="n">added_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">replace_chord_tone</span><span class="p">(</span><span class="n">chord_interval</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new_val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">replacing_lower</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}</span><span class="s2">v is redundant in </span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">replace_chord_tone</span><span class="p">(</span><span class="n">chord_interval</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new_val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># chord tone alterations</span>
            <span class="k">if</span> <span class="n">replacing_lower</span><span class="p">:</span>
                <span class="c1"># TODO: This must be possible, e.g. V(6v5) where 5 is suspension of 4</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}{</span><span class="n">full</span><span class="si">}</span><span class="s2"> -&gt; chord tones cannot replace neighbours, use + instead.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">chord_interval</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">figbass</span> <span class="o">!=</span> <span class="s1">&#39;7&#39;</span><span class="p">:</span>  <span class="c1"># 7th are a special case:</span>
                <span class="k">if</span> <span class="n">figbass</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>  <span class="c1"># in root position triads they are added</span>
                    <span class="c1"># TODO: The standard is lacking a distinction, because the root in root pos. can also be replaced from below!</span>
                    <span class="n">added_notes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">figbass</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;64&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;#&#39;</span> <span class="ow">in</span> <span class="n">acc</span><span class="p">:</span>  <span class="c1"># in inverted triads they replace the root, as does #7</span>
                    <span class="n">replace_chord_tone</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">new_val</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># otherwise they are unclear</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}</span><span class="s2">In seventh chords, such as </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">, it is not clear whether the </span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2"> alters the 7 or replaces the 8 and should not be used.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">tpcs</span><span class="p">[</span><span class="n">chord_interval</span><span class="p">]</span> <span class="o">==</span> <span class="n">new_val</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}</span><span class="s2">The change </span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2"> has no effect in </span><span class="si">{</span><span class="n">numeral</span><span class="si">}{</span><span class="n">form</span><span class="si">}{</span><span class="n">figbass</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">root_position</span><span class="p">[</span><span class="n">chord_interval</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_val</span><span class="p">]</span>

    <span class="n">figbass2bass</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;7&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;6&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;65&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;64&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;43&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;2&#39;</span><span class="p">:</span> <span class="mi">3</span>
    <span class="p">}</span>
    <span class="n">bass</span> <span class="o">=</span> <span class="n">figbass2bass</span><span class="p">[</span><span class="n">figbass</span><span class="p">]</span>
    <span class="n">chord_tones</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tf</span> <span class="ow">in</span> <span class="n">tone_functions</span><span class="p">[</span><span class="n">bass</span><span class="p">:]</span> <span class="o">+</span> <span class="n">tone_functions</span><span class="p">[:</span><span class="n">bass</span><span class="p">]:</span>
        <span class="n">chord_tone</span><span class="p">,</span> <span class="n">replacing_tones</span> <span class="o">=</span> <span class="n">root_position</span><span class="p">[</span><span class="n">tf</span><span class="p">],</span> <span class="n">replacements</span><span class="p">[</span><span class="n">tf</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">chord_tone</span> <span class="o">==</span> <span class="n">replacing_tones</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}{</span><span class="n">label</span><span class="si">}</span><span class="s2"> results in a chord without </span><span class="si">{</span><span class="n">tf</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">chord_tone</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">chord_tones</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chord_tone</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">replacing_tones</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">MC</span><span class="si">}{</span><span class="n">label</span><span class="si">}</span><span class="s2"> results in a chord tone </span><span class="si">{</span><span class="n">tf</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2"> AND its replacement(s) </span><span class="si">{</span><span class="n">replacing_tones</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                               <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">mc</span><span class="p">,</span> <span class="n">label</span><span class="p">)})</span>
        <span class="n">chord_tones</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">replacing_tones</span><span class="p">)</span>

    <span class="n">bass_tpc</span> <span class="o">=</span> <span class="n">chord_tones</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">bass_only</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">bass_tpc</span>
    <span class="k">elif</span> <span class="n">merge_tones</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sort_tpcs</span><span class="p">(</span><span class="n">chord_tones</span> <span class="o">+</span> <span class="n">added_notes</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">bass_tpc</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;chord_tones&#39;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">chord_tones</span><span class="p">),</span>
            <span class="s1">&#39;added_tones&#39;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">added_notes</span><span class="p">),</span>
            <span class="s1">&#39;root&#39;</span><span class="p">:</span> <span class="n">root</span><span class="p">,</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="path2parent_corpus"><a class="viewcode-back" href="../../reference.html#ms3.utils.path2parent_corpus">[docs]</a><span class="k">def</span> <span class="nf">path2parent_corpus</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Walk up the path and return the name of the superdirectory containing a &#39;metadata.tsv&#39; file.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">listdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;metadata.tsv&#39;</span> <span class="ow">in</span> <span class="n">listdir</span> <span class="ow">or</span> <span class="s1">&#39;.git&#39;</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">path</span>
        <span class="k">return</span> <span class="n">path2parent_corpus</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="chord2tpcs"><a class="viewcode-back" href="../../reference.html#ms3.utils.chord2tpcs">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">chord2tpcs</span><span class="p">(</span><span class="n">chord</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split a chord label into its features and apply features2tpcs().</span>

<span class="sd">    Uses: features2tpcs()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    chord : :obj:`str`</span>
<span class="sd">        Chord label that can be split into the features [&#39;numeral&#39;, &#39;form&#39;, &#39;figbass&#39;, &#39;changes&#39;, &#39;relativeroot&#39;].</span>
<span class="sd">    regex : :obj:`re.Pattern`, optional</span>
<span class="sd">        Compiled regex with named groups for the five features. By default, the current version of the DCML harmony</span>
<span class="sd">        annotation standard is used.</span>
<span class="sd">    **kwargs :</span>
<span class="sd">        arguments for features2tpcs (pass MC to show it in warnings!)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">regex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="n">DCML_REGEX</span>
    <span class="n">chord_features</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">chord</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">chord_features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">chord</span><span class="si">}</span><span class="s2"> does not match the regex.&quot;</span>
    <span class="n">chord_features</span> <span class="o">=</span> <span class="n">chord_features</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
    <span class="n">numeral</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">figbass</span><span class="p">,</span> <span class="n">changes</span><span class="p">,</span> <span class="n">relativeroot</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">chord_features</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;numeral&#39;</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="s1">&#39;figbass&#39;</span><span class="p">,</span> <span class="s1">&#39;changes&#39;</span><span class="p">,</span> <span class="s1">&#39;relativeroot&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">features2tpcs</span><span class="p">(</span><span class="n">numeral</span><span class="o">=</span><span class="n">numeral</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">figbass</span><span class="o">=</span><span class="n">figbass</span><span class="p">,</span> <span class="n">changes</span><span class="o">=</span><span class="n">changes</span><span class="p">,</span> <span class="n">relativeroot</span><span class="o">=</span><span class="n">relativeroot</span><span class="p">,</span>
                         <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="transpose"><a class="viewcode-back" href="../../reference.html#ms3.utils.transpose">[docs]</a><span class="k">def</span> <span class="nf">transpose</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Add `n` to all elements `e` recursively.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">map2elements</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">parse_ignored_warnings</span><span class="p">(</span><span class="n">messages</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="n">parse_ignored_warnings</span><span class="p">([</span><span class="n">messages</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">message</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="n">parse_ignored_warnings</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">message</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">):</span>
                <span class="c1"># if several lines of a warning were copied, use only the first one</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># if the annotator copied too much, cut off the redundant information at the end</span>
                    <span class="n">redundant</span> <span class="o">=</span>  <span class="n">message</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39; -- &#39;</span><span class="p">)</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="p">[:</span><span class="n">redundant</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">split_re</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;^(.*) (\S+)$&quot;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">msg</span><span class="p">,</span> <span class="n">logger_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">split_re</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The following message could not be split, apparently it does not end with the logger_name: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">raise</span>
                <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">level</span><span class="p">)</span> <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="s1">&#39;INFO&#39;</span><span class="p">,</span> <span class="s1">&#39;WARNING&#39;</span><span class="p">,</span> <span class="s1">&#39;ERROR&#39;</span><span class="p">,</span> <span class="s1">&#39;CRITICAL&#39;</span><span class="p">)):</span>
                        <span class="c1"># message_id has not (yet) specified for this log message and is ignored;</span>
                        <span class="c1"># a warning could be implemented at this point</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected log message format: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">tuple_start</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">tuple_str</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="n">tuple_start</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">str2inttuple</span><span class="p">(</span><span class="n">tuple_str</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">logger_name</span><span class="p">,</span> <span class="n">info</span>

<span class="k">def</span> <span class="nf">ignored_warnings2dict</span><span class="p">(</span><span class="n">messages</span><span class="p">):</span>
    <span class="n">ignored_warnings</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">logger_name</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">parse_ignored_warnings</span><span class="p">(</span><span class="n">messages</span><span class="p">):</span>
        <span class="n">ignored_warnings</span><span class="p">[</span><span class="n">logger_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ignored_warnings</span><span class="p">)</span>

<div class="viewcode-block" id="parse_ignored_warnings_file"><a class="viewcode-back" href="../../reference.html#ms3.utils.parse_ignored_warnings_file">[docs]</a><span class="k">def</span> <span class="nf">parse_ignored_warnings_file</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse file with log messages that have to be ignored to the dict.</span>
<span class="sd">    The expected structure of message: warning_type (warning_type_id, label) file</span>
<span class="sd">    Example of message: INCORRECT_VOLTA_MN_WARNING (2, 94) ms3.Parse.mixed_files.Did03M-Son_regina-1762-Sarti.mscx.MeasureList</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    key : :obj:`str`</span>
<span class="sd">        | Path to IGNORED_WARNINGS</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj: dict</span>
<span class="sd">        {file_name: [(message_id, label_of_message), (message_id, label_of_message), ...]}.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">resolve_dir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ignored_warnings2dict</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span></div>


<div class="viewcode-block" id="overlapping_chunk_per_interval"><a class="viewcode-back" href="../../reference.html#ms3.utils.overlapping_chunk_per_interval">[docs]</a><span class="k">def</span> <span class="nf">overlapping_chunk_per_interval</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">intervals</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; For each interval, create a chunk of the given DataFrame based on its IntervalIndex.</span>
<span class="sd">    This is an optimized algorithm compared to calling IntervalIndex.overlaps(interval) for each</span>
<span class="sd">    given interval, with the additional advantage that it will not discard rows where the</span>
<span class="sd">    interval is zero, such as [25.0, 25.0).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">   df : :obj:`pandas.DataFrame`</span>
<span class="sd">        The DataFrame is expected to come with an IntervalIndex and contain the columns &#39;quarterbeats&#39; and &#39;duration_qb&#39;.</span>
<span class="sd">        Those can be obtained through ``Parse.get_lists(interval_index=True)`` or</span>
<span class="sd">        ``Parse.iter_transformed(interval_index=True)``.</span>
<span class="sd">    intervals : :obj:`list` of :obj:`pd.Interval`</span>
<span class="sd">        The intervals defining the chunks&#39; dimensions. Expected to be non-overlapping and monotonically increasing.</span>
<span class="sd">    truncate : :obj:`bool`, optional</span>
<span class="sd">        Defaults to True, meaning that the interval index and the &#39;duration_qb&#39; will be adapted for overlapping intervals.</span>
<span class="sd">        Pass False to get chunks with all overlapping intervals as they are.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`dict`</span>
<span class="sd">        {interval -&gt; chunk}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lefts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">values</span>    <span class="c1"># lefts and rights will get shorter (potentially) with every</span>
    <span class="n">rights</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># interval, in order to reduce the time for comparing values</span>
    <span class="n">chunks</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">current_start_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">)</span> <span class="c1"># length remains the same</span>
    <span class="k">for</span> <span class="n">iv</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">:</span>
        <span class="c1"># assumes intervals are non-overlapping and monotonically increasing</span>
        <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">iv</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">iv</span><span class="o">.</span><span class="n">right</span>
        <span class="c1"># never again check events ending before the current interval&#39;s start</span>
        <span class="n">not_ending_before_l</span> <span class="o">=</span> <span class="p">(</span><span class="n">rights</span> <span class="o">&gt;=</span> <span class="n">l</span><span class="p">)</span>
        <span class="n">lefts</span> <span class="o">=</span> <span class="n">lefts</span><span class="p">[</span><span class="n">not_ending_before_l</span><span class="p">]</span>
        <span class="n">rights</span> <span class="o">=</span> <span class="n">rights</span><span class="p">[</span><span class="n">not_ending_before_l</span><span class="p">]</span>
        <span class="n">current_start_mask</span><span class="p">[</span><span class="n">current_start_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">not_ending_before_l</span>
        <span class="n">starting_before_r</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="n">lefts</span><span class="p">)</span>
        <span class="n">not_ending_on_l_except_empty</span> <span class="o">=</span> <span class="p">(</span><span class="n">rights</span> <span class="o">!=</span> <span class="n">l</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">lefts</span> <span class="o">==</span> <span class="n">l</span><span class="p">)</span>
        <span class="n">overlapping</span> <span class="o">=</span> <span class="p">(</span><span class="n">starting_before_r</span> <span class="o">&amp;</span> <span class="n">not_ending_on_l_except_empty</span><span class="p">)</span>
        <span class="n">bool_mask</span> <span class="o">=</span> <span class="n">current_start_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">bool_mask</span><span class="p">[</span><span class="n">current_start_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">overlapping</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">bool_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">truncate</span><span class="p">:</span>
            <span class="n">new_lefts</span><span class="p">,</span> <span class="n">new_rights</span> <span class="o">=</span> <span class="n">lefts</span><span class="p">[</span><span class="n">overlapping</span><span class="p">],</span> <span class="n">rights</span><span class="p">[</span><span class="n">overlapping</span><span class="p">]</span>
            <span class="n">starting_before_l</span><span class="p">,</span> <span class="n">ending_after_r</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_lefts</span> <span class="o">&lt;</span> <span class="n">l</span><span class="p">),</span> <span class="p">(</span><span class="n">new_rights</span> <span class="o">&gt;</span> <span class="n">r</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">starting_before_l</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">ending_after_r</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">new_lefts</span><span class="p">[</span><span class="n">starting_before_l</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span>
                <span class="n">new_rights</span><span class="p">[</span><span class="n">ending_after_r</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
                <span class="n">chunk</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">IntervalIndex</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">(</span><span class="n">new_lefts</span><span class="p">,</span> <span class="n">new_rights</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
                <span class="n">chunk</span><span class="o">.</span><span class="n">duration_qb</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_rights</span> <span class="o">-</span> <span class="n">new_lefts</span><span class="p">)</span>
        <span class="n">chunks</span><span class="p">[</span><span class="n">iv</span><span class="p">]</span> <span class="o">=</span> <span class="n">chunk</span>
    <span class="k">return</span> <span class="n">chunks</span></div>


<span class="k">def</span> <span class="nf">infer_tsv_type</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">type2cols</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;notes&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;tpc&#39;</span><span class="p">,</span> <span class="s1">&#39;midi&#39;</span><span class="p">],</span>
        <span class="s1">&#39;events&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;event&#39;</span><span class="p">],</span>
        <span class="s1">&#39;chords&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;chord_id&#39;</span><span class="p">],</span>
        <span class="s1">&#39;rests&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;nominal_duration&#39;</span><span class="p">],</span>
        <span class="s1">&#39;measures&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;act_dur&#39;</span><span class="p">],</span>
        <span class="s1">&#39;expanded&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;numeral&#39;</span><span class="p">],</span>
        <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;harmony_layer&#39;</span><span class="p">,</span> <span class="s1">&#39;label_type&#39;</span><span class="p">],</span>
        <span class="s1">&#39;cadences&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;cadence&#39;</span><span class="p">],</span>
        <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;last_mn&#39;</span><span class="p">,</span> <span class="s1">&#39;md5&#39;</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">columns</span> <span class="ow">in</span> <span class="n">type2cols</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="kc">True</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">t</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="kc">True</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;mn&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;labels&#39;</span>
    <span class="k">return</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div class="sphinx-toc sphinxglobaltoc">
<h3><a href="../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quick.html">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../manual.html">Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference.html">Developers' Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">ms3 0.5.3.post0.dev88+g764fcd4.dirty documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">ms3.utils</a></li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, johentsch.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.1.1.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>