


<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ms3.utils &#8212; ms3 0.4.9 documentation</title>
    <link rel="stylesheet" href="../../_static/cloud.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/ansi.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noticia+Text:400,i,b,bi|Open+Sans:400,i,b,bi|Roboto+Mono:400,i,b,bi&amp;display=swap" type="text/css" />
    
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>

    
    
     
        <script src="../../_static/jquery.cookie.js"></script>
    

    
     
        <script src="../../_static/cloud.base.js"></script>
    

    
     
        <script src="../../_static/cloud.js"></script>
    

    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">ms3 0.4.9 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">ms3.utils</a></li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ms3.utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">platform</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">fractions</span> <span class="kn">import</span> <span class="n">Fraction</span> <span class="k">as</span> <span class="n">frac</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">repeat</span><span class="p">,</span> <span class="n">takewhile</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">which</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">NamedTemporaryFile</span> <span class="k">as</span> <span class="n">Temp</span>
<span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span> <span class="k">as</span> <span class="n">Zip</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">webcolors</span>
<span class="kn">from</span> <span class="nn">pathos</span> <span class="kn">import</span> <span class="n">multiprocessing</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">pytablewriter</span> <span class="kn">import</span> <span class="n">MarkdownTableWriter</span>

<span class="kn">from</span> <span class="nn">.logger</span> <span class="kn">import</span> <span class="n">function_logger</span><span class="p">,</span> <span class="n">update_cfg</span>

<span class="n">DCML_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">^(\.?</span>
<span class="s2">    ((?P&lt;globalkey&gt;[a-gA-G](b*|\#*))\.)?</span>
<span class="s2">    ((?P&lt;localkey&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)+)\.)?</span>
<span class="s2">    ((?P&lt;pedal&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)+)\[)?</span>
<span class="s2">    (?P&lt;chord&gt;</span>
<span class="s2">        (?P&lt;numeral&gt;(b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i|Ger|It|Fr|@none))</span>
<span class="s2">        (?P&lt;form&gt;(%|o|\+|M|\+M))?</span>
<span class="s2">        (?P&lt;figbass&gt;(7|65|43|42|2|64|6))?</span>
<span class="s2">        (\((?P&lt;changes&gt;((\+|-|\^|v)?(b*|\#*)\d)+)\))?</span>
<span class="s2">        (/(?P&lt;relativeroot&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)*))?</span>
<span class="s2">    )</span>
<span class="s2">    (?P&lt;pedalend&gt;\])?</span>
<span class="s2">)?</span>
<span class="s2">(\|(?P&lt;cadence&gt;((HC|PAC|IAC|DC|EC|PC)(\..+?)?)))?</span>
<span class="s2">(?P&lt;phraseend&gt;(\\\\|\}\{|\{|\}))?$</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;:obj:`str`</span>
<span class="sd">Constant with a regular expression that recognizes labels conforming to the DCML harmony annotation standard excluding those</span>
<span class="sd">consisting of two alternatives.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">DCML_DOUBLE_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                                ^(?P&lt;first&gt;</span>
<span class="s2">                                  (\.?</span>
<span class="s2">                                    ((?P&lt;globalkey&gt;[a-gA-G](b*|\#*))\.)?</span>
<span class="s2">                                    ((?P&lt;localkey&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)+)\.)?</span>
<span class="s2">                                    ((?P&lt;pedal&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)+)\[)?</span>
<span class="s2">                                    (?P&lt;chord&gt;</span>
<span class="s2">                                        (?P&lt;numeral&gt;(b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i|Ger|It|Fr|@none))</span>
<span class="s2">                                        (?P&lt;form&gt;(%|o|\+|M|\+M))?</span>
<span class="s2">                                        (?P&lt;figbass&gt;(7|65|43|42|2|64|6))?</span>
<span class="s2">                                        (\((?P&lt;changes&gt;((\+|-|\^|v)?(b*|\#*)\d)+)\))?</span>
<span class="s2">                                        (/(?P&lt;relativeroot&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)*))?</span>
<span class="s2">                                    )</span>
<span class="s2">                                    (?P&lt;pedalend&gt;\])?</span>
<span class="s2">                                  )?</span>
<span class="s2">                                  (\|(?P&lt;cadence&gt;((HC|PAC|IAC|DC|EC|PC)(\..+?)?)))?</span>
<span class="s2">                                  (?P&lt;phraseend&gt;(\\\\|\}\{|\{|\})</span>
<span class="s2">                                  )?</span>
<span class="s2">                                 )</span>
<span class="s2">                                 (-</span>
<span class="s2">                                  (?P&lt;second&gt;</span>
<span class="s2">                                    ((?P&lt;globalkey2&gt;[a-gA-G](b*|\#*))\.)?</span>
<span class="s2">                                    ((?P&lt;localkey2&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)+)\.)?</span>
<span class="s2">                                    ((?P&lt;pedal2&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)+)\[)?</span>
<span class="s2">                                    (?P&lt;chord2&gt;</span>
<span class="s2">                                        (?P&lt;numeral2&gt;(b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i|Ger|It|Fr|@none))</span>
<span class="s2">                                        (?P&lt;form2&gt;(%|o|\+|M|\+M))?</span>
<span class="s2">                                        (?P&lt;figbass2&gt;(7|65|43|42|2|64|6))?</span>
<span class="s2">                                        (\((?P&lt;changes2&gt;((\+|-|\^|v)?(b*|\#*)\d)+)\))?</span>
<span class="s2">                                        (/(?P&lt;relativeroot2&gt;((b*|\#*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i)/?)*))?</span>
<span class="s2">                                    )</span>
<span class="s2">                                    (?P&lt;pedalend2&gt;\])?</span>
<span class="s2">                                  )?</span>
<span class="s2">                                  (\|(?P&lt;cadence2&gt;((HC|PAC|IAC|DC|EC|PC)(\..+?)?)))?</span>
<span class="s2">                                  (?P&lt;phraseend2&gt;(\\\\|\}\{|\{|\})</span>
<span class="s2">                                  )?</span>
<span class="s2">                                 )?</span>
<span class="s2">                                $</span>
<span class="s2">                                &quot;&quot;&quot;</span><span class="p">,</span>
                        <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;:obj:`str`</span>
<span class="sd">Constant with a regular expression that recognizes complete labels conforming to the DCML harmony annotation standard </span>
<span class="sd">including those consisting of two alternatives, without having to split them. It is simply a doubled version of DCML_REGEX.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="n">MS3_HTML</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;#005500&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkgreen&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aa0000&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkred&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aa5500&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_sienna&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#00aa00&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_green&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aaaa00&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkgoldenrod&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aaff00&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_chartreuse&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#00007f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_navy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aa007f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkmagenta&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#00557f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_teal&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aa557f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_indianred&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#00aa7f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkcyan&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aaaa7f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkgray&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aaff7f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_palegreen&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aa00ff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkviolet&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#0055ff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_dodgerblue&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aa55ff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_mediumorchid&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#00aaff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_deepskyblue&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aaaaff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_lightsteelblue&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#aaffff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_paleturquoise&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#550000&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_maroon&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#555500&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkolivegreen&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#ff5500&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_orangered&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#55aa00&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_olive&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#ffaa00&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_orange&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#55ff00&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_lawngreen&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#55007f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_indigo&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#ff007f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_deeppink&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#55557f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_darkslateblue&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#ff557f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_lightcoral&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#55aa7f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_mediumseagreen&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#ffaa7f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_lightsalmon&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#55ff7f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_lightgreen&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#ffff7f&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_khaki&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#5500ff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_blue&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#5555ff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_royalblue&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#ff55ff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_violet&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#55aaff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_cornflowerblue&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#ffaaff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_lightpink&#39;</span><span class="p">,</span>
            <span class="s1">&#39;#55ffff&#39;</span><span class="p">:</span> <span class="s1">&#39;ms3_aquamarine&#39;</span><span class="p">}</span>

<span class="n">MS3_RGB</span> <span class="o">=</span> <span class="p">{(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_darkgreen&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_darkred&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_sienna&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_green&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_darkgoldenrod&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_chartreuse&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_navy&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_darkmagenta&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_teal&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_indianred&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_darkcyan&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_darkgray&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_palegreen&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_darkviolet&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_dodgerblue&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_mediumorchid&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_deepskyblue&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_lightsteelblue&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_paleturquoise&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_maroon&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_darkolivegreen&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_orangered&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_olive&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_orange&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="s1">&#39;ms3_lawngreen&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_indigo&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_deeppink&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_darkslateblue&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_lightcoral&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_mediumseagreen&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_lightsalmon&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_lightgreen&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">127</span><span class="p">):</span> <span class="s1">&#39;ms3_khaki&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_blue&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_royalblue&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_violet&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_cornflowerblue&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_lightpink&#39;</span><span class="p">,</span>
           <span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">):</span> <span class="s1">&#39;ms3_aquamarine&#39;</span><span class="p">}</span>

<span class="n">CSS2MS3</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">:]:</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">MS3_HTML</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>
<span class="n">CSS_COLORS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">webcolors</span><span class="o">.</span><span class="n">CSS3_NAMES_TO_HEX</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">COLORS</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([[</span><span class="n">c</span><span class="p">,</span> <span class="n">CSS2MS3</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CSS2MS3</span> <span class="k">else</span> <span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CSS_COLORS</span><span class="p">],</span> <span class="p">[])</span>
<span class="n">rgba</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;RGBA&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">])</span>


<div class="viewcode-block" id="map_dict"><a class="viewcode-back" href="../../reference.html#ms3.utils.map_dict">[docs]</a><span class="k">class</span> <span class="nc">map_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Such a dictionary can be mapped to a Series to replace its values but leaving the values absent from the dict keys intact.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__missing__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">key</span></div>

<div class="viewcode-block" id="add_quarterbeats_col"><a class="viewcode-back" href="../../reference.html#ms3.utils.add_quarterbeats_col">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">add_quarterbeats_col</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">offset_dict</span><span class="p">,</span> <span class="n">insert_after</span><span class="o">=</span><span class="s1">&#39;mc&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Insert a column measuring the distance of events from MC 1 in quarter notes. If no &#39;mc_onset&#39; column is present,</span>
<span class="sd">        the column corresponds to the ``insert_after`` column&#39;s measure counts.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        DataFrame with an ``mc_playthrough`` and an ``mc_onset`` column.</span>
<span class="sd">    offset_dict : :obj:`pandas.Series` or :obj:`dict`</span>
<span class="sd">        If unfolded: {mc_playthrough -&gt; offset}</span>
<span class="sd">        Otherwise: {mc -&gt; offset}</span>
<span class="sd">        You can create the dict using the function :py:meth:`Parse.get_continuous_offsets()&lt;ms3.parsed.Parse.get_continuous_offsets&gt;`</span>
<span class="sd">    insert_after : :obj:`str`, optional</span>
<span class="sd">        Name of the column after which the new column will be inserted.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;quarterbeats&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">quarterbeats</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">insert_after</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">offset_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;mc_onset&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">quarterbeats</span> <span class="o">+=</span> <span class="n">df</span><span class="o">.</span><span class="n">mc_onset</span> <span class="o">*</span> <span class="mi">4</span>
        <span class="n">insert_here</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">insert_after</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">insert_here</span><span class="p">,</span> <span class="s1">&#39;quarterbeats&#39;</span><span class="p">,</span> <span class="n">quarterbeats</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;duration_quarterbeats&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;duration&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">dur</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">duration</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">insert_here</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;durations_quarterbeats&#39;</span><span class="p">,</span> <span class="n">dur</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;end&#39;</span> <span class="ow">in</span> <span class="n">offset_dict</span><span class="p">:</span>
                <span class="n">present_qb</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">quarterbeats</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
                <span class="n">breaks</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">present_qb</span><span class="p">,</span> <span class="s1">&#39;quarterbeats&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
                <span class="n">breaks</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">breaks</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">offset_dict</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">])]</span>
                <span class="n">ivs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">IntervalIndex</span><span class="o">.</span><span class="n">from_breaks</span><span class="p">(</span><span class="n">breaks</span><span class="p">,</span> <span class="n">closed</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">insert_here</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;durations_quarterbeats&#39;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">present_qb</span><span class="p">,</span> <span class="s1">&#39;durations_quarterbeats&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ivs</span><span class="o">.</span><span class="n">length</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Column &#39;durations_quarterbeats&#39; could not be created.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;quarterbeats column was already present.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="assert_all_lines_equal"><a class="viewcode-back" href="../../reference.html#ms3.utils.assert_all_lines_equal">[docs]</a><span class="k">def</span> <span class="nf">assert_all_lines_equal</span><span class="p">(</span><span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="n">original</span><span class="p">,</span> <span class="n">tmp_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Compares two multiline strings to test equality.&quot;&quot;&quot;</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">bef</span><span class="p">,</span> <span class="n">aft</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">bef</span><span class="p">,</span> <span class="n">aft</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">before</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(),</span> <span class="n">after</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()),</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">bef</span> <span class="o">!=</span> <span class="n">aft</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">line_n</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">diff</span><span class="p">)</span>
        <span class="n">ln</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">line_n</span><span class="p">)))</span>
        <span class="n">left_col</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">left</span><span class="p">)</span>
        <span class="n">folder</span><span class="p">,</span> <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
        <span class="n">tmp_persist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">tmp_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tmp_persist</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">original</span><span class="p">,</span> <span class="n">tmp_persist</span><span class="p">)]</span> <span class="o">+</span> <span class="n">diff</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">a</span><span class="si">:{</span><span class="n">ln</span><span class="si">}}</span><span class="s2">  </span><span class="si">{</span><span class="n">b</span><span class="si">:{</span><span class="n">left_col</span><span class="si">}}</span><span class="s2">    </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">)</span></div>


<div class="viewcode-block" id="assert_dfs_equal"><a class="viewcode-back" href="../../reference.html#ms3.utils.assert_dfs_equal">[docs]</a><span class="k">def</span> <span class="nf">assert_dfs_equal</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot; Compares the common columns of two DataFrames to test equality.&quot;&quot;&quot;</span>
    <span class="n">old_l</span><span class="p">,</span> <span class="n">new_l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">old</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
    <span class="n">greater_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">old_l</span><span class="p">,</span> <span class="n">new_l</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">old_l</span> <span class="o">!=</span> <span class="n">new_l</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Old length: </span><span class="si">{</span><span class="n">old_l</span><span class="si">}</span><span class="s2">, new length: </span><span class="si">{</span><span class="n">new_l</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">old_is_shorter</span> <span class="o">=</span> <span class="n">new_l</span> <span class="o">==</span> <span class="n">greater_length</span>
        <span class="n">shorter</span> <span class="o">=</span> <span class="n">old</span> <span class="k">if</span> <span class="n">old_is_shorter</span> <span class="k">else</span> <span class="n">new</span>
        <span class="n">missing_rows</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">old_l</span> <span class="o">-</span> <span class="n">new_l</span><span class="p">)</span>
        <span class="n">shorter_cols</span> <span class="o">=</span> <span class="n">shorter</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">patch</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="s1">&#39;missing row&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">shorter_cols</span><span class="p">)]</span> <span class="o">*</span> <span class="n">missing_rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">shorter_cols</span><span class="p">)</span>
        <span class="n">shorter</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">shorter</span><span class="p">,</span> <span class="n">patch</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">old_is_shorter</span><span class="p">:</span>
            <span class="n">old</span> <span class="o">=</span> <span class="n">shorter</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">shorter</span>
    <span class="n">old</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;old_ix&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">new</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;new_ix&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">old</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">new</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">]</span>
    <span class="n">nan_eq</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="o">~</span><span class="n">nan_eq</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="k">for</span> <span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">o</span><span class="p">),</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">(),</span> <span class="n">new</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">())]</span>
    <span class="n">old_bool</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="n">ix</span><span class="p">:</span> <span class="n">bool_series</span> <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">bool_series</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">},</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
    <span class="n">new_bool</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="n">ix</span><span class="p">:</span> <span class="n">bool_series</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">bool_series</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">},</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
    <span class="n">diffs_per_col</span> <span class="o">=</span> <span class="n">old_bool</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">show_diff</span><span class="p">():</span>
        <span class="n">comp_str</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">n_diffs</span> <span class="ow">in</span> <span class="n">diffs_per_col</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">n_diffs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">comparison</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">old</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">old_bool</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="n">col</span><span class="p">]]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">20</span><span class="p">],</span>
                                        <span class="n">new</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_bool</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="n">col</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span>
                                       <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                       <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;old&#39;</span><span class="p">,</span> <span class="s1">&#39;new&#39;</span><span class="p">])</span>
                <span class="n">comp_str</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n_diffs</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">greater_length</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">n_diffs</span> <span class="o">/</span> <span class="n">greater_length</span> <span class="o">*</span> <span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> %) rows are different for </span><span class="si">{</span><span class="n">col</span><span class="si">}{</span><span class="s1">&#39; (showing first 20)&#39;</span> <span class="k">if</span> <span class="n">n_diffs</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="n">comparison</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">comp_str</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">diffs_per_col</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">show_diff</span><span class="p">()</span></div>



<div class="viewcode-block" id="ambitus2oneliner"><a class="viewcode-back" href="../../reference.html#ms3.utils.ambitus2oneliner">[docs]</a><span class="k">def</span> <span class="nf">ambitus2oneliner</span><span class="p">(</span><span class="n">ambitus</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turns a ``metadata[&#39;parts&#39;][staff_id]`` dictionary into a string.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;min_midi&#39;</span> <span class="ow">in</span> <span class="n">ambitus</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ambitus</span><span class="p">[</span><span class="s1">&#39;min_midi&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">ambitus</span><span class="p">[</span><span class="s1">&#39;max_midi&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">ambitus</span><span class="p">[</span><span class="s1">&#39;min_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">ambitus</span><span class="p">[</span><span class="s1">&#39;max_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;max_midi&#39;</span> <span class="ow">in</span> <span class="n">ambitus</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ambitus</span><span class="p">[</span><span class="s1">&#39;max_midi&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">ambitus</span><span class="p">[</span><span class="s1">&#39;max_midi&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">ambitus</span><span class="p">[</span><span class="s1">&#39;max_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">ambitus</span><span class="p">[</span><span class="s1">&#39;max_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span></div>


<div class="viewcode-block" id="check_labels"><a class="viewcode-back" href="../../reference.html#ms3.utils.check_labels">[docs]</a><span class="k">def</span> <span class="nf">check_labels</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="n">split_regex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;mc_onset&#39;</span><span class="p">,</span> <span class="s1">&#39;staff&#39;</span><span class="p">,</span> <span class="s1">&#39;voice&#39;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;  Checks the labels in ``column`` against ``regex`` and returns those that don&#39;t match.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        DataFrame containing a column with labels.</span>
<span class="sd">    regex : :obj:`str`</span>
<span class="sd">        Regular expression that incorrect labels don&#39;t match.</span>
<span class="sd">    column : :obj:`str`, optional</span>
<span class="sd">        Column name where the labels are. Defaults to &#39;label&#39;</span>
<span class="sd">    split_regex : :obj:`str`, optional</span>
<span class="sd">        If you pass a regular expression (or simple string), it will be used to split the labels before checking the</span>
<span class="sd">        resulting column separately. Instead, pass True to use the default (a &#39;-&#39; that does not precede a scale degree).</span>
<span class="sd">    return_cols : :obj:`list`, optional</span>
<span class="sd">        Pass a list of the DataFrame columns that you want to be displayed for the wrong labels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        DataFrame with wrong labels.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">split_regex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">split_regex</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">check_this</span> <span class="o">=</span> <span class="n">split_alternatives</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">column</span><span class="p">,</span> <span class="n">alternatives_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">check_this</span> <span class="o">=</span> <span class="n">split_alternatives</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">column</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="n">split_regex</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">alternatives_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">check_this</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">column</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">regex</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">!=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="vm">__class__</span><span class="p">:</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
    <span class="n">not_matched</span> <span class="o">=</span> <span class="n">check_this</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="o">~</span><span class="n">c</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">return_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">select_wrong</span> <span class="o">=</span> <span class="n">not_matched</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">check_this</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">not_matched</span><span class="p">,</span> <span class="n">other</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="n">select_wrong</span><span class="p">]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;^/$&#39;</span><span class="p">,</span> <span class="s1">&#39;empty_harmony&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">select_wrong</span><span class="p">,</span> <span class="n">cols</span><span class="p">],</span> <span class="n">res</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>





<div class="viewcode-block" id="color2rgba"><a class="viewcode-back" href="../../reference.html#ms3.utils.color2rgba">[docs]</a><span class="k">def</span> <span class="nf">color2rgba</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Pass a RGB or RGBA tuple, HTML color or name to convert it to RGBA &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rgba</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rgba</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="p">(</span><span class="mi">255</span><span class="p">,)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rgba</span><span class="p">(</span><span class="o">*</span><span class="n">c</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">html_color2rgba</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">color_name2rgba</span><span class="p">(</span><span class="n">c</span><span class="p">)</span></div>



<div class="viewcode-block" id="color_name2format"><a class="viewcode-back" href="../../reference.html#ms3.utils.color_name2format">[docs]</a><span class="k">def</span> <span class="nf">color_name2format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;rgb&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts a single CSS3 name into one of &#39;HTML&#39;, &#39;rgb&#39;, or &#39;rgba&#39;&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">n</span>
    <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">CSS3_NAMES_TO_HEX</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">name_to_hex</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">MS3_HTML</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">html</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">MS3_HTML</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">n</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">n</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">html</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;rgb&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">hex_to_rgb</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;rgba&#39;</span><span class="p">:</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">hex_to_rgb</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rgba</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">rgb</span> <span class="o">+</span> <span class="p">(</span><span class="mi">255</span><span class="p">,)))</span>
    <span class="k">return</span> <span class="n">html</span></div>


<div class="viewcode-block" id="color_name2html"><a class="viewcode-back" href="../../reference.html#ms3.utils.color_name2html">[docs]</a><span class="k">def</span> <span class="nf">color_name2html</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts a single CSS3 name into HTML&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">color_name2format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="color_name2rgb"><a class="viewcode-back" href="../../reference.html#ms3.utils.color_name2rgb">[docs]</a><span class="k">def</span> <span class="nf">color_name2rgb</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts a single CSS3 name into RGB&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">color_name2format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;rgb&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="color_name2rgba"><a class="viewcode-back" href="../../reference.html#ms3.utils.color_name2rgba">[docs]</a><span class="k">def</span> <span class="nf">color_name2rgba</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts a single CSS3 name into RGBA&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">color_name2format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;rgba&#39;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">color_params2rgba</span><span class="p">(</span><span class="n">color_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_html</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_g</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_b</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color_a</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">[</span><span class="n">color_name</span><span class="p">,</span> <span class="n">color_html</span><span class="p">,</span> <span class="n">color_r</span><span class="p">,</span> <span class="n">color_g</span><span class="p">,</span> <span class="n">color_b</span><span class="p">,</span> <span class="n">color_a</span><span class="p">]):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">color_r</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">color_a</span><span class="p">):</span>
            <span class="n">color_a</span> <span class="o">=</span> <span class="mi">255</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">color_g</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">color_b</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">color_name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">color_html</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not a valid RGB color: </span><span class="si">{</span><span class="p">(</span><span class="n">color_r</span><span class="p">,</span> <span class="n">color_g</span><span class="p">,</span> <span class="n">color_b</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">color_r</span><span class="p">,</span> <span class="n">color_g</span><span class="p">,</span> <span class="n">color_b</span><span class="p">,</span> <span class="n">color_a</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">color_html</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">color2rgba</span><span class="p">(</span><span class="n">color_html</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">color_name</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">color2rgba</span><span class="p">(</span><span class="n">color_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rgba</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">allnamesequal</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

<div class="viewcode-block" id="commonprefix"><a class="viewcode-back" href="../../reference.html#ms3.utils.commonprefix">[docs]</a><span class="k">def</span> <span class="nf">commonprefix</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns common prefix of a list of paths.</span>
<span class="sd">    Uses: allnamesequal(), itertools.takewhile()&quot;&quot;&quot;</span>
    <span class="n">bydirectorylevels</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">takewhile</span><span class="p">(</span><span class="n">allnamesequal</span><span class="p">,</span> <span class="n">bydirectorylevels</span><span class="p">))</span></div>


<div class="viewcode-block" id="compute_mn"><a class="viewcode-back" href="../../reference.html#ms3.utils.compute_mn">[docs]</a><span class="k">def</span> <span class="nf">compute_mn</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Compute measure numbers from a measure list with columns [&#39;dont_count&#39;, &#39;numbering_offset&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">excluded</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;dont_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;numbering_offset&#39;</span><span class="p">]</span>
    <span class="n">mn</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">excluded</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">offset</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="n">mn</span> <span class="o">+=</span> <span class="n">offset</span>
    <span class="k">return</span> <span class="n">mn</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;mn&#39;</span><span class="p">)</span></div>




<span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">MS</span><span class="o">=</span><span class="s1">&#39;mscore&#39;</span><span class="p">):</span>
    <span class="n">process</span> <span class="o">=</span> <span class="p">[</span><span class="n">MS</span><span class="p">,</span> <span class="s1">&#39;--appimage-extract-and-run&#39;</span><span class="p">,</span> <span class="s2">&quot;-fo&quot;</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span><span class="p">]</span> <span class="k">if</span> <span class="n">MS</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.AppImage&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">MS</span><span class="p">,</span> <span class="s2">&quot;-fo&quot;</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">process</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Converted </span><span class="si">{</span><span class="n">old</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">new</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Error while converting &quot;</span> <span class="o">+</span> <span class="n">old</span><span class="p">)</span>

<div class="viewcode-block" id="convert_folder"><a class="viewcode-back" href="../../reference.html#ms3.utils.convert_folder">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">convert_folder</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">new_folder</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="p">[],</span> <span class="n">target_extension</span><span class="o">=</span><span class="s1">&#39;mscx&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="s1">&#39;.*&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">ms</span><span class="o">=</span><span class="s1">&#39;mscore&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Convert all files in `dir` that have one of the `extensions` to .mscx format using the executable `MS`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    directory, new_folder : str</span>
<span class="sd">        Directories</span>
<span class="sd">    extensions : list, optional</span>
<span class="sd">        If you want to convert only certain formats, give those, e.g. [&#39;mscz&#39;, &#39;xml&#39;]</span>
<span class="sd">    recursive : bool, optional</span>
<span class="sd">        Subdirectories as well.</span>
<span class="sd">    MS : str, optional</span>
<span class="sd">        Give the path to the MuseScore executable on your system. Need only if</span>
<span class="sd">        the command &#39;mscore&#39; does not execute MuseScore on your system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">MS</span> <span class="o">=</span> <span class="n">get_musescore</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">MS</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;MuseScore not found: </span><span class="si">{</span><span class="n">ms</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">target_extension</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
        <span class="n">target_extension</span> <span class="o">=</span> <span class="n">target_extension</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">conversion_params</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#logger.info(f&quot;Traversing {dir} {&#39;&#39; if recursive else &#39;non-&#39;}recursively...&quot;)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">exclude_re</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;^(?:(?!(</span><span class="si">{</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span><span class="si">}</span><span class="s2">)).)*$&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">exclude_re</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">new_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">new_folder</span> <span class="o">=</span> <span class="n">directory</span>
    <span class="n">new_dirs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">subdir</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">scan_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">file_re</span><span class="o">=</span><span class="n">regex</span><span class="p">,</span> <span class="n">exclude_re</span><span class="o">=</span><span class="n">exclude_re</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="n">recursive</span><span class="p">,</span> <span class="n">subdirs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exclude_files_only</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">subdir</span> <span class="ow">in</span> <span class="n">new_dirs</span><span class="p">:</span>
                <span class="n">new_subdir</span> <span class="o">=</span> <span class="n">new_dirs</span><span class="p">[</span><span class="n">subdir</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">old_subdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>
                <span class="n">new_subdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_folder</span><span class="p">,</span> <span class="n">old_subdir</span><span class="p">)</span> <span class="k">if</span> <span class="n">old_subdir</span> <span class="o">!=</span> <span class="s1">&#39;.&#39;</span> <span class="k">else</span> <span class="n">new_folder</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">new_subdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">new_dirs</span><span class="p">[</span><span class="n">subdir</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_subdir</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">target_extension</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">target_extension</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">old</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_subdir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">new</span><span class="p">):</span>
                <span class="n">conversion_params</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">MS</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="s1">&#39;exists already. Pass -o to overwrite.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">conversion_params</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No files to convert.&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to scan directory </span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2"> because of the following error:&quot;</span><span class="p">)</span>
        <span class="k">raise</span>


    <span class="c1"># TODO: pass filenames as &#39;logger&#39; argument to convert()</span>
    <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">convert</span><span class="p">,</span> <span class="n">conversion_params</span><span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">o</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">conversion_params</span><span class="p">:</span>
            <span class="n">convert</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span></div>


<div class="viewcode-block" id="decode_harmonies"><a class="viewcode-back" href="../../reference.html#ms3.utils.decode_harmonies">[docs]</a><span class="k">def</span> <span class="nf">decode_harmonies</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">label_col</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="n">keep_type</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_series</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alt_cols</span><span class="o">=</span><span class="s1">&#39;alt_label&#39;</span><span class="p">,</span> <span class="n">alt_separator</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;MuseScore stores types 2 (Nashville) and 3 (absolute chords) in several columns. This function returns a copy of</span>
<span class="sd">    the DataFrame ``Annotations.df`` where the label column contains the strings corresponding to these columns.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        DataFrame with encoded harmony labels as stored in an :obj:`Annotations` object.</span>
<span class="sd">    label_col : :obj:`str`, optional</span>
<span class="sd">        Column name where the main components (&lt;name&gt; tag) are stored, defaults to &#39;label&#39;</span>
<span class="sd">    keep_type : :obj:`bool`, optional</span>
<span class="sd">        Defaults to True, retaining the &#39;label_type&#39; column and setting types 2 and 3 to 0.</span>
<span class="sd">    return_series : :obj:`bool`, optional</span>
<span class="sd">        If set to True, only the decoded labels column is returned as a Series rather than a copy of ``df``.</span>
<span class="sd">    alt_cols : :obj:`str` or :obj:`list`, optional</span>
<span class="sd">        Column(s) with alternative labels that are joined with the label columns using ``alt_separator``. Defaults to</span>
<span class="sd">        &#39;alt_label&#39;. Suppress by passing None.</span>
<span class="sd">    alt_separator: :obj:`str`, optional</span>
<span class="sd">        Separator for joining ``alt_cols``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.DataFrame` or :obj:`pandas.Series`</span>
<span class="sd">        Decoded harmony labels.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">drop_cols</span><span class="p">,</span> <span class="n">compose_label</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s1">&#39;nashville&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">nashville</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sel</span><span class="p">,</span> <span class="n">label_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sel</span><span class="p">,</span> <span class="s1">&#39;nashville&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sel</span><span class="p">,</span> <span class="n">label_col</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">drop_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;nashville&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;leftParen&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">leftParen</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">compose_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;leftParen&#39;</span><span class="p">)</span>
        <span class="n">drop_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;leftParen&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;absolute_root&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">absolute_root</span> <span class="o">=</span> <span class="n">fifths2name</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">absolute_root</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">compose_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;absolute_root&#39;</span><span class="p">)</span>
        <span class="n">drop_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;absolute_root&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;rootCase&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rootCase</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sel</span><span class="p">,</span> <span class="s1">&#39;absolute_root&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sel</span><span class="p">,</span> <span class="s1">&#39;absolute_root&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">drop_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;rootCase&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">label_col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">compose_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label_col</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;absolute_base&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">absolute_base</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">fifths2name</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">absolute_base</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">compose_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;absolute_base&#39;</span><span class="p">)</span>
        <span class="n">drop_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;absolute_base&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;rightParen&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">rightParen</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">compose_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;rightParen&#39;</span><span class="p">)</span>
        <span class="n">drop_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;rightParen&#39;</span><span class="p">)</span>
    <span class="n">new_label_col</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">compose_label</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">new_label_col</span> <span class="o">=</span> <span class="n">new_label_col</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;^/$&#39;</span><span class="p">,</span> <span class="s1">&#39;empty_harmony&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">alt_cols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alt_cols</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">alt_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">alt_cols</span><span class="p">]</span>
        <span class="n">present</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">alt_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">present</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">alt_joined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">new_label_col</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">present</span><span class="p">:</span>
                <span class="n">alt_joined</span> <span class="o">+=</span> <span class="p">(</span><span class="n">alt_separator</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="n">c</span><span class="p">])</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">new_label_col</span> <span class="o">+=</span> <span class="n">alt_joined</span>

    <span class="k">if</span> <span class="n">return_series</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_label_col</span>

    <span class="k">if</span> <span class="s1">&#39;label_type&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">keep_type</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">label_type</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">]),</span> <span class="s1">&#39;label_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">drop_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;label_type&#39;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="n">label_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_label_col</span>
    <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">drop_cols</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="df2md"><a class="viewcode-back" href="../../reference.html#ms3.utils.df2md">[docs]</a><span class="k">def</span> <span class="nf">df2md</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Overview&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turns a DataFrame into a MarkDown table. The returned writer can be converted into a string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">MarkdownTableWriter</span><span class="p">()</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">header_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">value_matrix</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">writer</span></div>



<div class="viewcode-block" id="dict2oneliner"><a class="viewcode-back" href="../../reference.html#ms3.utils.dict2oneliner">[docs]</a><span class="k">def</span> <span class="nf">dict2oneliner</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turns a dictionary into a single-line string without brackets.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">())</span></div>


<div class="viewcode-block" id="fifths2acc"><a class="viewcode-back" href="../../reference.html#ms3.utils.fifths2acc">[docs]</a><span class="k">def</span> <span class="nf">fifths2acc</span><span class="p">(</span><span class="n">fifths</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns accidentals for a stack of fifths that can be combined with a</span>
<span class="sd">        basic representation of the seven steps.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fifths</span> <span class="o">//</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="s1">&#39;b&#39;</span> <span class="k">if</span> <span class="n">fifths</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">fifths</span> <span class="o">//</span> <span class="mi">7</span> <span class="o">*</span> <span class="s1">&#39;#&#39;</span></div>



<div class="viewcode-block" id="fifths2iv"><a class="viewcode-back" href="../../reference.html#ms3.utils.fifths2iv">[docs]</a><span class="k">def</span> <span class="nf">fifths2iv</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">smallest</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return interval name of a stack of fifths such that</span>
<span class="sd">       0 = &#39;P1&#39;, -1 = &#39;P4&#39;, -2 = &#39;m7&#39;, 4 = &#39;M3&#39; etc. If you pass ``smallest=True``, intervals of a fifth or greater</span>
<span class="sd">       will be inverted (e.g. &#39;m6&#39; =&gt; &#39;-M3&#39; and &#39;D5&#39; =&gt; &#39;-A4&#39;).</span>
<span class="sd">       Uses: map2elements()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">map2elements</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">fifths2iv</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">fifths</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fifths</span>
    <span class="n">interval_qualities</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">],</span>
                          <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">]}</span>
    <span class="n">interval_qualities_inverted</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">],</span>
                                   <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">]}</span>
    <span class="n">fifths</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># making 0 = fourth, 1 = unison, 2 = fifth etc.</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">fifths</span> <span class="o">%</span> <span class="mi">7</span>
    <span class="n">int_num</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">][</span><span class="n">pos</span><span class="p">]</span>
    <span class="n">qual_region</span> <span class="o">=</span> <span class="n">fifths</span> <span class="o">//</span> <span class="mi">7</span>
    <span class="k">if</span> <span class="n">smallest</span> <span class="ow">and</span> <span class="n">int_num</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">int_num</span> <span class="o">=</span> <span class="mi">9</span> <span class="o">-</span> <span class="n">int_num</span>
        <span class="k">if</span> <span class="n">qual_region</span> <span class="ow">in</span> <span class="n">interval_qualities_inverted</span><span class="p">:</span>
            <span class="n">int_qual</span> <span class="o">=</span> <span class="n">interval_qualities_inverted</span><span class="p">[</span><span class="n">qual_region</span><span class="p">][</span><span class="n">pos</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">qual_region</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">int_qual</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">qual_region</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="s1">&#39;A&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">int_qual</span> <span class="o">=</span> <span class="n">qual_region</span> <span class="o">*</span> <span class="s1">&#39;D&#39;</span>
        <span class="n">int_qual</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">int_qual</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">qual_region</span> <span class="ow">in</span> <span class="n">interval_qualities</span><span class="p">:</span>
            <span class="n">int_qual</span> <span class="o">=</span> <span class="n">interval_qualities</span><span class="p">[</span><span class="n">qual_region</span><span class="p">][</span><span class="n">pos</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">qual_region</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">int_qual</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">qual_region</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="s1">&#39;D&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">int_qual</span> <span class="o">=</span> <span class="n">qual_region</span> <span class="o">*</span> <span class="s1">&#39;A&#39;</span>
    <span class="k">return</span> <span class="n">int_qual</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">int_num</span><span class="p">)</span></div>



<div class="viewcode-block" id="fifths2name"><a class="viewcode-back" href="../../reference.html#ms3.utils.fifths2name">[docs]</a><span class="k">def</span> <span class="nf">fifths2name</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">midi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return note name of a stack of fifths such that</span>
<span class="sd">       0 = C, -1 = F, -2 = Bb, 1 = G etc.</span>
<span class="sd">       Uses: map2elements(), fifths2str()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fifths : :obj:`int`</span>
<span class="sd">        Tonal pitch class to turn into a note name.</span>
<span class="sd">    midi : :obj:`int`</span>
<span class="sd">        In order to include the octave into the note name,</span>
<span class="sd">        pass the corresponding MIDI pitch.</span>
<span class="sd">    ms : :obj:`bool`, optional</span>
<span class="sd">        Pass True if ``fifths`` is a MuseScore TPC, i.e. C = 14</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fifths</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">fifths</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">map2elements</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">fifths2name</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="n">ms</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fifths</span>

    <span class="k">if</span> <span class="n">ms</span><span class="p">:</span>
        <span class="n">fifths</span> <span class="o">-=</span> <span class="mi">14</span>
    <span class="n">note_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">]</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">fifths2str</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">note_names</span><span class="p">,</span> <span class="n">inverted</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">midi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">octave</span> <span class="o">=</span> <span class="n">midi2octave</span><span class="p">(</span><span class="n">midi</span><span class="p">,</span> <span class="n">fifths</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">octave</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">name</span></div>



<div class="viewcode-block" id="fifths2pc"><a class="viewcode-back" href="../../reference.html#ms3.utils.fifths2pc">[docs]</a><span class="k">def</span> <span class="nf">fifths2pc</span><span class="p">(</span><span class="n">fifths</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turn a stack of fifths into a chromatic pitch class.</span>
<span class="sd">        Uses: map2elements()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fifths</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">fifths</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">map2elements</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">fifths2pc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fifths</span>

    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="mi">7</span> <span class="o">*</span> <span class="n">fifths</span> <span class="o">%</span> <span class="mi">12</span><span class="p">)</span></div>



<div class="viewcode-block" id="fifths2rn"><a class="viewcode-back" href="../../reference.html#ms3.utils.fifths2rn">[docs]</a><span class="k">def</span> <span class="nf">fifths2rn</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">auto_key</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return Roman numeral of a stack of fifths such that</span>
<span class="sd">       0 = I, -1 = IV, 1 = V, -2 = bVII in major, VII in minor, etc.</span>
<span class="sd">       Uses: map2elements(), is_minor_mode()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    auto_key : :obj:`bool`, optional</span>
<span class="sd">        By default, the returned Roman numerals are uppercase. Pass True to pass upper-</span>
<span class="sd">        or lowercase according to the position in the scale.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">map2elements</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">fifths2rn</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">minor</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">fifths</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fifths</span>
    <span class="n">rn</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;VI&#39;</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">minor</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;IV&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">]</span>
    <span class="n">sel</span> <span class="o">=</span> <span class="n">fifths</span> <span class="o">+</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">minor</span> <span class="k">else</span> <span class="n">fifths</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">fifths2str</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">rn</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">auto_key</span> <span class="ow">and</span> <span class="n">is_minor_mode</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">minor</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="fifths2sd"><a class="viewcode-back" href="../../reference.html#ms3.utils.fifths2sd">[docs]</a><span class="k">def</span> <span class="nf">fifths2sd</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return scale degree of a stack of fifths such that</span>
<span class="sd">       0 = &#39;1&#39;, -1 = &#39;4&#39;, -2 = &#39;b7&#39; in major, &#39;7&#39; in minor etc.</span>
<span class="sd">       Uses: map2elements(), fifths2str()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">map2elements</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">fifths2sd</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">minor</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">fifths</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">fifths</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">minor</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">minor</span><span class="p">:</span>
        <span class="n">fifths</span> <span class="o">+=</span> <span class="mi">3</span>
    <span class="k">return</span> <span class="n">fifths2str</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">sd</span><span class="p">)</span></div>



<div class="viewcode-block" id="fifths2str"><a class="viewcode-back" href="../../reference.html#ms3.utils.fifths2str">[docs]</a><span class="k">def</span> <span class="nf">fifths2str</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">inverted</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Boiler plate used by fifths2-functions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fifths</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">fifths2acc</span><span class="p">(</span><span class="n">fifths</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inverted</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">steps</span><span class="p">[</span><span class="n">fifths</span> <span class="o">%</span> <span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="n">acc</span>
    <span class="k">return</span> <span class="n">acc</span> <span class="o">+</span> <span class="n">steps</span><span class="p">[</span><span class="n">fifths</span> <span class="o">%</span> <span class="mi">7</span><span class="p">]</span></div>


<span class="k">def</span> <span class="nf">get_ms_version</span><span class="p">(</span><span class="n">mscx_file</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">mscx_file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;programVersion&gt;(.*?)&lt;/programVersion&gt;&quot;</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<div class="viewcode-block" id="get_musescore"><a class="viewcode-back" href="../../reference.html#ms3.utils.get_musescore">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">get_musescore</span><span class="p">(</span><span class="n">MS</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Tests whether a MuseScore executable can be found on the system.</span>
<span class="sd">    Uses: test_binary()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    MS : :obj:`str`</span>
<span class="sd">        A path to the executable, installed command, or one of the keywords {&#39;auto&#39;, &#39;win&#39;, &#39;mac&#39;}</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`str`</span>
<span class="sd">        Path to the executable if found or None.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">MS</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">MS</span>
    <span class="k">if</span> <span class="n">MS</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;Windows&#39;</span><span class="p">:</span> <span class="s1">&#39;win&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Darwin&#39;</span><span class="p">:</span> <span class="s1">&#39;mac&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Linux&#39;</span><span class="p">:</span> <span class="s1">&#39;mscore&#39;</span>
        <span class="p">}</span>
        <span class="n">system</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">MS</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">system</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;System could not be inferred: </span><span class="si">{</span><span class="n">system</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">MS</span> <span class="o">=</span> <span class="s1">&#39;mscore&#39;</span>
    <span class="k">if</span> <span class="n">MS</span> <span class="o">==</span> <span class="s1">&#39;win&#39;</span><span class="p">:</span>
        <span class="n">program_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PROGRAMFILES&#39;</span><span class="p">]</span>
        <span class="n">MS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">program_files</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;MuseScore 3\bin\MuseScore3.exe&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">MS</span> <span class="o">==</span> <span class="s1">&#39;mac&#39;</span><span class="p">:</span>
        <span class="n">MS</span> <span class="o">=</span> <span class="s2">&quot;/Applications/MuseScore 3.app/Contents/MacOS/mscore&quot;</span>
    <span class="k">return</span> <span class="n">test_binary</span><span class="p">(</span><span class="n">MS</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span></div>


<div class="viewcode-block" id="group_id_tuples"><a class="viewcode-back" href="../../reference.html#ms3.utils.group_id_tuples">[docs]</a><span class="k">def</span> <span class="nf">group_id_tuples</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turns a list of (key, ix) into a {key: [ix]}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></div>


<div class="viewcode-block" id="html2format"><a class="viewcode-back" href="../../reference.html#ms3.utils.html2format">[docs]</a><span class="k">def</span> <span class="nf">html2format</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">html_col</span><span class="o">=</span><span class="s1">&#39;color_html&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts the HTML column of a DataFrame into &#39;name&#39;, &#39;rgb , or &#39;rgba&#39;. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">html_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">color_name2html</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;rgb&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">html_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">color_name2rgb</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;rgba&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">html_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">color_name2rgba</span><span class="p">)</span></div>


<div class="viewcode-block" id="html_color2format"><a class="viewcode-back" href="../../reference.html#ms3.utils.html_color2format">[docs]</a><span class="k">def</span> <span class="nf">html_color2format</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts a single HTML color into &#39;name&#39;, &#39;rgb&#39;, or  &#39;rgba&#39;.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">h</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">hex_to_name</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">MS3_HTML</span><span class="p">[</span><span class="n">h</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">h</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;rgb&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">hex_to_rgb</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;rgba&#39;</span><span class="p">:</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">hex_to_rgb</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rgba</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">rgb</span> <span class="o">+</span> <span class="p">(</span><span class="mi">255</span><span class="p">,)))</span></div>


<div class="viewcode-block" id="html_color2name"><a class="viewcode-back" href="../../reference.html#ms3.utils.html_color2name">[docs]</a><span class="k">def</span> <span class="nf">html_color2name</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts a HTML color into its CSS3 name or itself if there is none.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">html_color2format</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="html_color2rgb"><a class="viewcode-back" href="../../reference.html#ms3.utils.html_color2rgb">[docs]</a><span class="k">def</span> <span class="nf">html_color2rgb</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts a HTML color into RGB.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">html_color2format</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;rgb&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="html_color2rgba"><a class="viewcode-back" href="../../reference.html#ms3.utils.html_color2rgba">[docs]</a><span class="k">def</span> <span class="nf">html_color2rgba</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts a HTML color into RGBA.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">html_color2format</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s1">&#39;rgba&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_any_row_equal"><a class="viewcode-back" href="../../reference.html#ms3.utils.is_any_row_equal">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">is_any_row_equal</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns True if any two rows of the two DataFrames contain the same value tuples. &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">df1</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="s2">&quot;Pass the same number of columns for both DataFrames&quot;</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df1</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">v1</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_minor_mode"><a class="viewcode-back" href="../../reference.html#ms3.utils.is_minor_mode">[docs]</a><span class="k">def</span> <span class="nf">is_minor_mode</span><span class="p">(</span><span class="n">fifths</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns True if the scale degree `fifths` naturally has a minor third in the scale.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">thirds</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">minor</span> <span class="k">else</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">third</span> <span class="o">=</span> <span class="n">thirds</span><span class="p">[(</span><span class="n">fifths</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span><span class="p">]</span> <span class="o">-</span> <span class="n">fifths</span>
    <span class="k">return</span> <span class="n">third</span> <span class="o">==</span> <span class="o">-</span><span class="mi">3</span></div>


<span class="k">def</span> <span class="nf">iterable2str</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">iterable</span>


<div class="viewcode-block" id="join_tsvs"><a class="viewcode-back" href="../../reference.html#ms3.utils.join_tsvs">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">join_tsvs</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">sort_cols</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Performs outer join on the passed DataFrames based on &#39;mc&#39; and &#39;mc_onset&#39;, if any.</span>
<span class="sd">    Uses: functools.reduce(), sort_cols(), sort_note_lists()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dfs : :obj:`Collection`</span>
<span class="sd">        Collection of DataFrames to join.</span>
<span class="sd">    sort_cols : :obj:`bool`, optional</span>
<span class="sd">        If you pass True, the remaining columns (those that are not defined in the standard column order in the function</span>
<span class="sd">        sort_cols) will be sorted.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">zero</span><span class="p">,</span> <span class="n">one</span><span class="p">,</span> <span class="n">two</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;mc&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;mc_onset&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">two</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">one</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zero</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">join_order</span> <span class="o">=</span> <span class="n">two</span> <span class="o">+</span> <span class="n">one</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zero</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">zero</span><span class="p">)</span><span class="si">}</span><span class="s2"> DataFrames contain none of the columns &#39;mc&#39; and &#39;mc_onset&#39;.&quot;</span><span class="p">)</span>

    <span class="n">pos_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;mc_onset&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">join_tsv</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="n">join_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pos_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">join_cols</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_y&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_y&#39;</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">d</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="n">left</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">res</span><span class="p">[</span><span class="n">left</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">duplicates</span><span class="p">)</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">join_tsv</span><span class="p">,</span> <span class="n">join_order</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;midi&#39;</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">sort_note_list</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">two</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">pos_cols</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;mc&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">column_order</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort_cols</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="load_tsv"><a class="viewcode-back" href="../../reference.html#ms3.utils.load_tsv">[docs]</a><span class="k">def</span> <span class="nf">load_tsv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">converters</span><span class="o">=</span><span class="p">{},</span> <span class="n">dtypes</span><span class="o">=</span><span class="p">{},</span> <span class="n">stringtype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Loads the TSV file `path` while applying correct type conversion and parsing tuples.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : :obj:`str`</span>
<span class="sd">        Path to a TSV file as output by format_data().</span>
<span class="sd">    index_col : :obj:`list`, optional</span>
<span class="sd">        By default, the first two columns are loaded as MultiIndex.</span>
<span class="sd">        The first level distinguishes pieces and the second level the elements within.</span>
<span class="sd">    converters, dtypes : :obj:`dict`, optional</span>
<span class="sd">        Enhances or overwrites the mapping from column names to types included the constants.</span>
<span class="sd">    stringtype : :obj:`bool`, optional</span>
<span class="sd">        If you&#39;re using pandas &gt;= 1.0.0 you might want to set this to True in order</span>
<span class="sd">        to be using the new `string` datatype that includes the new null type `pd.NA`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">str2inttuple</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">()</span> <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">int2bool</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">safe_frac</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">frac</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>

    <span class="n">CONVERTERS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;added_tones&#39;</span><span class="p">:</span> <span class="n">str2inttuple</span><span class="p">,</span>
        <span class="s1">&#39;act_dur&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span>
        <span class="s1">&#39;chord_tones&#39;</span><span class="p">:</span> <span class="n">str2inttuple</span><span class="p">,</span>
        <span class="s1">&#39;globalkey_is_minor&#39;</span><span class="p">:</span> <span class="n">int2bool</span><span class="p">,</span>
        <span class="s1">&#39;localkey_is_minor&#39;</span><span class="p">:</span> <span class="n">int2bool</span><span class="p">,</span>
        <span class="s1">&#39;mc_offset&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span>
        <span class="s1">&#39;mc_onset&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span>
        <span class="s1">&#39;mn_onset&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span>
        <span class="s1">&#39;next&#39;</span><span class="p">:</span> <span class="n">str2inttuple</span><span class="p">,</span>
        <span class="s1">&#39;nominal_duration&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span>
        <span class="s1">&#39;quarterbeats&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span>
        <span class="s1">&#39;onset&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span>
        <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span>
        <span class="s1">&#39;scalar&#39;</span><span class="p">:</span> <span class="n">safe_frac</span><span class="p">,</span> <span class="p">}</span>

    <span class="n">DTYPES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;absolute_base&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;absolute_root&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;alt_label&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;barline&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;base&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;bass_note&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cadence&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;cadences_id&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;changes&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;chord&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;chord_id&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;chord_type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;color_name&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;color_html&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;color_r&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;color_g&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;color_b&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;color_a&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dont_count&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;figbass&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;globalkey&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;gracenote&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;harmonies_id&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;keysig&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;label_type&#39;</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
        <span class="s1">&#39;leftParen&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;localkey&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;mc&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mc_playthrough&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;midi&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mn&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;offset:x&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;offset_x&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;offset:y&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;offset_y&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;nashville&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;notes_id&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;numbering_offset&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;numeral&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;pedal&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;playthrough&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;phraseend&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;relativeroot&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;repeats&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;rightParen&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;root&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;rootCase&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;slur&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;special&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;staff&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tied&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;timesig&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="s1">&#39;tpc&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;voice&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;voices&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span><span class="p">,</span>
        <span class="s1">&#39;volta&#39;</span><span class="p">:</span> <span class="s1">&#39;Int64&#39;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">converters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">CONVERTERS</span><span class="p">)</span>
        <span class="n">conv</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">converters</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dtypes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">types</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">DTYPES</span><span class="p">)</span>
        <span class="n">types</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dtypes</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stringtype</span><span class="p">:</span>
        <span class="n">types</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span> <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="nb">str</span> <span class="k">else</span> <span class="n">typ</span> <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">types</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="n">index_col</span><span class="p">,</span>
                       <span class="n">dtype</span><span class="o">=</span><span class="n">types</span><span class="p">,</span>
                       <span class="n">converters</span><span class="o">=</span><span class="n">conv</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;mn&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
        <span class="n">mn_volta</span> <span class="o">=</span> <span class="n">mn2int</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">mn</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">mn</span> <span class="o">=</span> <span class="n">mn_volta</span><span class="o">.</span><span class="n">mn</span>
        <span class="k">if</span> <span class="n">mn_volta</span><span class="o">.</span><span class="n">volta</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;volta&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;volta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;Int64&#39;</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">volta</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mn_volta</span><span class="o">.</span><span class="n">volta</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="make_continuous_offset"><a class="viewcode-back" href="../../reference.html#ms3.utils.make_continuous_offset">[docs]</a><span class="k">def</span> <span class="nf">make_continuous_offset</span><span class="p">(</span><span class="n">act_durs</span><span class="p">,</span> <span class="n">quarters</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">negative_anacrusis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; In order to compute continuous offset, this function is required to compute each MC&#39;s offset from the</span>
<span class="sd">    piece&#39;s beginning.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    act_durs : :obj:`pandas.Series`</span>
<span class="sd">        A series of actual measures durations as fractions of whole notes (might differ from time signature).</span>
<span class="sd">    quarters : :obj:`bool`, optional</span>
<span class="sd">        By default, the continuous offsets are expressed in quarter notes. Pass false to leave them as fractions</span>
<span class="sd">        of a whole note.</span>
<span class="sd">    negative_anacrusis : :obj:`fractions.Fraction`</span>
<span class="sd">        By default, the first value is 0. If you pass a fraction here, the first value will be its negative and the</span>
<span class="sd">        second value will be 0.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.Series`</span>
<span class="sd">        Cumulative sum of the values, shifted down by 1.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">quarters</span><span class="p">:</span>
        <span class="n">act_durs</span> <span class="o">=</span> <span class="n">act_durs</span> <span class="o">*</span> <span class="mi">4</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">act_durs</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">last_val</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">last_ix</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">last_val</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">last_ix</span><span class="p">]))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">last_val</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">negative_anacrusis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">-=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">frac</span><span class="p">(</span><span class="n">negative_anacrusis</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="make_id_tuples"><a class="viewcode-back" href="../../reference.html#ms3.utils.make_id_tuples">[docs]</a><span class="k">def</span> <span class="nf">make_id_tuples</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; For a given key, this function return index tuples in the form [(key, 0), ..., (key, n)]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        indices in the form [(key, 0), ..., (key, n)]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span></div>




<div class="viewcode-block" id="map2elements"><a class="viewcode-back" href="../../reference.html#ms3.utils.map2elements">[docs]</a><span class="k">def</span> <span class="nf">map2elements</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; If `e` is an iterable, `f` is applied to all elements.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">map2elements</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="merge_ties"><a class="viewcode-back" href="../../reference.html#ms3.utils.merge_ties">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">merge_ties</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">return_dropped</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">perform_checks</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; In a note list, merge tied notes to single events with accumulated durations.</span>
<span class="sd">        Input dataframe needs columns [&#39;duration&#39;, &#39;tied&#39;, &#39;midi&#39;, &#39;staff&#39;]. This</span>
<span class="sd">        function does not handle correctly overlapping ties on the same pitch since</span>
<span class="sd">        it doesn&#39;t take into account the notational layers (&#39;voice&#39;).</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df</span>
<span class="sd">    return_dropped</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
        <span class="n">vc</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">tied</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">vc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">vc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;More than one 1 or -1:</span><span class="se">\n</span><span class="si">{</span><span class="n">vc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
        <span class="n">dur</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">drop</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="s1">&#39;ix&#39;</span><span class="p">:</span> <span class="n">ix</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">dur</span><span class="p">,</span> <span class="s1">&#39;dropped&#39;</span><span class="p">:</span> <span class="n">drop</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">merge_notes</span><span class="p">(</span><span class="n">staff_midi</span><span class="p">):</span>

        <span class="n">staff_midi</span><span class="p">[</span><span class="s1">&#39;chunks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">staff_midi</span><span class="o">.</span><span class="n">tied</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">staff_midi</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;chunks&#39;</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">merge</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;ix&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">tied</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">notna</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">tied</span><span class="o">.</span><span class="n">notna</span><span class="p">(),</span> <span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="s1">&#39;tied&#39;</span><span class="p">,</span> <span class="s1">&#39;midi&#39;</span><span class="p">,</span> <span class="s1">&#39;staff&#39;</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">perform_checks</span><span class="p">:</span>
        <span class="n">before</span> <span class="o">=</span> <span class="n">notna</span><span class="o">.</span><span class="n">tied</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="n">new_dur</span> <span class="o">=</span> <span class="n">notna</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;staff&#39;</span><span class="p">,</span> <span class="s1">&#39;midi&#39;</span><span class="p">],</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">merge_notes</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_dur</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_dur</span><span class="o">.</span><span class="n">duration</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">new_dur</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_dropped</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">new_dur</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;dropped&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_dur</span><span class="o">.</span><span class="n">dropped</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">new_dur</span><span class="o">.</span><span class="n">dropped</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">perform_checks</span><span class="p">:</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">tied</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">before</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">after</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;Error while merging ties. Before:</span><span class="se">\n</span><span class="si">{</span><span class="n">before</span><span class="si">}</span><span class="se">\n</span><span class="s2">After:</span><span class="se">\n</span><span class="si">{</span><span class="n">after</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="metadata2series"><a class="viewcode-back" href="../../reference.html#ms3.utils.metadata2series">[docs]</a><span class="k">def</span> <span class="nf">metadata2series</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turns a metadata dict into a pd.Series() (for storing in a DataFrame)</span>
<span class="sd">    Uses: ambitus2oneliner(), dict2oneliner(), parts_info()</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.Series`</span>
<span class="sd">        A series allowing for storing metadata as a row of a DataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;TimeSig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict2oneliner</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;TimeSig&#39;</span><span class="p">])</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;KeySig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict2oneliner</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;KeySig&#39;</span><span class="p">])</span>
    <span class="n">d</span><span class="p">[</span><span class="s1">&#39;ambitus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ambitus2oneliner</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;ambitus&#39;</span><span class="p">])</span>
    <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parts_info</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;parts&#39;</span><span class="p">]))</span>
    <span class="k">del</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;parts&#39;</span><span class="p">])</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span></div>


<div class="viewcode-block" id="midi2octave"><a class="viewcode-back" href="../../reference.html#ms3.utils.midi2octave">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">midi2octave</span><span class="p">(</span><span class="n">midi</span><span class="p">,</span> <span class="n">fifths</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; For a given MIDI pitch, calculate the octave. Middle octave = 4</span>
<span class="sd">        Uses: fifths2pc(), map2elements()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    midi : :obj:`int`</span>
<span class="sd">        MIDI pitch (positive integer)</span>
<span class="sd">    tpc : :obj:`int`, optional</span>
<span class="sd">        To be precise, for some Tonal Pitch Classes, the octave deviates</span>
<span class="sd">        from the simple formula ``MIDI // 12 - 1``, e.g. for B# or Cb.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">midi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">midi</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">midi</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">map2elements</span><span class="p">(</span><span class="n">midi</span><span class="p">,</span> <span class="n">midi2octave</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">midi</span>
    <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">fifths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pc</span> <span class="o">=</span> <span class="n">fifths2pc</span><span class="p">(</span><span class="n">fifths</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">midi</span> <span class="o">%</span> <span class="mi">12</span> <span class="o">!=</span> <span class="n">pc</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;midi2octave(): The Tonal Pitch Class </span><span class="si">{</span><span class="n">fifths</span><span class="si">}</span><span class="s2"> cannot be MIDI pitch </span><span class="si">{</span><span class="n">midi</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fifths</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="mi">12</span><span class="p">,</span>  <span class="c1"># B#</span>
            <span class="mi">19</span><span class="p">,</span>  <span class="c1"># B##</span>
            <span class="mi">26</span><span class="p">,</span>  <span class="c1"># B###</span>
            <span class="mi">24</span><span class="p">,</span>  <span class="c1"># A###</span>
        <span class="p">]:</span>
            <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">fifths</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="o">-</span><span class="mi">7</span><span class="p">,</span>  <span class="c1"># Cb</span>
            <span class="o">-</span><span class="mi">14</span><span class="p">,</span>  <span class="c1"># Cbb</span>
            <span class="o">-</span><span class="mi">21</span><span class="p">,</span>  <span class="c1"># Cbbb</span>
            <span class="o">-</span><span class="mi">19</span><span class="p">,</span>  <span class="c1"># Dbbb</span>
        <span class="p">]:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">midi</span> <span class="o">//</span> <span class="mi">12</span> <span class="o">+</span> <span class="n">i</span></div>



<div class="viewcode-block" id="mn2int"><a class="viewcode-back" href="../../reference.html#ms3.utils.mn2int">[docs]</a><span class="k">def</span> <span class="nf">mn2int</span><span class="p">(</span><span class="n">mn_series</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turn a series of measure numbers parsed as strings into two integer columns &#39;mn&#39; and &#39;volta&#39;. &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">split</span> <span class="o">=</span> <span class="n">mn_series</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?P&lt;mn&gt;\d+)(?P&lt;volta&gt;[a-g])?&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">mn_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">mn_series</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mn&#39;</span><span class="p">,</span> <span class="s1">&#39;volta&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mn_series</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;Int64&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mn_series</span>
    <span class="n">split</span><span class="o">.</span><span class="n">mn</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">split</span><span class="o">.</span><span class="n">mn</span><span class="p">)</span>
    <span class="n">split</span><span class="o">.</span><span class="n">volta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">split</span><span class="o">.</span><span class="n">volta</span><span class="o">.</span><span class="n">map</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}))</span>
    <span class="k">return</span> <span class="n">split</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;Int64&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="name2format"><a class="viewcode-back" href="../../reference.html#ms3.utils.name2format">[docs]</a><span class="k">def</span> <span class="nf">name2format</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="n">name_col</span><span class="o">=</span><span class="s1">&#39;color_name&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts a column with CSS3 names into &#39;html&#39;, &#39;rgb&#39;, or  &#39;rgba&#39;.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">name_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">color_name2html</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;rgb&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">name_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">color_name2rgb</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;rgba&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">name_col</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">color_name2rgba</span><span class="p">)</span></div>


<div class="viewcode-block" id="name2fifths"><a class="viewcode-back" href="../../reference.html#ms3.utils.name2fifths">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">name2fifths</span><span class="p">(</span><span class="n">nn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turn a note name such as `Ab` into a tonal pitch class, such that -1=F, 0=C, 1=G etc.</span>
<span class="sd">        Uses: split_note_name()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nn</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">int</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">nn</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">nn</span>
    <span class="n">name_tpcs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
    <span class="n">accidentals</span><span class="p">,</span> <span class="n">note_name</span> <span class="o">=</span> <span class="n">split_note_name</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">step_tpc</span> <span class="o">=</span> <span class="n">name_tpcs</span><span class="p">[</span><span class="n">note_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">step_tpc</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">accidentals</span></div>


<div class="viewcode-block" id="next2sequence"><a class="viewcode-back" href="../../reference.html#ms3.utils.next2sequence">[docs]</a><span class="k">def</span> <span class="nf">next2sequence</span><span class="p">(</span><span class="n">nxt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turns a &#39;next&#39; column into the correct sequence of MCs corresponding to unfolded repetitions.</span>
<span class="sd">    Requires that the Series&#39; index be the MCs as in ``measures.set_index(&#39;mc&#39;).next``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mc</span> <span class="o">=</span> <span class="n">nxt</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nxt</span> <span class="o">=</span> <span class="n">nxt</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">mc</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mc</span><span class="p">)</span>
        <span class="n">new_mc</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span> <span class="o">=</span> <span class="n">nxt</span><span class="p">[</span><span class="n">mc</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nxt</span><span class="p">[</span><span class="n">mc</span><span class="p">]</span> <span class="o">=</span> <span class="n">rest</span>
        <span class="n">mc</span> <span class="o">=</span> <span class="n">new_mc</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="no_collections_no_booleans"><a class="viewcode-back" href="../../reference.html#ms3.utils.no_collections_no_booleans">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">no_collections_no_booleans</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">coll_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bool_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cleans the DataFrame columns [&#39;next&#39;, &#39;chord_tones&#39;, &#39;added_tones&#39;] from tuples and the columns</span>
<span class="sd">    [&#39;globalkey_is_minor&#39;, &#39;localkey_is_minor&#39;] from booleans, converting them all to integers</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="n">collection_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;next&#39;</span><span class="p">,</span> <span class="s1">&#39;chord_tones&#39;</span><span class="p">,</span> <span class="s1">&#39;added_tones&#39;</span><span class="p">]</span>
    <span class="n">bool_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;globalkey_is_minor&#39;</span><span class="p">,</span> <span class="s1">&#39;localkey_is_minor&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">coll_columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">collection_cols</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">coll_columns</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bool_columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bool_cols</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bool_columns</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">collection_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;df needs to be a DataFrame, not a </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="vm">__class__</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cc</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cc</span><span class="p">],</span> <span class="n">iterable2str</span><span class="p">,</span> <span class="n">column_wise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transformed iterables in the columns </span><span class="si">{</span><span class="n">cc</span><span class="si">}</span><span class="s2"> to strings.&quot;</span><span class="p">)</span>
    <span class="n">bc</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">bool_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="nb">int</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">bc</span><span class="p">}</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">conv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<span class="k">def</span> <span class="nf">ordinal_suffix</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">suffixes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;st&#39;</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;nd&#39;</span><span class="p">,</span>
        <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;rd&#39;</span>
    <span class="p">}</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">suffixes</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">suffixes</span><span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">return</span> <span class="s1">&#39;th&#39;</span>


<div class="viewcode-block" id="parts_info"><a class="viewcode-back" href="../../reference.html#ms3.utils.parts_info">[docs]</a><span class="k">def</span> <span class="nf">parts_info</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Turns a (nested) ``metadata[&#39;parts&#39;]`` dict into a flat dict based on staves.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; d = s.mscx.metadata</span>
<span class="sd">    &gt;&gt;&gt; parts_info(d[&#39;parts&#39;])</span>
<span class="sd">    {&#39;staff_1_instrument&#39;: &#39;Voice&#39;,</span>
<span class="sd">     &#39;staff_1_ambitus&#39;: &#39;66-76 (F#4-E5)&#39;,</span>
<span class="sd">     &#39;staff_2_instrument&#39;: &#39;Voice&#39;,</span>
<span class="sd">     &#39;staff_2_ambitus&#39;: &#39;55-69 (G3-A4)&#39;,</span>
<span class="sd">     &#39;staff_3_instrument&#39;: &#39;Voice&#39;,</span>
<span class="sd">     &#39;staff_3_ambitus&#39;: &#39;48-67 (C3-G4)&#39;,</span>
<span class="sd">     &#39;staff_4_instrument&#39;: &#39;Voice&#39;,</span>
<span class="sd">     &#39;staff_4_ambitus&#39;: &#39;41-60 (F2-C4)&#39;}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">part_dict</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">part_dict</span><span class="p">[</span><span class="s1">&#39;staves&#39;</span><span class="p">]:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;staff_</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_instrument&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">part_dict</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span>
            <span class="n">amb_name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_ambitus&#39;</span>
            <span class="n">res</span><span class="p">[</span><span class="n">amb_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ambitus2oneliner</span><span class="p">(</span><span class="n">part_dict</span><span class="p">[</span><span class="n">amb_name</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="pretty_dict"><a class="viewcode-back" href="../../reference.html#ms3.utils.pretty_dict">[docs]</a><span class="k">def</span> <span class="nf">pretty_dict</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">heading</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turns a dictionary into a string where the keys are printed in a column, separated by &#39;-&gt;&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">heading</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">KEY</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">heading</span><span class="p">),</span> <span class="o">**</span><span class="n">d</span><span class="p">)</span>
    <span class="n">left</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">ks</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="n">vs</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vs</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">vs</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">vs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ks</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="si">:{</span><span class="n">left</span><span class="si">}}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ks</span><span class="si">:{</span><span class="n">left</span><span class="si">}}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">vs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">heading</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">heading</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>



<div class="viewcode-block" id="resolve_dir"><a class="viewcode-back" href="../../reference.html#ms3.utils.resolve_dir">[docs]</a><span class="k">def</span> <span class="nf">resolve_dir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Resolves &#39;~&#39; to HOME directory and turns ``d`` into an absolute path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;~&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></div>


<div class="viewcode-block" id="rgb2format"><a class="viewcode-back" href="../../reference.html#ms3.utils.rgb2format">[docs]</a><span class="k">def</span> <span class="nf">rgb2format</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="n">r_col</span><span class="o">=</span><span class="s1">&#39;color_r&#39;</span><span class="p">,</span> <span class="n">g_col</span><span class="o">=</span><span class="s1">&#39;color_g&#39;</span><span class="p">,</span> <span class="n">b_col</span><span class="o">=</span><span class="s1">&#39;color_b&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts three RGB columns into a color_html or color_name column. &quot;&quot;&quot;</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">r_col</span><span class="p">,</span> <span class="n">g_col</span><span class="p">,</span> <span class="n">b_col</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">rgb_tuple2html</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;color_html&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">rgb_tuple2name</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;color_name&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="rgb_tuple2format"><a class="viewcode-back" href="../../reference.html#ms3.utils.rgb_tuple2format">[docs]</a><span class="k">def</span> <span class="nf">rgb_tuple2format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts a single RGB tuple into &#39;HTML&#39; or &#39;name&#39;.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">t</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">normalize_integer_triplet</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">t</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">rgb_to_hex</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">rgb_to_name</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">MS3_RGB</span><span class="p">[</span><span class="n">norm</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">webcolors</span><span class="o">.</span><span class="n">rgb_to_hex</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span></div>


<div class="viewcode-block" id="rgb_tuple2html"><a class="viewcode-back" href="../../reference.html#ms3.utils.rgb_tuple2html">[docs]</a><span class="k">def</span> <span class="nf">rgb_tuple2html</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts a single RGB tuple into HTML.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">rgb_tuple2format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="rgb_tuple2name"><a class="viewcode-back" href="../../reference.html#ms3.utils.rgb_tuple2name">[docs]</a><span class="k">def</span> <span class="nf">rgb_tuple2name</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Converts a single RGB tuple into its CSS3 name or to HTML if there is none.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">rgb_tuple2format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">rgba2attrs</span><span class="p">(</span><span class="n">named_tuple</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">named_tuple</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="k">def</span> <span class="nf">rgba2params</span><span class="p">(</span><span class="n">named_tuple</span><span class="p">):</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="n">rgba2attrs</span><span class="p">(</span><span class="n">named_tuple</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;color_&#39;</span><span class="o">+</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>


<div class="viewcode-block" id="roman_numeral2fifths"><a class="viewcode-back" href="../../reference.html#ms3.utils.roman_numeral2fifths">[docs]</a><span class="k">def</span> <span class="nf">roman_numeral2fifths</span><span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">global_minor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turn a Roman numeral into a TPC interval (e.g. for transposition purposes).</span>
<span class="sd">        Uses: split_scale_degree()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">rn</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">rn</span>
    <span class="n">rn_tpcs_maj</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
    <span class="n">rn_tpcs_min</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">}</span>
    <span class="n">accidentals</span><span class="p">,</span> <span class="n">rn_step</span> <span class="o">=</span> <span class="n">split_scale_degree</span><span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">accidentals</span><span class="p">,</span> <span class="n">rn_step</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">rn_step</span> <span class="o">=</span> <span class="n">rn_step</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">step_tpc</span> <span class="o">=</span> <span class="n">rn_tpcs_min</span><span class="p">[</span><span class="n">rn_step</span><span class="p">]</span> <span class="k">if</span> <span class="n">global_minor</span> <span class="k">else</span> <span class="n">rn_tpcs_maj</span><span class="p">[</span><span class="n">rn_step</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">step_tpc</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">accidentals</span></div>


<div class="viewcode-block" id="roman_numeral2semitones"><a class="viewcode-back" href="../../reference.html#ms3.utils.roman_numeral2semitones">[docs]</a><span class="k">def</span> <span class="nf">roman_numeral2semitones</span><span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">global_minor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Turn a Roman numeral into a semitone distance from the root (0-11).</span>
<span class="sd">        Uses: split_scale_degree()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">rn</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">rn</span>
    <span class="n">rn_tpcs_maj</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">}</span>
    <span class="n">rn_tpcs_min</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
    <span class="n">accidentals</span><span class="p">,</span> <span class="n">rn_step</span> <span class="o">=</span> <span class="n">split_scale_degree</span><span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">accidentals</span><span class="p">,</span> <span class="n">rn_step</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">rn_step</span> <span class="o">=</span> <span class="n">rn_step</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">step_tpc</span> <span class="o">=</span> <span class="n">rn_tpcs_min</span><span class="p">[</span><span class="n">rn_step</span><span class="p">]</span> <span class="k">if</span> <span class="n">global_minor</span> <span class="k">else</span> <span class="n">rn_tpcs_maj</span><span class="p">[</span><span class="n">rn_step</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">step_tpc</span> <span class="o">+</span> <span class="n">accidentals</span></div>




<div class="viewcode-block" id="scan_directory"><a class="viewcode-back" href="../../reference.html#ms3.utils.scan_directory">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">scan_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">file_re</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;.*&quot;</span><span class="p">,</span> <span class="n">folder_re</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;.*&quot;</span><span class="p">,</span> <span class="n">exclude_re</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;^(\.|_)&quot;</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subdirs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exclude_files_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Generator of file names in ``directory``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dir : :obj:`str`</span>
<span class="sd">        Directory to be scanned for files.</span>
<span class="sd">    file_re, folder_re : :obj:`str` or :obj:`re.Pattern`, optional</span>
<span class="sd">        Regular expressions for filtering certain file names or folder names.</span>
<span class="sd">        The regEx are checked with search(), not match(), allowing for fuzzy search.</span>
<span class="sd">    recursive : :obj:`bool`, optional</span>
<span class="sd">        By default, sub-directories are recursively scanned. Pass False to scan only ``dir``.</span>
<span class="sd">    subdirs : :obj:`bool`, optional</span>
<span class="sd">        By default, full file paths are returned. Pass True to return (path, name) tuples instead.</span>
<span class="sd">    progress : :obj:`bool`, optional</span>
<span class="sd">        By default, the scanning process is shown. Pass False to prevent.</span>
<span class="sd">    exclude_files_only : :obj:`bool`, optional</span>
<span class="sd">        By default, ``exclude_re`` excludes files and folder. Pass True to exclude only files matching the regEx.</span>


<span class="sd">    Yields</span>
<span class="sd">    ------</span>
<span class="sd">    list</span>
<span class="sd">        List of full paths meeting the criteria.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">traverse</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">counter</span>

        <span class="k">def</span> <span class="nf">check_regex</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">excl</span><span class="o">=</span><span class="n">exclude_re</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">excl</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="k">return</span> <span class="n">res</span>

        <span class="k">for</span> <span class="n">dir_entry</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">scandir</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">dir_entry</span><span class="o">.</span><span class="n">name</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dir_entry</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="ow">and</span> <span class="n">recursive</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">exclude_files_only</span> <span class="ow">and</span> <span class="n">check_regex</span><span class="p">(</span><span class="n">folder_re</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">excl</span><span class="o">=</span><span class="s1">&#39;^$&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">exclude_files_only</span> <span class="ow">and</span> <span class="n">check_regex</span><span class="p">(</span><span class="n">folder_re</span><span class="p">,</span> <span class="n">name</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">traverse</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                        <span class="k">yield</span> <span class="n">res</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pbar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">dir_entry</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="n">check_regex</span><span class="p">(</span><span class="n">file_re</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">pbar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">pbar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">({</span><span class="s1">&#39;selected&#39;</span><span class="p">:</span> <span class="n">counter</span><span class="p">})</span>
                    <span class="k">if</span> <span class="n">subdirs</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">path</span>

    <span class="k">if</span> <span class="n">exclude_re</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">exclude_re</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">exclude_re</span> <span class="o">=</span> <span class="s1">&#39;^$&#39;</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">resolve_dir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not an existing directory: &quot;</span> <span class="o">+</span> <span class="n">directory</span><span class="p">)</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Scanning files&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39; files&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">progress</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">traverse</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span></div>


<div class="viewcode-block" id="column_order"><a class="viewcode-back" href="../../reference.html#ms3.utils.column_order">[docs]</a><span class="k">def</span> <span class="nf">column_order</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">first_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sort DataFrame columns so that they start with the order of ``first_cols``, followed by those not included. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">first_cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">first_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="s1">&#39;mc_playthrough&#39;</span><span class="p">,</span> <span class="s1">&#39;mn&#39;</span><span class="p">,</span> <span class="s1">&#39;mn_playthrough&#39;</span><span class="p">,</span> <span class="s1">&#39;quarterbeats&#39;</span><span class="p">,</span> <span class="s1">&#39;mc_onset&#39;</span><span class="p">,</span> <span class="s1">&#39;mn_onset&#39;</span><span class="p">,</span> <span class="s1">&#39;beat&#39;</span><span class="p">,</span> <span class="s1">&#39;event&#39;</span><span class="p">,</span> <span class="s1">&#39;timesig&#39;</span><span class="p">,</span> <span class="s1">&#39;staff&#39;</span><span class="p">,</span> <span class="s1">&#39;voice&#39;</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="s1">&#39;tied&#39;</span><span class="p">,</span>
            <span class="s1">&#39;gracenote&#39;</span><span class="p">,</span> <span class="s1">&#39;nominal_duration&#39;</span><span class="p">,</span> <span class="s1">&#39;scalar&#39;</span><span class="p">,</span> <span class="s1">&#39;tpc&#39;</span><span class="p">,</span> <span class="s1">&#39;midi&#39;</span><span class="p">,</span> <span class="s1">&#39;volta&#39;</span><span class="p">,</span> <span class="s1">&#39;chord_id&#39;</span><span class="p">]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">remaining</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">first_cols</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
        <span class="n">remaining</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span>
    <span class="n">column_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">first_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span> <span class="o">+</span> <span class="n">remaining</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">column_order</span><span class="p">]</span></div>


<div class="viewcode-block" id="sort_note_list"><a class="viewcode-back" href="../../reference.html#ms3.utils.sort_note_list">[docs]</a><span class="k">def</span> <span class="nf">sort_note_list</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">mc_col</span><span class="o">=</span><span class="s1">&#39;mc&#39;</span><span class="p">,</span> <span class="n">mc_onset_col</span><span class="o">=</span><span class="s1">&#39;mc_onset&#39;</span><span class="p">,</span> <span class="n">midi_col</span><span class="o">=</span><span class="s1">&#39;midi&#39;</span><span class="p">,</span> <span class="n">duration_col</span><span class="o">=</span><span class="s1">&#39;duration&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Sort every measure (MC) by [&#39;mc_onset&#39;, &#39;midi&#39;, &#39;duration&#39;] while leaving gracenotes&#39; order (duration=0) intact.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df</span>
<span class="sd">    mc_col</span>
<span class="sd">    mc_onset_col</span>
<span class="sd">    midi_col</span>
<span class="sd">    duration_col</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_grace</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">duration_col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">grace_ix</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="n">is_grace</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">mc_col</span><span class="p">,</span> <span class="n">mc_onset_col</span><span class="p">])</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">has_nan</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">midi_col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">has_nan</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">midi_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">midi_col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">normal_ix</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">is_grace</span><span class="p">,</span> <span class="p">[</span><span class="n">mc_col</span><span class="p">,</span> <span class="n">mc_onset_col</span><span class="p">,</span> <span class="n">midi_col</span><span class="p">,</span> <span class="n">duration_col</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">mc_col</span><span class="p">,</span> <span class="n">mc_onset_col</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">gr</span><span class="p">:</span> <span class="n">gr</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">((</span><span class="n">gr</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">gr</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]))]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
    <span class="n">sorted_ixs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">grace_ix</span><span class="p">[</span><span class="n">onset</span><span class="p">],</span> <span class="n">ix</span><span class="p">))</span> <span class="k">if</span> <span class="n">onset</span> <span class="ow">in</span> <span class="n">grace_ix</span> <span class="k">else</span> <span class="n">ix</span> <span class="k">for</span> <span class="n">onset</span><span class="p">,</span> <span class="n">ix</span> <span class="ow">in</span>
                  <span class="n">normal_ix</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sorted_ixs</span><span class="p">))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">has_nan</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">midi_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">midi_col</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="mi">1000</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">})</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;Int64&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="sort_tpcs"><a class="viewcode-back" href="../../reference.html#ms3.utils.sort_tpcs">[docs]</a><span class="k">def</span> <span class="nf">sort_tpcs</span><span class="p">(</span><span class="n">tpcs</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Sort tonal pitch classes by order on the piano.</span>
<span class="sd">        Uses: fifths2pc()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tpcs : collection of :obj:`int`</span>
<span class="sd">        Tonal pitch classes to sort.</span>
<span class="sd">    ascending : :obj:`bool`, optional</span>
<span class="sd">        Pass False to sort by descending order.</span>
<span class="sd">    start : :obj:`int`, optional</span>
<span class="sd">        Start on or above this TPC.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tpcs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">fifths2pc</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="o">-</span><span class="n">x</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">fifths2pc</span><span class="p">(</span><span class="n">tpc</span><span class="p">)</span> <span class="k">for</span> <span class="n">tpc</span> <span class="ow">in</span> <span class="n">res</span><span class="p">]</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">fifths2pc</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pcs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">pcs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span> <span class="o">+</span> <span class="n">res</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">res</span> <span class="k">if</span> <span class="n">ascending</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">res</span><span class="p">))</span></div>


<div class="viewcode-block" id="split_alternatives"><a class="viewcode-back" href="../../reference.html#ms3.utils.split_alternatives">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">split_alternatives</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;-(?!(\d|b+\d|\#+\d))&quot;</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alternatives_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Splits labels that come with an alternative separated by &#39;-&#39; and adds</span>
<span class="sd">    a new column. Only one alternative is taken into account. `df` is</span>
<span class="sd">    mutated inplace.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        Dataframe where one column contains DCML chord labels.</span>
<span class="sd">    column : :obj:`str`, optional</span>
<span class="sd">        Name of the column that holds the harmony labels.</span>
<span class="sd">    regex : :obj:`str`, optional</span>
<span class="sd">        The regular expression (or simple string) that detects the character combination used to separate alternative annotations.</span>
<span class="sd">        By default, alternatives are separated by a &#39;-&#39; that does not precede a scale degree such as &#39;b6&#39; or &#39;3&#39;.</span>
<span class="sd">    max : :obj:`int`, optional</span>
<span class="sd">        Maximum number of admitted alternatives, defaults to 2.</span>
<span class="sd">    inplace : :obj:`bool`, optional</span>
<span class="sd">        Pass True if you want to mutate ``df``.</span>
<span class="sd">    alternatives_only : :obj:`bool`, optional</span>
<span class="sd">        By default the alternatives are added to the original DataFrame (``inplace`` or not).</span>
<span class="sd">        Pass True if you just need the split alternatives.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; import pandas as pd</span>
<span class="sd">    &gt;&gt;&gt; labels = pd.read_csv(&#39;labels.csv&#39;)</span>
<span class="sd">    &gt;&gt;&gt; split_alternatives(labels, inplace=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">alternatives</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">alternatives</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">alternatives</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">alternatives</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">alternatives_only</span><span class="p">:</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;alt_</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;alt</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">alternatives</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
        <span class="n">alternatives</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span>
        <span class="k">return</span> <span class="n">alternatives</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="nb">max</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternatives</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Labels split into alternatives.&quot;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">alternatives</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">column</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">alternatives</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">max</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">alt_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;alt_</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;alt</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">alt_name</span><span class="p">,</span> <span class="n">alternatives</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">))</span>  <span class="c1"># replace None by NaN</span>
            <span class="n">position</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alternatives</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;More than </span><span class="si">{</span><span class="nb">max</span><span class="si">}</span><span class="s2"> alternatives are not taken into account:</span><span class="se">\n</span><span class="si">{</span><span class="n">alternatives</span><span class="p">[</span><span class="n">alternatives</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Contains no alternative labels.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="split_note_name"><a class="viewcode-back" href="../../reference.html#ms3.utils.split_note_name">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">split_note_name</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Splits a note name such as &#39;Ab&#39; into accidentals and name.</span>

<span class="sd">    nn : :obj:`str`</span>
<span class="sd">        Note name.</span>
<span class="sd">    count : :obj:`bool`, optional</span>
<span class="sd">        Pass True to get the accidentals as integer rather than as string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^([A-G]|[a-g])(#*|b*)$&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nn</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">nn</span> <span class="o">+</span> <span class="s2">&quot; is not a valid scale degree.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">note_name</span><span class="p">,</span> <span class="n">accidentals</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
        <span class="n">accidentals</span> <span class="o">=</span> <span class="n">accidentals</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">accidentals</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">accidentals</span><span class="p">,</span> <span class="n">note_name</span></div>


<div class="viewcode-block" id="split_scale_degree"><a class="viewcode-back" href="../../reference.html#ms3.utils.split_scale_degree">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">split_scale_degree</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Splits a scale degree such as &#39;bbVI&#39; or &#39;b6&#39; into accidentals and numeral.</span>

<span class="sd">    sd : :obj:`str`</span>
<span class="sd">        Scale degree.</span>
<span class="sd">    count : :obj:`bool`, optional</span>
<span class="sd">        Pass True to get the accidentals as integer rather than as string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^(#*|b*)(VII|VI|V|IV|III|II|I|vii|vi|v|iv|iii|ii|i|\d)$&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sd</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sd</span><span class="si">}</span><span class="s2"> is not a valid scale degree.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">acc</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
        <span class="n">acc</span> <span class="o">=</span> <span class="n">acc</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">acc</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">acc</span><span class="p">,</span> <span class="n">num</span></div>


<div class="viewcode-block" id="chunkstring"><a class="viewcode-back" href="../../reference.html#ms3.utils.chunkstring">[docs]</a><span class="k">def</span> <span class="nf">chunkstring</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">80</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Generate chunks of a given length &quot;&quot;&quot;</span>
    <span class="n">string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="mi">0</span> <span class="o">+</span> <span class="n">i</span><span class="p">:</span><span class="n">length</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">),</span> <span class="n">length</span><span class="p">))</span></div>


<div class="viewcode-block" id="string2lines"><a class="viewcode-back" href="../../reference.html#ms3.utils.string2lines">[docs]</a><span class="k">def</span> <span class="nf">string2lines</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">80</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Use chunkstring() and make chunks into lines. &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chunkstring</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span></div>


<span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">test_binary</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">command</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">command</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found MuseScore binary: </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span>
    <span class="k">if</span> <span class="n">which</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MuseScore binary not found and not an installed command: </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found MuseScore command: </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">command</span>


<div class="viewcode-block" id="transform"><a class="viewcode-back" href="../../reference.html#ms3.utils.transform">[docs]</a><span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">param2col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">column_wise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Compute a function for every row of a DataFrame, using several cols as arguments.</span>
<span class="sd">        The result is the same as using df.apply(lambda r: func(param1=r.col1, param2=r.col2...), axis=1)</span>
<span class="sd">        but it optimizes the procedure by precomputing `func` for all occurrent parameter combinations.</span>
<span class="sd">        Uses: inspect.getfullargspec()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame` or :obj:`pandas.Series`</span>
<span class="sd">        Dataframe containing function parameters.</span>
<span class="sd">    func : :obj:`callable`</span>
<span class="sd">        The result of this function for every row will be returned.</span>
<span class="sd">    param2col : :obj:`dict` or :obj:`list`, optional</span>
<span class="sd">        Mapping from parameter names of `func` to column names.</span>
<span class="sd">        If you pass a list of column names, the columns&#39; values are passed as positional arguments.</span>
<span class="sd">        Pass None if you want to use all columns as positional arguments.</span>
<span class="sd">    column_wise : :obj:`bool`, optional</span>
<span class="sd">        Pass True if you want to map ``func`` to the elements of every column separately.</span>
<span class="sd">        This is simply an optimized version of df.apply(func) but allows for naming</span>
<span class="sd">        columns to use as function arguments. If param2col is None, ``func`` is mapped</span>
<span class="sd">        to the elements of all columns, otherwise to all columns that are not named</span>
<span class="sd">        as parameters in ``param2col``.</span>
<span class="sd">        In the case where ``func`` does not require a positional first element and</span>
<span class="sd">        you want to pass the elements of the various columns as keyword argument,</span>
<span class="sd">        give it as param2col={&#39;function_argument&#39;: None}</span>
<span class="sd">    inplace : :obj:`bool`, optional</span>
<span class="sd">        Pass True if you want to mutate ``df`` rather than getting an altered copy.</span>
<span class="sd">    **kwargs : Other parameters passed to ``func``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">column_wise</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param2col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">func</span><span class="p">,),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">param2col</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="n">var_arg</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">param2col</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
                <span class="n">apply_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">param2col</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="n">var_arg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Name only one variable keyword argument as which </span><span class="si">{</span><span class="n">apply_cols</span><span class="si">}</span><span class="s2"> are used </span><span class="si">{</span><span class="s1">&#39;argument&#39;</span><span class="si">:</span><span class="s2"> None</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="n">var_arg</span> <span class="o">=</span> <span class="n">var_arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_arg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">getfullargspec</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">param2col</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">param2col</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
                <span class="n">result_cols</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="p">{</span><span class="o">**</span><span class="p">{</span><span class="n">var_arg</span><span class="p">:</span> <span class="n">col</span><span class="p">},</span> <span class="o">**</span><span class="n">param2col</span><span class="p">},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span>
                               <span class="n">apply_cols</span><span class="p">}</span>
                <span class="n">param2col</span> <span class="o">=</span> <span class="n">param2col</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">apply_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">param2col</span><span class="p">]</span>
                <span class="n">result_cols</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">+</span> <span class="n">param2col</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">apply_cols</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result_cols</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">param2col</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">param_tuples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">param2col</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
        <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">param2col</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">t</span><span class="p">)},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">param_tuples</span><span class="p">)}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param2col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;When &#39;df&#39; is a Series, the parameter &#39;param2col&#39; has no use.&quot;</span><span class="p">)</span>
            <span class="n">param_tuples</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span>
            <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">param_tuples</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param2col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">param_tuples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">param_tuples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">param2col</span><span class="p">)]</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
            <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">param_tuples</span><span class="p">)}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">result_dict</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">param_tuples</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="unfold_repeats"><a class="viewcode-back" href="../../reference.html#ms3.utils.unfold_repeats">[docs]</a><span class="k">def</span> <span class="nf">unfold_repeats</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">mc_sequence</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Use a succesion of MCs to bring a DataFrame in this succession. MCs may repeat.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        DataFrame needs to have the columns &#39;mc&#39; and &#39;mn&#39;.</span>
<span class="sd">    mc_sequence : :obj:`pandas.Series`</span>
<span class="sd">        A Series of the format ``{mc_playthrough: mc}`` where ``mc_playthrough`` corresponds</span>
<span class="sd">        to continuous MC</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">############## &lt; v0.5: playthrough &lt;=&gt; mn; &gt;= v0.5: playthrough &lt;=&gt; mc</span>
    <span class="n">vc</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;mc&#39;</span><span class="p">)</span>
    <span class="n">seq</span> <span class="o">=</span> <span class="n">mc_sequence</span><span class="p">[</span><span class="n">mc_sequence</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
    <span class="n">playthrough_col</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([[</span><span class="n">playthrough</span><span class="p">]</span> <span class="o">*</span> <span class="n">vc</span><span class="p">[</span><span class="n">mc</span><span class="p">]</span> <span class="k">for</span> <span class="n">playthrough</span><span class="p">,</span> <span class="n">mc</span> <span class="ow">in</span> <span class="n">seq</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span> <span class="p">[])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">seq</span><span class="o">.</span><span class="n">values</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">res</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;mc&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;mc_playthrough&#39;</span><span class="p">,</span> <span class="n">playthrough_col</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span></div>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">unpack_mscz</span><span class="p">(</span><span class="n">mscz</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">tmp_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">mscz</span><span class="p">)</span>
    <span class="n">tmp_file</span> <span class="o">=</span> <span class="n">Temp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.mscx&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">Zip</span><span class="p">(</span><span class="n">mscz</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_file</span><span class="p">:</span>
        <span class="n">mscx_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">zip_file</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.mscx&#39;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mscx_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mscz</span><span class="si">}</span><span class="s2"> contains several MSCX files. Picking the first one&quot;</span><span class="p">)</span>
        <span class="n">mscx</span> <span class="o">=</span> <span class="n">mscx_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">zip_file</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mscx</span><span class="p">)</span> <span class="k">as</span> <span class="n">mscx_file</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">tmp_file</span> <span class="k">as</span> <span class="n">tmp</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">mscx_file</span><span class="p">:</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">tmp_file</span><span class="o">.</span><span class="n">name</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while dealing with the temporarily unpacked </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">mscz</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmp_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>


<span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">update_labels_cfg</span><span class="p">(</span><span class="n">labels_cfg</span><span class="p">):</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;staff&#39;</span><span class="p">,</span> <span class="s1">&#39;voice&#39;</span><span class="p">,</span> <span class="s1">&#39;label_type&#39;</span><span class="p">,</span> <span class="s1">&#39;positioning&#39;</span><span class="p">,</span> <span class="s1">&#39;decode&#39;</span><span class="p">,</span> <span class="s1">&#39;column_name&#39;</span><span class="p">,</span> <span class="s1">&#39;color_format&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;logger&#39;</span> <span class="ow">in</span> <span class="n">labels_cfg</span><span class="p">:</span>
        <span class="k">del</span><span class="p">(</span><span class="n">labels_cfg</span><span class="p">[</span><span class="s1">&#39;logger&#39;</span><span class="p">])</span>
    <span class="n">updated</span> <span class="o">=</span> <span class="n">update_cfg</span><span class="p">(</span><span class="n">cfg_dict</span><span class="o">=</span><span class="n">labels_cfg</span><span class="p">,</span> <span class="n">admitted_keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;logger&#39;</span> <span class="ow">in</span> <span class="n">updated</span><span class="p">:</span>
        <span class="k">del</span><span class="p">(</span><span class="n">updated</span><span class="p">[</span><span class="s1">&#39;logger&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">updated</span>


<span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">write_metadata</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">markdown</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;metadata.tsv&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">write_this</span> <span class="o">=</span> <span class="n">df</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Created&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Trying to load an existing &#39;metadata.tsv&#39; file to update overlapping indices, assuming two index levels</span>
            <span class="n">previous</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">ix_union</span> <span class="o">=</span> <span class="n">previous</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">col_union</span> <span class="o">=</span> <span class="n">previous</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">previous</span> <span class="o">=</span> <span class="n">previous</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">ix_union</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">col_union</span><span class="p">)</span>
            <span class="n">previous</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
            <span class="n">write_this</span> <span class="o">=</span> <span class="n">previous</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Updated&#39;</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">write_this</span> <span class="o">=</span> <span class="n">df</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Replaced &#39;</span>
    <span class="n">first_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;last_mc&#39;</span><span class="p">,</span> <span class="s1">&#39;last_mn&#39;</span><span class="p">,</span> <span class="s1">&#39;KeySig&#39;</span><span class="p">,</span> <span class="s1">&#39;TimeSig&#39;</span><span class="p">,</span> <span class="s1">&#39;label_count&#39;</span><span class="p">,</span> <span class="s1">&#39;harmony_version&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;annotated_key&#39;</span><span class="p">,</span> <span class="s1">&#39;annotators&#39;</span><span class="p">,</span> <span class="s1">&#39;reviewers&#39;</span><span class="p">,</span> <span class="s1">&#39;composer&#39;</span><span class="p">,</span> <span class="s1">&#39;workTitle&#39;</span><span class="p">,</span> <span class="s1">&#39;movementNumber&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;movementTitle&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;workNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;poet&#39;</span><span class="p">,</span> <span class="s1">&#39;lyricist&#39;</span><span class="p">,</span> <span class="s1">&#39;arranger&#39;</span><span class="p">,</span> <span class="s1">&#39;copyright&#39;</span><span class="p">,</span> <span class="s1">&#39;creationDate&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;mscVersion&#39;</span><span class="p">,</span> <span class="s1">&#39;platform&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;translator&#39;</span><span class="p">,</span> <span class="s1">&#39;musescore&#39;</span><span class="p">,</span> <span class="s1">&#39;ambitus&#39;</span><span class="p">]</span>
    <span class="n">write_this</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">column_order</span><span class="p">(</span><span class="n">write_this</span><span class="p">,</span> <span class="n">first_cols</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">markdown</span><span class="p">:</span>
        <span class="n">rename4markdown</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;fnames&#39;</span><span class="p">:</span> <span class="s1">&#39;file_name&#39;</span><span class="p">,</span>
            <span class="s1">&#39;last_mn&#39;</span><span class="p">:</span> <span class="s1">&#39;measures&#39;</span><span class="p">,</span>
            <span class="s1">&#39;label_count&#39;</span><span class="p">:</span> <span class="s1">&#39;labels&#39;</span><span class="p">,</span>
            <span class="s1">&#39;harmony_version&#39;</span><span class="p">:</span> <span class="s1">&#39;standard&#39;</span><span class="p">,</span>
            <span class="s1">&#39;annotators&#39;</span><span class="p">:</span> <span class="s1">&#39;annotators&#39;</span><span class="p">,</span>
            <span class="s1">&#39;reviewers&#39;</span><span class="p">:</span> <span class="s1">&#39;reviewers&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">drop_index</span> <span class="o">=</span> <span class="s1">&#39;fnames&#39;</span> <span class="ow">in</span> <span class="n">write_this</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">write_this</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="n">drop_index</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">rename4markdown</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">md</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">md</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">rename4markdown</span><span class="p">)[</span><span class="nb">list</span><span class="p">(</span><span class="n">rename4markdown</span><span class="o">.</span><span class="n">values</span><span class="p">())]</span>
        <span class="n">md_table</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">df2md</span><span class="p">(</span><span class="n">md</span><span class="p">))</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">readme</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;README.md&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">readme</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Updated&#39;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">readme</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Created&#39;</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># in case the README exists, everything from the line including &#39;# Overview&#39; (or last line otherwise) is overwritten</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">readme</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;# Overview&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">md_table</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">readme</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="abs2rel_key"><a class="viewcode-back" href="../../reference.html#ms3.utils.abs2rel_key">[docs]</a><span class="k">def</span> <span class="nf">abs2rel_key</span><span class="p">(</span><span class="n">absolute</span><span class="p">,</span> <span class="n">localkey</span><span class="p">,</span> <span class="n">global_minor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Expresses a Roman numeral as scale degree relative to a given localkey.</span>
<span class="sd">    The result changes depending on whether Roman numeral and localkey are</span>
<span class="sd">    interpreted within a global major or minor key.</span>

<span class="sd">    Uses: :py:func:`split_scale_degree`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    absolute : :obj:`str`</span>
<span class="sd">        Relative key expressed as Roman scale degree of the local key.</span>
<span class="sd">    localkey : :obj:`str`</span>
<span class="sd">        The local key in terms of which `absolute` will be expressed.</span>
<span class="sd">    global_minor : bool, optional</span>
<span class="sd">        Has to be set to True if `absolute` and `localkey` are scale degrees of a global minor key.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    In a minor context, the key of II would appear within the key of vii as #III.</span>

<span class="sd">        &gt;&gt;&gt; abs2rel_key(&#39;iv&#39;, &#39;VI&#39;, global_minor=False)</span>
<span class="sd">        &#39;bvi&#39;       # F minor expressed with respect to A major</span>
<span class="sd">        &gt;&gt;&gt; abs2rel_key(&#39;iv&#39;, &#39;vi&#39;, global_minor=False)</span>
<span class="sd">        &#39;vi&#39;        # F minor expressed with respect to A minor</span>
<span class="sd">        &gt;&gt;&gt; abs2rel_key(&#39;iv&#39;, &#39;VI&#39;, global_minor=True)</span>
<span class="sd">        &#39;vi&#39;        # F minor expressed with respect to Ab major</span>
<span class="sd">        &gt;&gt;&gt; abs2rel_key(&#39;iv&#39;, &#39;vi&#39;, global_minor=True)</span>
<span class="sd">        &#39;#vi&#39;       # F minor expressed with respect to Ab minor</span>

<span class="sd">        &gt;&gt;&gt; abs2rel_key(&#39;VI&#39;, &#39;IV&#39;, global_minor=False)</span>
<span class="sd">        &#39;III&#39;       # A major expressed with respect to F major</span>
<span class="sd">        &gt;&gt;&gt; abs2rel_key(&#39;VI&#39;, &#39;iv&#39;, global_minor=False)</span>
<span class="sd">        &#39;#III&#39;       # A major expressed with respect to F minor</span>
<span class="sd">        &gt;&gt;&gt; abs2rel_key(&#39;VI&#39;, &#39;IV&#39;, global_minor=True)</span>
<span class="sd">        &#39;bIII&#39;       # Ab major expressed with respect to F major</span>
<span class="sd">        &gt;&gt;&gt; abs2rel_key(&#39;VI&#39;, &#39;iv&#39;, global_minor=False)</span>
<span class="sd">        &#39;III&#39;       # Ab major expressed with respect to F minor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">absolute</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">maj_rn</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">]</span>
    <span class="n">min_rn</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;ii&#39;</span><span class="p">,</span> <span class="s1">&#39;iii&#39;</span><span class="p">,</span> <span class="s1">&#39;iv&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;vi&#39;</span><span class="p">,</span> <span class="s1">&#39;vii&#39;</span><span class="p">]</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
    <span class="n">abs_acc</span><span class="p">,</span> <span class="n">absolute</span> <span class="o">=</span> <span class="n">split_scale_degree</span><span class="p">(</span><span class="n">absolute</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">localkey_acc</span><span class="p">,</span> <span class="n">localkey</span> <span class="o">=</span> <span class="n">split_scale_degree</span><span class="p">(</span><span class="n">localkey</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="n">abs_acc</span> <span class="o">-</span> <span class="n">localkey_acc</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="n">maj_rn</span> <span class="k">if</span> <span class="n">absolute</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="k">else</span> <span class="n">min_rn</span>
    <span class="n">key_num</span> <span class="o">=</span> <span class="n">maj_rn</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">localkey</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="n">abs_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">steps</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">absolute</span><span class="p">)</span> <span class="o">-</span> <span class="n">key_num</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">steps</span><span class="p">[</span><span class="n">abs_num</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">localkey</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span> <span class="ow">and</span> <span class="n">abs_num</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]:</span>
        <span class="n">shift</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">global_minor</span><span class="p">:</span>
        <span class="n">key_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">key_num</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span>
    <span class="n">shift</span> <span class="o">-=</span> <span class="n">shifts</span><span class="p">[</span><span class="n">key_num</span><span class="p">][</span><span class="n">abs_num</span><span class="p">]</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">*</span> <span class="s1">&#39;#&#39;</span> <span class="k">if</span> <span class="n">shift</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="n">shift</span> <span class="o">*</span> <span class="s1">&#39;b&#39;</span>
    <span class="k">return</span> <span class="n">acc</span> <span class="o">+</span> <span class="n">step</span></div>


<div class="viewcode-block" id="rel2abs_key"><a class="viewcode-back" href="../../reference.html#ms3.utils.rel2abs_key">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">rel2abs_key</span><span class="p">(</span><span class="n">rel</span><span class="p">,</span> <span class="n">localkey</span><span class="p">,</span> <span class="n">global_minor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Expresses a Roman numeral that is expressed relative to a localkey</span>
<span class="sd">    as scale degree of the global key. For local keys {III, iii, VI, vi, VII, vii}</span>
<span class="sd">    the result changes depending on whether the global key is major or minor.</span>

<span class="sd">    Uses: :py:func:`split_scale_degree`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rel : :obj:`str`</span>
<span class="sd">        Relative key or chord expressed as Roman scale degree of the local key.</span>
<span class="sd">    localkey : :obj:`str`</span>
<span class="sd">        The local key to which `rel` is relative.</span>
<span class="sd">    global_minor : bool, optional</span>
<span class="sd">        Has to be set to True if `localkey` is a scale degree of a global minor key.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    If the label viio6/VI appears in the context of the local key VI or vi,</span>
<span class="sd">    viio6 the absolute key to which viio6 applies depends on the global key.</span>
<span class="sd">    The comments express the examples in relation to global C major or C minor.</span>

<span class="sd">        &gt;&gt;&gt; rel2abs_key(&#39;vi&#39;, &#39;VI&#39;, global_minor=False)</span>
<span class="sd">        &#39;#iv&#39;       # vi of A major = F# minor</span>
<span class="sd">        &gt;&gt;&gt; rel2abs_key(&#39;vi&#39;, &#39;vi&#39;, global_minor=False)</span>
<span class="sd">        &#39;iv&#39;        # vi of A minor = F minor</span>
<span class="sd">        &gt;&gt;&gt; rel2abs_key(&#39;vi&#39;, &#39;VI&#39;, global_minor=True)</span>
<span class="sd">        &#39;iv&#39;        # vi of Ab major = F minor</span>
<span class="sd">        &gt;&gt;&gt; rel2abs_key(&#39;vi&#39;, &#39;vi&#39;, global_minor=True)</span>
<span class="sd">        &#39;biv&#39;       # vi of Ab minor = Fb minor</span>

<span class="sd">    The same examples hold if you&#39;re expressing in terms of the global key</span>
<span class="sd">    the root of a VI-chord within the local keys VI or vi.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">rel</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">maj_rn</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="s1">&#39;III&#39;</span><span class="p">,</span> <span class="s1">&#39;IV&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;VI&#39;</span><span class="p">,</span> <span class="s1">&#39;VII&#39;</span><span class="p">]</span>
    <span class="n">min_rn</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;ii&#39;</span><span class="p">,</span> <span class="s1">&#39;iii&#39;</span><span class="p">,</span> <span class="s1">&#39;iv&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;vi&#39;</span><span class="p">,</span> <span class="s1">&#39;vii&#39;</span><span class="p">]</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                       <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
    <span class="n">rel_acc</span><span class="p">,</span> <span class="n">rel</span> <span class="o">=</span> <span class="n">split_scale_degree</span><span class="p">(</span><span class="n">rel</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">localkey_acc</span><span class="p">,</span> <span class="n">localkey</span> <span class="o">=</span> <span class="n">split_scale_degree</span><span class="p">(</span><span class="n">localkey</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="n">rel_acc</span> <span class="o">+</span> <span class="n">localkey_acc</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="n">maj_rn</span> <span class="k">if</span> <span class="n">rel</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="k">else</span> <span class="n">min_rn</span>
    <span class="n">rel_num</span> <span class="o">=</span> <span class="n">steps</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">rel</span><span class="p">)</span>
    <span class="n">key_num</span> <span class="o">=</span> <span class="n">maj_rn</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">localkey</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">steps</span><span class="p">[(</span><span class="n">rel_num</span> <span class="o">+</span> <span class="n">key_num</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">localkey</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span> <span class="ow">and</span> <span class="n">rel_num</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]:</span>
        <span class="n">shift</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">global_minor</span><span class="p">:</span>
        <span class="n">key_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">key_num</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span>
    <span class="n">shift</span> <span class="o">+=</span> <span class="n">shifts</span><span class="p">[</span><span class="n">rel_num</span><span class="p">][</span><span class="n">key_num</span><span class="p">]</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">*</span> <span class="s1">&#39;#&#39;</span> <span class="k">if</span> <span class="n">shift</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="n">shift</span> <span class="o">*</span> <span class="s1">&#39;b&#39;</span>
    <span class="k">return</span> <span class="n">acc</span> <span class="o">+</span> <span class="n">step</span></div>


<div class="viewcode-block" id="labels2global_tonic"><a class="viewcode-back" href="../../reference.html#ms3.utils.labels2global_tonic">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">labels2global_tonic</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="p">{},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transposes all numerals to their position in the global major or minor scale.</span>
<span class="sd">    This eliminates localkeys and relativeroots. The resulting chords are defined</span>
<span class="sd">    by [`numeral`, `figbass`, `changes`, `globalkey_is_minor`] (and `pedal`).</span>

<span class="sd">    Uses: :py:func:`transform`, :py:func:`rel2abs_key^, :py:func:`resolve_relative_keys` -&gt; :py:func:`str_is_minor()`</span>
<span class="sd">    :py:func:`transpose_changes`, :py:func:`series_is_minor`,</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : :obj:`pandas.DataFrame`</span>
<span class="sd">        Dataframe containing DCML chord labels that have been split by split_labels()</span>
<span class="sd">        and where the keys have been propagated using propagate_keys(add_bool=True).</span>
<span class="sd">    cols : :obj:`dict`, optional</span>
<span class="sd">        In case the column names for ``[&#39;numeral&#39;, &#39;form&#39;, &#39;figbass&#39;, &#39;changes&#39;, &#39;relativeroot&#39;, &#39;localkey&#39;, &#39;globalkey&#39;]`` deviate, pass a dict, such as</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            {&#39;chord&#39;:           &#39;chord_col_name&#39;</span>
<span class="sd">             &#39;pedal&#39;:           &#39;pedal_col_name&#39;,</span>
<span class="sd">             &#39;numeral&#39;:         &#39;numeral_col_name&#39;,</span>
<span class="sd">             &#39;form&#39;:            &#39;form_col_name&#39;,</span>
<span class="sd">             &#39;figbass&#39;:         &#39;figbass_col_name&#39;,</span>
<span class="sd">             &#39;changes&#39;:         &#39;changes_col_name&#39;,</span>
<span class="sd">             &#39;relativeroot&#39;:    &#39;relativeroot_col_name&#39;,</span>
<span class="sd">             &#39;localkey&#39;:        &#39;localkey_col_name&#39;,</span>
<span class="sd">             &#39;globalkey&#39;:       &#39;globalkey_col_name&#39;}}</span>

<span class="sd">    inplace : :obj:`bool`, optional</span>
<span class="sd">        Pass True if you want to mutate the input.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`pandas.DataFrame`</span>
<span class="sd">        If `inplace=False`, the relevant features of the transposed chords are returned.</span>
<span class="sd">        Otherwise, the original DataFrame is mutated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1">### If the index is not unique, it has to be temporarily replaced</span>
    <span class="n">tmp_index</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_unique</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">interval</span><span class="o">.</span><span class="n">IntervalIndex</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tmp_index</span><span class="p">:</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
        <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chord&#39;</span><span class="p">,</span> <span class="s1">&#39;pedal&#39;</span><span class="p">,</span> <span class="s1">&#39;numeral&#39;</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="s1">&#39;figbass&#39;</span><span class="p">,</span> <span class="s1">&#39;changes&#39;</span><span class="p">,</span> <span class="s1">&#39;relativeroot&#39;</span><span class="p">,</span> <span class="s1">&#39;localkey&#39;</span><span class="p">,</span> <span class="s1">&#39;globalkey&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span>
    <span class="n">local_minor</span><span class="p">,</span> <span class="n">global_minor</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;localkey&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_is_minor&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;globalkey&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_is_minor&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">local_minor</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">local_minor</span><span class="p">]</span> <span class="o">=</span> <span class="n">series_is_minor</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;localkey&#39;</span><span class="p">]],</span> <span class="n">is_name</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Boolean column &#39;</span><span class="si">{</span><span class="n">local_minor</span><span class="si">}</span><span class="s2"> created.&#39;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">global_minor</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">global_minor</span><span class="p">]</span> <span class="o">=</span> <span class="n">series_is_minor</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;globalkey&#39;</span><span class="p">]],</span> <span class="n">is_name</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Boolean column &#39;</span><span class="si">{</span><span class="n">global_minor</span><span class="si">}</span><span class="s2"> created.&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># Express pedals in relation to the global tonic</span>
    <span class="n">param_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pedal&#39;</span><span class="p">,</span> <span class="s1">&#39;localkey&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">global_minor</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;pedal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">rel2abs_key</span><span class="p">,</span> <span class="n">param_cols</span><span class="p">)</span>

    <span class="c1"># Make relativeroots to local keys</span>
    <span class="n">param_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;relativeroot&#39;</span><span class="p">,</span> <span class="s1">&#39;localkey&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">local_minor</span><span class="p">,</span> <span class="n">global_minor</span><span class="p">]</span>
    <span class="n">relativeroots</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;relativeroot&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">notna</span><span class="p">(),</span> <span class="n">param_cols</span><span class="p">]</span>
    <span class="n">rr_tuples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">relativeroots</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
    <span class="n">transposed_rr</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">localkey</span><span class="p">,</span> <span class="n">local_minor</span><span class="p">,</span> <span class="n">global_minor</span><span class="p">):</span> <span class="n">rel2abs_key</span><span class="p">(</span><span class="n">resolve_relative_keys</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">local_minor</span><span class="p">),</span> <span class="n">localkey</span><span class="p">,</span>
                                                               <span class="n">global_minor</span><span class="p">)</span> <span class="k">for</span>
        <span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">localkey</span><span class="p">,</span> <span class="n">local_minor</span><span class="p">,</span> <span class="n">global_minor</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">rr_tuples</span><span class="p">)}</span>
    <span class="n">transposed_rr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">((</span><span class="n">transposed_rr</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">rr_tuples</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">relativeroots</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">relativeroots</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cols</span><span class="p">[</span><span class="s1">&#39;localkey&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">transposed_rr</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">relativeroots</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">local_minor</span><span class="p">]</span> <span class="o">=</span> <span class="n">series_is_minor</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">relativeroots</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">cols</span><span class="p">[</span><span class="s1">&#39;localkey&#39;</span><span class="p">]])</span>

    <span class="c1"># Express numerals in relation to the global tonic</span>
    <span class="n">param_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;numeral&#39;</span><span class="p">,</span> <span class="s1">&#39;localkey&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">global_minor</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;abs_numeral&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">rel2abs_key</span><span class="p">,</span> <span class="n">param_cols</span><span class="p">)</span>

    <span class="c1"># Transpose changes to be valid with the new numeral</span>
    <span class="n">param_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;changes&#39;</span><span class="p">,</span> <span class="s1">&#39;numeral&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;abs_numeral&#39;</span><span class="p">,</span> <span class="n">local_minor</span><span class="p">,</span> <span class="n">global_minor</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;changes&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">transpose_changes</span><span class="p">,</span> <span class="n">param_cols</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>

    <span class="c1"># Combine the new chord features</span>
    <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;chord&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">abs_numeral</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">figbass</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="n">changes</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
        <span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1"># + (&#39;/&#39; + df.relativeroot).fillna(&#39;&#39;)</span>

    <span class="k">if</span> <span class="n">tmp_index</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ix</span>

    <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;numeral&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">abs_numeral</span>
        <span class="n">drop_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;localkey&#39;</span><span class="p">,</span> <span class="s1">&#39;relativeroot&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;abs_numeral&#39;</span><span class="p">,</span> <span class="n">local_minor</span><span class="p">]</span>
        <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">drop_cols</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;abs_numeral&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="s1">&#39;figbass&#39;</span><span class="p">,</span> <span class="s1">&#39;changes&#39;</span><span class="p">,</span> <span class="s1">&#39;globalkey&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">global_minor</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">res_cols</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;abs_numeral&#39;</span><span class="p">:</span> <span class="n">cols</span><span class="p">[</span><span class="s1">&#39;numeral&#39;</span><span class="p">]})</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="series_is_minor"><a class="viewcode-back" href="../../reference.html#ms3.utils.series_is_minor">[docs]</a><span class="k">def</span> <span class="nf">series_is_minor</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="n">is_name</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns boolean Series where every value in ``S`` representing a minor key/chord is True.&quot;&quot;&quot;</span>
    <span class="c1"># regex = r&#39;([A-Ga-g])[#|b]*&#39; if is_name else &#39;[#|b]*(\w+)&#39;</span>
    <span class="c1"># return S.str.replace(regex, lambda m: m.group(1)).str.islower()</span>
    <span class="k">return</span> <span class="n">S</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span> <span class="c1"># as soon as one character is not lowercase, it should be major</span></div>


<div class="viewcode-block" id="resolve_relative_keys"><a class="viewcode-back" href="../../reference.html#ms3.utils.resolve_relative_keys">[docs]</a><span class="k">def</span> <span class="nf">resolve_relative_keys</span><span class="p">(</span><span class="n">relativeroot</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Resolve nested relative keys, e.g. &#39;V/V/V&#39; =&gt; &#39;VI&#39;.</span>

<span class="sd">    Uses: :py:func:`rel2abs_key`, :py:func:`str_is_minor`</span>

<span class="sd">    relativeroot : :obj:`str`</span>
<span class="sd">        One or several relative keys, e.g. iv/v/VI (fourth scale degree of the fifth scale degree of the sixth scale degree)</span>
<span class="sd">    minor : :obj:`bool`, optional</span>
<span class="sd">        Pass True if the last of the relative keys is to be interpreted within a minor context.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">relativeroot</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">relativeroot</span>
    <span class="n">spl</span> <span class="o">=</span> <span class="n">relativeroot</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spl</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">relativeroot</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">applied</span><span class="p">,</span> <span class="n">to</span> <span class="o">=</span> <span class="n">spl</span>
        <span class="k">return</span> <span class="n">rel2abs_key</span><span class="p">(</span><span class="n">applied</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">minor</span><span class="p">)</span>
    <span class="n">previous</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spl</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">spl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">rel2abs_key</span><span class="p">(</span><span class="n">resolve_relative_keys</span><span class="p">(</span><span class="n">previous</span><span class="p">,</span> <span class="n">str_is_minor</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="n">is_name</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span> <span class="n">last</span><span class="p">,</span> <span class="n">minor</span><span class="p">)</span></div>


<div class="viewcode-block" id="transpose_changes"><a class="viewcode-back" href="../../reference.html#ms3.utils.transpose_changes">[docs]</a><span class="nd">@function_logger</span>
<span class="k">def</span> <span class="nf">transpose_changes</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">old_num</span><span class="p">,</span> <span class="n">new_num</span><span class="p">,</span> <span class="n">old_minor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">new_minor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Since the interval sizes expressed by the changes of the DCML harmony syntax</span>
<span class="sd">    depend on the numeral&#39;s position in the scale, these may change if the numeral</span>
<span class="sd">    is transposed. This function expresses the same changes for the new position.</span>
<span class="sd">    Chord tone alterations (of 3 and 5) stay untouched.</span>

<span class="sd">    Uses: :py:func:`changes2tpc`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    changes : :obj:`str`</span>
<span class="sd">        A string of changes following the DCML harmony standard.</span>
<span class="sd">    old_num, new_num : :obj:`str`:</span>
<span class="sd">        Old numeral, new numeral.</span>
<span class="sd">    old_minor, new_minor : :obj:`bool`, optional</span>
<span class="sd">        For each numeral, pass True if it occurs in a minor context.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">changes</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">changes</span>
    <span class="n">old</span> <span class="o">=</span> <span class="n">changes2tpc</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">old_num</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">old_minor</span><span class="p">,</span> <span class="n">root_alterations</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">new</span> <span class="o">=</span> <span class="n">changes2tpc</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">new_num</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">new_minor</span><span class="p">,</span> <span class="n">root_alterations</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">get_acc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">n</span> <span class="o">*</span> <span class="s1">&#39;#&#39;</span> <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="n">n</span> <span class="o">*</span> <span class="s1">&#39;b&#39;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">full</span><span class="p">,</span> <span class="n">added</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">chord_interval</span><span class="p">,</span> <span class="n">iv1</span><span class="p">),</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">iv2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">iv1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">iv1</span> <span class="o">==</span> <span class="n">iv2</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">iv2</span> <span class="o">-</span> <span class="n">iv1</span>
            <span class="k">if</span> <span class="n">d</span> <span class="o">%</span> <span class="mi">7</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The difference between the intervals of </span><span class="si">{</span><span class="n">full</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">old_num</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">new_num</span><span class="si">}</span><span class="s2"> (in </span><span class="si">{</span><span class="s1">&#39;minor&#39;</span> <span class="k">if</span> <span class="n">minor</span> <span class="k">else</span> <span class="s1">&#39;major&#39;</span><span class="si">}</span><span class="s2">) don&#39;t differ by chromatic semitones.&quot;</span><span class="p">)</span>
            <span class="n">n_acc</span> <span class="o">=</span> <span class="n">acc</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">acc</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
            <span class="n">new_acc</span> <span class="o">=</span> <span class="n">get_acc</span><span class="p">(</span><span class="n">n_acc</span> <span class="o">-</span> <span class="n">d</span> <span class="o">//</span> <span class="mi">7</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">added</span> <span class="o">+</span> <span class="n">new_acc</span> <span class="o">+</span> <span class="n">chord_interval</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>


<div class="viewcode-block" id="str_is_minor"><a class="viewcode-back" href="../../reference.html#ms3.utils.str_is_minor">[docs]</a><span class="k">def</span> <span class="nf">str_is_minor</span><span class="p">(</span><span class="n">tone</span><span class="p">,</span> <span class="n">is_name</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns True if ``tone`` represents a minor key or chord.&quot;&quot;&quot;</span>
    <span class="c1"># regex = r&#39;([A-Ga-g])[#|b]*&#39; if is_name else &#39;[#|b]*(\w+)&#39;</span>
    <span class="c1"># m = re.match(regex, tone)</span>
    <span class="c1"># if m is None:</span>
    <span class="c1">#     return m</span>
    <span class="c1"># return m.group(1).islower()</span>
    <span class="k">return</span> <span class="n">tone</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span></div>


<div class="viewcode-block" id="changes2tpc"><a class="viewcode-back" href="../../reference.html#ms3.utils.changes2tpc">[docs]</a><span class="k">def</span> <span class="nf">changes2tpc</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">numeral</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">root_alterations</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a numeral and changes, computes the intervals that the changes represent.</span>
<span class="sd">    Changes do not express absolute intervals but instead depend on the numeral and the mode.</span>

<span class="sd">    Uses: split_scale_degree(), changes2list()</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    changes : :obj:`str`</span>
<span class="sd">        A string of changes following the DCML harmony standard.</span>
<span class="sd">    numeral : :obj:`str`</span>
<span class="sd">        Roman numeral. If it is preceded by accidentals, it depends on the parameter</span>
<span class="sd">        `root_alterations` whether these are taken into account.</span>
<span class="sd">    minor : :obj:`bool`, optional</span>
<span class="sd">        Set to true if the `numeral` occurs in a minor context.</span>
<span class="sd">    root_alterations : :obj:`bool`, optional</span>
<span class="sd">        Set to True if accidentals of the root should change the result.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">root_alteration</span><span class="p">,</span> <span class="n">num_degree</span> <span class="o">=</span> <span class="n">split_scale_degree</span><span class="p">(</span><span class="n">numeral</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="c1"># build 2-octave diatonic scale on C major/minor</span>
    <span class="n">root</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;II&#39;</span><span class="p">,</span><span class="s1">&#39;III&#39;</span><span class="p">,</span><span class="s1">&#39;IV&#39;</span><span class="p">,</span><span class="s1">&#39;V&#39;</span><span class="p">,</span><span class="s1">&#39;VI&#39;</span><span class="p">,</span><span class="s1">&#39;VII&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">num_degree</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
    <span class="n">tpcs</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">)]</span> <span class="k">if</span> <span class="n">minor</span> <span class="k">else</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">)]</span>
    <span class="n">tpcs</span> <span class="o">=</span> <span class="n">tpcs</span><span class="p">[</span><span class="n">root</span><span class="p">:]</span> <span class="o">+</span> <span class="n">tpcs</span><span class="p">[:</span><span class="n">root</span><span class="p">]</span>               <span class="c1"># starting the scale from chord root</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">tpcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">root_alterations</span><span class="p">:</span>
        <span class="n">root</span> <span class="o">+=</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">root_alteration</span>
        <span class="n">tpcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">root</span>

    <span class="n">alts</span> <span class="o">=</span> <span class="n">changes2list</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">acc2tpc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">accidentals</span><span class="p">:</span> <span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="n">accidentals</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">accidentals</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">[(</span><span class="n">full</span><span class="p">,</span> <span class="n">added</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">chord_interval</span><span class="p">,</span> <span class="p">(</span><span class="n">tpcs</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">chord_interval</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">acc2tpc</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span> <span class="o">-</span> <span class="n">root</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">chord_interval</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">full</span><span class="p">,</span> <span class="n">added</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">chord_interval</span> <span class="ow">in</span> <span class="n">alts</span><span class="p">]</span></div>


<div class="viewcode-block" id="changes2list"><a class="viewcode-back" href="../../reference.html#ms3.utils.changes2list">[docs]</a><span class="k">def</span> <span class="nf">changes2list</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Splits a string of changes into a list of 4-tuples.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    &gt;&gt;&gt; changes2list(&#39;+#7b5&#39;)</span>
<span class="sd">    [(&#39;+#7&#39;, &#39;+&#39;, &#39;#&#39;, &#39;7&#39;),</span>
<span class="sd">     (&#39;b5&#39;,  &#39;&#39;,  &#39;b&#39;, &#39;5&#39;)]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;((\+|-|\^|v)?(#+|b+)?(1\d|\d))&quot;</span><span class="p">,</span> <span class="n">changes</span><span class="p">)]</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">sort</span> <span class="k">else</span> <span class="n">res</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div class="sphinx-toc sphinxglobaltoc">
<h3><a href="../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quick.html">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../manual.html">Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference.html">Developers' Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
    <li><a href="../../index.html">ms3 0.4.9 documentation</a> &#187;</li>

          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">ms3.utils</a></li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, johentsch.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>